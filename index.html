<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
            --text: #2c3e50;
            --bg: #f5f7fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html,body { height:100%; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* Login Screen */
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%); }
        .login-form { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .login-form h1 { text-align: center; margin-bottom: 1.5rem; color: var(--primary); }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display:block; margin-bottom:0.5rem; font-weight:500; }
        .form-group input { width:100%; padding:0.8rem; border:1px solid #ddd; border-radius:5px; font-size:1rem; }

        .btn { padding:0.6rem 1rem; border:none; border-radius:5px; cursor:pointer; font-size:0.9rem; font-weight:600; transition:all .3s; display:inline-block; text-align:center; }
        .btn-primary { background:var(--secondary); color:#fff; }
        .btn-primary:hover { background:#2980b9; }
        .btn-link { background:none; color:var(--secondary); text-decoration:underline; padding:0.5rem; }

        /* Main */
        .app-container { display:none; flex-direction:column; height:100vh; }

        /* Header */
        .app-header { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; }
        .app-title { font-size:1.3rem; font-weight:600; }
        .user-info { display:flex; align-items:center; gap:0.8rem; }

        .user-info button {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            background: var(--accent);
            color: white;
            min-width: 100px;
        }
        .user-info button:hover { background: #c0392b; transform: translateY(-1px); }

        /* Tabs */
        .tabs { display:flex; background-color:var(--dark); }
        .tab { padding:0.8rem 1.5rem; color:white; cursor:pointer; font-weight:500; border-bottom:3px solid transparent; font-size:0.9rem; }
        .tab.active { background:var(--light); color:var(--primary); border-bottom:3px solid var(--secondary); }

        /* Content */
        .tab-content { flex-grow:1; padding:1.2rem; overflow:hidden; /* internal panes will handle scrolling */ }
        .tab-pane { display:none; height: calc(100vh - 200px); overflow:auto; } /* consistent pane sizing */
        .tab-pane.active { display:block; }

        .packaging-header { display:flex; justify-content:space-between; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; align-items: center; }
        .customer-info { display:flex; gap:0.8rem; align-items: center; flex-wrap: wrap; }
        .info-group { display:flex; flex-direction:column; margin-bottom: 0; }
        .info-group label { font-weight:600; margin-bottom:0.2rem; font-size:0.8rem; }
        .info-group select, .info-group input { padding:0.4rem; border:1px solid #ddd; border-radius:5px; font-size:0.8rem; height: auto; }
        .info-group span { font-size: 0.9rem; }
        .action-buttons { display:flex; gap:0.6rem; }

        .packaging-content {
            display: flex;
            gap: 1.2rem;
            align-items: flex-start;
            padding-bottom: 10px;
        }
        .barcode-section { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .pending-packages { flex: 0 0 50%; min-width: 360px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); overflow:auto; }
        .package-details { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); display:flex; flex-direction:column; }

        .barcode-input { display:flex; margin-bottom:0.8rem; }
        .barcode-input input { flex-grow:1; padding:0.6rem; border:1px solid #ddd; border-radius:5px 0 0 5px; font-size:1rem; }
        .barcode-input button { padding:0 0.8rem; border:1px solid #ddd; background:var(--light); cursor:pointer; }

        .package-table { width:100%; border-collapse:collapse; font-size:0.85rem; }
        .package-table th, .package-table td { padding:0.5rem; text-align:left; border-bottom:1px solid #ddd; }
        .package-table th { background:var(--light); font-weight:600; }
        .package-table tr:hover { background:#f9f9f9; }

        .quick-buttons { display:grid; grid-template-columns:repeat(3, 1fr); gap:0.4rem; margin-top:0.8rem; }
        .quick-btn { padding:0.6rem 0.4rem; background:var(--light); border:1px solid #ddd; border-radius:5px; cursor:pointer; text-align:center; font-size:0.8rem; position:relative; }
        .quantity-badge { position:absolute; top:-5px; right:-5px; background:var(--secondary); color:white; border-radius:50%; width:18px; height:18px; font-size:0.7rem; display:flex; align-items:center; justify-content:center; }

        .package-actions { margin-top:auto; display:flex; flex-direction:column; gap:0.6rem; }

        .btn-success { background:var(--success); color:white; }
        .btn-warning { background:var(--warning); color:white; }
        .btn-danger { background:var(--accent); color:white; }

        .status-beklemede { background: var(--warning); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }
        .status-sevk-edildi { background: var(--success); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }

        .app-footer { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; font-size:0.85rem; }
        .container-info { display:flex; align-items:center; gap:0.8rem; }

        /* Toast styles */
        .toast { position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:5px; color:white; z-index:1000; opacity:0; transform:translateY(-20px); transition:all .3s; }
        .toast.show { opacity:1; transform:translateY(0); }
        .toast.success { background:var(--success); } .toast.error { background:var(--accent); } .toast.warning { background:var(--warning); }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; }
        .modal-close { background:none; border:none; font-size:1.5rem; cursor:pointer; }

        .customer-list { max-height:300px; overflow-y:auto; margin-bottom:1rem; }
        .customer-item { padding:0.8rem; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
        .customer-item:hover { background:#f5f5f5; } .customer-item.selected { background:#e3f2fd; }

        .quantity-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center; }
        .quantity-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:300px; text-align:center; }
        .quantity-input { width:100%; padding:0.8rem; margin:1rem 0; border:1px solid #ddd; border-radius:5px; font-size:1.2rem; text-align:center; }
        .quantity-buttons { display:flex; justify-content:center; gap:0.8rem; margin-top:1rem; }

        .stock-search { display:flex; gap:0.8rem; margin-bottom:1.2rem; }
        .stock-search input { flex-grow:1; padding:0.8rem; border:1px solid #ddd; border-radius:5px; }
        .stock-table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .stock-table th, .stock-table td { padding:0.8rem; text-align:left; border-bottom:1px solid #ddd; } .stock-table th { background:var(--light); font-weight:600; } .stock-table tr:hover { background:#f9f9f9; }

        .file-upload { margin-top:1.2rem; padding:1.2rem; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .upload-button { display:inline-block; padding:0.8rem 1.5rem; background:var(--secondary); color:white; border-radius:5px; cursor:pointer; margin-top:0.8rem; }
        .upload-button:hover { background:#2980b9; }

        .offline-indicator { position:fixed; bottom:20px; left:20px; padding:0.8rem 1.2rem; background:var(--accent); color:white; border-radius:5px; z-index:1000; display:none; }

        /* Stock status classes */
        .status-kritik { background:#c0392b;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }
        .status-az-stok { background:#f39c12;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }
        .status-stokta { background:#2ecc71;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }

        /* Responsive */
        @media (max-width:1200px) {
            .barcode-section, .package-details { min-width:200px; }
            .pending-packages { flex: 1 1 60%; }
        }
        @media (max-width:900px) {
            .packaging-content { flex-direction:column; height:auto; }
            .barcode-section, .pending-packages, .package-details { flex: 1 1 auto; width:100%; min-width: auto; }
            .tab-pane { height: auto; }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <div class="login-form">
            <h1>ProClean - Oturum Aç</h1>
            <div class="form-group">
    <label for="email">E-posta</label>
    <input type="email" id="email" placeholder="E-posta adresinizi girin">
</div>
<div class="form-group">
    <label for="password">Şifre</label>
    <input type="password" id="password" placeholder="Şifrenizi girin">
</div>
<button type="button" class="btn btn-primary" id="loginBtn">Giriş Yap</button>
            </div>
           <button type="button" class="btn btn-primary" id="loginBtn">Giriş Yap</button>
            <div style="text-align:center; margin-top:1rem;">
                <button type="button" class="btn-link">Şifremi Unuttum</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer" aria-hidden="true">
        <div class="app-header">
            <div class="app-title">ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</div>
            <div class="user-info">
                <span id="userRole">Operatör: Ahmet Yılmaz</span>
                <button type="button" id="logoutBtn" class="btn btn-danger" onclick="logout()">Çıkış Yap</button>
            </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Ana Sekmeler">
            <div class="tab active" data-tab="packaging" role="tab" onclick="switchTab('packaging')">Paketleme</div>
            <div class="tab" data-tab="shipping" role="tab" onclick="switchTab('shipping')">Sevkiyat</div>
            <div class="tab" data-tab="stock" role="tab" onclick="switchTab('stock')">Stok Sorgu</div>
        </div>

        <div class="tab-content">
            <div class="tab-pane active" id="packagingTab">
                <div class="packaging-header">
                    <div class="customer-info">
                        <div class="info-group">
                            <label for="customer">Müşteri</label>
                            <select id="customer"></select>
                        </div>
                        <div class="info-group">
                            <label for="personnel">Personel</label>
                            <select id="personnel">
                                <option value="user1">Paket1 - Ahmet Yılmaz</option>
                                <option value="user2">Paket2 - Mehmet Demir</option>
                            </select>
                        </div>
                        <div class="info-group">
                            <label>Müşteri Adı</label>
                            <span><strong id="customerName">Lütfen müşteri seçin</strong></span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="showCustomerSelection()">Müşteri Seç</button>
                        <button type="button" class="btn" onclick="showAllCustomers()">Tüm Müş. Göster</button>
                        <button type="button" class="btn btn-warning" onclick="generateDailyReport()">İş Sonu Raporu</button>
                    </div>
                </div>

                <div class="packaging-content">
                    <div class="barcode-section" id="barcodeSection">
                        <h3>Paket Oluştur</h3>
                        <div class="barcode-input">
                            <input type="text" id="barcodeInput" placeholder="Barkodu okutun veya girin" autofocus>
                            <button type="button" onclick="searchBarcode()"><i class="fas fa-search"></i></button>
                            <button type="button" onclick="clearBarcode()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="barcode-counter">
                            <span>Okutulan barkod sayısı: <strong id="barcodeCount">0</strong></span>
                        </div>
                        <div class="barcode-preview"><svg id="barcode"></svg></div>
                    </div>

                    <div class="pending-packages" id="pendingPackages">
                        <h3>Paket Detayları</h3>
                        <table class="package-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllPackages"></th>
                                    <th>Sıra</th>
                                    <th>Paket No</th>
                                    <th>T. Miktar</th>
                                    <th>P. Zamanı</th>
                                    <th>Cari Kod</th>
                                    <th>Cari Ünvan</th>
                                    <th>Paketleyen</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTableBody"></tbody>
                        </table>
                    </div>

                    <div class="package-details" id="packageDetails">
                        <h3>Hızlı Ürün Ekleme</h3>
                        <div class="quick-buttons" id="quickButtons"></div>

                        <div class="package-actions">
                            <button type="button" class="btn" onclick="showManualEntry()">MANUEL</button>
                            <div class="definition-panel">
                                <p>Tanımsız Adet: <span style="color: red;" id="undefinedCount">0</span></p>
                                <p>Tanımlı Adet: <span style="color: blue;" id="definedCount">0</span></p>
                                <p>Ortalama Adet: <span id="averageCount">0</span></p>
                            </div>
                            <button type="button" class="btn btn-success" onclick="savePackage()">(F2) Paketle / Kaydet</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="shippingTab">
                <h2>Sevkiyat Yönetimi</h2>
                <div class="shipping-controls" style="display:flex; gap:10px; align-items:flex-end; margin-bottom:10px;">
                    <div class="info-group">
                        <label for="shippingFilter">Filtrele</label>
                        <select id="shippingFilter">
                            <option value="all">Tümü</option>
                            <option value="beklemede">Beklemede</option>
                            <option value="sevk-edildi">Sevk Edildi</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="filterShipping()">Uygula</button>
                </div>

                <table class="package-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>Konteyner No</th>
                            <th>Müşteri</th>
                            <th>Paket Sayısı</th>
                            <th>Toplam Adet</th>
                            <th>Oluşturulma Tarihi</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="shippingTableBody"></tbody>
                </table>
            </div>

            <div class="tab-pane" id="stockTab">
                <h2>Stok Sorgulama</h2>
                <div class="stock-search">
                    <input type="text" id="stockSearch" placeholder="Ürün adı veya koduna göre ara...">
                    <button type="button" class="btn btn-primary" onclick="searchStock()">Ara</button>
                    <button type="button" class="btn" onclick="clearStockSearch()">Temizle</button>
                </div>

                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>Stok Kodu</th>
                            <th>Ürün Adı</th>
                            <th>Mevcut Adet</th>
                            <th>Birim</th>
                            <th>Son Güncelleme</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody"></tbody>
                </table>

                <div class="file-upload">
                    <h3>Stok Dosyası Yükle</h3>
                    <p>Stok bilgilerini güncellemek için bir Excel veya CSV dosyası yükleyin.</p>
                    <input type="file" id="stockFileUpload" accept=".xlsx,.xls,.csv" style="display:none;">
                    <label for="stockFileUpload" class="upload-button" role="button"><i class="fas fa-upload"></i> Dosya Seç</label>
                    <span id="selectedFileName" style="margin-left:10px;"></span>
                    <button type="button" class="btn btn-primary" onclick="uploadStockFile()" style="margin-top:10px;">Yükle</button>
                    <p style="margin-top:8px; font-size:0.85rem; color:#666">Desteklenen başlık örnekleri: "Stok Kodu", "Ürün Adı", "Mevcut Adet" veya "code", "name", "quantity"</p>
                </div>
            </div>
        </div>

        <div class="app-footer">
            <div class="footer-actions">
                <button type="button" class="btn" onclick="printLabel()"><i class="fas fa-print"></i> Etiket Bas</button>
                <button type="button" class="btn" onclick="selectAllPackages()">Tümünü Seç</button>
                <button type="button" class="btn" onclick="clearSelection()">Seçimi Kaldır</button>
                <button type="button" class="btn btn-danger" onclick="deletePackage()">Paket Sil</button>
            </div>
            <div class="container-info">
                <button type="button" class="btn" onclick="loadCurrentContainer()">Mev. K.</button>
                <button type="button" class="btn" onclick="createNewContainer()">Yeni K.</button>
                <span>Konteyner No: <span id="containerNumber">C000094</span></span>
            </div>
            <div class="footer-actions">
                <button type="button" class="btn btn-danger" onclick="deleteContainer()">Konteyner Sil</button>
                <button type="button" class="btn btn-success" onclick="sendToRamp()">Kon. Rampaya Gönder</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <div class="offline-indicator" id="offlineIndicator"><i class="fas fa-wifi"></i> Çevrimdışı moddasınız</div>

    <!-- Customer Selection Modal -->
    <div class="modal" id="customerModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Müşteri Seçimi</h3>
                <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <div class="customer-list" id="customerList"></div>
                <div class="add-customer-form">
                    <h4>Müşteri Yönetimi</h4>
                    <div class="form-row">
                        <input type="text" id="newCustomerCode" placeholder="Müşteri Kodu">
                        <input type="text" id="newCustomerName" placeholder="Müşteri Adı">
                    </div>
                    <div class="form-row">
                        <input type="email" id="newCustomerEmail" placeholder="E-posta">
                        <button type="button" class="btn btn-primary" onclick="addNewCustomer()">Müşteri Ekle</button>
                        <button type="button" class="btn btn-danger" onclick="deleteSelectedCustomer()">Müşteri Sil</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-All Customers Modal -->
    <div class="modal" id="allCustomersModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tüm Müşteriler</h3>
                <button type="button" class="modal-close" onclick="closeAllCustomersModal()">&times;</button>
            </div>
            <div class="customer-list" id="allCustomersList" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Daily Report Email Modal -->
    <div class="modal" id="emailModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>İş Sonu Raporu Gönder</h3>
                <button type="button" class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="email-settings">
                <label for="reportEmail">E-posta Adresi:</label>
                <input type="email" id="reportEmail" placeholder="rapor@firma.com">
                <div style="display:flex;gap:8px;margin-top:8px">
                    <button type="button" class="btn btn-primary" onclick="sendDailyReport()">Raporu Gönder</button>
                    <button type="button" class="btn" onclick="previewReport()">Raporu Önizle</button>
                </div>
            </div>
        </div>
    </div>

    <div class="quantity-modal" id="quantityModal" aria-hidden="true">
        <div class="quantity-content">
            <h3 id="quantityProductName">Ürün Miktarı</h3>
            <input type="number" id="quantityInput" class="quantity-input" min="1" value="1">
            <div class="quantity-buttons">
                <button type="button" class="btn btn-primary" onclick="confirmQuantity()">Tamam</button>
                <button type="button" class="btn" onclick="closeQuantityModal()">İptal</button>
            </div>
        </div>
    </div>

    <div class="modal" id="manualModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manuel Ürün Ekleme</h3>
                <button type="button" class="modal-close" onclick="closeManualModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="manualProductCode">Ürün Kodu</label>
                <input type="text" id="manualProductCode" placeholder="Ürün kodunu girin">
            </div>
            <div class="form-group">
                <label for="manualProductName">Ürün Adı</label>
                <input type="text" id="manualProductName" placeholder="Ürün adını girin">
            </div>
            <div class="form-group">
                <label for="manualQuantity">Miktar</label>
                <input type="number" id="manualQuantity" min="1" value="1">
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-primary" onclick="addManualProduct()">Ekle</button>
                <button type="button" class="btn" onclick="closeManualModal()">İptal</button>
            </div>
        </div>
    </div>

    <script> 
     function logout() {
    supabase.auth.signOut().then(() => {
        currentUser = null;
        appContainer.style.display = 'none';
        appContainer.setAttribute('aria-hidden','true');
        loginScreen.style.display = 'flex';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        closeModal(); closeAllCustomersModal(); closeEmailModal(); closeQuantityModal(); closeManualModal();
        showToast('Başarıyla çıkış yapıldı', 'success');
    }).catch((error) => {
        showToast('Çıkış yapılırken hata oluştu', 'error');
    });
}
        /* -----------------------
           Data & State
           ----------------------- */
        const users = [
            { username: "operator", password: "1234", role: "operator", name: "Ahmet Yılmaz" },
            { username: "supervisor", password: "1234", role: "supervisor", name: "Mehmet Demir" }
        ];

        let customers = [
            { code: "P0006", name: "LALELİ HAMİT", email: "hamit@lalelitextile.com" },
            { code: "P0007", name: "BEYOĞLU TEKSTİL", email: "info@beyoglutextile.com" },
            { code: "P0008", name: "ŞİŞLİ OTEL", email: "reservations@sisliotel.com" },
            { code: "P0009", name: "KADIKÖY GIDA", email: "siparis@kadikoyglda.com" },
            { code: "P0010", name: "ATAŞEHIR LTD", email: "muhasebe@atasehirltd.com" }
        ];

        let packages = [
            { id: 1, packageNo: "PKG-0001", totalQuantity: 5, packageTime: "12.05.2023 14:30", customerCode: "P0006", customerName: "LALELİ HAMİT", packer: "Ahmet Yılmaz", selected: false },
            { id: 2, packageNo: "PKG-0002", totalQuantity: 3, packageTime: "12.05.2023 14:45", customerCode: "P0006", customerName: "LALELİ HAMİT", packer: "Ahmet Yılmaz", selected: false }
        ];

        let containers = [
            { id: 1, containerNo: "C000094", customer: "LALELİ HAMİT", packageCount: 2, totalQuantity: 8, createdAt: "12.05.2023", status: "beklemede", packages: [1,2] },
            { id: 2, containerNo: "C000095", customer: "BEYOĞLU TEKSTİL", packageCount: 1, totalQuantity: 4, createdAt: "13.05.2023", status: "sevk-edildi", packages: [] }
        ];

        const products = [
            { code: "PRD001", name: "Çarşaf", quantity: 0 },
            { code: "PRD002", name: "Büyük Çarşaf", quantity: 0 },
            { code: "PRD003", name: "Havlu", quantity: 0 },
            { code: "PRD004", name: "Büyük havlu", quantity: 0 },
            { code: "PRD005", name: "Alez", quantity: 0 },
            { code: "PRD006", name: "Nevresim", quantity: 0 },
            { code: "PRD007", name: "Pıke", quantity: 0 },
            { code: "PRD008", name: "Yastık", quantity: 0 },
            { code: "PRD009", name: "Yastık kılıfı", quantity: 0 }
        ];

        let stockItems = [
            { code: "STK001", name: "Temizlik Maddesi A", quantity: 150, unit: "Adet", lastUpdate: "12.05.2023", status: "Stokta" },
            { code: "STK002", name: "Deterjan Premium", quantity: 75, unit: "Kg", lastUpdate: "11.05.2023", status: "Az Stok" },
            { code: "STK003", name: "Yumuşatıcı", quantity: 200, unit: "Lt", lastUpdate: "10.05.2023", status: "Stokta" },
            { code: "STK004", name: "Leke Çıkarıcı", quantity: 5, unit: "Adet", lastUpdate: "12.05.2023", status: "Kritik" }
        ];

        let currentUser = null;
        let selectedCustomerInModal = null;
        let selectedPackage = null;
        let currentContainer = "C000094";
        let currentQuantityProduct = null;
        let barcodeCount = 0;

        // DOM refs
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const toast = document.getElementById('toast');
        const modal = document.getElementById('customerModal');
        const allCustomersModal = document.getElementById('allCustomersModal');
        const emailModal = document.getElementById('emailModal');
        const quantityModal = document.getElementById('quantityModal');
        const manualModal = document.getElementById('manualModal');
        const selectAllCheckbox = document.getElementById('selectAllPackages');

        /* -----------------------
           Initialization
           ----------------------- */
        function initApp() {
            // avoid re-binding listeners multiple times
            if (!window._proclean_listeners_initialized) {
                setupEventListeners();
                window._proclean_listeners_initialized = true;
            }

            populateCustomerDropdown();
            populateQuickButtons();
            populatePackagesTable();
            populateStockTable();
            populateShippingTable();
        }

        function setupEventListeners() {
            // Barcode input enter
            const bInput = document.getElementById('barcodeInput');
            if (bInput && !bInput._bound) {
                bInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') searchBarcode();
                });
                bInput._bound = true;
            }

            const stockInput = document.getElementById('stockSearch');
            if (stockInput && !stockInput._bound) {
                stockInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') searchStock();
                });
                stockInput._bound = true;
            }

            const fileInput = document.getElementById('stockFileUpload');
            if (fileInput && !fileInput._bound) {
                fileInput.addEventListener('change', function(e) {
                    const fileName = e.target.files[0]?.name || '';
                    document.getElementById('selectedFileName').textContent = fileName;
                });
                fileInput._bound = true;
            }

            if (selectAllCheckbox && !selectAllCheckbox._bound) {
                selectAllCheckbox.addEventListener('change', function() {
                    if (this.checked) selectAllPackages(); else clearSelection();
                });
                selectAllCheckbox._bound = true;
            }

            // F2 and ESC handling
            if (!document._proclean_keybound) {
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'F2') { e.preventDefault(); savePackage(); }
                    if (e.key === 'Escape') {
                        closeModal(); closeAllCustomersModal(); closeEmailModal(); closeQuantityModal(); closeManualModal();
                    }
                });
                document._proclean_keybound = true;
            }

            // Additional shortcuts (Ctrl)
            if (!document._proclean_ctrlbound) {
                document.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key.toLowerCase() === 's') { e.preventDefault(); savePackage(); }
                    if (e.ctrlKey && e.key.toLowerCase() === 'p') { e.preventDefault(); printLabel(); }
                    if (e.ctrlKey && e.key.toLowerCase() === 'n') { e.preventDefault(); createNewContainer(); }
                });
                document._proclean_ctrlbound = true;
            }
        }

        /* -----------------------
           Populate helpers
           ----------------------- */
        // Replace all customer operations with Supabase equivalents

async function populateCustomerDropdown() {
    const customerSelect = document.getElementById('customer');
    if (!customerSelect) return;
    customerSelect.innerHTML = '<option value="">Müşteri seçin...</option>';
    
    // Fetch customers from Supabase
    const { data: customers, error } = await supabase
        .from('customers')
        .select('*')
        .order('name');
    
    if (error) {
        console.error('Error fetching customers:', error);
        return;
    }
    
    window.customers = customers; // Store globally
    
    customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id; // Use ID instead of code
        option.textContent = `${customer.code} - ${customer.name}`;
        customerSelect.appendChild(option);
    });
}

async function addNewCustomer() {
    const code = document.getElementById('newCustomerCode').value.trim();
    const name = document.getElementById('newCustomerName').value.trim();
    const email = document.getElementById('newCustomerEmail').value.trim();

    if (!code || !name) { showToast('Müşteri kodu ve adı gerekli', 'error'); return; }

    // Check if customer code exists in Supabase
    const { data: existingCustomer } = await supabase
        .from('customers')
        .select('id')
        .eq('code', code)
        .single();

    if (existingCustomer) { showToast('Bu müşteri kodu zaten mevcut', 'error'); return; }

    // Insert new customer
    const { data, error } = await supabase
        .from('customers')
        .insert([{ code, name, email: email || '' }])
        .select();

    if (error) {
        showToast('Müşteri eklenirken hata oluştu', 'error');
        return;
    }

    showToast(`Yeni müşteri eklendi: ${name}`, 'success');
    populateCustomerDropdown();
    
    document.getElementById('newCustomerCode').value = '';
    document.getElementById('newCustomerName').value = '';
    document.getElementById('newCustomerEmail').value = '';
}
        function populateQuickButtons() {
            const quickButtons = document.getElementById('quickButtons');
            if (!quickButtons) return;
            quickButtons.innerHTML = '';
            products.forEach(product => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'quick-btn';
                button.innerHTML = `${product.name}${product.quantity > 0 ? `<div class="quantity-badge">${product.quantity}</div>` : ''}`;
                button.onclick = () => openQuantityModal(product);
                quickButtons.appendChild(button);
            });
        }

        async function savePackage() {
    const selectedCustomerId = document.getElementById('customer').value;
    const selectedCustomer = customers.find(c => c.id == selectedCustomerId);

    if (!selectedCustomer) { showToast('Lütfen bir müşteri seçin', 'error'); return; }

    const totalQuantity = products.reduce((sum, p) => sum + p.quantity, 0);
    if (totalQuantity === 0) { showToast('Paket için en az bir ürün ekleyin', 'error'); return; }

    const packageNo = `PKG-${String(packages.length + 1).padStart(4, '0')}`;
    
    // Save to Supabase
    const { data, error } = await supabase
        .from('packages')
        .insert([{
            package_no: packageNo,
            total_quantity: totalQuantity,
            customer_id: selectedCustomerId,
            packer: currentUser?.name || 'Bilinmiyor'
        }])
        .select();

    if (error) {
        showToast('Paket kaydedilirken hata oluştu', 'error');
        return;
    }

    showToast(`Paket kaydedildi: ${packageNo}`, 'success');
    
    // Reset UI
    products.forEach(p => p.quantity = 0);
    barcodeCount = 0;
    populateQuickButtons();
    clearBarcode();
    document.getElementById('barcodeCount').textContent = '0';
    updateDefinitionCounts();
    
    // Refresh packages table
    populatePackagesTable();
}

async function populatePackagesTable() {
    const tbody = document.getElementById('packagesTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    // Fetch packages from Supabase with customer data
    const { data: packages, error } = await supabase
        .from('packages')
        .select(`
            *,
            customers (code, name)
        `)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error fetching packages:', error);
        return;
    }

    window.packages = packages; // Store globally

    packages.forEach((pkg, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="checkbox" ${pkg.selected ? 'checked' : ''} onchange="togglePackageSelection('${pkg.id}')" data-id="${pkg.id}"></td>
            <td>${index + 1}</td>
            <td>${pkg.package_no}</td>
            <td>${pkg.total_quantity}</td>
            <td>${new Date(pkg.created_at).toLocaleString('tr-TR')}</td>
            <td>${pkg.customers.code}</td>
            <td>${pkg.customers.name}</td>
            <td>${pkg.packer}</td>
        `;
        tbody.appendChild(row);
    });
}
        
        async function populateStockTable() {
    const tbody = document.getElementById('stockTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    // Fetch stock items from Supabase
    const { data: stockItems, error } = await supabase
        .from('stock_items')
        .select('*')
        .order('name');
    
    if (error) {
        console.error('Error fetching stock items:', error);
        return;
    }
    
    window.stockItems = stockItems; // Store globally
    
    stockItems.forEach(item => {
        const row = document.createElement('tr');
        const statusClass = item.quantity <= 10 ? 'status-kritik' : 
                           item.quantity <= 50 ? 'status-az-stok' : 'status-stokta';
        const statusText = item.quantity <= 10 ? 'Kritik' : 
                          item.quantity <= 50 ? 'Az Stok' : 'Stokta';
        
        row.innerHTML = `
            <td>${escapeHtml(item.code)}</td>
            <td>${escapeHtml(item.name)}</td>
            <td>${escapeHtml(item.quantity)}</td>
            <td>${escapeHtml(item.unit)}</td>
            <td>${new Date(item.updated_at).toLocaleDateString('tr-TR')}</td>
            <td><span class="${statusClass}">${statusText}</span></td>
        `;
        tbody.appendChild(row);
    });
}
        async function populateShippingTable() {
    const tbody = document.getElementById('shippingTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    const filter = document.getElementById('shippingFilter')?.value || 'all';
    
    // Fetch containers from Supabase
    let query = supabase.from('containers').select('*');
    
    if (filter !== 'all') {
        query = query.eq('status', filter);
    }
    
    const { data: containers, error } = await query.order('created_at', { ascending: false });
    
    if (error) {
        console.error('Error fetching containers:', error);
        return;
    }
    
    window.containers = containers; // Store globally
    
    containers.forEach(container => {
        const row = document.createElement('tr');
        const statusClass = container.status === 'beklemede' ? 'status-beklemede' : 'status-sevk-edildi';
        
        row.innerHTML = `
            <td>${escapeHtml(container.container_no)}</td>
            <td>${escapeHtml(container.customer)}</td>
            <td>${escapeHtml(container.package_count)}</td>
            <td>${escapeHtml(container.total_quantity)}</td>
            <td>${new Date(container.created_at).toLocaleDateString('tr-TR')}</td>
            <td><span class="${statusClass}">${container.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</span></td>
            <td>
                ${container.status === 'beklemede' ? 
                    `<button class="btn btn-success" type="button" data-container="${container.container_no}">Sevk Et</button>` :
                    `<span>Sevk Edildi</span>`
                }
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Delegate button clicks for "Sevk Et"
    tbody.querySelectorAll('button[data-container]').forEach(btn => {
        if (!btn._bound) {
            btn.addEventListener('click', function() {
                shipContainer(this.dataset.container);
            });
            btn._bound = true;
        }
    });
}
        /* -----------------------
           Customer modal & list
           ----------------------- */
        function showAllCustomers() {
            const allCustomersList = document.getElementById('allCustomersList');
            if (!allCustomersList) return;
            allCustomersList.innerHTML = '';

            customers.forEach(customer => {
                const item = document.createElement('div');
                item.className = 'customer-item';
                item.innerHTML = `
                    <div>
                        <strong>${escapeHtml(customer.code)} - ${escapeHtml(customer.name)}</strong><br>
                        <small>E-posta: ${escapeHtml(customer.email)}</small>
                    </div>
                `;
                allCustomersList.appendChild(item);
            });

            allCustomersModal.style.display = 'flex';
            allCustomersModal.setAttribute('aria-hidden', 'false');
        }

        function closeAllCustomersModal() {
            allCustomersModal.style.display = 'none';
            allCustomersModal.setAttribute('aria-hidden', 'true');
        }

        function generateDailyReport() { emailModal.style.display = 'flex'; emailModal.setAttribute('aria-hidden','false'); }
        function closeEmailModal() { emailModal.style.display = 'none'; emailModal.setAttribute('aria-hidden','true'); }

        function previewReport() {
            const reportData = {
                date: new Date().toLocaleDateString('tr-TR'),
                totalPackages: packages.length,
                totalItems: packages.reduce((sum, pkg) => sum + pkg.totalQuantity, 0),
                containers: containers.length,
                customers: [...new Set(packages.map(p => p.customerName))].length,
                operator: currentUser?.name || 'Bilinmiyor'
            };

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <html>
                <head>
                    <title>İş Sonu Raporu - ${reportData.date}</title>
                    <style>body{font-family:Arial;margin:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:8px}</style>
                </head>
                <body>
                    <h1>ProClean - İş Sonu Raporu</h1>
                    <p>Tarih: ${reportData.date} | Operatör: ${reportData.operator}</p>
                    <h2>Özet</h2>
                    <ul>
                        <li>Toplam Paket Sayısı: ${reportData.totalPackages}</li>
                        <li>Toplam Ürün Adedi: ${reportData.totalItems}</li>
                        <li>Konteyner Sayısı: ${reportData.containers}</li>
                        <li>Müşteri Sayısı: ${reportData.customers}</li>
                    </ul>
                    <h2>Paket Detayları</h2>
                    <table><thead><tr><th>Paket No</th><th>Müşteri</th><th>Adet</th><th>Zaman</th><th>Paketleyen</th></tr></thead><tbody>
                        ${packages.map(pkg => `<tr><td>${escapeHtml(pkg.packageNo)}</td><td>${escapeHtml(pkg.customerName)}</td><td>${pkg.totalQuantity}</td><td>${escapeHtml(pkg.packageTime)}</td><td>${escapeHtml(pkg.packer)}</td></tr>`).join('')}
                    </tbody></table>
                </body>
                </html>
            `);
            reportWindow.document.close();
        }

        function sendDailyReport() {
            const email = document.getElementById('reportEmail').value;
            if (!email) { showToast('Lütfen e-posta adresini girin', 'error'); return; }

            // simulate send
            showToast('Rapor e-posta ile gönderildi: ' + email, 'success');
            closeEmailModal();
        }

        /* -----------------------
           Shipping helpers
           ----------------------- */
        async function sendToRamp() {
    const selectedPackages = packages.filter(p => p.selected);
    if (selectedPackages.length === 0) { 
        showToast('Lütfen rampaya göndermek için paket seçin', 'error'); 
        return; 
    }
    
    if (!confirm('Seçilen paketleri rampaya göndermek istediğinize emin misiniz?')) return;
    
    // Create container in Supabase
    const totalQuantity = selectedPackages.reduce((sum, pkg) => sum + pkg.total_quantity, 0);
    const containerNo = `C${String(containers.length + 1).padStart(6, '0')}`;
    
    const { data: newContainer, error } = await supabase
        .from('containers')
        .insert([{
            container_no: containerNo,
            customer: selectedPackages[0].customers.name,
            package_count: selectedPackages.length,
            total_quantity: totalQuantity,
            status: 'beklemede',
            package_ids: selectedPackages.map(p => p.id)
        }])
        .select();
    
    if (error) {
        showToast('Konteyner oluşturulurken hata oluştu', 'error');
        return;
    }
    
    // Update packages to mark them as in container
    for (const pkg of selectedPackages) {
        const { error: updateError } = await supabase
            .from('packages')
            .update({ container_id: newContainer[0].id })
            .eq('id', pkg.id);
        
        if (updateError) {
            showToast(`Paket ${pkg.package_no} güncellenirken hata oluştu`, 'error');
            return;
        }
    }
    
    // Update local state
    containers.push(newContainer[0]);
    packages = packages.filter(p => !p.selected);
    
    populatePackagesTable();
    populateShippingTable();
    clearSelection();
    
    showToast(`${selectedPackages.length} paket konteyner(${containerNo}) ile rampaya gönderildi - Durum: Beklemede`, 'success');
    switchTab('shipping');
}

        async function shipContainer(containerNo) {
    // Update container status in Supabase
    const { error } = await supabase
        .from('containers')
        .update({ status: 'sevk-edildi' })
        .eq('container_no', containerNo);
    
    if (error) {
        showToast(`Konteyner ${containerNo} sevk durumu güncellenirken hata oluştu`, 'error');
        return;
    }
    
    // Update local state
    const container = containers.find(c => c.container_no === containerNo);
    if (container) {
        container.status = 'sevk-edildi';
        populateShippingTable();
        showToast(`Konteyner ${containerNo} sevk edildi`, 'success');
    }
}

        function filterShipping() { populateShippingTable(); }

        /* -----------------------
           Customer modal selection
           ----------------------- */
        function showCustomerSelection() {
            populateCustomerModal();
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden','false');
        }

        function populateCustomerModal() {
            const customerList = document.getElementById('customerList');
            if (!customerList) return;
            customerList.innerHTML = '';
            customers.forEach(customer => {
                const item = document.createElement('div');
                item.className = 'customer-item';
                if (selectedCustomerInModal?.code === customer.code) item.classList.add('selected');
                item.innerHTML = `
                    <div>
                        <strong>${escapeHtml(customer.code)} - ${escapeHtml(customer.name)}</strong><br>
                        <small>E-posta: ${escapeHtml(customer.email)}</small>
                    </div>
                    <button class="btn btn-primary" type="button">Seç</button>
                `;
                const selectBtn = item.querySelector('button');
                selectBtn.addEventListener('click', () => selectCustomer(customer.code));
                customerList.appendChild(item);
            });
        }

        function selectCustomer(code) {
            selectedCustomerInModal = customers.find(c => c.code === code);
            if (selectedCustomerInModal) {
                document.getElementById('customer').value = code;
                document.getElementById('customerName').textContent = selectedCustomerInModal.name;
                closeModal();
                showToast(`Müşteri seçildi: ${selectedCustomerInModal.name}`, 'success');
            }
        }

        async function deleteSelectedCustomer() {
    if (!selectedCustomerInModal) { 
        showToast('Silmek için bir müşteri seçin', 'error'); 
        return; 
    }
    
    if (!confirm(`${selectedCustomerInModal.name} müşterisini silmek istediğinize emin misiniz?`)) return;
    
    // Delete from Supabase
    const { error } = await supabase
        .from('customers')
        .delete()
        .eq('id', selectedCustomerInModal.id);
    
    if (error) {
        showToast('Müşteri silinirken hata oluştu', 'error');
        return;
    }
    
    // Update local state
    customers = customers.filter(c => c.id !== selectedCustomerInModal.id);
    selectedCustomerInModal = null;
    populateCustomerDropdown();
    populateCustomerModal();
    showToast('Müşteri silindi', 'success');
}

        /* -----------------------
           Quantity / quick product handling
           ----------------------- */
        function openQuantityModal(product) {
            currentQuantityProduct = product;
            document.getElementById('quantityProductName').textContent = product.name;
            document.getElementById('quantityInput').value = 1;
            quantityModal.style.display = 'flex';
            quantityModal.setAttribute('aria-hidden','false');
            document.getElementById('quantityInput').focus();
        }

        function confirmQuantity() {
            const quantity = parseInt(document.getElementById('quantityInput').value, 10) || 0;
            if (quantity > 0 && currentQuantityProduct) {
                currentQuantityProduct.quantity += quantity;
                populateQuickButtons();
                updateDefinitionCounts();
                showToast(`${currentQuantityProduct.name}: ${quantity} adet eklendi`, 'success');
                closeQuantityModal();
            } else {
                showToast('Geçerli bir miktar girin', 'error');
            }
        }

        function closeQuantityModal() {
            quantityModal.style.display = 'none';
            quantityModal.setAttribute('aria-hidden','true');
            currentQuantityProduct = null;
        }

        function showManualEntry() {
            manualModal.style.display = 'flex';
            manualModal.setAttribute('aria-hidden','false');
            document.getElementById('manualProductCode').focus();
        }

        function closeManualModal() {
            manualModal.style.display = 'none';
            manualModal.setAttribute('aria-hidden','true');
            document.getElementById('manualProductCode').value = '';
            document.getElementById('manualProductName').value = '';
            document.getElementById('manualQuantity').value = '1';
        }

        function addManualProduct() {
            const code = document.getElementById('manualProductCode').value.trim();
            const name = document.getElementById('manualProductName').value.trim();
            const quantity = parseInt(document.getElementById('manualQuantity').value, 10) || 0;

            if (!code || !name || quantity < 1) { showToast("Tüm alanlar gerekli ve miktar 1'den büyük olmalı", 'error'); return; }

            let product = products.find(p => p.code === code);
            if (!product) { product = { code, name, quantity: 0 }; products.push(product); }

            product.quantity += quantity;
            populateQuickButtons();
            updateDefinitionCounts();
            closeManualModal();
            showToast(`${name}: ${quantity} adet eklendi`, 'success');
        }

        function updateDefinitionCounts() {
            const defined = products.filter(p => p.quantity > 0).reduce((sum, p) => sum + p.quantity, 0);
            const undefinedCount = Math.max(0, barcodeCount - defined);
            const average = packages.length > 0 ? Math.round(packages.reduce((sum, p) => sum + p.totalQuantity, 0) / packages.length) : 0;

            document.getElementById('definedCount').textContent = defined;
            document.getElementById('undefinedCount').textContent = undefinedCount;
            document.getElementById('averageCount').textContent = average;
        }

        /* -----------------------
           Barcode, package, selection
           ----------------------- */
        function searchBarcode() {
            const barcode = document.getElementById('barcodeInput').value.trim();
            if (!barcode) return;
            barcodeCount++;
            document.getElementById('barcodeCount').textContent = barcodeCount;

            try {
                JsBarcode("#barcode", barcode, { format: "CODE128", displayValue: true, fontSize: 12, height: 40 });
            } catch (e) {
                showToast('Geçersiz barkod formatı', 'error');
            }

            updateDefinitionCounts();
            showToast(`Barkod okundu: ${barcode}`, 'success');
            document.getElementById('barcodeInput').value = '';
        }

        function clearBarcode() {
            document.getElementById('barcodeInput').value = '';
            document.getElementById('barcode').innerHTML = '';
        }

        
        async function togglePackageSelection(id) {
    // Update in Supabase
    const { error } = await supabase
        .from('packages')
        .update({ selected: !pkg.selected })
        .eq('id', id);
    
    if (error) {
        showToast('Paket durumu güncellenirken hata oluştu', 'error');
        return;
    }
    
    // Update local state
    const pkg = packages.find(p => p.id === id);
    if (pkg) {
        pkg.selected = !pkg.selected;
        selectedPackage = pkg.selected ? pkg : null;
    }
}
        function selectAllPackages() {
            selectAllCheckbox.checked = true;
            packages.forEach(p => p.selected = true);
            document.querySelectorAll('#packagesTableBody input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function clearSelection() {
            selectAllCheckbox.checked = false;
            packages.forEach(p => p.selected = false);
            document.querySelectorAll('#packagesTableBody input[type="checkbox"]').forEach(cb => cb.checked = false);
            selectedPackage = null;
        }

        async function deletePackage() {
    const selectedPackages = packages.filter(p => p.selected);
    if (selectedPackages.length === 0) { 
        showToast('Lütfen silmek için bir paket seçin', 'error'); 
        return; 
    }
    
    if (!confirm(`${selectedPackages.length} paketi silmek istediğinize emin misiniz?`)) return;
    
    // Delete from Supabase
    for (const pkg of selectedPackages) {
        const { error } = await supabase
            .from('packages')
            .delete()
            .eq('id', pkg.id);
        
        if (error) {
            showToast(`Paket ${pkg.package_no} silinirken hata oluştu`, 'error');
            return;
        }
    }
    
    // Update local state
    packages = packages.filter(p => !p.selected);
    populatePackagesTable();
    clearSelection();
    showToast(`${selectedPackages.length} paket silindi`, 'success');
}
       async function deleteContainer() {
    if (!confirm('Konteyneri silmek istediğinize emin misiniz? Bu işlem geri alınamaz.')) return;
    
    // Delete from Supabase
    const { error } = await supabase
        .from('containers')
        .delete()
        .eq('container_no', currentContainer);
    
    if (error) {
        showToast('Konteyner silinirken hata oluştu', 'error');
        return;
    }
    
    // Update local state
    const idx = containers.findIndex(c => c.container_no === currentContainer);
    if (idx !== -1) containers.splice(idx, 1);
    
    document.getElementById('containerNumber').textContent = 'Yok';
    currentContainer = null;
    populateShippingTable();
    showToast('Konteyner silindi', 'success');
}

        function printLabel() {
            const selectedPackages = packages.filter(p => p.selected);
            if (selectedPackages.length === 0) { showToast('Lütfen yazdırmak için bir paket seçin', 'error'); return; }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html><head><title>Paket Etiketleri</title><style>body{font-family:Arial}.label{width:300px;height:150px;border:1px solid #000;margin:10px;padding:10px;display:inline-block;page-break-inside:avoid}</style><script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script></head><body><h1>Paket Etiketleri</h1>
            `);

            selectedPackages.forEach(pkg => {
                printWindow.document.write(`
                    <div class="label">
                        <h3>${escapeHtml(pkg.customerName)}</h3>
                        <p>Paket No: ${escapeHtml(pkg.packageNo)}</p>
                        <p>Adet: ${pkg.totalQuantity}</p>
                        <svg id="barcode-${pkg.id}"></svg>
                        <script>JsBarcode("#barcode-${pkg.id}", "${pkg.packageNo}", { format: "CODE128", displayValue:true, fontSize:12, height:30 });<\/script>
                    </div>
                `);
            });

            printWindow.document.write('</body></html>');
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 500);
            showToast(`${selectedPackages.length} paket için etiket yazdırılıyor...`, 'success');
        }

        /* -----------------------
           Stock search & upload
           ----------------------- */
        function searchStock() {
            const searchTerm = (document.getElementById('stockSearch').value || '').toLowerCase();
            const tbody = document.getElementById('stockTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const filteredItems = stockItems.filter(item =>
                item.name.toLowerCase().includes(searchTerm) ||
                item.code.toLowerCase().includes(searchTerm)
            );

            if (filteredItems.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="6" style="text-align:center;color:#666;padding:12px">Eşleşen stok bulunamadı</td>`;
                tbody.appendChild(tr);
                return;
            }

            filteredItems.forEach(item => {
                const row = document.createElement('tr');
                const statusClass = item.status === 'Kritik' ? 'status-kritik' : item.status === 'Az Stok' ? 'status-az-stok' : 'status-stokta';
                row.innerHTML = `
                    <td>${escapeHtml(item.code)}</td>
                    <td>${escapeHtml(item.name)}</td>
                    <td>${escapeHtml(item.quantity)}</td>
                    <td>${escapeHtml(item.unit)}</td>
                    <td>${escapeHtml(item.lastUpdate)}</td>
                    <td><span class="${statusClass}">${escapeHtml(item.status)}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function clearStockSearch() {
            const stockInput = document.getElementById('stockSearch');
            if (stockInput) stockInput.value = '';
            populateStockTable();
        }

        async function uploadStockFile() {
    const fileInput = document.getElementById('stockFileUpload');
    const file = fileInput.files[0];
    if (!file) { 
        showToast('Lütfen bir dosya seçin', 'error'); 
        return; 
    }
    
    showToast('Dosya yükleniyor...', 'warning');
    
    try {
        // Parse the file (CSV or Excel)
        let stockData = [];
        
        if (file.name.endsWith('.csv')) {
            const text = await file.text();
            stockData = Papa.parse(text, { header: true }).data;
        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            stockData = XLSX.utils.sheet_to_json(worksheet);
        }
        
        // Process and upload to Supabase
        for (const item of stockData) {
            // Normalize field names
            const code = item['Stok Kodu'] || item['code'] || item['StokKodu'] || '';
            const name = item['Ürün Adı'] || item['name'] || item['ÜrünAdı'] || item['product'] || '';
            const quantity = parseInt(item['Mevcut Adet'] || item['quantity'] || item['MevcutAdet'] || 0);
            const unit = item['Birim'] || item['unit'] || 'Adet';
            
            if (!code || !name) continue;
            
            // Upsert to Supabase
            const { error } = await supabase
                .from('stock_items')
                .upsert({
                    code: code,
                    name: name,
                    quantity: quantity,
                    unit: unit,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'code' });
            
            if (error) {
                console.error('Error upserting stock item:', error);
            }
        }
        
        showToast('Stok dosyası başarıyla yüklendi', 'success');
        document.getElementById('selectedFileName').textContent = '';
        fileInput.value = '';
        
        // Refresh the stock table
        populateStockTable();
        
    } catch (error) {
        console.error('Error processing stock file:', error);
        showToast('Dosya işlenirken hata oluştu', 'error');
    }
}
            // Simulated processing
            setTimeout(() => {
                showToast('Stok dosyası başarıyla yüklendi', 'success');
                document.getElementById('selectedFileName').textContent = '';
                fileInput.value = '';
            }, 1200);
        }

        function loadCurrentContainer() { showToast('Mevcut konteyner yüklendi', 'success'); }

        async function createNewContainer() {
    const containerNo = `C${String(containers.length + 1).padStart(6, '0')}`;
    
    // Create container in Supabase
    const { data: newContainer, error } = await supabase
        .from('containers')
        .insert([{
            container_no: containerNo,
            customer: '',
            package_count: 0,
            total_quantity: 0,
            status: 'beklemede',
            package_ids: []
        }])
        .select();
    
    if (error) {
        showToast('Konteyner oluşturulurken hata oluştu', 'error');
        return;
    }
    
    // Update local state
    containers.push(newContainer[0]);
    document.getElementById('containerNumber').textContent = containerNo;
    currentContainer = containerNo;
    
    showToast(`Yeni konteyner oluşturuldu: ${containerNo}`, 'success');
}
        function closeModal() {
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden','true');
            selectedCustomerInModal = null;
        }

        function switchTab(tabName) {
            // make switching robust by using data-tab attributes
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            const tabElement = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (tabElement) tabElement.classList.add('active');
            const pane = document.getElementById(`${tabName}Tab`);
            if (pane) pane.classList.add('active');
            else {
                // fallback: try known ids
                const map = { packaging: 'packagingTab', shipping: 'shippingTab', stock: 'stockTab' };
                const alt = document.getElementById(map[tabName]);
                if (alt) alt.classList.add('active');
            }
        }

        /* -----------------------
           Toast / alert helpers
           ----------------------- */
        function showToast(message, type = 'success', duration = 3000) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = message;
            el.className = `toast ${type} show`;
            // ensure accessible announce
            el.setAttribute('role','status');
            setTimeout(() => { el.classList.remove('show'); }, duration);
        }

        /* -----------------------
           Login / Logout
           ----------------------- */

     window.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.getElementById("loginBtn");
    if (loginBtn) {
        loginBtn.onclick = async () => {
            const email = document.getElementById("email").value; // Changed from username to email
            const password = document.getElementById("password").value;

            if (!email || !password) {
                showToast("Lütfen e-posta ve şifre girin", "error");
                return;
            }

            try {
                // Supabase login
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    showToast("Giriş başarısız: " + error.message, "error");
                    return;
                }

                // Login successful
                currentUser = {
                    email: data.user.email,
                    uid: data.user.id,
                    name: data.user.email.split('@')[0]
                };
                
                document.getElementById("userRole").textContent = `Operatör: ${currentUser.name}`;
                document.getElementById("loginScreen").style.display = "none";
                document.getElementById("appContainer").style.display = "flex";
                
                showToast("Giriş başarılı", "success");
                initApp();
                
            } catch (e) {
                showToast("Giriş başarısız: " + e.message, "error");
                console.error(e);
            }
        };
    }

    // Supabase auth state listener remains the same
    supabase.auth.onAuthStateChange((event, session) => {
        if (session) {
            // User is signed in
            currentUser = {
                email: session.user.email,
                uid: session.user.id,
                name: session.user.email.split('@')[0]
            };
            
            document.getElementById("userRole").textContent = `Operatör: ${currentUser.name}`;
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("appContainer").style.display = "flex";
            initApp();
        } else {
            // User is signed out
            document.getElementById("loginScreen").style.display = "flex";
            document.getElementById("appContainer").style.display = "none";
        }
    });
});

    // Supabase auth state listener
    supabase.auth.onAuthStateChange((event, session) => {
        if (session) {
            // User is signed in
            currentUser = {
                username: session.user.email,
                uid: session.user.id,
                name: session.user.email.split('@')[0]
            };
            
            document.getElementById("userRole").textContent = `Operatör: ${currentUser.name}`;
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("appContainer").style.display = "flex";
            initApp();
        } else {
            // User is signed out
            document.getElementById("loginScreen").style.display = "flex";
            document.getElementById("appContainer").style.display = "none";
        }
    });
});
        
        function logout() {
            currentUser = null;
            appContainer.style.display = 'none';
            appContainer.setAttribute('aria-hidden','true');
            loginScreen.style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            closeModal(); closeAllCustomersModal(); closeEmailModal(); closeQuantityModal(); closeManualModal();
            showToast('Başarıyla çıkış yapıldı', 'success');
        }

        /* -----------------------
           Auto-save
           ----------------------- */
        function autoSave() {
            try {
                const appData = { customers, packages, containers, stockItems, timestamp: new Date().toISOString() };
                localStorage.setItem('proclean_data', JSON.stringify(appData));
            } catch (e) { console.warn('Auto-save failed', e); }
        }

        function loadAutoSave() {
            const savedData = localStorage.getItem('proclean_data');
            if (!savedData) return;
            try {
                const data = JSON.parse(savedData);
                if (data.customers) customers = data.customers;
                if (data.packages) packages = data.packages;
                if (data.containers) containers = data.containers;
                if (data.stockItems) stockItems = data.stockItems;
            } catch (e) { console.error('Error loading saved data:', e); }
        }

        setInterval(autoSave, 30000);

        /* -----------------------
           Utilities
           ----------------------- */
        function escapeHtml(s) {
            if (s === null || s === undefined) return '';
            return String(s).replace(/[&<>"']/g, function (m) { return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]; });
        }

        // On load
        window.addEventListener('load', function() {
            loginScreen.style.display = 'flex';
            appContainer.style.display = 'none';
            loadAutoSave();
            // pre-populate customer dropdown so it's available on login
            populateCustomerDropdown();
            // set initial tab pane ids mapping if missing (ensure correct panes are visible)
            // nothing else by default - user must login
        });

        // Global error handler (helps debugging)
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error', msg, url, lineNo, columnNo, error);
            showToast(`Beklenmeyen hata: ${msg} (Satır ${lineNo})`, 'error');
            return false;
        };
</script>
    <script>
// Supabase initialization
const SUPABASE_URL = 'https://viehnigcbosgsxgehgnn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpZWhuaWdjYm9zZ3N4Z2VoZ25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1Mzg3MzgsImV4cCI6MjA3MzExNDczOH0.iZX8Z5mUjHc_LZpmH5EtFe0C7k4A_1zX8UoM7iDs5FM';

// Create Supabase client
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
</body>
</html>
