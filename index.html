<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ProClean - Profesyonel Ã‡amaÅŸÄ±rhane YÃ¶netim Sistemi</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>

    <!-- âœ… Local libraries -->
<script src="libs/JsBarcode.all.min.js"></script>
<script src="libs/jspdf.umd.min.js"></script>
<script src="libs/jspdf.plugin.autotable.min.js"></script>
<script src="libs/papaparse.min.js"></script>
<script src="libs/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
            --text: #2c3e50;
            --bg: #f5f7fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html,body { height:100%; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* Login Screen */
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%); }
        .login-form { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .login-form h1 { text-align: center; margin-bottom: 1.5rem; color: var(--primary); }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display:block; margin-bottom:0.5rem; font-weight:500; }
        .form-group input { width:100%; padding:0.8rem; border:1px solid #ddd; border-radius:5px; font-size:1rem; }

        .btn { padding:0.6rem 1rem; border:none; border-radius:5px; cursor:pointer; font-size:0.9rem; font-weight:600; transition:all .3s; display:inline-block; text-align:center; }
        .btn-primary { background:var(--secondary); color:#fff; }
        .btn-primary:hover { background:#2980b9; }
        .btn-link { background:none; color:var(--secondary); text-decoration:underline; padding:0.5rem; }

        /* Main */
        .app-container { display:none; flex-direction:column; height:100vh; }

        /* Header */
        .app-header { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; }
        .app-title { font-size:1.3rem; font-weight:600; }
        .user-info { display:flex; align-items:center; gap:0.8rem; }

        .user-info button {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            background: var(--accent);
            color: white;
            min-width: 100px;
        }
        .user-info button:hover { background: #c0392b; transform: translateY(-1px); }

        /* Tabs */
        .tabs { display:flex; background-color:var(--dark); }
        .tab { padding:0.8rem 1.5rem; color:white; cursor:pointer; font-weight:500; border-bottom:3px solid transparent; font-size:0.9rem; }
        .tab.active { background:var(--light); color:var(--primary); border-bottom:3px solid var(--secondary); }

        /* Content */
        .tab-content { flex-grow:1; padding:1.2rem; overflow:hidden; }
        .tab-pane { display:none; height: calc(100vh - 200px); overflow:auto; }
        .tab-pane.active { display:block; }

        .packaging-header { display:flex; justify-content:space-between; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; align-items: center; }
        .customer-info { display:flex; gap:0.8rem; align-items: center; flex-wrap: wrap; }
        .info-group { display:flex; flex-direction:column; margin-bottom: 0; }
        .info-group label { font-weight:600; margin-bottom:0.2rem; font-size:0.8rem; }
        .info-group select, .info-group input { padding:0.4rem; border:1px solid #ddd; border-radius:5px; font-size:0.8rem; height: auto; }
        .info-group span { font-size: 0.9rem; }
        .action-buttons { display:flex; gap:0.6rem; }

        .packaging-content {
            display: flex;
            gap: 1.2rem;
            align-items: flex-start;
            padding-bottom: 10px;
        }
        .barcode-section { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .pending-packages { flex: 0 0 50%; min-width: 360px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); overflow:auto; }
        .package-details { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); display:flex; flex-direction:column; }

        .barcode-input { display:flex; margin-bottom:0.8rem; }
        .barcode-input input { flex-grow:1; padding:0.6rem; border:1px solid #ddd; border-radius:5px 0 0 5px; font-size:1rem; }
        .barcode-input button { padding:0 0.8rem; border:1px solid #ddd; background:var(--light); cursor:pointer; }

        .package-table { width:100%; border-collapse:collapse; font-size:0.85rem; }
        .package-table th, .package-table td { padding:0.5rem; text-align:left; border-bottom:1px solid #ddd; }
        .package-table th { background:var(--light); font-weight:600; }
        .package-table tr:hover { background:#f9f9f9; }

        .quick-buttons { display:grid; grid-template-columns:repeat(3, 1fr); gap:0.4rem; margin-top:0.8rem; }
        .quick-btn { padding:0.6rem 0.4rem; background:var(--light); border:1px solid #ddd; border-radius:5px; cursor:pointer; text-align:center; font-size:0.8rem; position:relative; }
        .quantity-badge { position:absolute; top:-5px; right:-5px; background:var(--secondary); color:white; border-radius:50%; width:18px; height:18px; font-size:0.7rem; display:flex; align-items:center; justify-content:center; }

        .package-actions { margin-top:auto; display:flex; flex-direction:column; gap:0.6rem; }

        .btn-success { background:var(--success); color:white; }
        .btn-warning { background:var(--warning); color:white; }
        .btn-danger { background:var(--accent); color:white; }

        .status-beklemede { background: var(--warning); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }
        .status-sevk-edildi { background: var(--success); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }

        .app-footer { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; font-size:0.85rem; }
        .container-info { display:flex; align-items:center; gap:0.8rem; }

        /* Toast styles */
        .toast { position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:5px; color:white; z-index:1000; opacity:0; transform:translateY(-20px); transition:all .3s; }
        .toast.show { opacity:1; transform:translateY(0); }
        .toast.success { background:var(--success); } .toast.error { background:var(--accent); } .toast.warning { background:var(--warning); }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; }
        .modal-close { background:none; border:none; font-size:1.5rem; cursor:pointer; }

        .customer-list { max-height:300px; overflow-y:auto; margin-bottom:1rem; }
        .customer-item { padding:0.8rem; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
        .customer-item:hover { background:#f5f5f5; } .customer-item.selected { background:#e3f2fd; }

        .quantity-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center; }
        .quantity-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:300px; text-align:center; }
        .quantity-input { width:100%; padding:0.8rem; margin:1rem 0; border:1px solid #ddd; border-radius:5px; font-size:1.2rem; text-align:center; }
        .quantity-buttons { display:flex; justify-content:center; gap:0.8rem; margin-top:1rem; }

        .stock-search { display:flex; gap:0.8rem; margin-bottom:1.2rem; }
        .stock-search input { flex-grow:1; padding:0.8rem; border:1px solid #ddd; border-radius:5px; }
        .stock-table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .stock-table th, .stock-table td { padding:0.8rem; text-align:left; border-bottom:1px solid #ddd; } .stock-table th { background:var(--light); font-weight:600; } .stock-table tr:hover { background:#f9f9f9; }

        .file-upload { margin-top:1.2rem; padding:1.2rem; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .upload-button { display:inline-block; padding:0.8rem 1.5rem; background:var(--secondary); color:white; border-radius:5px; cursor:pointer; margin-top:0.8rem; }
        .upload-button:hover { background:#2980b9; }

        .offline-indicator { position:fixed; bottom:20px; left:20px; padding:0.8rem 1.2rem; background:var(--accent); color:white; border-radius:5px; z-index:1000; display:none; }

        /* Stock status classes */
        .status-kritik { background:#c0392b;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }
        .status-az-stok { background:#f39c12;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }
        .status-stokta { background:#2ecc71;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }

        /* Responsive */
        @media (max-width:1200px) {
            .barcode-section, .package-details { min-width:200px; }
            .pending-packages { flex: 1 1 60%; }
        }
        @media (max-width:900px) {
            .packaging-content { flex-direction:column; height:auto; }
            .barcode-section, .pending-packages, .package-details { flex: 1 1 auto; width:100%; min-width: auto; }
            .tab-pane { height: auto; }
        }
        /* Add to existing CSS */
        .package-table tr.selected {
            background-color: #e3f2fd !important;
            font-weight: bold;
        }

        .package-table tr.selected:hover {
            background-color: #bbdefb !important;
        }
        
        .api-key-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }
        
        .api-key-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        
        .api-key-input {
            width: 100%;
            padding: 0.8rem;
            margin: 1rem 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        /* Add these styles to your existing CSS */

/* Desktop app styling */
.app-container {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    margin: 20px;
    height: calc(100vh - 40px);
}

.app-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.tabs {
    background: linear-gradient(to bottom, #3a5169 0%, #2c3e50 100%);
}

.tab {
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
}

.tab:hover {
    background: rgba(255, 255, 255, 0.1);
}

.tab.active {
    background: var(--light);
    color: var(--primary);
    border-bottom: 3px solid var(--secondary);
    font-weight: bold;
}

/* Form elements styling */
select, input {
    border: 1px solid #d1d1d1;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 14px;
    transition: all 0.3s;
}

select:focus, input:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

/* Button styling */
.btn {
    border-radius: 4px;
    padding: 8px 16px;
    font-weight: 600;
    transition: all 0.3s;
    border: none;
    cursor: pointer;
}

.btn-primary {
    background: linear-gradient(to bottom, var(--secondary) 0%, #2980b9 100%);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.btn-primary:hover {
    background: linear-gradient(to bottom, #2980b9 0%, #2573a7 100%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

.btn-success {
    background: linear-gradient(to bottom, var(--success) 0%, #27ae60 100%);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.btn-success:hover {
    background: linear-gradient(to bottom, #27ae60 0%, #229954 100%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

.btn-warning {
    background: linear-gradient(to bottom, var(--warning) 0%, #e67e22 100%);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.btn-warning:hover {
    background: linear-gradient(to bottom, #e67e22 0%, #d35400 100%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

.btn-danger {
    background: linear-gradient(to bottom, var(--accent) 0%, #c0392b 100%);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.btn-danger:hover {
    background: linear-gradient(to bottom, #c0392b 0%, #a93226 100%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

/* Card styling */
.barcode-section, .pending-packages, .package-details {
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    background: white;
}

/* Table styling */
.package-table, .stock-table {
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
}

.package-table th, .stock-table th {
    background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
    padding: 12px 15px;
    font-weight: 600;
    text-align: left;
}

.package-table td, .stock-table td {
    padding: 10px 15px;
    border-bottom: 1px solid #e9ecef;
}

.package-table tr:last-child td, .stock-table tr:last-child td {
    border-bottom: none;
}

.package-table tr:hover, .stock-table tr:hover {
    background: #f8f9fa;
}

/* Modal styling */
.modal-content {
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Admin only elements */
.admin-only {
    display: none;
}

/* Shipping customer folders */
.customer-folder {
    background-color: #f5f7fa;
    border-left: 4px solid var(--secondary);
    margin-bottom: 8px;
    border-radius: 4px;
}

.folder-header {
    padding: 12px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}

.folder-content {
    display: none;
    padding: 0 12px 12px 12px;
    background-color: white;
    border-radius: 0 0 4px 4px;
}

.folder-content table {
    width: 100%;
    font-size: 0.9em;
}

.folder-content th {
    background-color: #e9ecef;
}

.folder-toggle {
    transition: transform 0.3s;
}

.folder-open .folder-toggle {
    transform: rotate(90deg);
}

/* Editable table cells */
.editable-cell {
    position: relative;
}

.editable-cell input {
    width: 100%;
    padding: 4px;
    border: 1px solid #ddd;
    border-radius: 3px;
}

.edit-buttons {
    display: flex;
    gap: 5px;
    margin-top: 5px;
}

/* Alert system */
.alert-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1100;
    max-width: 350px;
}

.alert {
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 5px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    animation: slideIn 0.3s forwards;
}

.alert-success {
    background-color: var(--success);
}

.alert-error {
    background-color: var(--accent);
}

.alert-warning {
    background-color: var(--warning);
}

.alert-info {
    background-color: var(--secondary);
}

.alert-close {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    margin-left: 10px;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

.alert.hide {
    animation: slideOut 0.3s forwards;
}

/* Validation error styling */
.validation-error {
    color: #e74c3c;
    font-size: 0.8rem;
    margin-top: 0.3rem;
    display: none;
}

input.invalid, select.invalid {
    border-color: #e74c3c;
    box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);
}

/* Print styles for barcode labels */
@media print {
    body * {
        visibility: hidden;
    }
    .print-label, .print-label * {
        visibility: visible;
    }
    .print-label {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
}

/* Barcode scanner indicator */
.scanner-active {
    animation: pulse 1.5s infinite;
    border: 2px solid #3498db !important;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
    100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
}

/* Container status */
.container-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
}

.status-beklemede { background-color: #f39c12; color: white; }
.status-sevk-edildi { background-color: #2ecc71; color: white; }
.status-hazirlaniyor { background-color: #3498db; color: white; }

    </style>
    </head>
<body>
    <!-- API Key GiriÅŸ ModalÄ± -->
    <div class="api-key-modal" id="apiKeyModal">
        <div class="api-key-content">
            <h2>Supabase API AnahtarÄ± Gerekli</h2>
            <p>UygulamayÄ± kullanabilmek iÃ§in geÃ§erli bir Supabase API anahtarÄ± girmeniz gerekiyor.</p>
            <input type="text" id="apiKeyInput" class="api-key-input" placeholder="Supabase API AnahtarÄ±nÄ±zÄ± girin">
            <div class="quantity-buttons">
                <button type="button" class="btn btn-primary" onclick="saveApiKey()">Kaydet</button>
                <button type="button" class="btn btn-secondary" onclick="showApiKeyHelp()">YardÄ±m</button>
            </div>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                API anahtarÄ±nÄ± nasÄ±l alacaÄŸÄ±nÄ±zÄ± bilmiyorsanÄ±z "YardÄ±m" butonuna tÄ±klayÄ±n.
            </p>
        </div>
    </div>

    <div class="login-container" id="loginScreen">
        <div class="login-form">
            <h1>ProClean - Oturum AÃ§</h1>
            <div class="form-group">
                <label for="email">E-posta</label>
                <input type="email" id="email" placeholder="E-posta adresinizi girin" required>
                <div class="validation-error" id="emailError">GeÃ§erli bir e-posta adresi girin</div>
            </div>
            <div class="form-group">
                <label for="password">Åžifre</label>
                <input type="password" id="password" placeholder="Åžifrenizi girin" required>
                <div class="validation-error" id="passwordError">Åžifre gereklidir</div>
            </div>
            <button type="button" class="btn btn-primary" id="loginBtn">GiriÅŸ Yap</button>
            <div style="margin-top: 1rem; text-align: center;">
                <a href="#" onclick="showApiKeyModal()" style="color: #3498db; text-decoration: underline; font-size: 0.9rem;">API AnahtarÄ±nÄ± YÃ¶net</a>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer" aria-hidden="true">
        <div class="app-header">
            <div class="app-title">ProClean - Profesyonel Ã‡amaÅŸÄ±rhane YÃ¶netim Sistemi</div>
            <div class="user-info">
                <span id="userRole">OperatÃ¶r: YÃ¼kleniyor...</span>
                <button type="button" id="logoutBtn" class="btn btn-danger">Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Ana Sekmeler">
            <div class="tab active" data-tab="packaging" role="tab">Paketleme</div>
            <div class="tab" data-tab="shipping" role="tab">Sevkiyat</div>
            <div class="tab" data-tab="stock" role="tab">Stok Sorgu</div>
            <div class="tab admin-only" data-tab="reports" role="tab">Raporlar</div>
        </div>

        <div class="tab-content">
            <div class="tab-pane active" id="packagingTab">
                <div class="packaging-header">
                    <div class="customer-info">
                        <div class="info-group">
                            <label for="customerSelect">MÃ¼ÅŸteri SeÃ§imi</label>
                            <select id="customerSelect" required>
                                <option value="">MÃ¼ÅŸteri seÃ§in...</option>
                            </select>
                            <div class="validation-error" id="customerError">MÃ¼ÅŸteri seÃ§imi zorunludur</div>
                        </div>
                        <div class="info-group">
                            <label for="personnelSelect">Personel</label>
                            <select id="personnelSelect" required>
                                <option value="">Personel seÃ§in...</option>
                            </select>
                            <div class="validation-error" id="personnelError">Personel seÃ§imi zorunludur</div>
                        </div>
                        <div class="info-group">
                            <label>Tarih</label>
                            <span id="currentDate">-</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="showAllCustomers()">MÃ¼ÅŸteri YÃ¶netimi</button>
                        <button type="button" class="btn btn-warning" onclick="generateDailyReport()">Ä°ÅŸ Sonu Raporu</button>
                        <button type="button" class="btn btn-success" onclick="sendToRamp()">Konteynere Ekle</button>
                    </div>
                </div>

                <div class="packaging-content">
                    <div class="barcode-section">
                        <h3>Barkod Okuma</h3>
                        <div class="barcode-input">
                            <input type="text" id="barcodeInput" placeholder="Barkod okutun veya girin" autofocus>
                            <button type="button" onclick="processBarcode()"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="barcodeResult">
                            <div id="scannedBarcodes" style="margin-top: 10px; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        
                        <div class="quick-buttons">
                            <div class="quick-btn" onclick="openQuantityModal('BÃ¼yÃ¼k Ã‡arÅŸaf')" data-product="BÃ¼yÃ¼k Ã§arÅŸaf">
                                <span>BÃ¼yÃ¼k Ã§arÅŸaf</span>
                                <div class="quantity-badge" id="BÃ¼yÃ¼k Ã‡arÅŸaf-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Ã‡arÅŸaf')" data-product="Ã‡arÅŸaf">
                                <span>Ã‡arÅŸaf</span>
                                <div class="quantity-badge" id="Ã‡arÅŸaf-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('BÃ¼yÃ¼k Nevresim')" data-product="BÃ¼yÃ¼k Nevresim">
                                <span>BÃ¼yÃ¼k Nevresim</span>
                                <div class="quantity-badge" id="BÃ¼yÃ¼k Nevresim-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Nevresim')" data-product="Nevresim">
                                <span>Nevresim</span>
                                <div class="quantity-badge" id="Nevresim-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('BÃ¼yÃ¼k Havlu')" data-product="BÃ¼yÃ¼k Havlu">
                                <span>BÃ¼yÃ¼k Havlu</span>
                                <div class="quantity-badge" id="BÃ¼yÃ¼k Havlu-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Havlu')" data-product="Havlu">
                                <span>Havlu</span>
                                <div class="quantity-badge" id="Havlu-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('YastÄ±k')" data-product="YastÄ±k">
                                <span>YastÄ±k</span>
                                <div class="quantity-badge" id="YastÄ±k-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('YastÄ±k KÄ±lÄ±fÄ±')" data-product="YastÄ±k KÄ±lÄ±fÄ±">
                                <span>YastÄ±k KÄ±lÄ±fÄ±</span>
                                <div class="quantity-badge" id="YastÄ±k KÄ±lÄ±fÄ±-quantity">0</div>
                            </div>
                             <div class="quick-btn" onclick="openQuantityModal('Alez')" data-product="Alez">
                                <span>Alez</span>
                                <div class="quantity-badge" id="Alez-quantity">0</div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="openManualEntry()" style="width:100%; margin-top:1rem;">Manuel GiriÅŸ</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleScannerMode()" style="width:100%; margin-top:0.5rem;" id="scannerToggle">
                            <i class="fas fa-camera"></i> Barkod TarayÄ±cÄ±yÄ± AÃ§
                        </button>
                    </div>

                    <div class="pending-packages">
    <h3>Bekleyen Paketler</h3>
    <table class="package-table">
        <thead>
            <tr>
                <th>
                    <input type="checkbox" id="selectAllPackages" onchange="toggleSelectAll()">
                </th>
                <th>Paket No</th>
                <th>MÃ¼ÅŸteri</th>
                <th>ÃœrÃ¼n</th>
                <th>Tarih</th>
                <th>Durum</th>
            </tr>
        </thead>
        <tbody id="packagesTableBody">
            </tbody>
    </table>
</div>

                    <div class="package-details">
                        <h3>Paket DetaylarÄ±</h3>
                        <div id="packageDetailContent">
                            <p style="text-align:center; color:#666; margin:2rem 0;">Paket seÃ§in</p>
                        </div>
                        
                        <div class="package-actions">
                            <button type="button" class="btn btn-success" onclick="completePackage()">Paketle</button>
                            <button type="button" class="btn btn-warning" onclick="printAllLabels()">Etiket YazdÄ±r</button>
                            <button type="button" class="btn btn-danger" onclick="deleteSelectedPackages()">Sil</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="shippingTab">
                <div class="packaging-header">
                    <div class="customer-info">
                        <div class="info-group">
                            <label for="shippingFilter">Durum Filtresi</label>
                            <select id="shippingFilter" onchange="filterShipping()">
                                <option value="all">TÃ¼mÃ¼</option>
                                <option value="beklemede">Beklemede</option>
                                <option value="sevk-edildi">Sevk Edildi</option>
                            </select>
                        </div>
                        <div class="info-group">
                            <label for="containerSearch">Konteyner Ara</label>
                            <input type="text" id="containerSearch" placeholder="Konteyner no..." oninput="searchContainers()">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="createNewContainer()">Yeni Konteyner</button>
                        <button type="button" class="btn btn-warning" onclick="loadCurrentContainer()">Mevcut Konteyner</button>
                        <button type="button" class="btn btn-danger" onclick="deleteContainer()">Konteyner Sil</button>
                    </div>
                </div>

                <div id="shippingFolders">
                    <!-- Customer folders will be populated here -->
                </div>
            </div>

            <div class="tab-pane" id="stockTab">
                <div class="stock-search">
                    <input type="text" id="stockSearch" placeholder="Stok ara..." oninput="searchStock()">
                    <button type="button" class="btn btn-primary" onclick="clearStockSearch()">Temizle</button>
                    <button type="button" class="btn btn-success" onclick="exportStock()">StoklarÄ± DÄ±ÅŸa Aktar</button>
                </div>

                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>Stok Kodu</th>
                            <th>ÃœrÃ¼n AdÄ±</th>
                            <th>Mevcut Adet</th>
                            <th>Birim</th>
                            <th>Durum</th>
                            <th>Son GÃ¼ncelleme</th>
                            <th>Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                        <!-- Stock data will be populated here -->
                    </tbody>
                </table>

                <div class="file-upload">
                    <h3>Stok DosyasÄ± YÃ¼kle</h3>
                    <p>Excel (.xlsx, .xls) veya CSV (.csv) dosyasÄ± seÃ§in</p>
                    <input type="file" id="stockFileUpload" accept=".xlsx,.xls,.csv" onchange="document.getElementById('selectedFileName').textContent = this.files[0] ? this.files[0].name : ''">
                    <div>
                        <span id="selectedFileName"></span>
                        <div class="validation-error" id="fileError"></div>
                    </div>
                    <button type="button" class="upload-button" onclick="uploadStockFile()">
                        <i class="fas fa-upload"></i> Dosya YÃ¼kle
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="downloadTemplate()" style="margin-left: 10px;">
                        <i class="fas fa-download"></i> Åžablon Ä°ndir
                    </button>
                </div>
            </div>

            <div class="tab-pane admin-only" id="reportsTab">
                <div class="packaging-header">
                    <h3>Raporlar</h3>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="generateCustomReport()">Ã–zel Rapor</button>
                        <button type="button" class="btn btn-warning" onclick="exportReports()">RaporlarÄ± DÄ±ÅŸa Aktar</button>
                    </div>
                </div>

                <div class="report-filters" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div class="info-group">
                        <label for="reportType">Rapor TÃ¼rÃ¼</label>
                        <select id="reportType">
                            <option value="daily">GÃ¼nlÃ¼k Rapor</option>
                            <option value="weekly">HaftalÄ±k Rapor</option>
                            <option value="monthly">AylÄ±k Rapor</option>
                            <option value="custom">Ã–zel Rapor</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label for="startDate">BaÅŸlangÄ±Ã§ Tarihi</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="info-group">
                        <label for="endDate">BitiÅŸ Tarihi</label>
                        <input type="date" id="endDate">
                    </div>
                    <div class="info-group" style="align-self: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="loadReports()">RaporlarÄ± YÃ¼kle</button>
                    </div>
                </div>

                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>Rapor Tarihi</th>
                            <th>Rapor TÃ¼rÃ¼</th>
                            <th>Paket SayÄ±sÄ±</th>
                            <th>Toplam Adet</th>
                            <th>OluÅŸturan</th>
                            <th>Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <!-- Reports will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="app-footer">
            <div class="container-info">
                <span>Aktif Konteyner: <strong id="containerNumber">Yok</strong></span>
                <span>|</span>
                <span>Toplam Paket: <strong id="totalPackages">0</strong></span>
                <span>|</span>
                <span>ProClean Â© 2025</span>
            </div>
            <div id="connectionStatus">Ã‡evrimiÃ§i</div>
        </div>
    </div>

    <!-- Alert container -->
    <div class="alert-container" id="alertContainer"></div>

    <!-- Customer Modal -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>MÃ¼ÅŸteri SeÃ§</h3>
                <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="customer-list" id="customerList">
                <!-- Customers will be populated here -->
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Ä°ptal</button>
            </div>
        </div>
    </div>

    <!-- All Customers Modal -->
    <div class="modal" id="allCustomersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>MÃ¼ÅŸteri YÃ¶netimi</h3>
                <button type="button" class="modal-close" onclick="closeAllCustomersModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="newCustomerCode">MÃ¼ÅŸteri Kodu</label>
                <input type="text" id="newCustomerCode" placeholder="Ã–rn: P0005" required>
                <div class="validation-error" id="customerCodeError">MÃ¼ÅŸteri kodu gereklidir</div>
            </div>
            <div class="form-group">
                <label for="newCustomerName">MÃ¼ÅŸteri AdÄ±</label>
                <input type="text" id="newCustomerName" placeholder="MÃ¼ÅŸteri adÄ±nÄ± girin" required>
                <div class="validation-error" id="customerNameError">MÃ¼ÅŸteri adÄ± gereklidir</div>
            </div>
            <div class="form-group">
                <label for="newCustomerEmail">E-posta (Ä°steÄŸe baÄŸlÄ±)</label>
                <input type="email" id="newCustomerEmail" placeholder="E-posta adresini girin">
                <div class="validation-error" id="customerEmailError">GeÃ§erli bir e-posta adresi girin</div>
            </div>
            <button type="button" class="btn btn-primary" onclick="addNewCustomer()">MÃ¼ÅŸteri Ekle</button>
            
            <hr style="margin: 1.5rem 0;">
            <h4>Mevcut MÃ¼ÅŸteriler</h4>
            <div class="customer-list" id="allCustomersList">
                <!-- All customers will be populated here -->
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div class="modal" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ä°ÅŸ Sonu Raporu GÃ¶nder</h3>
                <button type="button" class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="reportEmail">E-posta Adresi</label>
                <input type="email" id="reportEmail" placeholder="Rapor gÃ¶nderilecek e-posta" required>
                <div class="validation-error" id="reportEmailError">GeÃ§erli bir e-posta adresi girin</div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" onclick="sendDailyReport()">Rapor GÃ¶nder</button>
                <button type="button" class="btn btn-warning" onclick="previewReport()">Ã–nizleme</button>
                <button type="button" class="btn btn-secondary" onclick="closeEmailModal()">Ä°ptal</button>
            </div>
        </div>
    </div>

    <!-- Quantity Modal -->
    <div class="quantity-modal" id="quantityModal">
        <div class="quantity-content">
            <h3 id="quantityModalTitle">Adet Girin</h3>
            <input type="number" id="quantityInput" class="quantity-input" min="1" placeholder="Adet" required>
            <div class="validation-error" id="quantityError">GeÃ§erli bir adet girin</div>
            <div class="quantity-buttons">
                <button type="button" class="btn btn-primary" onclick="confirmQuantity()">Onayla</button>
                <button type="button" class="btn btn-secondary" onclick="closeQuantityModal()">Ä°ptal</button>
            </div>
        </div>
    </div>

    <!-- Manual Entry Modal -->
    <div class="modal" id="manualModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manuel ÃœrÃ¼n GiriÅŸi</h3>
                <button type="button" class="modal-close" onclick="closeManualModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="manualProduct">ÃœrÃ¼n AdÄ±</label>
                <input type="text" id="manualProduct" placeholder="ÃœrÃ¼n adÄ±nÄ± girin" required>
                <div class="validation-error" id="manualProductError">ÃœrÃ¼n adÄ± gereklidir</div>
            </div>
            <div class="form-group">
                <label for="manualQuantity">Adet</label>
                <input type="number" id="manualQuantity" min="1" placeholder="Adet girin" required>
                <div class="validation-error" id="manualQuantityError">GeÃ§erli bir adet girin</div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" onclick="addManualProduct()">Ekle</button>
                <button type="button" class="btn btn-secondary" onclick="closeManualModal()">Ä°ptal</button>
            </div>
        </div>
    </div>

    <!-- Container Detail Modal -->
    <div class="modal" id="containerDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="containerDetailTitle">Konteyner DetaylarÄ±</h3>
                <button type="button" class="modal-close" onclick="closeContainerDetailModal()">&times;</button>
            </div>
            <div id="containerDetailContent">
                <!-- Container details will be populated here -->
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button type="button" class="btn btn-success" onclick="shipContainerFromModal()">Sevk Et</button>
                <button type="button" class="btn btn-secondary" onclick="closeContainerDetailModal()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Print Label Container (hidden) -->
    <div id="printContainer" style="display:none;"></div>

    <div class="printer-status-section">
    <div id="printer-status" class="printer-status">
        <span id="printer-indicator">ðŸ”´</span>
        <span id="printer-text">Checking printer...</span>
        <button id="test-printer" onclick="testPrinter()">Test Printer</button>
        <button onclick="checkPrinterStatus()">Check Status</button>
    </div>
</div>
    
    <div class="toast" id="toast" role="status" aria-live="polite"></div>
    <div class="offline-indicator" id="offlineIndicator">Ã‡evrimdÄ±ÅŸÄ± Mod</div>

    <script>
        // Supabase initialization - VarsayÄ±lan deÄŸerler
        const SUPABASE_URL = 'https://viehnigcbosgsxgehgnn.supabase.co';
let SUPABASE_ANON_KEY = null;
let supabase = null;

// Global state variables
let selectedCustomer = null;
let currentPackage = {};
let currentContainer = null;
let selectedProduct = null;
let currentUser = null;
let scannedBarcodes = [];
let editingStockItem = null;
let scannerMode = false;
let currentContainerDetails = null;
let currentReportData = null;
let selectedPackageForPrinting = null;

// EmailJS initialization
(function() {
    // EmailJS kullanÄ±cÄ± ID'si - KENDÄ° ID'NÄ°ZÄ° EKLEYÄ°N
    emailjs.init("jH-KlJ2ffs_lGwfsp");
})();

// Elementleri bir defa tanÄ±mla
const elements = {};

function initializeElementsObject() {
    const elementMap = {
        loginScreen: 'loginScreen',
        appContainer: 'appContainer',
        loginButton: 'loginBtn',
        emailInput: 'email',
        passwordInput: 'password',
        customerSelect: 'customerSelect',
        personnelSelect: 'personnelSelect',
        currentDate: 'currentDate',
        barcodeInput: 'barcodeInput',
        packagesTableBody: 'packagesTableBody',
        packageDetailContent: 'packageDetailContent',
        shippingFolders: 'shippingFolders',
        stockTableBody: 'stockTableBody',
        customerList: 'customerList',
        allCustomersList: 'allCustomersList',
        toast: 'toast',
        containerNumber: 'containerNumber',
        totalPackages: 'totalPackages',
        shippingFilter: 'shippingFilter',
        stockSearch: 'stockSearch',
        selectAllPackages: 'selectAllPackages',
        apiKeyModal: 'apiKeyModal',
        apiKeyInput: 'apiKeyInput',
        quantityInput: 'quantityInput',
        quantityModal: 'quantityModal',
        quantityModalTitle: 'quantityModalTitle',
        scannedBarcodes: 'scannedBarcodes',
        connectionStatus: 'connectionStatus',
        alertContainer: 'alertContainer',
        scannerToggle: 'scannerToggle',
        containerSearch: 'containerSearch'
    };
    
    Object.keys(elementMap).forEach(key => {
        const element = document.getElementById(elementMap[key]);
        if (element) {
            elements[key] = element;
        } else {
            console.warn(`Element ${elementMap[key]} not found`);
            elements[key] = null;
        }
    });
    
    return elements;
}



        

// Profesyonel alert sistemi
function showAlert(message, type = 'info', duration = 5000) {
    if (!elements.alertContainer) {
        console.error('Alert container not found, using console instead');
        console.log(`${type.toUpperCase()}: ${message}`);
        return;
    }
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    
    const span = document.createElement('span');
    span.textContent = message; // Use textContent for XSS protection
    
    const button = document.createElement('button');
    button.className = 'alert-close';
    button.textContent = 'Ã—';
    
    alert.appendChild(span);
    alert.appendChild(button);
    
    elements.alertContainer.appendChild(alert);
    
    // Close button event
    button.addEventListener('click', () => {
        alert.classList.add('hide');
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 300);
    });
    
    // Auto close
    if (duration > 0) {
        setTimeout(() => {
            if (alert.parentNode) {
                alert.classList.add('hide');
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 300);
            }
        }, duration);
    }
    
    return alert;
}




        
// YardÄ±mcÄ± fonksiyonlar
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}



        

// Form doÄŸrulama fonksiyonu
function validateForm(inputs) {
    let isValid = true;
    
    inputs.forEach(input => {
        const element = document.getElementById(input.id);
        const errorElement = document.getElementById(input.errorId);
        
        if (input.required && !element.value.trim()) {
            element.classList.add('invalid');
            errorElement.style.display = 'block';
            isValid = false;
        } else if (input.type === 'email' && element.value.trim() && !isValidEmail(element.value)) {
            element.classList.add('invalid');
            errorElement.style.display = 'block';
            errorElement.textContent = 'GeÃ§erli bir e-posta adresi girin';
            isValid = false;
        } else if (input.type === 'number' && element.value && (!Number.isInteger(Number(element.value)) || Number(element.value) < 1)) {
            element.classList.add('invalid');
            errorElement.style.display = 'block';
            errorElement.textContent = 'GeÃ§erli bir sayÄ± girin';
            isValid = false;
        } else {
            element.classList.remove('invalid');
            errorElement.style.display = 'none';
        }
    });
    
    return isValid;
}





        
function isValidEmail(email) {
    const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(String(email).toLowerCase());
}



        
// FIXED: Supabase istemcisini baÅŸlat - Singleton pattern ile
function initializeSupabase() {
    // EÄŸer client zaten oluÅŸturulmuÅŸsa ve API key geÃ§erliyse, mevcut olanÄ± dÃ¶ndÃ¼r
    if (supabase && SUPABASE_ANON_KEY) {
        return supabase;
    }
    
    if (!SUPABASE_ANON_KEY) {
        console.warn('Supabase API key not set, showing modal');
        showApiKeyModal();
        return null;
    }
    
    try {
        // Global supabase deÄŸiÅŸkenine ata
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase client initialized successfully');
        return supabase;
    } catch (error) {
        console.error('Supabase initialization error:', error);
        showAlert('Supabase baÅŸlatÄ±lamadÄ±. API anahtarÄ±nÄ± kontrol edin.', 'error');
        showApiKeyModal();
        return null;
    }
}


        

// FIXED: API anahtarÄ±nÄ± kaydet ve istemciyi baÅŸlat
function saveApiKey() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    if (!apiKey) {
        showAlert('LÃ¼tfen bir API anahtarÄ± girin', 'error');
        return;
    }
    
    // Eski client'Ä± temizle
    supabase = null;
    
    // Yeni API key'i ayarla
    SUPABASE_ANON_KEY = apiKey;
    localStorage.setItem('procleanApiKey', apiKey);
    
    // Yeni client oluÅŸtur
    const newClient = initializeSupabase();
    
    if (newClient) {
        document.getElementById('apiKeyModal').style.display = 'none';
        showAlert('API anahtarÄ± kaydedildi', 'success');
        testConnection();
    }
}



        

// API anahtarÄ± modalÄ±nÄ± gÃ¶ster
function showApiKeyModal() {
    const apiKeyInput = document.getElementById('apiKeyInput');
    if (apiKeyInput) {
        apiKeyInput.value = SUPABASE_ANON_KEY || '';
        document.getElementById('apiKeyModal').style.display = 'flex';
    }
}



        
// API anahtarÄ± yardÄ±mÄ± gÃ¶ster
function showApiKeyHelp() {
    const helpWindow = window.open('', '_blank');
    helpWindow.document.write(`
        <html>
        <head>
            <title>Supabase API AnahtarÄ± Alma Rehberi</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
                h1 { color: #2c3e50; }
                .step { margin-bottom: 20px; padding: 15px; background: #f5f7fa; border-radius: 5px; }
            </style>
        </head>
        <body>
            <h1>Supabase API AnahtarÄ± NasÄ±l AlÄ±nÄ±r?</h1>
            <div class="step">
                <h3>1. Supabase hesabÄ±nÄ±za giriÅŸ yapÄ±n</h3>
                <p><a href="https://supabase.com/dashboard" target="_blank">https://supabase.com/dashboard</a></p>
            </div>
            <div class="step">
                <h3>2. Projenizi seÃ§in veya yeni proje oluÅŸturun</h3>
            </div>
            <div class="step">
                <h3>3. Sol menÃ¼den Settings (Ayarlar) seÃ§eneÄŸine tÄ±klayÄ±n</h3>
            </div>
            <div class="step">
                <h3>4. API sekmesine gidin</h3>
            </div>
            <div class="step">
                <h3>5. "Project API Keys" bÃ¶lÃ¼mÃ¼ndeki "anon" veya "public" anahtarÄ±nÄ± kopyalayÄ±n</h3>
                <p>Bu anahtarÄ± uygulamadaki API anahtarÄ± alanÄ±na yapÄ±ÅŸtÄ±rÄ±n.</p>
            </div>
            <div class="step">
                <h3>Ã–nemli Not:</h3>
                <p>API anahtarÄ±nÄ±zÄ± asla paylaÅŸmayÄ±n ve gizli tutun.</p>
            </div>
        </body>
        </html>
    `);
}




        
// FIXED: Supabase baÄŸlantÄ±sÄ±nÄ± test et
async function testConnection() {
    if (!supabase) {
        console.warn('Supabase client not initialized for connection test');
        showAlert('Supabase istemcisi baÅŸlatÄ±lmadÄ±. LÃ¼tfen API anahtarÄ±nÄ± girin.', 'error');
        return false;
    }
    
    try {
        const { data, error } = await supabase.from('customers').select('*').limit(1);
        if (error) throw error;
        
        console.log('Supabase connection test successful:', data);
        showAlert('VeritabanÄ± baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±!', 'success', 3000);
        return true;
    } catch (e) {
        console.error('Supabase connection test failed:', e.message);
        showAlert('VeritabanÄ±na baÄŸlanÄ±lamÄ±yor. LÃ¼tfen API anahtarÄ±nÄ±zÄ± ve internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.', 'error');
        return false;
    }
}



        

// FIXED: KullanÄ±cÄ± giriÅŸi
async function login() {
    // Supabase client'Ä± kontrol et ve gerekirse baÅŸlat
    if (!supabase) {
        const client = initializeSupabase();
        if (!client) {
            showAlert('LÃ¼tfen Ã¶nce API anahtarÄ±nÄ± girin.', 'error');
            showApiKeyModal();
            return;
        }
    }

    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    // Form doÄŸrulama
    if (!validateForm([
        { id: 'email', errorId: 'emailError', type: 'email', required: true },
        { id: 'password', errorId: 'passwordError', type: 'text', required: true }
    ])) {
        return;
    }

    const loginBtn = document.getElementById('loginBtn');
    loginBtn.disabled = true;
    loginBtn.textContent = 'GiriÅŸ yapÄ±lÄ±yor...';

    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password,
        });

        if (error) {
            showAlert(`GiriÅŸ baÅŸarÄ±sÄ±z: ${error.message}`, 'error');
            return;
        }

        if (data.user && data.user.email) {
            // KullanÄ±cÄ± rolÃ¼nÃ¼ al
            const { data: userData, error: userError } = await supabase
                .from('personnel')
                .select('role, name')
                .eq('email', data.user.email)
                .single();

            if (!userError && userData) {
                currentUser = {
                    email: data.user.email,
                    uid: data.user.id,
                    name: userData.name || data.user.email.split('@')[0],
                    role: userData.role
                };
            } else {
                currentUser = {
                    email: data.user.email,
                    uid: data.user.id,
                    name: data.user.email.split('@')[0],
                    role: 'operator' // VarsayÄ±lan rol
                };
            }

            const userRoleElement = document.getElementById('userRole');
            if (userRoleElement) {
                userRoleElement.textContent = 
                    `${currentUser.role === 'admin' ? 'YÃ¶netici' : 'OperatÃ¶r'}: ${currentUser.name}`;
            }
            
            // Rol bazlÄ± yetkilendirme (eÄŸer fonksiyon mevcutsa)
            if (typeof applyRoleBasedPermissions === 'function') {
                applyRoleBasedPermissions(currentUser.role);
            }
            
            showAlert('GiriÅŸ baÅŸarÄ±lÄ±!', 'success');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            
            // BaÄŸlantÄ± testini arka planda yap
            testConnection();
        } else {
            showAlert('GiriÅŸ baÅŸarÄ±sÄ±z. LÃ¼tfen tekrar deneyin.', 'error');
        }

    } catch (e) {
        console.error('Login error:', e);
        showAlert('GiriÅŸ sÄ±rasÄ±nda bir hata oluÅŸtu.', 'error');
    } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'GiriÅŸ Yap';
    }
}



        

// YardÄ±mcÄ± fonksiyonlar
function getSupabaseClient() {
    if (!supabase) {
        return initializeSupabase();
    }
    return supabase;
}




        
function isSupabaseReady() {
    return supabase !== null && SUPABASE_ANON_KEY !== null;
}

// Sayfa yÃ¼klendiÄŸinde API anahtarÄ±nÄ± localStorage'dan yÃ¼kle
document.addEventListener('DOMContentLoaded', () => {
    const savedApiKey = localStorage.getItem('procleanApiKey');
    if (savedApiKey) {
        SUPABASE_ANON_KEY = savedApiKey;
        initializeSupabase();
        console.log('API key loaded from localStorage');
    }
});



        
        function applyRoleBasedPermissions(role) {
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            
            if (role === 'admin') {
                adminOnlyElements.forEach(el => el.style.display = 'block');
            } else {
                adminOnlyElements.forEach(el => el.style.display = 'none');
            }
        }



        

        // KullanÄ±cÄ± Ã§Ä±kÄ±ÅŸÄ±
        function logout() {
            if (!supabase) return;
            
            supabase.auth.signOut().then(() => {
                showAlert('BaÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yapÄ±ldÄ±.', 'success');
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
            }).catch(e => {
                console.error('Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken bir hata oluÅŸtu:', e);
                showAlert('Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken bir hata oluÅŸtu.', 'error');
            });
        }




        
        // 3. ELEMENT EXISTENCE VALIDATION - ADD THIS AT THE BEGINNING
function initializeElements() {
    const elementIds = ['loginScreen', 'appContainer', 'customerSelect'];
    const elements = {};
    
    elementIds.forEach(id => {
        elements[id] = document.getElementById(id);
        if (!elements[id]) {
            console.error(`Element ${id} not found`);
        }
    });
    
    return elements;
}



        
        
        // State management functions
        function saveAppState() {
            const state = {
                selectedCustomerId: selectedCustomer ? selectedCustomer.id : null,
                selectedPersonnelId: elements.personnelSelect.value,
                currentContainer: currentContainer,
            };
            localStorage.setItem('procleanState', JSON.stringify(state));
        }


        

        function loadAppState() {
            const savedState = localStorage.getItem('procleanState');
            if (savedState) {
                const state = JSON.parse(savedState);
                
                // Restore customer selection
                if (state.selectedCustomerId) {
                    elements.customerSelect.value = state.selectedCustomerId;
                    // Find and set the selectedCustomer object
                    const option = elements.customerSelect.querySelector(`option[value="${state.selectedCustomerId}"]`);
                    if (option) {
                        selectedCustomer = {
                            id: state.selectedCustomerId,
                            name: option.textContent.split(' (')[0],
                            code: option.textContent.match(/\(([^)]+)\)/)?.[1] || ''
                        };
                    }
                }
                
                // Restore personnel selection
                if (state.selectedPersonnelId) {
                    elements.personnelSelect.value = state.selectedPersonnelId;
                }
                
                // Restore current container
                if (state.currentContainer) {
                    currentContainer = state.currentContainer;
                    elements.containerNumber.textContent = currentContainer;
                }
            }
        }

        function clearAppState() {
            localStorage.removeItem('procleanState');
            selectedCustomer = null;
            elements.customerSelect.value = '';
            elements.personnelSelect.value = '';
            currentContainer = null;
            elements.containerNumber.textContent = 'Yok';
            currentPackage = {};
            
            // Reset quantity badges
            document.querySelectorAll('.quantity-badge').forEach(badge => {
                badge.textContent = '0';
            });
            
            // Clear package details
            document.getElementById('packageDetailContent').innerHTML = 
                '<p style="text-align:center; color:#666; margin:2rem 0;">Paket seÃ§in</p>';
        }

        // Initialize application
        async function initApp() {
            elements.currentDate.textContent = new Date().toLocaleDateString('tr-TR');
            
            // Populate dropdowns
            await populateCustomers();
            await populatePersonnel();
            
            // Load saved state
            loadAppState();
            
            // Load data
            await populatePackagesTable();
            await populateStockTable();
            await populateShippingTable();
            
            // Test connection
            await testConnection();
            
            // Set up auto-save
            setInterval(saveAppState, 5000); // Save every 5 seconds
            
            // Set up offline support
            setupOfflineSupport();
            
            // Set up barcode scanner listener
            setupBarcodeScanner();
        }

        // Ã‡evrimdÄ±ÅŸÄ± destek
        function setupOfflineSupport() {
            window.addEventListener('online', () => {
                document.getElementById('offlineIndicator').style.display = 'none';
                elements.connectionStatus.textContent = 'Ã‡evrimiÃ§i';
                showAlert('Ã‡evrimiÃ§i moda geÃ§ildi. Veriler senkronize ediliyor...', 'success');
                syncOfflineData();
            });

            window.addEventListener('offline', () => {
                document.getElementById('offlineIndicator').style.display = 'block';
                elements.connectionStatus.textContent = 'Ã‡evrimdÄ±ÅŸÄ±';
                showAlert('Ã‡evrimdÄ±ÅŸÄ± moda geÃ§ildi. DeÄŸiÅŸiklikler internet baÄŸlantÄ±sÄ± saÄŸlandÄ±ÄŸÄ±nda senkronize edilecek.', 'warning');
            });

            // BaÅŸlangÄ±Ã§ta Ã§evrimiÃ§i durumu kontrol et
            if (!navigator.onLine) {
                document.getElementById('offlineIndicator').style.display = 'block';
                elements.connectionStatus.textContent = 'Ã‡evrimdÄ±ÅŸÄ±';
            }
        }

        // Ã‡evrimdÄ±ÅŸÄ± verileri senkronize et
        async function syncOfflineData() {
            const offlineData = JSON.parse(localStorage.getItem('procleanOfflineData') || '{}');
            
            if (Object.keys(offlineData).length === 0) return;
            
            showAlert('Ã‡evrimdÄ±ÅŸÄ± veriler senkronize ediliyor...', 'warning');
            
            try {
                // Paketleri senkronize et
                if (offlineData.packages && offlineData.packages.length > 0) {
                    for (const pkg of offlineData.packages) {
                        const { error } = await supabase
                            .from('packages')
                            .insert([pkg]);
                        
                        if (error) console.error('Paket senkronizasyon hatasÄ±:', error);
                    }
                }
                
                // BarkodlarÄ± senkronize et
                if (offlineData.barcodes && offlineData.barcodes.length > 0) {
                    for (const barcode of offlineData.barcodes) {
                        const { error } = await supabase
                            .from('barcodes')
                            .insert([barcode]);
                        
                        if (error) console.error('Barkod senkronizasyon hatasÄ±:', error);
                    }
                }
                
                // Stok gÃ¼ncellemelerini senkronize et
                if (offlineData.stockUpdates && offlineData.stockUpdates.length > 0) {
                    for (const update of offlineData.stockUpdates) {
                        const { error } = await supabase
                            .from('stock_items')
                            .update({ quantity: update.quantity })
                            .eq('code', update.code);
                        
                        if (error) console.error('Stok senkronizasyon hatasÄ±:', error);
                    }
                }
                
                // BaÅŸarÄ±lÄ± senkronizasyondan sonra Ã§evrimdÄ±ÅŸÄ± verileri temizle
                localStorage.removeItem('procleanOfflineData');
                showAlert('Ã‡evrimdÄ±ÅŸÄ± veriler baÅŸarÄ±yla senkronize edildi', 'success');
                
            } catch (error) {
                console.error('Senkronizasyon hatasÄ±:', error);
                showAlert('Veri senkronizasyonu sÄ±rasÄ±nda hata oluÅŸtu', 'error');
            }
        }

        // Ã‡evrimdÄ±ÅŸÄ± veri kaydetme
        function saveOfflineData(type, data) {
            const offlineData = JSON.parse(localStorage.getItem('procleanOfflineData') || '{}');
            
            if (!offlineData[type]) {
                offlineData[type] = [];
            }
            
            offlineData[type].push(data);
            localStorage.setItem('procleanOfflineData', JSON.stringify(offlineData));
        }

        // Barkod tarayÄ±cÄ± modunu aÃ§/kapa
        function toggleScannerMode() {
            scannerMode = !scannerMode;
            
            if (scannerMode) {
                elements.barcodeInput.classList.add('scanner-active');
                elements.scannerToggle.innerHTML = '<i class="fas fa-camera"></i> Barkod TarayÄ±cÄ±yÄ± Kapat';
                elements.barcodeInput.focus();
                showAlert('Barkod tarayÄ±cÄ± modu aktif. Barkodu okutun.', 'info');
            } else {
                elements.barcodeInput.classList.remove('scanner-active');
                elements.scannerToggle.innerHTML = '<i class="fas fa-camera"></i> Barkod TarayÄ±cÄ±yÄ± AÃ§';
                showAlert('Barkod tarayÄ±cÄ± modu kapatÄ±ldÄ±.', 'info');
            }
        }

        // Barkod tarayÄ±cÄ± dinleyicisi
      function setupBarcodeScanner() {
    if (!elements.barcodeInput) {
        console.error('Barcode input element not found');
        return;
    }
    
    let barcodeBuffer = '';
    let lastKeyTime = Date.now();
    
    elements.barcodeInput.addEventListener('keypress', function(e) {
        const currentTime = Date.now();
        
        if (scannerMode || currentTime - lastKeyTime < 50) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (barcodeBuffer.length > 5) {
                    elements.barcodeInput.value = barcodeBuffer;
                    processBarcode();
                }
                barcodeBuffer = '';
            } else {
                barcodeBuffer += e.key;
            }
        } else {
            barcodeBuffer = '';
        }
        
        lastKeyTime = currentTime;
    });
}

        // Data loading functions
   async function populateCustomers() {
    try {
        if (!elements.customerSelect) {
            console.error('Customer select element not found');
            showAlert('MÃ¼ÅŸteri seÃ§im alanÄ± bulunamadÄ±', 'error');
            return;
        }
        
        // Clear dropdown
        elements.customerSelect.innerHTML = '<option value="">MÃ¼ÅŸteri seÃ§in...</option>';
        
        if (!supabase) {
            throw new Error('Supabase client not initialized');
        }
        
        const { data: customers, error } = await supabase
            .from('customers')
            .select('*')
            .order('name');

        if (error) {
            handleSupabaseError(error, 'MÃ¼ÅŸteri yÃ¼kleme');
            return;
        }

        if (customers && customers.length > 0) {
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} (${customer.code})`;
                elements.customerSelect.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Error in populateCustomers:', error);
        showAlert('MÃ¼ÅŸteri yÃ¼kleme hatasÄ±: ' + error.message, 'error');
    }
}

        function checkOnlineStatus() {
    if (!navigator.onLine) {
        showAlert("Ã‡evrimdÄ±ÅŸÄ± Mod: Ä°nternet yok, bazÄ± iÅŸlemler Ã§alÄ±ÅŸmayacak", "error");
        return false;
    }
    return true;
}

        
        async function populatePersonnel() {
            try {
                // Dropdown'u temizle
                elements.personnelSelect.innerHTML = '<option value="">Personel seÃ§in...</option>';
                
                const { data: personnel, error } = await supabase
                    .from('personnel')
                    .select('*')
                    .order('name');

                if (error) {
                    console.error('Error loading personnel:', error);
                    // Add default current user
                    const option = document.createElement('option');
                    option.value = currentUser?.uid || 'default';
                    option.textContent = currentUser?.name || 'Mevcut KullanÄ±cÄ±';
                    option.selected = true;
                    elements.personnelSelect.appendChild(option);
                    return;
                }

                if (personnel && personnel.length > 0) {
                    personnel.forEach(person => {
                        const option = document.createElement('option');
                        option.value = person.id;
                        option.textContent = person.name;
                        elements.personnelSelect.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Error in populatePersonnel:', error);
                // Add default current user
                const option = document.createElement('option');
                option.value = currentUser?.uid || 'default';
                option.textContent = currentUser?.name || 'Mevcut KullanÄ±cÄ±';
                option.selected = true;
                elements.personnelSelect.appendChild(option);
            }
        }


        

       async function populatePackagesTable() {
    try {
        elements.packagesTableBody.innerHTML = '';
        
        const { data: packages, error } = await supabase
            .from('packages')
            .select(`
                *,
                customers (name, code)
            `)
            .is('container_id', null)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading packages:', error);
            showAlert('Paket verileri yÃ¼klenemedi', 'error');
            return;
        }

        if (packages && packages.length > 0) {
            packages.forEach(pkg => {
                const row = document.createElement('tr');
                
                // Format product information
                let productInfo = '';
                if (pkg.items && typeof pkg.items === 'object') {
                    productInfo = Object.entries(pkg.items)
                        .map(([product, quantity]) => `${product}: ${quantity}`)
                        .join(', ');
                }
                
                // Paket verilerini data attribute olarak sakla
                row.innerHTML = `
                    <td><input type="checkbox" value="${pkg.id}" data-package='${JSON.stringify(pkg).replace(/'/g, "&apos;")}' onchange="updatePackageSelection()"></td>
                    <td>${pkg.package_no}</td>
                    <td>${pkg.customers?.name || 'N/A'}</td>
                    <td>${productInfo || 'N/A'}</td>
                    <td>${new Date(pkg.created_at).toLocaleDateString('tr-TR')}</td>
                    <td><span class="status-${pkg.status}">${pkg.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</span></td>
                `;
                row.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        selectPackage(pkg);
                    }
                };
                elements.packagesTableBody.appendChild(row);
            });
            
            elements.totalPackages.textContent = packages.length;
        } else {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="7" style="text-align:center; color:#666;">HenÃ¼z paket yok</td>';
            elements.packagesTableBody.appendChild(row);
        }
        
    } catch (error) {
        console.error('Error in populatePackagesTable:', error);
        showAlert('Paket tablosu yÃ¼kleme hatasÄ±', 'error');
    }
}


        
        
        // Helper function to calculate total quantity of selected packages
        async function calculateTotalQuantity(packageIds) {
            try {
                const { data: packages, error } = await supabase
                    .from('packages')
                    .select('total_quantity')
                    .in('id', packageIds);
                    
                if (error) throw error;
                
                return packages.reduce((sum, pkg) => sum + pkg.total_quantity, 0);
            } catch (error) {
                console.error('Error calculating total quantity:', error);
                return packageIds.length; // Fallback to package count
            }
        }


        

        // Update the populateShippingTable function to use customer folders
        async function populateShippingTable() {
            try {
                elements.shippingFolders.innerHTML = '';
                
                const filter = elements.shippingFilter?.value || 'all';
                let query = supabase
                    .from('containers')
                    .select(`
                        *,
                        packages (
                            id,
                            package_no,
                            total_quantity,
                            customers (name, code)
                        )
                    `);
                
                if (filter !== 'all') {
                    query = query.eq('status', filter);
                }
                
                const { data: containers, error } = await query.order('created_at', { ascending: false });

                if (error) {
                    console.error('Error loading containers:', error);
                    showAlert('Sevkiyat verileri yÃ¼klenemedi', 'error');
                    return;
                }

                if (containers && containers.length > 0) {
                    // MÃ¼ÅŸterilere gÃ¶re grupla
                    const customersMap = {};
                    
                    containers.forEach(container => {
                        const customerName = container.packages && container.packages.length > 0 ? 
                            container.packages[0].customers?.name : container.customer || 'DiÄŸer';
                        
                        if (!customersMap[customerName]) {
                            customersMap[customerName] = [];
                        }
                        
                        customersMap[customerName].push(container);
                    });
                    
                    // MÃ¼ÅŸteri klasÃ¶rlerini oluÅŸtur
                    for (const [customerName, customerContainers] of Object.entries(customersMap)) {
                        const folderDiv = document.createElement('div');
                        folderDiv.className = 'customer-folder';
                        
                        const folderHeader = document.createElement('div');
                        folderHeader.className = 'folder-header';
                        folderHeader.innerHTML = `
                            <span>${customerName}</span>
                            <span class="folder-toggle"><i class="fas fa-chevron-right"></i></span>
                        `;
                        
                        const folderContent = document.createElement('div');
                        folderContent.className = 'folder-content';
                        
                        const table = document.createElement('table');
                        table.className = 'package-table';
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th><input type="checkbox" class="select-all-customer" onchange="toggleSelectAllCustomer(this)"></th>
                                    <th>Konteyner No</th>
                                    <th>Paket SayÄ±sÄ±</th>
                                    <th>Toplam Adet</th>
                                    <th>Tarih</th>
                                    <th>Durum</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${customerContainers.map(container => `
                                    <tr>
                                        <td><input type="checkbox" value="${container.id}" class="container-checkbox"></td>
                                        <td>${container.container_no}</td>
                                        <td>${container.package_count || 0}</td>
                                        <td>${container.total_quantity || 0}</td>
                                        <td>${container.created_at ? new Date(container.created_at).toLocaleDateString('tr-TR') : 'N/A'}</td>
                                        <td><span class="status-${container.status}">${container.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</span></td>
                                        <td>
                                            <button onclick="viewContainerDetails('${container.id}')" class="btn btn-primary btn-sm">Detay</button>
                                            <button onclick="sendToRamp('${container.container_no}')" class="btn btn-warning btn-sm">Paket Ekle</button>
                                            <button onclick="shipContainer('${container.container_no}')" class="btn btn-success btn-sm">Sevk Et</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        `;
                        
                        folderContent.appendChild(table);
                        folderDiv.appendChild(folderHeader);
                        folderDiv.appendChild(folderContent);
                        
                        // KlasÃ¶r aÃ§ma/kapama iÅŸlevi
                        folderHeader.addEventListener('click', () => {
                            folderDiv.classList.toggle('folder-open');
                            folderContent.style.display = folderDiv.classList.contains('folder-open') ? 'block' : 'none';
                        });
                        
                        elements.shippingFolders.appendChild(folderDiv);
                    }
                } else {
                    elements.shippingFolders.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">Sevkiyat verisi yok</p>';
                }
                
            } catch (error) {
                console.error('Error in populateShippingTable:', error);
                showAlert('Sevkiyat tablosu yÃ¼kleme hatasÄ±', 'error');
            }
        }


        

        // Konteyner detaylarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le
        async function viewContainerDetails(containerId) {
            try {
                const { data: container, error } = await supabase
                    .from('containers')
                    .select(`
                        *,
                        packages (
                            *,
                            customers (name, code)
                        )
                    `)
                    .eq('id', containerId)
                    .single();

                if (error) throw error;
                
                currentContainerDetails = container;
                
                const modalTitle = document.getElementById('containerDetailTitle');
                const modalContent = document.getElementById('containerDetailContent');
                
                modalTitle.textContent = `Konteyner: ${container.container_no}`;
                
                let contentHTML = `
                    <p><strong>Durum:</strong> <span class="container-status status-${container.status}">${container.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</span></p>
                    <p><strong>OluÅŸturulma Tarihi:</strong> ${new Date(container.created_at).toLocaleDateString('tr-TR')}</p>
                    <p><strong>Paket SayÄ±sÄ±:</strong> ${container.package_count || 0}</p>
                    <p><strong>Toplam Adet:</strong> ${container.total_quantity || 0}</p>
                `;
                
                if (container.packages && container.packages.length > 0) {
                    contentHTML += `
                        <h4>Paketler</h4>
                        <table class="package-table">
                            <thead>
                                <tr>
                                    <th>Paket No</th>
                                    <th>MÃ¼ÅŸteri</th>
                                    <th>Adet</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${container.packages.map(pkg => `
                                    <tr>
                                        <td>${pkg.package_no}</td>
                                        <td>${pkg.customers?.name || 'N/A'}</td>
                                        <td>${pkg.total_quantity}</td>
                                        <td><span class="status-${pkg.status}">${pkg.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                
                modalContent.innerHTML = contentHTML;
                document.getElementById('containerDetailModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading container details:', error);
                showAlert('Konteyner detaylarÄ± yÃ¼klenirken hata oluÅŸtu', 'error');
            }
        }


        

        // Konteyner detay modalÄ±nÄ± kapat
        function closeContainerDetailModal() {
            document.getElementById('containerDetailModal').style.display = 'none';
            currentContainerDetails = null;
        }

        // Konteyner detay modalÄ±ndan sevk et
        async function shipContainerFromModal() {
            if (currentContainerDetails) {
                await shipContainer(currentContainerDetails.container_no);
                closeContainerDetailModal();
            }
        }



        
        // Konteyner ara
        function searchContainers() {
            const searchTerm = elements.containerSearch.value.toLowerCase();
            const folders = document.querySelectorAll('.customer-folder');
            
            folders.forEach(folder => {
                const containerRows = folder.querySelectorAll('tbody tr');
                let hasVisibleRows = false;
                
                containerRows.forEach(row => {
                    const containerNo = row.cells[1].textContent.toLowerCase();
                    if (containerNo.includes(searchTerm)) {
                        row.style.display = '';
                        hasVisibleRows = true;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // EÄŸer bu klasÃ¶rde gÃ¶rÃ¼nebilir satÄ±r yoksa, klasÃ¶rÃ¼ gizle
                const folderHeader = folder.querySelector('.folder-header');
                if (hasVisibleRows) {
                    folder.style.display = 'block';
                    folderHeader.style.display = 'flex';
                } else {
                    folder.style.display = 'none';
                }
            });
        }

        // MÃ¼ÅŸteri klasÃ¶rÃ¼ndeki tÃ¼m konteynerleri seÃ§
        function toggleSelectAllCustomer(checkbox) {
            const folder = checkbox.closest('.customer-folder');
            const checkboxes = folder.querySelectorAll('.container-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }




        
        async function populateStockTable() {
            try {
                elements.stockTableBody.innerHTML = '';
                
                const { data: stockItems, error } = await supabase
                    .from('stock_items')
                    .select('*')
                    .order('name');

                if (error) {
                    console.error('Error loading stock items:', error);
                    showAlert('Stok verileri yÃ¼klenemedi', 'error');
                    return;
                }

                if (stockItems && stockItems.length > 0) {
                    stockItems.forEach(item => {
                        const row = document.createElement('tr');
                        
                        // Determine stock status
                        let statusClass = 'status-stokta';
                        let statusText = 'Stokta';
                        
                        if (item.quantity <= 0) {
                            statusClass = 'status-kritik';
                            statusText = 'Kritik';
                        } else if (item.quantity < 10) {
                            statusClass = 'status-az-stok';
                            statusText = 'Az Stok';
                        }
                        
                        row.innerHTML = `
                            <td>${item.code}</td>
                            <td>${item.name}</td>
                            <td class="editable-cell">
                                <span class="stock-quantity">${item.quantity}</span>
                                <input type="number" class="stock-quantity-input" value="${item.quantity}" style="display:none;">
                            </td>
                            <td>${item.unit || 'Adet'}</td>
                            <td><span class="${statusClass}">${statusText}</span></td>
                            <td>${item.updated_at ? new Date(item.updated_at).toLocaleDateString('tr-TR') : 'N/A'}</td>
                            <td>
                                <button onclick="editStockItem(this, '${item.code}')" class="btn btn-primary btn-sm">DÃ¼zenle</button>
                                <div class="edit-buttons" style="display:none;">
                                    <button onclick="saveStockItem('${item.code}')" class="btn btn-success btn-sm">Kaydet</button>
                                    <button onclick="cancelEditStockItem('${item.code}', ${item.quantity})" class="btn btn-secondary btn-sm">Ä°ptal</button>
                                </div>
                            </td>
                        `;
                        elements.stockTableBody.appendChild(row);
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="7" style="text-align:center; color:#666;">Stok verisi yok</td>';
                    elements.stockTableBody.appendChild(row);
                }
                
            } catch (error) {
                console.error('Error in populateStockTable:', error);
                showAlert('Stok tablosu yÃ¼kleme hatasÄ±', 'error');
            }
        }




        
        // Stok dÃ¼zenleme fonksiyonlarÄ±
        function editStockItem(button, code) {
            const row = button.closest('tr');
            const quantitySpan = row.querySelector('.stock-quantity');
            const quantityInput = row.querySelector('.stock-quantity-input');
            const editButton = row.querySelector('button');
            const editButtons = row.querySelector('.edit-buttons');
            
            // DÃ¼zenleme moduna geÃ§
            quantitySpan.style.display = 'none';
            quantityInput.style.display = 'block';
            editButton.style.display = 'none';
            editButtons.style.display = 'flex';
            
            editingStockItem = code;
        }



        
        async function saveStockItem(code) {
            const row = document.querySelector(`tr:has(td:first-child:contains("${code}"))`);
            const quantityInput = row.querySelector('.stock-quantity-input');
            const quantitySpan = row.querySelector('.stock-quantity');
            const editButton = row.querySelector('button');
            const editButtons = row.querySelector('.edit-buttons');
            const newQuantity = parseInt(quantityInput.value);
            
            if (isNaN(newQuantity) || newQuantity < 0) {
                showAlert('GeÃ§erli bir miktar girin', 'error');
                return;
            }
            
            try {
                if (!navigator.onLine) {
                    // Ã‡evrimdÄ±ÅŸÄ± mod
                    saveOfflineData('stockUpdates', {
                        code: code,
                        quantity: newQuantity,
                        updated_at: new Date().toISOString()
                    });
                    showAlert(`Stok Ã§evrimdÄ±ÅŸÄ± gÃ¼ncellendi: ${code}`, 'warning');
                } else {
                    // Ã‡evrimiÃ§i mod
                    const { error } = await supabase
                        .from('stock_items')
                        .update({ 
                            quantity: newQuantity,
                            updated_at: new Date().toISOString()
                        })
                        .eq('code', code);
                    
                    if (error) throw error;
                    
                    showAlert(`Stok gÃ¼ncellendi: ${code}`, 'success');
                }
                
                // GÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
                quantitySpan.textContent = newQuantity;
                quantitySpan.style.display = 'block';
                quantityInput.style.display = 'none';
                editButton.style.display = 'block';
                editButtons.style.display = 'none';
                
                // Durumu yeniden hesapla
                const statusCell = row.querySelector('td:nth-child(5) span');
                if (newQuantity <= 0) {
                    statusCell.className = 'status-kritik';
                    statusCell.textContent = 'Kritik';
                } else if (newQuantity < 10) {
                    statusCell.className = 'status-az-stok';
                    statusCell.textContent = 'Az Stok';
                } else {
                    statusCell.className = 'status-stokta';
                    statusCell.textContent = 'Stokta';
                }
                
                editingStockItem = null;
                
            } catch (error) {
                console.error('Error updating stock:', error);
                showAlert('Stok gÃ¼ncellenirken hata oluÅŸtu', 'error');
            }
        }



        

        function cancelEditStockItem(code, originalQuantity) {
            const row = document.querySelector(`tr:has(td:first-child:contains("${code}"))`);
            const quantityInput = row.querySelector('.stock-quantity-input');
            const quantitySpan = row.querySelector('.stock-quantity');
            const editButton = row.querySelector('button');
            const editButtons = row.querySelector('.edit-buttons');
            
            // DeÄŸiÅŸiklikleri iptal et
            quantityInput.value = originalQuantity;
            quantitySpan.style.display = 'block';
            quantityInput.style.display = 'none';
            editButton.style.display = 'block';
            editButtons.style.display = 'none';
            
            editingStockItem = null;
        }



        
        // Barkod iÅŸleme fonksiyonu
      async function processBarcode() {
    if (!elements.barcodeInput) {
        showAlert('Barkod giriÅŸi bulunamadÄ±', 'error');
        return;
    }
    
    const barcode = elements.barcodeInput.value.trim();
    if (!barcode) {
        showAlert('Barkod girin', 'error');
        return;
    }

    if (!selectedCustomer) {
        showAlert('Ã–nce mÃ¼ÅŸteri seÃ§in', 'error');
        return;
    }

    try {
        const barcodeData = {
            barcode: barcode,
            customer_id: selectedCustomer.id,
            scanned_at: new Date().toISOString(),
            processed: false
        };

        if (!navigator.onLine) {
            // Offline mode
            saveOfflineData('barcodes', barcodeData);
            scannedBarcodes.push({...barcodeData, id: 'offline-' + Date.now()});
            showAlert(`Barkod Ã§evrimdÄ±ÅŸÄ± kaydedildi: ${barcode}`, 'warning');
        } else {
            // Online mode with proper error handling
            if (!supabase) {
                throw new Error('Supabase client not initialized');
            }
            
            const { data, error } = await supabase
                .from('barcodes')
                .insert([barcodeData])
                .select();

            if (error) {
                handleSupabaseError(error, 'Barkod kaydetme');
                return;
            }

            if (data && data.length > 0) {
                scannedBarcodes.push(data[0]);
                showAlert(`Barkod kaydedildi: ${barcode}`, 'success');
            }
        }

        elements.barcodeInput.value = '';
        if (elements.barcodeInput.focus) {
            elements.barcodeInput.focus();
        }
        
        displayScannedBarcodes();
        
    } catch (error) {
        console.error('Barkod iÅŸleme hatasÄ±:', error);
        showAlert('Barkod iÅŸlenirken bir hata oluÅŸtu: ' + error.message, 'error');
    }
}



        
        // Taranan barkodlarÄ± gÃ¶ster
        function displayScannedBarcodes() {
            const container = document.getElementById('scannedBarcodes');
            container.innerHTML = '';
            
            if (scannedBarcodes.length === 0) {
                container.innerHTML = '<p style="color:#666; text-align:center; font-size:0.8rem;">HenÃ¼z barkod taranmadÄ±</p>';
                return;
            }
            
            const list = document.createElement('ul');
            list.style = 'list-style: none; padding: 0; margin: 0; font-size: 0.8rem;';
            
            scannedBarcodes.forEach(barcode => {
                const item = document.createElement('li');
                item.style = 'padding: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;';
                item.innerHTML = `
                    <span>${barcode.barcode}</span>
                    <span style="color: ${barcode.processed ? 'green' : 'orange'}">
                        ${barcode.processed ? 'Ä°ÅŸlendi' : 'Beklemede'}
                    </span>
                `;
                list.appendChild(item);
            });
            
            container.appendChild(list);
        }




        
        // Customer operations
        async function showCustomers() {
            try {
                elements.customerList.innerHTML = '';
                
                const { data: customers, error } = await supabase
                    .from('customers')
                    .select('*')
                    .order('name');

                if (error) {
                    console.error('Error loading customers:', error);
                    showAlert('MÃ¼ÅŸteri verileri yÃ¼klenemedi', 'error');
                    return;
                }

                if (customers && customers.length > 0) {
                    customers.forEach(customer => {
                        const div = document.createElement('div');
                        div.className = 'customer-item';
                        div.innerHTML = `
                            <div>
                                <strong>${customer.name}</strong><br>
                                <small>${customer.code}</small>
                            </div>
                        `;
                        div.onclick = () => selectCustomerFromModal(customer);
                        elements.customerList.appendChild(div);
                    });
                }
                
                document.getElementById('customerModal').style.display = 'flex';
            } catch (error) {
                console.error('Error in showCustomers:', error);
                showAlert('MÃ¼ÅŸteri listesi yÃ¼kleme hatasÄ±', 'error');
            }
        }


        

        async function showAllCustomers() {
            try {
                elements.allCustomersList.innerHTML = '';
                
                const { data: customers, error } = await supabase
                    .from('customers')
                    .select('*')
                    .order('name');

                if (error) {
                    console.error('Error loading customers:', error);
                    showAlert('MÃ¼ÅŸteri verileri yÃ¼klenemedi', 'error');
                    return;
                }

                if (customers && customers.length > 0) {
                    customers.forEach(customer => {
                        const div = document.createElement('div');
                        div.className = 'customer-item';
                        div.innerHTML = `
                            <div>
                                <strong>${customer.name}</strong> (${customer.code})<br>
                                <small>${customer.email || 'E-posta yok'}</small>
                            </div>
                            <button onclick="deleteCustomer('${customer.id}')" class="btn btn-danger btn-sm">Sil</button>
                        `;
                        elements.allCustomersList.appendChild(div);
                    });
                }
                
                document.getElementById('allCustomersModal').style.display = 'flex';
            } catch (error) {
                console.error('Error in showAllCustomers:', error);
                showAlert('MÃ¼ÅŸteri yÃ¶netimi yÃ¼kleme hatasÄ±', 'error');
            }
        }


        

        async function addNewCustomer() {
            const code = document.getElementById('newCustomerCode').value.trim();
            const name = document.getElementById('newCustomerName').value.trim();
            const email = document.getElementById('newCustomerEmail').value.trim();

            // Form doÄŸrulama
            if (!validateForm([
                { id: 'newCustomerCode', errorId: 'customerCodeError', type: 'text', required: true },
                { id: 'newCustomerName', errorId: 'customerNameError', type: 'text', required: true },
                { id: 'newCustomerEmail', errorId: 'customerEmailError', type: 'email', required: false }
            ])) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('customers')
                    .insert([{ code, name, email: email || null }]);

                if (error) {
                    console.error('Error adding customer:', error);
                    showAlert('MÃ¼ÅŸteri eklenirken hata: ' + error.message, 'error');
                    return;
                }

                showAlert('MÃ¼ÅŸteri baÅŸarÄ±yla eklendi', 'success');
                
                // Clear form
                document.getElementById('newCustomerCode').value = '';
                document.getElementById('newCustomerName').value = '';
                document.getElementById('newCustomerEmail').value = '';
                
                // Refresh lists
                await populateCustomers();
                await showAllCustomers();
                
            } catch (error) {
                console.error('Error in addNewCustomer:', error);
                showAlert('MÃ¼ÅŸteri ekleme hatasÄ±', 'error');
            }
        }


        

        async function deleteCustomer(customerId) {
            if (!confirm('Bu mÃ¼ÅŸteriyi silmek istediÄŸinize emin misiniz?')) return;

            try {
                const { error } = await supabase
                    .from('customers')
                    .delete()
                    .eq('id', customerId);

                if (error) {
                    console.error('Error deleting customer:', error);
                    showAlert('MÃ¼ÅŸteri silinirken hata: ' + error.message, 'error');
                    return;
                }

                showAlert('MÃ¼ÅŸteri baÅŸarÄ±yla silindi', 'success');
                
                // Refresh lists
                await populateCustomers();
                await showAllCustomers();
                
            } catch (error) {
                console.error('Error in deleteCustomer:', error);
                showAlert('MÃ¼ÅŸteri silme hatasÄ±', 'error');
            }
        }



        
        function selectCustomerFromModal(customer) {
            selectedCustomer = customer;
            elements.customerSelect.value = customer.id;
            closeModal();
            showAlert(`MÃ¼ÅŸteri seÃ§ildi: ${customer.name}`, 'success');
        }



        
        // Package operations
        function openQuantityModal(product) {
            selectedProduct = product;
            elements.quantityModalTitle.textContent = `${product} - Adet Girin`;
            elements.quantityInput.value = '';
            document.getElementById('quantityError').style.display = 'none';
            elements.quantityModal.style.display = 'flex';
            elements.quantityInput.focus();
        }




        
        function confirmQuantity() {
            const quantity = parseInt(elements.quantityInput.value);
            
            // DoÄŸrulama
            if (!quantity || quantity <= 0) {
                document.getElementById('quantityError').style.display = 'block';
                return;
            }

            // Update quantity badge
            const badge = document.getElementById(`${selectedProduct}-quantity`);
            if (badge) {
                const currentQuantity = parseInt(badge.textContent) || 0;
                badge.textContent = currentQuantity + quantity;
            }

            // Add to current package
            if (!currentPackage.items) currentPackage.items = {};
            currentPackage.items[selectedProduct] = (currentPackage.items[selectedProduct] || 0) + quantity;

            showAlert(`${selectedProduct}: ${quantity} adet eklendi`, 'success');
            closeQuantityModal();
        }



        
        function openManualEntry() {
            document.getElementById('manualModal').style.display = 'flex';
            document.getElementById('manualProduct').focus();
        }




        
        function addManualProduct() {
            const product = document.getElementById('manualProduct').value.trim();
            const quantity = parseInt(document.getElementById('manualQuantity').value);

            // Form doÄŸrulama
            if (!validateForm([
                { id: 'manualProduct', errorId: 'manualProductError', type: 'text', required: true },
                { id: 'manualQuantity', errorId: 'manualQuantityError', type: 'number', required: true }
            ])) {
                return;
            }

            // Add to current package
            if (!currentPackage.items) currentPackage.items = {};
            currentPackage.items[product] = (currentPackage.items[product] || 0) + quantity;

            showAlert(`${product}: ${quantity} adet eklendi`, 'success');
            
            // Clear form
            document.getElementById('manualProduct').value = '';
            document.getElementById('manualQuantity').value = '';
            closeManualModal();
        }



        
        async function completePackage() {
            if (!selectedCustomer) {
                showAlert('Ã–nce mÃ¼ÅŸteri seÃ§in', 'error');
                return;
            }

            if (!currentPackage.items || Object.keys(currentPackage.items).length === 0) {
                showAlert('Pakete Ã¼rÃ¼n ekleyin', 'error');
                return;
            }

            try {
                const packageNo = `PKG-${Date.now()}`;
                const totalQuantity = Object.values(currentPackage.items).reduce((sum, qty) => sum + qty, 0);
                const selectedPersonnel = elements.personnelSelect.value;

                const packageData = {
                    package_no: packageNo,
                    customer_id: selectedCustomer.id,
                    items: currentPackage.items,
                    total_quantity: totalQuantity,
                    status: 'beklemede',
                    packer: selectedPersonnel || currentUser?.name || 'Bilinmeyen',
                    created_at: new Date().toISOString()
                };

                if (!navigator.onLine) {
                    // Ã‡evrimdÄ±ÅŸÄ± mod
                    saveOfflineData('packages', packageData);
                    showAlert(`Paket Ã§evrimdÄ±ÅŸÄ± oluÅŸturuldu: ${packageNo}`, 'warning');
                } else {
                    // Ã‡evrimiÃ§i mod
                    const { data, error } = await supabase
                        .from('packages')
                        .insert([packageData])
                        .select();

                    if (error) {
                        console.error('Error creating package:', error);
                        showAlert('Paket oluÅŸturulurken hata: ' + error.message, 'error');
                        return;
                    }

                    showAlert(`Paket oluÅŸturuldu: ${packageNo}`, 'success');
                }

                // Reset current package and quantities
                currentPackage = {};
                document.querySelectorAll('.quantity-badge').forEach(badge => {
                    badge.textContent = '0';
                });
                
                // Taranan barkodlarÄ± iÅŸlendi olarak iÅŸaretle
                if (scannedBarcodes.length > 0 && navigator.onLine) {
                    const barcodeIds = scannedBarcodes.filter(b => b.id && !b.id.startsWith('offline-')).map(b => b.id);
                    if (barcodeIds.length > 0) {
                        await supabase
                            .from('barcodes')
                            .update({ processed: true })
                            .in('id', barcodeIds);
                    }
                    scannedBarcodes = [];
                    displayScannedBarcodes();
                }
                
                // Refresh packages table
                await populatePackagesTable();
                
            } catch (error) {
                console.error('Error in completePackage:', error);
                showAlert('Paket oluÅŸturma hatasÄ±', 'error');
            }
        }



        
            
      function selectPackage(pkg) {
    // Remove selected class from all rows
    document.querySelectorAll('#packagesTableBody tr').forEach(row => {
        row.classList.remove('selected');
    });
    
    // Add selected class to the clicked row
    const rows = document.querySelectorAll('#packagesTableBody tr');
    for (let i = 0; i < rows.length; i++) {
        const checkbox = rows[i].querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.value === pkg.id) {
            rows[i].classList.add('selected'); // FIXED: removed extra "class."
            break;
        }
    }
    
    const detailContent = document.getElementById('packageDetailContent');
    if (detailContent) {
        detailContent.innerHTML = `
            <h4>Paket: ${pkg.package_no}</h4>
            <p><strong>MÃ¼ÅŸteri:</strong> ${pkg.customers?.name || 'N/A'}</p>
            <p><strong>Toplam Adet:</strong> ${pkg.total_quantity}</p>
            <p><strong>Tarih:</strong> ${new Date(pkg.created_at).toLocaleDateString('tr-TR')}</p>
            <p><strong>Durum:</strong> ${pkg.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</p>
            ${pkg.items ? `
                <h5>ÃœrÃ¼nler:</h5>
                <ul>
                    ${Object.entries(pkg.items).map(([product, quantity]) => 
                        `<li>${escapeHtml(product)}: ${quantity} adet</li>`
                    ).join('')}
                </ul>
            ` : ''}
        `;
    }
}



        

        // This function needs to be a global function



        
        
function getSelectedPackage() {
    const selectedRow = document.querySelector('#packagesTableBody tr.selected');
    if (!selectedRow) return null;
    
    const packageId = selectedRow.querySelector('input[type="checkbox"]').value;
    
    return {
        id: packageId,
        package_no: selectedRow.cells[1].textContent,
        customers: { name: selectedRow.cells[2].textContent },
        total_quantity: selectedRow.cells[3].textContent.trim(), // now as text
        created_at: selectedRow.cells[4].textContent
    };
}



        
let printer = null;

class PrinterService {
    constructor(serverUrl = 'http://localhost:3001') {
        this.serverUrl = serverUrl;
        this.isConnected = false;
        console.log('ðŸ–¨ï¸ Initializing printer service...');
        this.checkConnection();
    }

    // Check if printer server is alive
    async checkConnection() {
        try {
            const response = await fetch(`${this.serverUrl}/api/test`);
            const data = await response.json();
            if (response.ok) {
                this.isConnected = true;
                this.updateStatus('connected', 'âœ… Printer server connected');
                console.log('âœ… Printer server connected:', data);
            } else {
                this.isConnected = false;
                this.updateStatus('error', 'âŒ Server responded with error');
            }
        } catch (error) {
            this.isConnected = false;
            this.updateStatus('error', 'âŒ Printer server not found');
            console.error('âŒ Printer server error:', error);
        }
    }

    // Update UI indicator
    updateStatus(status, message) {
        const indicator = document.getElementById('printer-indicator');
        const text = document.getElementById('printer-text');
        if (indicator) indicator.textContent = status === 'connected' ? 'ðŸŸ¢' : 'ðŸ”´';
        if (text) text.textContent = message;
        console.log(`Printer status: ${status} - ${message}`);
    }

    // Show alerts on the page
    showAlert(message, type = 'info', duration = 5000) {
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 10000;
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            max-width: 400px;
            background: ${type === 'success' ? '#2ecc71' : type === 'error' ? '#e74c3c' : '#3498db'};
        `;
        alertDiv.textContent = message;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), duration);
    }

    // Test print
    async testPrint() {
        console.log('ðŸ§ª Test print...');
        const result = await this.printBarcode('TEST123456', 'Test Label ' + new Date().toLocaleTimeString());
        if (result) this.showAlert('âœ… Test print successful!', 'success');
        else this.showAlert('âŒ Test print failed!', 'error');
        return result;
    }

    // Print barcode + text
    async printBarcode(barcode, text = '') {
        if (!this.isConnected) {
            console.error('âŒ Printer not connected');
            this.showAlert('Printer server is not connected. Please check Node.js server.', 'error');
            return false;
        }

        try {
            const response = await fetch(`${this.serverUrl}/api/print/barcode`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ barcode, text, copies: 1 })
            });

            const result = await response.json();

            if (result.success) {
                console.log(`âœ… Print successful: ${barcode}`);
                return true;
            } else {
                console.error(`âŒ Print failed: ${result.error}`);
                this.showAlert(`âŒ Print failed: ${result.error}`, 'error');
                return false;
            }
        } catch (error) {
            console.error('âŒ Print error:', error);
            this.showAlert(`âŒ Print error: ${error.message}`, 'error');
            return false;
        }
    }
}

// Generate barcode SVG
function generateBarcode(text) {
    try {
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        JsBarcode(svg, text, { format: "CODE128", lineColor: "#000", width: 2, height: 40, displayValue: true });
        return svg.outerHTML;
    } catch (error) {
        console.error('Barkod oluÅŸturma hatasÄ±:', error);
        return `<div style="color:red; border:1px solid red; padding:5px;">Barkod oluÅŸturulamadÄ±: ${text}</div>`;
    }
}

// Get selected package from table
function getSelectedPackage(row) {
    return {
        package_no: row.cells[1].textContent.trim(),
        customer_name: row.cells[2].textContent.trim(),
        product: row.cells[3].textContent.trim(),
        created_at: row.cells[4].textContent.trim()
    };
}

// Print all selected labels
async function printAllLabels() {
    const checkboxes = document.querySelectorAll('#packagesTableBody input[type="checkbox"]:checked');
    if (!checkboxes.length) return printer.showAlert('Etiket yazdÄ±rmak iÃ§in en az bir paket seÃ§in', 'error');
    if (!printer.isConnected) return printer.showAlert('YazÄ±cÄ± servisi baÄŸlÄ± deÄŸil.', 'error');

    printer.showAlert(`${checkboxes.length} paket etiketi yazdÄ±rÄ±lÄ±yor...`, 'info', 5000);

    let successCount = 0;
    let errorCount = 0;

    for (let i = 0; i < checkboxes.length; i++) {
        const row = checkboxes[i].closest('tr');
        if (!row) { errorCount++; continue; }

        const pkg = getSelectedPackage(row);
        const labelText = `${pkg.customer_name} - ${pkg.product}`;
        const barcode = pkg.package_no;

        const result = await printer.printBarcode(barcode, labelText);
        if (result) successCount++; else errorCount++;

        // 1-second delay between prints
        if (i < checkboxes.length - 1) await new Promise(res => setTimeout(res, 1000));
    }

    if (successCount > 0 && errorCount === 0) printer.showAlert(`âœ… ${successCount} etiket baÅŸarÄ±yla yazdÄ±rÄ±ldÄ±!`, 'success');
    else if (successCount > 0 && errorCount > 0) printer.showAlert(`âš ï¸ ${successCount} etiket yazdÄ±rÄ±ldÄ±, ${errorCount} hata oluÅŸtu.`, 'warning');
    else printer.showAlert(`âŒ HiÃ§bir etiket yazdÄ±rÄ±lamadÄ±. ${errorCount} hata oluÅŸtu.`, 'error');

    console.log(`Print job completed: ${successCount} success, ${errorCount} errors`);
}

// Initialize printer service on page load
document.addEventListener('DOMContentLoaded', () => {
    printer = new PrinterService();

    setTimeout(() => {
        if (printer.isConnected) console.log('âœ… Printer service ready');
        else console.log('âš ï¸ Printer service not connected - check Node.js server');
    }, 2000);

    // Attach buttons
    const generateBtn = document.getElementById('generateBtn');
    const testPrintBtn = document.getElementById('testPrintBtn');
    const printBtn = document.getElementById('printBtn');

    if (generateBtn) generateBtn.addEventListener('click', () => {
        const row = document.querySelector('#packagesTableBody tr.selected');
        if (row) row.cells[1].innerHTML = generateBarcode(row.cells[1].textContent.trim());
    });
    if (testPrintBtn) testPrintBtn.addEventListener('click', () => printer.testPrint());
    if (printBtn) printBtn.addEventListener('click', printAllLabels);
});


        
        
        async function deleteSelectedPackages() {
            const checkboxes = document.querySelectorAll('#packagesTableBody input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                showAlert('Silinecek paket seÃ§in', 'error');
                return;
            }

            if (!confirm(`${checkboxes.length} paketi silmek istediÄŸinize emin misiniz?`)) return;

            try {
                const packageIds = Array.from(checkboxes).map(cb => cb.value);
                
                const { error } = await supabase
                    .from('packages')
                    .delete()
                    .in('id', packageIds);

                if (error) {
                    console.error('Error deleting packages:', error);
                    showAlert('Paketler silinirken hata: ' + error.message, 'error');
                    return;
                }

                showAlert(`${packageIds.length} paket silindi`, 'success');
                await populatePackagesTable();
                
            } catch (error) {
                console.error('Error in deleteSelectedPackages:', error);
                showAlert('Paket silme hatasÄ±', 'error');
            }
        }



        
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('#packagesTableBody input[type="checkbox"]');
            const selectAll = document.getElementById('selectAllPackages').checked;
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
        }


        

        function updatePackageSelection() {
            const checkboxes = document.querySelectorAll('#packagesTableBody input[type="checkbox"]');
            const checkedBoxes = document.querySelectorAll('#packagesTableBody input[type="checkbox"]:checked');
            
            document.getElementById('selectAllPackages').checked = checkboxes.length > 0 && checkboxes.length === checkedBoxes.length;
        }




        
        // Shipping operations
        async function sendToRamp(containerNo = null) {
            try {
                const selectedPackages = Array.from(document.querySelectorAll('#packagesTableBody input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
                
                if (selectedPackages.length === 0) {
                    showAlert('Rampaya gÃ¶ndermek iÃ§in paket seÃ§in', 'error');
                    return;
                }

                // Use existing container or create a new one
                let containerId;
                if (containerNo && currentContainer) {
                    containerId = currentContainer;
                } else {
                    const timestamp = new Date().getTime();
                    containerNo = `CONT-${timestamp.toString().slice(-6)}`;
                    
                    const { data: newContainer, error } = await supabase
                        .from('containers')
                        .insert([{
                            container_no: containerNo,
                            customer: selectedCustomer?.name || '',
                            package_count: selectedPackages.length,
                            total_quantity: await calculateTotalQuantity(selectedPackages),
                            status: 'beklemede',
                            created_at: new Date().toISOString()
                        }])
                        .select();

                    if (error) throw error;
                    
                    containerId = newContainer[0].id;
                    currentContainer = containerNo;
                    elements.containerNumber.textContent = containerNo;
                    saveAppState();
                }

                // Update packages with container reference
                const { error: updateError } = await supabase
                    .from('packages')
                    .update({ 
                        container_id: containerId,
                        status: 'sevk-edildi'
                    })
                    .in('id', selectedPackages);

                if (updateError) throw updateError;

                showAlert(`${selectedPackages.length} paket konteynere eklendi: ${containerNo}`, 'success');
                
                // Refresh tables
                await populatePackagesTable();
                await populateShippingTable();
                
            } catch (error) {
                console.error('Error sending to ramp:', error);
                showAlert('Paketler konteynere eklenirken hata oluÅŸtu: ' + error.message, 'error');
            }
        }



        
        async function shipContainer(containerNo) {
            try {
                // First get the container ID
                const { data: container, error: fetchError } = await supabase
                    .from('containers')
                    .select('id')
                    .eq('container_no', containerNo)
                    .single();

                if (fetchError) throw fetchError;

                // Update container status
                const { error: updateError } = await supabase
                    .from('containers')
                    .update({ status: 'sevk-edildi' })
                    .eq('id', container.id);

                if (updateError) throw updateError;

                showAlert(`Konteyner ${containerNo} sevk edildi`, 'success');
                await populateShippingTable();
                
            } catch (error) {
                console.error('Error shipping container:', error);
                showAlert('Konteyner sevk edilirken hata oluÅŸtu: ' + error.message, 'error');
            }
        }


        

        function filterShipping() {
            populateShippingTable();
        }



        
        // Stock operations
function searchStock() {
    if (!elements.stockSearch) {
        console.error('Stock search input not found');
        return;
    }
    
    if (!elements.stockTableBody) {
        console.error('Stock table body not found');
        return;
    }
    
    const searchTerm = elements.stockSearch.value.toLowerCase();
    const rows = elements.stockTableBody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}




        
        function clearStockSearch() {
            elements.stockSearch.value = '';
            const rows = elements.stockTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }


        

        // Stok ÅŸablonu indirme
        function downloadTemplate() {
            // Create sample data for template
            const templateData = [
                { 'Stok Kodu': 'Ã–RN001', 'ÃœrÃ¼n AdÄ±': 'Ã–rnek ÃœrÃ¼n', 'Mevcut Adet': 10, 'Birim': 'Adet' }
            ];
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(templateData);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Stok Åžablonu');
            
            // Download
            XLSX.writeFile(wb, 'stok_sablonu.xlsx');
            showAlert('Stok ÅŸablonu indirildi', 'success');
        }




        
        // StoklarÄ± dÄ±ÅŸa aktarma
        function exportStock() {
            try {
                const stockData = [];
                const rows = elements.stockTableBody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    if (row.style.display !== 'none') {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 6) {
                            stockData.push({
                                'Stok Kodu': cells[0].textContent,
                                'ÃœrÃ¼n AdÄ±': cells[1].textContent,
                                'Mevcut Adet': cells[2].textContent,
                                'Birim': cells[3].textContent,
                                'Durum': cells[4].textContent,
                                'Son GÃ¼ncelleme': cells[5].textContent
                            });
                        }
                    }
                });
                
                if (stockData.length === 0) {
                    showAlert('DÄ±ÅŸa aktarÄ±lacak stok verisi yok', 'warning');
                    return;
                }
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(stockData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Stok Listesi');
                
                // Download
                const date = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(wb, `stok_listesi_${date}.xlsx`);
                showAlert('Stok listesi dÄ±ÅŸa aktarÄ±ldÄ±', 'success');
                
            } catch (error) {
                console.error('Error exporting stock:', error);
                showAlert('Stok listesi dÄ±ÅŸa aktarÄ±lÄ±rken hata oluÅŸtu', 'error');
            }
        }



        
        async function uploadStockFile() {
            const fileInput = document.getElementById('stockFileUpload');
            const file = fileInput.files[0];
            if (!file) {
                showAlert('LÃ¼tfen bir dosya seÃ§in', 'error');
                return;
            }

            // Dosya tipi doÄŸrulama
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!['xlsx', 'xls', 'csv'].includes(fileExtension)) {
                document.getElementById('fileError').textContent = 'Sadece Excel v CSV dosyalarÄ± yÃ¼kleyebilirsiniz';
                document.getElementById('fileError').style.display = 'block';
                return;
            }

            showAlert('Dosya yÃ¼kleniyor...', 'warning');

            try {
                let stockData = [];
                
                if (fileExtension === 'csv') {
                    const text = await file.text();
                    stockData = Papa.parse(text, { header: true }).data;
                } else {
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    stockData = XLSX.utils.sheet_to_json(worksheet);
                }

                let successCount = 0;
                let errorCount = 0;
                
                for (const item of stockData) {
                    const code = item['Stok Kodu'] || item['code'] || item['StokKodu'] || '';
                    const name = item['ÃœrÃ¼n AdÄ±'] || item['name'] || item['ÃœrÃ¼nAdÄ±'] || item['product'] || '';
                    const quantity = parseInt(item['Mevcut Adet'] || item['quantity'] || item['MevcutAdet'] || 0);
                    const unit = item['Birim'] || item['unit'] || 'Adet';
                    
                    if (!code || !name) {
                        errorCount++;
                        continue;
                    }

                    try {
                        const { error } = await supabase
                            .from('stock_items')
                            .upsert({
                                code: code,
                                name: name,
                                quantity: quantity,
                                unit: unit,
                                updated_at: new Date().toISOString()
                            }, { onConflict: 'code' });

                        if (error) {
                            errorCount++;
                        } else {
                            successCount++;
                        }
                    } catch (e) {
                        errorCount++;
                    }
                }

                showAlert(`${successCount} stok Ã¶ÄŸesi gÃ¼ncellendi, ${errorCount} hata`, successCount > 0 ? 'success' : 'error');
                document.getElementById('selectedFileName').textContent = '';
                fileInput.value = '';
                
                await populateStockTable();
                
            } catch (error) {
                console.error('Error uploading stock file:', error);
                showAlert('Dosya yÃ¼klenirken hata oluÅŸtu', 'error');
            }
        }




        
        // Report operations
async function generateDailyReport() {
    try {
        showAlert('GÃ¼nlÃ¼k rapor oluÅŸturuluyor...', 'info');

        // Fetch the authenticated user first
const { data: { user }, error: userError } = await supabase.auth.getUser();
if (userError) throw new Error(`User fetch error: ${userError.message}`);
if (!user) throw new Error('User not authenticated');
        
        const today = new Date();
        const startOfDay = new Date(today.setHours(0, 0, 0, 0)).toISOString();
        const endOfDay = new Date(today.setHours(23, 59, 59, 999)).toISOString();

        // Fetch data for the report
        const [
            { data: packages, error: packagesError },
            { data: containers, error: containersError },
            { data: criticalStock, error: stockError }
        ] = await Promise.all([
            supabase
                .from('packages')
                .select('*, customers (name, code)')
                .gte('created_at', startOfDay)
                .lte('created_at', endOfDay),
            supabase
                .from('containers')
                .select('*')
                .gte('created_at', startOfDay)
                .lte('created_at', endOfDay),
            supabase
                .from('stock_items')
                .select('*')
                .lte('quantity', 5)
                .order('quantity', { ascending: true })
        ]);

        // Handle errors
        if (packagesError) throw new Error(`Paket verileri alÄ±namadÄ±: ${packagesError.message}`);
        if (containersError) throw new Error(`Konteyner verileri alÄ±namadÄ±: ${containersError.message}`);
        if (stockError) throw new Error(`Stok verileri alÄ±namadÄ±: ${stockError.message}`);

        // Prepare report data
        currentReportData = {
            date: new Date().toLocaleDateString('tr-TR'),
            totalPackages: packages.length,
            totalItems: packages.reduce((sum, pkg) => sum + pkg.total_quantity, 0),
            containers: containers.length,
            customers: [...new Set(packages.map(p => p.customers?.name))].length,
            packages: packages,
            containers: containers,
            criticalStock: criticalStock,
            operator: user.user_metadata?.full_name || 'Bilinmiyor',
            user_id: user.id
            };

        // Save report to database
       const { data: report, error: reportError } = await supabase
    .from('reports')
    .insert([{
        report_date: new Date(),
        report_type: 'daily',
        data: currentReportData,
        user_id: user.id
    }])
    .select()
    .single();


        if (reportError) throw new Error(`Rapor kaydedilemedi: ${reportError.message}`);

        currentReportData.id = report.id;
        
        showAlert('GÃ¼nlÃ¼k rapor baÅŸarÄ±yla oluÅŸturuldu', 'success');
        
        // Show email modal with customer email if available
        document.getElementById('reportEmail').value = selectedCustomer?.email || '';
        document.getElementById('emailModal').style.display = 'flex';

    } catch (error) {
        console.error('Rapor oluÅŸturma hatasÄ±:', error);
        showAlert(`Rapor oluÅŸturulamadÄ±: ${error.message}`, 'error');
    }
}




        
function closeEmailModal() {
    const modal = document.getElementById('emailModal');
    if (modal) {
        modal.style.display = 'none';
    } else {
        console.warn('Email modal not found');
    }
}




        
// PDF Generation Function - Fixed version
async function generatePDFReport(reportData) {
    return new Promise((resolve, reject) => {
        try {
            // Use jsPDF with autotable plugin
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set default font
            doc.setFont("helvetica");
            
            // Title
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            const title = 'ProClean - GÃ¼nlÃ¼k Ä°ÅŸ Sonu Raporu';
            const pageWidth = doc.internal.pageSize.getWidth();
            const titleWidth = doc.getTextWidth(title);
            doc.text(title, (pageWidth - titleWidth) / 2, 20);
            
            // Report details
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Tarih: ${reportData.date}`, 20, 35);
            doc.text(`OperatÃ¶r: ${reportData.operator}`, 20, 42);
            doc.text(`Rapor ID: ${reportData.id || 'Yerel KayÄ±t'}`, 20, 49);
            
            // Summary section
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Ã–ZET', 20, 65);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`â€¢ Toplam Paket SayÄ±sÄ±: ${reportData.totalPackages}`, 30, 75);
            doc.text(`â€¢ Toplam ÃœrÃ¼n Adedi: ${reportData.totalItems}`, 30, 82);
            doc.text(`â€¢ Konteyner SayÄ±sÄ±: ${reportData.containers || 0}`, 30, 89);
            doc.text(`â€¢ MÃ¼ÅŸteri SayÄ±sÄ±: ${reportData.customers || 0}`, 30, 96);
            doc.text(`â€¢ Kritik Stok SayÄ±sÄ±: ${reportData.criticalStock?.length || 0}`, 30, 103);
            
            let currentY = 115;
            
            // Critical stock table if exists
            if (reportData.criticalStock && reportData.criticalStock.length > 0) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('KRÄ°TÄ°K STOKLAR', 20, currentY);
                currentY += 10;
                
                const criticalStockData = reportData.criticalStock.map(item => [
                    item.code || 'N/A',
                    item.name || 'N/A',
                    item.quantity?.toString() || '0'
                ]);
                
                doc.autoTable({
                    startY: currentY,
                    head: [['Stok Kodu', 'ÃœrÃ¼n AdÄ±', 'Mevcut Adet']],
                    body: criticalStockData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [231, 76, 60],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    styles: {
                        fontSize: 9,
                        cellPadding: 3
                    }
                });
                
                currentY = doc.lastAutoTable.finalY + 15;
            }
            
            // Package details table
            if (reportData.packages && reportData.packages.length > 0) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('PAKET DETAYLARI', 20, currentY);
                currentY += 10;
                
                const packageData = reportData.packages.map(pkg => [
                    pkg.package_no || 'N/A',
                    pkg.customers?.name || 'N/A',
                    pkg.total_quantity?.toString() || '0',
                    pkg.created_at ? new Date(pkg.created_at).toLocaleDateString('tr-TR') : 'N/A',
                    pkg.packer || 'Bilinmiyor'
                ]);
                
                doc.autoTable({
                    startY: currentY,
                    head: [['Paket No', 'MÃ¼ÅŸteri', 'Adet', 'Tarih', 'Paketleyen']],
                    body: packageData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [52, 152, 219],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2
                    },
                    margin: { top: 10 },
                    pageBreak: 'auto'
                });
                
                currentY = doc.lastAutoTable.finalY + 15;
            }
            
            // Container details table if exists
            if (reportData.containers && reportData.containers.length > 0) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('KONTEYNER DETAYLARI', 20, currentY);
                currentY += 10;
                
                const containerData = reportData.containers.map(container => [
                    container.container_no || 'N/A',
                    container.customer || 'N/A',
                    container.package_count?.toString() || '0',
                    container.total_quantity?.toString() || '0',
                    container.created_at ? new Date(container.created_at).toLocaleDateString('tr-TR') : 'N/A'
                ]);
                
                doc.autoTable({
                    startY: currentY,
                    head: [['Konteyner No', 'MÃ¼ÅŸteri', 'Paket SayÄ±sÄ±', 'Toplam Adet', 'OluÅŸturulma Tarihi']],
                    body: containerData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [46, 204, 113],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2
                    },
                    margin: { top: 10 }
                });
                
                currentY = doc.lastAutoTable.finalY + 15;
            }
            
            // Footer on each page
            const addFooter = (doc) => {
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'italic');
                    doc.text(`Sayfa ${i} / ${pageCount}`, pageWidth / 2, doc.internal.pageSize.height - 10, { align: 'center' });
                    doc.text(`OluÅŸturulma: ${new Date().toLocaleString('tr-TR')}`, pageWidth - 20, doc.internal.pageSize.height - 10, { align: 'right' });
                }
            };
            
            // Add footer to all pages
            addFooter(doc);
            
            // Generate PDF blob
            const pdfBlob = doc.output('blob');
            resolve(pdfBlob);
            
        } catch (error) {
            console.error('PDF oluÅŸturma hatasÄ±:', error);
            reject(new Error(`PDF oluÅŸturulamadÄ±: ${error.message}`));
        }
    });
}



        

// Alternatif basit PDF oluÅŸturma fonksiyonu (yedek)
async function generateSimplePDFReport(reportData) {
    return new Promise((resolve, reject) => {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Basit baÅŸlÄ±k
            doc.setFontSize(16);
            doc.text('ProClean - GÃ¼nlÃ¼k Rapor', 20, 20);
            
            // Tarih ve operatÃ¶r
            doc.setFontSize(12);
            doc.text(`Tarih: ${reportData.date}`, 20, 35);
            doc.text(`OperatÃ¶r: ${reportData.operator}`, 20, 45);
            
            // Ã–zet bilgiler
            doc.text('Ã–ZET:', 20, 60);
            doc.text(`â€¢ Toplam Paket: ${reportData.totalPackages}`, 30, 70);
            doc.text(`â€¢ Toplam ÃœrÃ¼n: ${reportData.totalItems}`, 30, 80);
            doc.text(`â€¢ MÃ¼ÅŸteri SayÄ±sÄ±: ${reportData.customers || 0}`, 30, 90);
            
            // PDF'i blob olarak dÃ¶ndÃ¼r
            const pdfBlob = doc.output('blob');
            resolve(pdfBlob);
            
        } catch (error) {
            reject(new Error('Basit PDF oluÅŸturulamadÄ±'));
        }
    });
}



        
// YardÄ±mcÄ± fonksiyon: jsPDF versiyon kontrolÃ¼
function checkJsPdfVersion() {
    if (typeof window.jspdf === 'undefined') {
        console.error('jsPDF kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ');
        showAlert('PDF oluÅŸturma kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ', 'error');
        return false;
    }
    
    // jsPDF versiyon bilgisini kontrol et
    console.log('jsPDF versiyonu:', window.jspdf.jsPDF?.version || 'Bilinmiyor');
    return true;
}




        
// PDF oluÅŸturmadan Ã¶nce versiyon kontrolÃ¼ yap
async function generatePDFReportSafe(reportData) {
    if (!checkJsPdfVersion()) {
        throw new Error('PDF kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ');
    }
    
    return await generatePDFReport(reportData);
}



        
// Storage bucket kontrolÃ¼ ve oluÅŸturma fonksiyonu
async function setupStorageBucket() {
    try {
        // Storage bucket var mÄ± kontrol et
        const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();
        
        if (bucketsError) {
            console.warn('Bucket listeleme hatasÄ±:', bucketsError);
            return false;
        }
        
        const reportsBucketExists = buckets.some(bucket => bucket.name === 'reports');
        
        if (!reportsBucketExists) {
            console.log('Reports bucket bulunamadÄ±, oluÅŸturuluyor...');
            // Bucket oluÅŸturmaya Ã§alÄ±ÅŸ (admin yetkisi gerektirir)
            try {
                const { data: newBucket, error: createError } = await supabase.storage.createBucket('reports', {
                    public: true,
                    fileSizeLimit: 5242880, // 5MB
                    allowedMimeTypes: ['application/pdf']
                });
                
                if (createError) {
                    console.warn('Bucket oluÅŸturulamadÄ±:', createError);
                    return false;
                }
                
                console.log('Reports bucket oluÅŸturuldu:', newBucket);
                return true;
            } catch (createError) {
                console.warn('Bucket oluÅŸturma hatasÄ±:', createError);
                return false;
            }
        }
        
        return true;
    } catch (error) {
        console.warn('Storage setup hatasÄ±:', error);
        return false;
    }
}




        
// GÃ¼ncellenmiÅŸ upload fonksiyonu
async function uploadReportToStorage(pdfBlob, reportData) {
    try {
        // Ã–nce storage bucket'Ä± kontrol et
        const storageReady = await setupStorageBucket();
        if (!storageReady) {
            throw new Error('Storage bucket hazÄ±r deÄŸil');
        }
        
        const fileName = `report-${reportData.id || Date.now()}.pdf`;
        
        // PDF'i yÃ¼kle
        const { data, error } = await supabase.storage
            .from('reports')
            .upload(fileName, pdfBlob, {
                contentType: 'application/pdf',
                upsert: true,
                cacheControl: '3600'
            });
            
        if (error) {
            console.error('Storage upload error:', error);
            throw new Error(`Dosya yÃ¼klenemedi: ${error.message}`);
        }
        
        // Public URL al
        const { data: { publicUrl } } = supabase.storage
            .from('reports')
            .getPublicUrl(fileName);
            
        console.log('PDF baÅŸarÄ±yla yÃ¼klendi:', publicUrl);
        return publicUrl;
        
    } catch (error) {
        console.error('PDF upload error:', error);
        throw new Error('PDF depolama alanÄ±na yÃ¼klenemedi');
    }
}




        
// EmailJS yapÄ±landÄ±rma kontrolÃ¼
function checkEmailJSConfig() {
    if (typeof emailjs === 'undefined') {
        throw new Error('EmailJS kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ');
    }
    
    // Basit bir EmailJS init kontrolÃ¼
    try {
        emailjs.init("jH-KlJ2ffs_lGwfsp"); // Buraya gerÃ§ek EmailJS ID'nizi ekleyin
        return true;
    } catch (error) {
        console.warn('EmailJS init hatasÄ±:', error);
        return false;
    }
}




        
// Alternatif e-posta gÃ¶nderim fonksiyonu (EmailJS yoksa)
async function sendEmailFallback(email, subject, body, pdfBlob = null) {
    // Basit bir mailto: linki oluÅŸtur
    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    
    // Yeni pencere aÃ§
    const mailWindow = window.open(mailtoLink, '_blank');
    
    if (mailWindow) {
        return { success: true, message: 'E-posta istemcisi aÃ§Ä±ldÄ±' };
    } else {
        return { success: false, error: 'E-posta istemcisi aÃ§Ä±lamadÄ±' };
    }
}




        
// GÃ¼ncellenmiÅŸ e-posta gÃ¶nderim fonksiyonu
async function sendReportEmail(email, templateParams, pdfBlob = null) {
    try {
        // EmailJS yapÄ±landÄ±rmasÄ±nÄ± kontrol et
        const emailjsReady = checkEmailJSConfig();
        
        if (!emailjsReady) {
            console.warn('EmailJS hazÄ±r deÄŸil, fallback kullanÄ±lÄ±yor');
            
            // Fallback e-posta gÃ¶nderimi
            const subject = `ProClean Raporu - ${templateParams.report_date}`;
            const body = `
                ProClean GÃ¼nlÃ¼k Raporu
                ----------------------
                Tarih: ${templateParams.report_date}
                OperatÃ¶r: ${templateParams.operator_name}
                Toplam Paket: ${templateParams.total_packages}
                Toplam ÃœrÃ¼n: ${templateParams.total_items}
                Kritik Stok: ${templateParams.critical_stock_count}
                
                Rapor PDF'i e-posta ekinde gÃ¶nderilmiÅŸtir.
            `;
            
            return await sendEmailFallback(email, subject, body, pdfBlob);
        }
        
        // EmailJS ile gÃ¶nder
        return new Promise((resolve) => {
            // EÄŸer PDF blob'u varsa, base64'e Ã§evir
            if (pdfBlob) {
                const reader = new FileReader();
                reader.readAsDataURL(pdfBlob);
                reader.onload = function() {
                    templateParams.pdf_attachment = reader.result;
                    templateParams.pdf_name = `proclean-report-${templateParams.report_date}.pdf`;
                    
                    emailjs.send('service_4rt2w5g', 'template_16f4gyy', templateParams)
                        .then(response => resolve({ success: true, response }))
                        .catch(error => resolve({ success: false, error: error.text }));
                };
            } else {
                // URL varsa doÄŸrudan gÃ¶nder
                emailjs.send('service_4rt2w5g', 'template_16f4gyy', templateParams)
                    .then(response => resolve({ success: true, response }))
                    .catch(error => resolve({ success: false, error: error.text }));
            }
        });
        
    } catch (error) {
        console.error('E-posta gÃ¶nderim hatasÄ±:', error);
        return { success: false, error: error.message };
    }
}




        
// GÃ¼ncellenmiÅŸ sendDailyReport fonksiyonu
async function sendDailyReport() {
    const emailInput = document.getElementById('reportEmail');
    if (!emailInput) {
        showAlert('E-posta alanÄ± bulunamadÄ±', 'error');
        return;
    }
    
    const email = emailInput.value;
    console.log('AlÄ±nan e-posta adresi:', email);
    
    // Form validation
    if (!validateForm([
        { id: 'reportEmail', errorId: 'reportEmailError', type: 'email', required: true }
    ])) {
        return;
    }

    try {
        if (!currentReportData) {
            showAlert('Ã–nce rapor oluÅŸturmalÄ±sÄ±nÄ±z', 'error');
            return;
        }

        showAlert('Rapor hazÄ±rlanÄ±yor...', 'info');
        
        let pdfBlob;
        
        // PDF oluÅŸtur - with proper error handling
        try {
            if (typeof generatePDFReportSafe === 'function') {
                pdfBlob = await generatePDFReportSafe(currentReportData);
            } else {
                throw new Error('PDF generation function not available');
            }
        } catch (pdfError) {
            console.warn('PDF oluÅŸturma baÅŸarÄ±sÄ±z:', pdfError);
            throw new Error('Rapor PDF\'i oluÅŸturulamadÄ±');
        }

        let pdfUrl = null;
        
        // Ã–nce storage'a yÃ¼klemeyi dene
        try {
            pdfUrl = await uploadReportToStorage(pdfBlob, currentReportData);
            showAlert('Rapor buluta yÃ¼klendi, e-posta hazÄ±rlanÄ±yor...', 'success');
        } catch (uploadError) {
            console.warn('Storage yÃ¼kleme baÅŸarÄ±sÄ±z, direkt e-posta eki kullanÄ±lacak:', uploadError);
            // Storage yÃ¼kleme baÅŸarÄ±sÄ±z olursa, direkt e-posta eki kullan
        }

        // E-posta parametrelerini hazÄ±rla
        const templateParams = {
            to_email: email,
            to_name: selectedCustomer?.name || 'MÃ¼ÅŸteri',
            report_date: currentReportData.date,
            total_packages: currentReportData.totalPackages,
            total_items: currentReportData.totalItems,
            operator_name: currentReportData.operator,
            critical_stock_count: currentReportData.criticalStock ? currentReportData.criticalStock.length : 0,
            report_id: currentReportData.id || 'N/A',
            report_url: pdfUrl || 'PDF eklenti olarak gÃ¶nderildi',
            company_name: 'ProClean Ã‡amaÅŸÄ±rhane'
        };

        // E-posta gÃ¶nder
        showAlert('E-posta gÃ¶nderiliyor...', 'info');
        const emailResult = await sendReportEmail(email, templateParams, pdfUrl ? null : pdfBlob);
        
        if (emailResult.success) {
            // VeritabanÄ±na kaydetmeyi dene
            try {
                await supabase
                    .from('report_emails')
                    .insert([{
                        report_id: currentReportData.id,
                        sent_to: email,
                        sent_at: new Date().toISOString(),
                        status: 'sent',
                        pdf_url: pdfUrl,
                        delivery_method: pdfUrl ? 'link' : 'attachment'
                    }]);
            } catch (dbError) {
                console.warn('E-posta kaydÄ± veritabanÄ±na eklenemedi:', dbError);
            }
            
            showAlert(`Rapor ${email} adresine baÅŸarÄ±yla gÃ¶nderildi`, 'success');
            
            // BaÅŸarÄ±lÄ± gÃ¶nderimden sonra modalÄ± kapat
            setTimeout(() => {
                closeEmailModal();
            }, 2000);
            
        } else {
            // E-posta gÃ¶nderimi baÅŸarÄ±sÄ±z olursa kullanÄ±cÄ±ya alternatif sun
            const shouldDownload = confirm('E-posta gÃ¶nderilemedi. Raporu bilgisayarÄ±nÄ±za indirmek ister misiniz?');
            
            if (shouldDownload) {
                // PDF'i indir
                const pdfUrl = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = pdfUrl;
                a.download = `proclean-rapor-${currentReportData.date}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(pdfUrl);
                
                showAlert('Rapor bilgisayarÄ±nÄ±za indirildi', 'success');
            }
            
            throw new Error(`E-posta gÃ¶nderilemedi: ${emailResult.error}`);
        }
        
  } catch (error) {
        console.error('Rapor gÃ¶nderme hatasÄ±:', error);
        showAlert(`Rapor gÃ¶nderilemedi: ${error.message}`, 'error');
    }
}




        
// YardÄ±mcÄ± fonksiyon: EmailJS yapÄ±landÄ±rma modalÄ±
function showEmailJSConfigModal() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); display: flex; justify-content: center;
        align-items: center; z-index: 10000;
    `;
    
    modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px;">
            <h3>E-posta GÃ¶nderim AyarlarÄ±</h3>
            <p>E-posta gÃ¶ndermek iÃ§in EmailJS yapÄ±landÄ±rmanÄ±z gerekiyor.</p>
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">EmailJS Service ID:</label>
                <input type="text" id="emailjsServiceId" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">EmailJS Template ID:</label>
                <input type="text" id="emailjsTemplateId" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" style="padding: 8px 16px; background: #ccc; border: none; border-radius: 5px;">Ä°ptal</button>
                <button onclick="saveEmailJSConfig()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 5px;">Kaydet</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}




        
// Uygulama baÅŸlangÄ±cÄ±nda storage'Ä± kontrol et
async function initializeApp() {
    try {
        // Storage bucket'Ä± kontrol et ve gerekirse oluÅŸtur
        await setupStorageBucket();
        
        // DiÄŸer baÅŸlangÄ±Ã§ iÅŸlemleri...
        console.log('Uygulama baÅŸlatÄ±ldÄ±');
        
    } catch (error) {
        console.warn('BaÅŸlangÄ±Ã§ hatasÄ±:', error);
    }
}

// Uygulama yÃ¼klendiÄŸinde storage'Ä± kontrol et
    document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log('Initializing ProClean application...');
        
        // Initialize elements first
        initializeElementsObject();
        
        // Check critical elements exist before adding listeners
        const loginBtn = elements.loginButton;
        const emailInput = elements.emailInput;
        const passwordInput = elements.passwordInput;
        
        if (loginBtn) {
            loginBtn.addEventListener('click', login);
            console.log('Login button listener added');
        } else {
            console.error('Login button not found - check HTML structure');
            showAlert('GiriÅŸ butonu bulunamadÄ±', 'error');
        }
        
        // Logout button
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', logout);
        }
        
        // Enter key listeners
        if (emailInput) {
            emailInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    login();
                }
            });
        }
        
        if (passwordInput) {
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    login();
                }
            });
        }
        
        // Quantity modal enter key
        if (elements.quantityInput) {
            elements.quantityInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmQuantity();
                }
            });
        }
        
        // Customer select change listener
        if (elements.customerSelect) {
            elements.customerSelect.addEventListener('change', function() {
                const customerId = this.value;
                if (customerId) {
                    const selectedOption = this.options[this.selectedIndex];
                    selectedCustomer = {
                        id: customerId,
                        name: selectedOption.textContent.split(' (')[0],
                        code: selectedOption.textContent.match(/\(([^)]+)\)/)?.[1] || ''
                    };
                    showAlert(`MÃ¼ÅŸteri seÃ§ildi: ${selectedCustomer.name}`, 'success');
                } else {
                    selectedCustomer = null;
                }
            });
        }
        
        // Tab click events
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                if (tabName) {
                    switchTab(tabName);
                }
            });
        });
        
        // API key initialization
        if (loadApiKey()) {
            supabase = initializeSupabase();
            if (supabase) {
                setupAuthListener();
                console.log('Supabase client initialized successfully');
            } else {
                console.warn('Failed to initialize Supabase client');
            }
        } else {
            console.log('No saved API key found, showing API key modal');
            showApiKeyModal();
        }
        
        // Set initial display states
        if (elements.loginScreen) {
            elements.loginScreen.style.display = 'flex';
        }
        if (elements.appContainer) {
            elements.appContainer.style.display = 'none';
        }
        
        console.log('ProClean application initialized successfully');
        
    } catch (error) {
        console.error('Critical error during DOMContentLoaded:', error);
        showAlert('Uygulama baÅŸlatÄ±lÄ±rken kritik hata oluÅŸtu: ' + error.message, 'error');
    }
});



        
        
async function previewReport() {
    if (!currentReportData) {
        showAlert('Ã–nce rapor oluÅŸturmalÄ±sÄ±nÄ±z', 'error');
        return;
    }
    
    try {
        // Generate PDF
        const pdfBlob = await generatePDFReport(currentReportData);
        
        // Create object URL for the PDF
        const pdfUrl = URL.createObjectURL(pdfBlob);
        
        // Open PDF in a new window
        const reportWindow = window.open(pdfUrl, '_blank');
        
        // Clean up the URL when window is closed
        if (reportWindow) {
            reportWindow.onbeforeunload = function() {
                URL.revokeObjectURL(pdfUrl);
            };
        }
    } catch (error) {
        console.error('Rapor Ã¶nizleme hatasÄ±:', error);
        showAlert('Rapor Ã¶nizlenemedi', 'error');
    }
}



        

        // Container operations
        function loadCurrentContainer() {
            showAlert('Mevcut konteyner yÃ¼klendi', 'success');
        }

        async function createNewContainer() {
            try {
                const timestamp = new Date().getTime();
                const containerNo = `CONT-${timestamp.toString().slice(-6)}`;
                
                const { data: newContainer, error } = await supabase
                    .from('containers')
                    .insert([{
                        container_no: containerNo,
                        customer: '',
                        package_count: 0,
                        total_quantity: 0,
                        status: 'beklemede',
                        package_ids: []
                    }])
                    .select();

                if (error) throw error;

                elements.containerNumber.textContent = containerNo;
                currentContainer = containerNo;
                saveAppState();
                
                showAlert(`Yeni konteyner oluÅŸturuldu: ${containerNo}`, 'success');
                await populateShippingTable();
                
            } catch (error) {
                console.error('Error creating container:', error);
                showAlert('Konteyner oluÅŸturulurken hata oluÅŸtu', 'error');
            }
        }




        

        async function deleteContainer() {
            // SeÃ§ili konteynerleri al
            const selectedContainers = Array.from(document.querySelectorAll('.container-checkbox:checked'))
                .map(cb => cb.value);
                
            if (selectedContainers.length === 0) {
                showAlert('Silinecek konteyner seÃ§in', 'error');
                return;
            }

            if (!confirm(`${selectedContainers.length} konteyneri silmek istediÄŸinize emin misiniz?`)) return;

            try {
                // Ã–nce bu konteynerlere baÄŸlÄ± paketleri gÃ¼ncelle
                const { error: updateError } = await supabase
                    .from('packages')
                    .update({ 
                        container_id: null,
                        status: 'beklemede'
                    })
                    .in('container_id', selectedContainers);

                if (updateError) throw updateError;

                // Sonra konteynerleri sil
                const { error: deleteError } = await supabase
                    .from('containers')
                    .delete()
                    .in('id', selectedContainers);

                if (deleteError) throw deleteError;

                // EÄŸer silinen konteyner aktif konteyner ise sÄ±fÄ±rla
                if (currentContainer && selectedContainers.includes(currentContainer)) {
                    currentContainer = null;
                    elements.containerNumber.textContent = 'Yok';
                    saveAppState();
                }
                
                showAlert(`${selectedContainers.length} konteyner silindi`, 'success');
                await populateShippingTable();
                
            } catch (error) {
                console.error('Error deleting container:', error);
                showAlert('Konteyner silinirken hata oluÅŸtu', 'error');
            }
        }



        

        // Utility functions
        function switchTab(tabName) {
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Deactivate all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activate selected tab
            const selectedTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
            const selectedPane = document.getElementById(`${tabName}Tab`);
            
            if (selectedTab && selectedPane) {
                selectedTab.classList.add('active');
                selectedPane.classList.add('active');
            }
        }



        

        function closeAllModals() {
            document.getElementById('customerModal').style.display = 'none';
            document.getElementById('allCustomersModal').style.display = 'none';
            document.getElementById('emailModal').style.display = 'none';
            document.getElementById('quantityModal').style.display = 'none';
            document.getElementById('manualModal').style.display = 'none';
            document.getElementById('containerDetailModal').style.display = 'none';
        }
        function closeModal() {
            document.getElementById('customerModal').style.display = 'none';
        }
        function closeAllCustomersModal() {
            document.getElementById('allCustomersModal').style.display = 'none';
        }
        function closeQuantityModal() {
            document.getElementById('quantityModal').style.display = 'none';
        }

        function closeManualModal() {
            document.getElementById('manualModal').style.display = 'none';
        }

        function escapeHtml(text) {
    if (typeof text !== 'string') {
        return String(text);
    }
    
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}



        
        // Initialize auth state listener
        function setupAuthListener() {
            if (!supabase) return;
            
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth state change:', event, session?.user?.email || 'No user');
                
                if (session) {
                    currentUser = {
                        email: session.user.email,
                        uid: session.user.id,
                        name: session.user.email.split('@')[0]
                    };
                    
                    document.getElementById('userRole').textContent = `OperatÃ¶r: ${currentUser.name}`;
                    document.getElementById('loginScreen').style.display = "none";
                    document.getElementById('appContainer').style.display = "flex";
                    
                    initApp();
                } else {
                    document.getElementById('loginScreen').style.display = "flex";
                    document.getElementById('appContainer').style.display = "none";
                }
            });
        }




        
        // Load API key from localStorage
        function loadApiKey() {
            const savedApiKey = localStorage.getItem('procleanApiKey');
            if (savedApiKey) {
                SUPABASE_ANON_KEY = savedApiKey;
                return true;
            }
            return false;
        }

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showAlert('Beklenmeyen bir hata oluÅŸtu. LÃ¼tfen sayfayÄ± yenileyin.', 'error');
        });




        
        // API hata yÃ¶netimi
       function handleSupabaseError(error, context) {
    console.error(`Supabase error in ${context}:`, error);
    
    let userMessage = `${context} sÄ±rasÄ±nda bir hata oluÅŸtu.`;
    
    if (error.code === '42501') {
        userMessage = 'Bu iÅŸlem iÃ§in yetkiniz bulunmamaktadÄ±r.';
    } else if (error.code === '42P01') {
        userMessage = 'VeritabanÄ± tablosu bulunamadÄ±. LÃ¼tfen yÃ¶netici ile iletiÅŸime geÃ§in.';
    } else if (error.code === '08006') {
        userMessage = 'VeritabanÄ± baÄŸlantÄ± hatasÄ±. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.';
    } else if (error.message) {
        userMessage += ' ' + error.message;
    }
    
    showAlert(userMessage, 'error');
    
    // Switch to offline mode if connection issue
    if (!navigator.onLine && elements.connectionStatus) {
        elements.connectionStatus.textContent = 'Ã‡evrimdÄ±ÅŸÄ±';
        document.getElementById('offlineIndicator')?.style.setProperty('display', 'block');
    }
}
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // API anahtarÄ±nÄ± yÃ¼kle ve supabase'i baÅŸlat
            if (loadApiKey()) {
                supabase = initializeSupabase();
                if (supabase) {
                    setupAuthListener();
                }
            } else {
                showApiKeyModal();
            }
            
             // Login button event
            document.getElementById('loginBtn').addEventListener('click', login);
            
            // Logout button event
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Enter key for login
            document.getElementById('email').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            // Quantity modal enter key
            if (elements.quantityInput) {
                elements.quantityInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') confirmQuantity();
                });
            }
            
            // Barcode input enter key
            if (elements.barcodeInput) {
                elements.barcodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') processBarcode();
                });
            }
            
            // Tab click events
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Customer select change
            if (elements.customerSelect) {
                elements.customerSelect.addEventListener('change', function() {
                    const customerId = this.value;
                    if (customerId) {
                        // Find customer from populated options
                        const selectedOption = this.options[this.selectedIndex];
                        selectedCustomer = {
                            id: customerId,
                            name: selectedOption.textContent.split(' (')[0],
                            code: selectedOption.textContent.match(/\(([^)]+)\)/)?.[1] || ''
                        };
                        showAlert(`MÃ¼ÅŸteri seÃ§ildi: ${selectedCustomer.name}`, 'success');
                    } else {
                        selectedCustomer = null;
                    }
                });
            }
            
            // Initial state
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';

            console.log('ProClean application initialized with Supabase authentication');
        });
      // Add this section here ðŸ‘‡
    document.getElementById('packagesTableBody').addEventListener('change', function(event) {
        if (event.target.type === 'checkbox') {
            const checkbox = event.target;
            const packageId = checkbox.dataset.packageId;
            if (checkbox.checked) {
                selectedPackageForPrinting = packages.find(pkg => pkg.id === packageId);
            } else {
                selectedPackageForPrinting = null;
            }
        }
    });

class PrinterService {
    constructor() {
        this.serverUrl = 'http://localhost:3001';
        this.isConnected = false;
        console.log('ðŸ–¨ï¸ Initializing printer service...');
        this.checkConnection();
    }
    
    async checkConnection() {
        try {
            const response = await fetch(`${this.serverUrl}/api/test`);
            const data = await response.json();
            if (response.ok) {
                this.isConnected = true;
                this.updateStatus('connected', 'âœ… Printer server connected');
                console.log('âœ… Printer server connected:', data);
            } else {
                this.isConnected = false;
                this.updateStatus('error', 'âŒ Server responded with error');
            }
        } catch (error) {
            this.isConnected = false;
            this.updateStatus('error', 'âŒ Printer server not found');
            console.error('âŒ Printer server error:', error);
        }
    }
    
    updateStatus(status, message) {
        const indicator = document.getElementById('printer-indicator');
        const text = document.getElementById('printer-text');
        if (indicator && text) {
            indicator.textContent = status === 'connected' ? 'ðŸŸ¢' : 'ðŸ”´';
            text.textContent = message;
        }
        console.log(`Printer status: ${status} - ${message}`);
    }

    async testPrint() {
        console.log('ðŸ–¨ï¸ Test print called');
        // implement actual test print logic here
    }
}



        
      
    </script>
</body>
</html>
