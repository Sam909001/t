<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Probar Çamaşırhane Yönetim Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Slate Gray & Blue -->
    <!-- Application Structure Plan: Uygulama, kullanıcı rollerine göre (operatör, süpervizör) erişim kontrolü sağlayan bir giriş ekranıyla başlar. Ana arayüz, üç temel iş akışını (Paketleme, Sevkiyat, Stok Sorgu) yansıtan sekmeli bir yapıya sahiptir. Bu yapı, kullanıcıların görevler arasında kolayca geçiş yapmasını sağlar ve her sekmeyi kendi özel işlevine odaklayarak bilişsel yükü azaltır. Paketleme ekranı, en sık kullanılan bölüm olduğu için, barkod okuma, hızlı ürün ekleme ve paket kaydetme işlemlerini en verimli hale getiren üç panelli bir düzene (giriş/liste, detay/hızlı ekleme, aksiyonlar) sahiptir. Bu tasarım, operasyonel hızı en üst düzeye çıkarmak için seçilmiştir. Kullanıcı akışı, girişten başlayarak paket oluşturma, konteynere ekleme ve sevkiyat takibine kadar mantıksal bir sıra izler. -->
    <!-- Visualization & Content Choices: Bu uygulama operasyonel bir araç olduğundan, karmaşık veri görselleştirmeleri (grafikler) yerine, verinin net ve hızlı bir şekilde işlenmesine odaklanılmıştır. Bilgi sunumu için HTML tabloları, formlar, büyük butonlar ve modal pencereler gibi standart UI bileşenleri kullanılmıştır.
    - **Paket Listeleri (Paketleme/Sevkiyat):** Amaç: Bekleyen veya sevk edilen işleri göstermek. Sunum: HTML `<table>`. Etkileşim: Satır seçimiyle detay panellerini doldurma, filtreleme, sıralama. Gerekçe: Yapılandırılmış verileri sunmak için en etkili yöntem.
    - **Hızlı Ekleme Butonları (Paketleme):** Amaç: Sık kullanılan ürünleri barkodsuz eklemek. Sunum: Grid düzende HTML `<button>`'lar. Etkileşim: Tıklandığında seçili pakete ürün ekler. Gerekçe: Tekrarlayan görevlerde zaman kazandırır.
    - **Durum Bildirimleri:** Amaç: Kullanıcıya geri bildirim sağlamak. Sunum: Geçici "toast" bildirimleri (başarı/hata) ve eylem onayı için "modal" pencereler. Etkileşim: Onay/iptal butonları. Gerekçe: Kritik işlemlerde yanlışlığı önler ve akışı kesintiye uğratmadan bilgi verir.
    - **Stok Sorgu:** Amaç: Ürün bilgilerini bulmak. Sunum: Arama formu ve sonuç tablosu. Etkileşim: Filtreleme ve arama. Gerekçe: Bilgiye hızlı erişim için standart ve etkili bir arayüz.
    Tüm bu seçimler, masaüstü odaklı, klavye ve barkod okuyucu ile hızlı kullanıma uygun bir deneyim yaratma hedefini desteklemektedir. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-btn.active { border-color: #3b82f6; background-color: #3b82f6; color: white; }
        .tab-btn:not(.active):hover { background-color: #e5e7eb; }
        .page { display: none; }
        .page.active { display: flex; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 60; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .toast.show { opacity: 1; }
        .toast-success { background-color: #16a34a; }
        .toast-error { background-color: #dc2626; }
        .toast-warning { background-color: #f59e0b; }
        .table-selected-row { background-color: #bfdbfe; }
        .supervisor-only { display: none; }
        .supervisor-enabled .supervisor-only { display: inline-flex; }
        .supervisor-enabled-block .supervisor-only { display: block; }
        input:focus, select:focus { outline: 2px solid #3b82f6; outline-offset: 2px; }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Giriş Ekranı -->
    <div id="login-screen" class="min-h-screen w-full flex items-center justify-center bg-slate-200">
        <div class="bg-white p-10 rounded-xl shadow-2xl w-full max-w-md">
            <h1 class="text-4xl font-bold text-center text-slate-700 mb-2">Giriş / Oturum Aç</h1>
            <p class="text-center text-slate-500 mb-8">Çamaşırhane Yönetim Sistemine Hoş Geldiniz</p>
            <form id="login-form">
                <div class="mb-6">
                    <label for="username" class="block text-lg font-medium text-slate-600 mb-2">Kullanıcı Adı</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-slate-300 rounded-lg text-lg focus:ring-blue-500" value="operator" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-lg font-medium text-slate-600 mb-2">Şifre</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-slate-300 rounded-lg text-lg focus:ring-blue-500" value="123" required>
                </div>
                <div class="mb-6">
                     <label for="role" class="block text-lg font-medium text-slate-600 mb-2">Rol</label>
                    <select id="role" class="w-full px-4 py-3 border border-slate-300 rounded-lg text-lg bg-white">
                        <option value="operator" selected>Operator (Personel)</option>
                        <option value="supervisor">Supervisor (Süpervizör)</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 px-4 rounded-lg text-lg hover:bg-blue-700 transition-colors">Giriş Yap</button>
                <div class="text-center mt-6">
                    <a href="#" class="text-blue-600 hover:underline">Şifremi Unuttum</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Ana Uygulama Ekranı -->
    <div id="app-screen" class="hidden w-full flex-col">
        <!-- Üst Header -->
        <header class="bg-white shadow-md p-3 flex justify-between items-center flex-shrink-0">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold text-blue-600">PROBAR</h1>
                <nav id="tab-navigation" class="flex items-center border border-slate-300 rounded-lg p-1">
                    <button data-tab="paketleme" class="tab-btn active text-lg font-semibold px-6 py-2 rounded-md">Paketleme</button>
                    <button data-tab="sevkiyat" class="tab-btn text-lg font-semibold px-6 py-2 rounded-md">Sevkiyat</button>
                    <button data-tab="stok-sorgu" class="tab-btn text-lg font-semibold px-6 py-2 rounded-md">Stok Sorgu</button>
                </nav>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <div id="user-display" class="font-semibold text-lg">Kullanıcı Adı</div>
                    <div id="role-display" class="text-sm text-slate-500">Rol</div>
                </div>
                <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Çıkış Yap</button>
            </div>
        </header>

        <!-- Sayfa İçerikleri -->
        <main class="flex flex-col p-4 bg-slate-50">
            <!-- Paketleme Sayfası -->
            <div id="paketleme-page" class="page active flex-col">
                <!-- Üst Kontrol Paneli -->
                <div class="flex-shrink-0 bg-white p-3 rounded-lg shadow-sm mb-4">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center space-x-4">
                            <div>
                                <label for="customer-select" class="text-sm font-medium text-slate-500">Müşteri</label>
                                <select id="customer-select" class="w-64 p-2 border border-slate-300 rounded-md bg-white text-lg">
                                    <option value="P0006">P0006 - LALELİ HAMİT</option>
                                    <option value="P0012">P0012 - ACIBADEM HASTANESİ</option>
                                </select>
                            </div>
                            <div>
                                <label for="staff-select" class="text-sm font-medium text-slate-500">Personel</label>
                                <select id="staff-select" class="w-48 p-2 border border-slate-300 rounded-md bg-white text-lg">
                                    <option>paket1</option>
                                    <option>paket2</option>
                                </select>
                            </div>
                             <h2 id="customer-name-display" class="text-4xl font-extrabold text-slate-800 self-end ml-6">LALELİ HAMİT</h2>
                        </div>
                        <div class="flex items-center space-x-2">
                             <button class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-md hover:bg-slate-100">Müşteri Seç</button>
                             <button class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-md hover:bg-slate-100">Tüm Müş. Göster</button>
                             <button class="bg-amber-500 text-white px-4 py-2 rounded-md hover:bg-amber-600 supervisor-only">İş Sonu</button>
                        </div>
                    </div>
                </div>

                <!-- Ana Çalışma Alanı -->
                <div class="grid grid-cols-12 gap-4">
                    <!-- Sol Panel -->
                    <div class="col-span-12 lg:col-span-4 flex flex-col gap-4">
                        <div class="bg-white p-3 rounded-lg shadow-sm flex-shrink-0">
                            <h3 class="text-lg font-semibold mb-2">Paket Oluştur</h3>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-slate-500">Ürün Ekle</span>
                                <input type="text" id="barcode-input" placeholder="Barkod Okutun..." class="flex-grow text-lg p-2 border-2 border-slate-300 rounded-lg">
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-sm text-slate-500">Aynı paket sayısı:</span>
                                <span class="font-bold text-lg">1</span>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold mb-2">Bekleyen Paketler</h3>
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-sm">Toplam Bekleyen: <span id="package-count" class="font-bold">0</span></span>
                            </div>
                            <div class="overflow-y-auto max-h-[400px]">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-200">
                                        <tr>
                                            <th class="p-2 w-12"><input type="checkbox" id="select-all-packages"></th>
                                            <th class="p-2">Sıra</th>
                                            <th class="p-2">Paket No</th>
                                            <th class="p-2">T. Miktar</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pending-packages-table">
                                        <!-- Dinamik olarak doldurulacak -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Orta Panel -->
                    <div class="col-span-12 lg:col-span-4 flex flex-col gap-4">
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold mb-2">Paket Detayı</h3>
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center space-x-2">
                                     <button class="bg-slate-200 p-1 rounded-full text-lg hover:bg-slate-300">▲</button>
                                     <button class="bg-slate-200 p-1 rounded-full text-lg hover:bg-slate-300">▼</button>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="px-3 py-1 text-sm rounded-md bg-green-500 text-white hover:bg-green-600">MANUEL</button>
                                    <button class="px-3 py-1 text-sm rounded-md bg-blue-500 text-white hover:bg-blue-600">Ürün Ekle</button>
                                </div>
                            </div>
                            <div id="package-item-details" class="min-h-[200px] max-h-[400px] overflow-y-auto bg-slate-50 p-2 rounded">
                                <p class="text-slate-500">Yeni bir paket oluşturmak için barkod okutun veya hızlı ekle butonlarını kullanın.</p>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-sm flex-shrink-0">
                            <h3 class="text-lg font-semibold mb-2">TANIMLA</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <button class="p-2 rounded-lg bg-slate-100 hover:bg-slate-200">Temizle / Yeni</button>
                                <div class="p-2 rounded-lg bg-red-100 text-center">
                                    <div class="text-xl font-bold text-red-700" id="undefined-count">0</div>
                                    <div class="text-sm text-red-600">Tanımsız Adet</div>
                                </div>
                                <div class="p-2 rounded-lg bg-blue-100 text-center">
                                    <div class="text-xl font-bold text-blue-700" id="defined-count">0</div>
                                    <div class="text-sm text-blue-600">Tanımlı Adet</div>
                                </div>
                                <div class="p-2 rounded-lg bg-slate-100 text-center">
                                    <div class="text-xl font-bold">0</div>
                                    <div class="text-sm">Ortalama Adet</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sağ Panel -->
                    <div class="col-span-12 lg:col-span-4 flex flex-col gap-4">
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold mb-2">Hızlı Ekle</h3>
                            <div id="quick-add-grid" class="grid grid-cols-3 gap-2">
                                <!-- Dinamik olarak doldurulacak -->
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-sm flex-shrink-0">
                            <button id="save-package-btn" class="w-full text-2xl font-bold bg-green-600 text-white rounded-lg px-8 py-6 hover:bg-green-700">(F2) Paketle / Kaydet</button>
                        </div>
                    </div>
                </div>

                <!-- Alt Menü -->
                <footer class="flex-shrink-0 bg-white mt-4 p-2 rounded-lg shadow-inner flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <button class="px-3 py-2 border rounded hover:bg-slate-100">Etiket Bas</button>
                        <button id="select-all-btn-footer" class="px-3 py-2 border rounded hover:bg-slate-100">Tümünü Seç</button>
                        <button id="deselect-all-btn-footer" class="px-3 py-2 border rounded hover:bg-slate-100">Seçimi Kaldır</button>
                        <button id="delete-package-btn" class="px-3 py-2 border rounded bg-red-100 text-red-600 hover:bg-red-200 supervisor-only">Paket Sil</button>
                    </div>
                     <div class="flex items-center space-x-2">
                         <button class="px-3 py-2 border rounded hover:bg-slate-100">Mev. K.</button>
                         <button class="px-3 py-2 border rounded hover:bg-slate-100">Yeni K.</button>
                         <div class="text-lg font-mono">Konteyner No: <span id="container-no">C000094</span></div>
                    </div>
                     <div class="flex items-center space-x-2">
                        <button class="px-3 py-2 border rounded hover:bg-slate-100 supervisor-only">Konteyner Sil</button>
                        <button class="px-3 py-2 border rounded bg-blue-500 text-white hover:bg-blue-600">Kon. Rampaya Gönder</button>
                    </div>
                </footer>
            </div>

            <!-- Sevkiyat Sayfası -->
            <div id="sevkiyat-page" class="page flex-col">
                 <div class="bg-white p-3 rounded-lg shadow-sm mb-4 flex-shrink-0">
                    <h2 class="text-2xl font-bold mb-3">Sevkiyat Filtrele</h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                        <div class="flex space-x-2">
                            <div>
                                <label class="text-sm font-medium">Başlangıç Tarihi</label>
                                <input type="date" class="w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label class="text-sm font-medium">Bitiş Tarihi</label>
                                <input type="date" class="w-full p-2 border rounded-md">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">Durum</label>
                            <select class="w-full p-2 border rounded-md bg-white"><option>Beklemede</option><option>Rampaya Gönderildi</option><option>Gönderildi</option></select>
                        </div>
                        <div>
                            <label class="text-sm font-medium">Konteyner No</label>
                            <input type="text" class="w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="text-sm font-medium">Müşteri</label>
                            <select class="w-full p-2 border rounded-md bg-white"><option>P0006 - LALELİ HAMİT</option><option>P0012 - ACIBADEM HASTANESİ</option></select>
                        </div>
                         <button class="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Filtrele</button>
                    </div>
                </div>
                 <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-8 flex flex-col bg-white rounded-lg shadow-sm">
                        <h3 class="p-3 text-lg font-semibold bg-slate-100 flex-shrink-0">Paket Listesi</h3>
                        <div class="overflow-y-auto max-h-[400px]">
                           <table class="w-full text-left text-sm">
                                <thead class="bg-slate-200">
                                    <tr>
                                        <th class="p-2">Paket No</th>
                                        <th class="p-2">Müşteri</th>
                                        <th class="p-2">Konteyner No</th>
                                        <th class="p-2">Durum</th>
                                        <th class="p-2">Toplam Ürün</th>
                                        <th class="p-2">Aksiyonlar</th>
                                    </tr>
                                </thead>
                                <tbody id="shipment-packages-table">
                                    <!-- Dinamik olarak doldurulacak -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-span-4 bg-white rounded-lg shadow-sm p-4">
                        <h3 class="text-lg font-semibold mb-3">Konteyner Detayı (C000094)</h3>
                        <ul id="container-details-list" class="space-y-1 mb-4 max-h-[400px] overflow-y-auto bg-slate-50 p-2 rounded">
                            <!-- Dinamik olarak doldurulacak -->
                        </ul>
                        <div class="space-y-2">
                             <button class="w-full text-center py-2 border rounded bg-blue-500 text-white hover:bg-blue-600">Konteyner Rampa Gönder</button>
                             <button class="w-full text-center py-2 border rounded hover:bg-slate-100 supervisor-only">Konteyneri Kapat</button>
                        </div>
                         <div class="mt-8">
                             <h3 class="text-lg font-semibold mb-3">Rapor & Export</h3>
                             <div class="flex space-x-2">
                                <button class="flex-1 text-center py-2 border rounded bg-green-100 text-green-700 hover:bg-green-200">CSV Export</button>
                                <button class="flex-1 text-center py-2 border rounded bg-red-100 text-red-700 hover:bg-red-200">PDF Export</button>
                             </div>
                         </div>
                    </div>
                 </div>
            </div>

            <!-- Stok Sorgu Sayfası -->
            <div id="stok-sorgu-page" class="page flex-col">
                <div class="bg-white p-3 rounded-lg shadow-sm mb-4 flex-shrink-0">
                    <h2 class="text-2xl font-bold mb-3">Stok Sorgulama</h2>
                     <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label class="text-sm font-medium">Stok Kodu</label>
                            <input type="text" class="w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="text-sm font-medium">Stok İsmi</label>
                            <input type="text" class="w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="text-sm font-medium">Kategori</label>
                            <select id="stock-category-filter" class="w-full p-2 border rounded-md bg-white">
                                <option>Tümü</option>
                            </select>
                        </div>
                        <div class="flex space-x-2">
                            <button class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Ara</button>
                            <button class="w-full bg-slate-200 text-slate-700 p-2 rounded-md hover:bg-slate-300">Temizle</button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm overflow-y-auto max-h-[600px]">
                    <table class="w-full text-left">
                        <thead class="bg-slate-200 sticky top-0">
                            <tr>
                                <th class="p-3">Stok Kodu</th>
                                <th class="p-3">Stok İsmi</th>
                                <th class="p-3">Miktar</th>
                                <th class="p-3">Depo Konumu</th>
                                <th class="p-3">Günlük Hareket</th>
                            </tr>
                        </thead>
                        <tbody id="stock-query-results">
                            <!-- Dinamik olarak doldurulacak -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal ve Toast Alanı -->
    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- MOCK DATA ---
        const MOCK_USERS = {
            operator: { username: 'operator', password: '123', role: 'operator', name: 'Ayşe Yılmaz' },
            supervisor: { username: 'supervisor', password: '123', role: 'supervisor', name: 'Ahmet Kaya' },
        };

        const MOCK_STOCK = {
            '8691234567890': { kod: 'CRS001', isim: 'ÇARŞAF', kategori: 'Tekstil', miktar: 1500, depo: 'A1-01' },
            '8691234567891': { kod: 'HVL002', isim: 'HAVLU', kategori: 'Tekstil', miktar: 3200, depo: 'A1-02' },
            '8691234567892': { kod: 'ALZ003', isim: 'ALEZ', kategori: 'Tekstil', miktar: 800, depo: 'B2-05' },
            '8691234567893': { kod: 'BCRS004', isim: 'BÜYÜK ÇARŞAF YIKAMA', kategori: 'Hizmet', miktar: null, depo: 'N/A' },
            '8691234567894': { kod: 'NVR005', isim: 'NEVRESİM', kategori: 'Tekstil', miktar: 1250, depo: 'A1-03' },
            '8691234567895': { kod: 'PIK006', isim: 'PİKE', kategori: 'Tekstil', miktar: 600, depo: 'B2-06' },
            '8691234567896': { kod: 'YST007', isim: 'YASTIK', kategori: 'Tekstil', miktar: 2100, depo: 'C3-01' },
            '8691234567897': { kod: 'YKL008', isim: 'YASTIK KILIFI', kategori: 'Tekstil', miktar: 4500, depo: 'C3-02' },
            '8691234567898': { kod: 'DGR009', isim: 'DİĞER', kategori: 'Genel', miktar: 0, depo: 'N/A' },
        };
        
        const QUICK_ADD_ITEMS = ['ÇARŞAF', 'HAVLU', 'ALEZ', 'BÜYÜK ÇARŞAF YIKAMA', 'NEVRESİM', 'PİKE', 'YASTIK', 'YASTIK KILIFI', 'DİĞER'];

        let MOCK_PENDING_PACKAGES = [
            { id: 1, no: 'PK00123', miktar: 15, zaman: '10:32', cariKod: 'P0006', cariUnvan: 'LALELİ HAMİT', paketleyen: 'paket1' },
            { id: 2, no: 'PK00124', miktar: 8, zaman: '10:35', cariKod: 'P0006', cariUnvan: 'LALELİ HAMİT', paketleyen: 'paket1' },
        ];
        
        let MOCK_SHIPMENT_PACKAGES = [
            { no: 'PK00120', musteri: 'ACIBADEM HASTANESİ', konteyner: 'C000093', durum: 'Gönderildi', urun: 25 },
            { no: 'PK00121', musteri: 'LALELİ HAMİT', konteyner: 'C000094', durum: 'Rampaya Gönderildi', urun: 18 },
            { no: 'PK00122', musteri: 'LALELİ HAMİT', konteyner: 'C000094', durum: 'Rampaya Gönderildi', urun: 32 },
        ]

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let currentPackage = {
            items: {},
            tanimsiz: 0,
        };
        let packageCounter = MOCK_PENDING_PACKAGES.length;

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const userDisplay = document.getElementById('user-display');
        const roleDisplay = document.getElementById('role-display');
        const tabNavigation = document.getElementById('tab-navigation');
        const pages = document.querySelectorAll('.page');
        const barcodeInput = document.getElementById('barcode-input');
        const definedCountEl = document.getElementById('defined-count');
        const undefinedCountEl = document.getElementById('undefined-count');
        const packageItemDetailsEl = document.getElementById('package-item-details');
        const savePackageBtn = document.getElementById('save-package-btn');
        const quickAddGrid = document.getElementById('quick-add-grid');
        const pendingPackagesTable = document.getElementById('pending-packages-table');
        const packageCountEl = document.getElementById('package-count');
        const customerNameDisplay = document.getElementById('customer-name-display');
        const customerSelect = document.getElementById('customer-select');
        const shipmentPackagesTable = document.getElementById('shipment-packages-table');
        const containerDetailsList = document.getElementById('container-details-list');
        const stockQueryResults = document.getElementById('stock-query-results');
        const stockCategoryFilter = document.getElementById('stock-category-filter');
        const deletePackageBtn = document.getElementById('delete-package-btn');

        // --- SYSTEM WRAPPERS (Desktop Integration Placeholders) ---
        const SystemAPI = {
            saveFile: (data, fileName) => {
                console.log(`[DESKTOP WRAPPER] Saving file: ${fileName}`, data);
                // Web fallback
                const blob = new Blob([data], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Dosya indirildi.', 'success');
            },
            openFile: () => {
                console.log('[DESKTOP WRAPPER] Opening file dialog.');
                // Web fallback
                const input = document.createElement('input');
                input.type = 'file';
                input.click();
            },
            print: (content) => {
                console.log('[DESKTOP WRAPPER] Printing content.');
                 // Web fallback
                const printWindow = window.open('', '_blank');
                printWindow.document.write(content);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            },
            sendEmail: (to, subject, body) => {
                 console.log(`[EMAIL WRAPPER] Sending email to: ${to}`);
                 console.log(`Subject: ${subject}`);
                 console.log(`Body: ${body}`);
                 // Gerçek bir API çağrısı burada olur.
                 return new Promise(resolve => setTimeout(() => resolve({success: true}), 500));
            },
        };

        // --- UI FUNCTIONS ---
        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { toast.remove(); }, 300);
            }, 3000);
        };

        const showModal = (title, content, buttons) => {
            const modalContainer = document.getElementById('modal-container');
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            
            let buttonsHtml = buttons.map(btn => 
                `<button class="px-6 py-2 rounded-md ${btn.class}" data-action="${btn.action}">${btn.text}</button>`
            ).join('');

            modalOverlay.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
                    <h2 class="text-2xl font-bold mb-4">${title}</h2>
                    <p class="text-slate-600 mb-6">${content}</p>
                    <div class="flex justify-end space-x-4">
                        ${buttonsHtml}
                    </div>
                </div>
            `;
            
            modalContainer.appendChild(modalOverlay);

            return new Promise((resolve) => {
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        const action = e.target.dataset.action;
                        modalOverlay.remove();
                        resolve(action);
                    }
                });
            });
        };
        
        const updateRoleUI = () => {
            if (currentUser.role === 'supervisor') {
                appScreen.classList.add('supervisor-enabled');
                document.body.classList.add('supervisor-enabled-block'); // for block elements
            } else {
                appScreen.classList.remove('supervisor-enabled');
                document.body.classList.remove('supervisor-enabled-block');
            }
        };

        // --- APP LOGIC ---
        const handleLogin = (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const role = document.getElementById('role').value;

            const user = (role === 'operator') ? MOCK_USERS.operator : MOCK_USERS.supervisor;

            if (user) {
                currentUser = { ...user };
                loginScreen.style.display = 'none';
                appScreen.style.display = 'flex';
                userDisplay.textContent = currentUser.name;
                roleDisplay.textContent = currentUser.role === 'operator' ? 'Operatör' : 'Süpervizör';
                updateRoleUI();
                initializePaketlemePage();
                initializeSevkiyatPage();
                initializeStokSorguPage();
                barcodeInput.focus();
            } else {
                showToast('Geçersiz kullanıcı adı veya şifre.', 'error');
            }
        };

        const handleLogout = () => {
            currentUser = null;
            loginScreen.style.display = 'flex';
            appScreen.style.display = 'none';
            document.getElementById('login-form').reset();
        };

        const switchTab = (tabName) => {
            tabNavigation.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            pages.forEach(page => {
                page.classList.toggle('active', page.id === `${tabName}-page`);
            });
        };

        // --- PAKETLEME SAYFASI LOGIC ---
        const initializePaketlemePage = () => {
            renderPendingPackages();
            renderQuickAddButtons();
            updatePackageCounts();
            packageCountEl.textContent = MOCK_PENDING_PACKAGES.length;
            customerNameDisplay.textContent = customerSelect.options[customerSelect.selectedIndex].text.split(' - ')[1];
            updatePackageDetails(); // Yeni eklendi
        };
        
        const renderPendingPackages = () => {
            pendingPackagesTable.innerHTML = MOCK_PENDING_PACKAGES.map((pkg, index) => `
                <tr class="hover:bg-slate-50 cursor-pointer" data-id="${pkg.id}">
                    <td class="p-2 w-12"><input type="checkbox" class="package-checkbox"></td>
                    <td class="p-2">${index + 1}</td>
                    <td class="p-2">${pkg.no}</td>
                    <td class="p-2">${pkg.miktar}</td>
                </tr>
            `).join('');
        };
        
        const renderQuickAddButtons = () => {
            quickAddGrid.innerHTML = QUICK_ADD_ITEMS.map(item => `
                <button data-item-name="${item}" class="quick-add-btn text-sm font-semibold p-2 border rounded-lg bg-slate-50 hover:bg-blue-100 hover:border-blue-400 transition-all">${item}</button>
            `).join('');
        };

        const updatePackageCounts = () => {
            const definedTotal = Object.values(currentPackage.items).reduce((sum, item) => sum + item.qty, 0);
            definedCountEl.textContent = definedTotal;
            undefinedCountEl.textContent = currentPackage.tanimsiz;
        };
        
        // Bu fonksiyon, Paket Detayları panelini güncelliyor
        const updatePackageDetails = () => {
             if (Object.keys(currentPackage.items).length === 0 && currentPackage.tanimsiz === 0) {
                 packageItemDetailsEl.innerHTML = '<p class="text-slate-500">Yeni bir paket oluşturmak için barkod okutun veya hızlı ekle butonlarını kullanın.</p>';
                 return;
             }
             let html = '<ul class="space-y-1 text-sm">';
             for(const [kod, item] of Object.entries(currentPackage.items)) {
                html += `<li class="flex justify-between items-center p-1 rounded hover:bg-slate-200 cursor-pointer" data-item-kod="${kod}"><span>${item.isim}</span><span class="font-bold bg-blue-200 text-blue-800 px-2 rounded-full">${item.qty}</span></li>`;
             }
             if (currentPackage.tanimsiz > 0) {
                 html += `<li class="flex justify-between items-center p-1 rounded bg-red-100 hover:bg-red-200 cursor-pointer"><span>Tanımsız Ürün</span><span class="font-bold text-red-800 px-2 rounded-full">${currentPackage.tanimsiz}</span></li>`;
             }
             html += '</ul>';
             packageItemDetailsEl.innerHTML = html;
        };

        const addItemToPackage = (item) => {
            if (currentPackage.items[item.kod]) {
                currentPackage.items[item.kod].qty++;
            } else {
                currentPackage.items[item.kod] = { ...item, qty: 1 };
            }
            updatePackageCounts();
            updatePackageDetails();
        };

        const handleBarcodeScan = () => {
            const barcode = barcodeInput.value.trim();
            if (!barcode) return;

            const stockItem = Object.values(MOCK_STOCK).find(s => s.kod === barcode) || MOCK_STOCK[barcode];
            if (stockItem) {
                addItemToPackage(stockItem);
                showToast(`${stockItem.isim} eklendi.`, 'success');
            } else {
                currentPackage.tanimsiz++;
                updatePackageCounts();
                updatePackageDetails(); // Tanımsız ürün eklendiğinde de detayları güncelle
                showToast('Tanımsız barkod okutuldu.', 'warning');
            }
            barcodeInput.value = '';
            barcodeInput.focus();
        };

        const handleQuickAdd = (e) => {
            const itemName = e.target.dataset.itemName;
            if (!itemName) return;
            
            const stockItem = Object.values(MOCK_STOCK).find(s => s.isim === itemName);
            if(stockItem){
                addItemToPackage(stockItem);
                showToast(`${stockItem.isim} eklendi.`, 'success');
            } else {
                showToast('Hızlı ekleme ürünü bulunamadı!', 'error');
            }
        };

        const handleSavePackage = async () => {
            const totalItems = Object.values(currentPackage.items).reduce((sum, item) => sum + item.qty, 0) + currentPackage.tanimsiz;
            if (totalItems === 0) {
                showModal('Hata', 'Pakete kaydedilecek en az 1 ürün eklenmelidir.', [{text: 'Tamam', class: 'bg-blue-500 text-white', action: 'ok'}]);
                return;
            }

            const newPackageNo = `PK${String(125 + MOCK_PENDING_PACKAGES.length + 1).padStart(5, '0')}`;
            const now = new Date();
            const newPackage = {
                id: MOCK_PENDING_PACKAGES.length + 1,
                no: newPackageNo,
                miktar: totalItems,
                zaman: `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`,
                cariKod: customerSelect.value,
                cariUnvan: customerSelect.options[customerSelect.selectedIndex].text.split(' - ')[1],
                paketleyen: document.getElementById('staff-select').value
            };
            
            MOCK_PENDING_PACKAGES.push(newPackage);
            packageCountEl.textContent = MOCK_PENDING_PACKAGES.length;

            renderPendingPackages();
            resetCurrentPackage();
            showToast('Paket başarıyla kaydedildi!', 'success');
            
            // Etiket oluştur ve e-posta gönder
            const labelContent = generateLabelContent(newPackage, currentPackage.items);
            SystemAPI.print(labelContent);
            
            const emailBody = `Sayın ${newPackage.cariUnvan}, ${newPackage.no} numaralı paketiniz ${totalItems} adet ürün ile oluşturulmuştur.`;
            await SystemAPI.sendEmail('musteri@ornek.com', `Paketiniz #${newPackage.no} Oluşturuldu`, emailBody);
        };
        
        const generateLabelContent = (packageInfo, items) => {
            let itemsList = Object.values(items).map(i => `<li>${i.isim}: ${i.qty}</li>`).join('');
            return `
                <html><head><title>Etiket</title><style>body{font-family: sans-serif; margin: 10px;} h1{font-size: 18px;} p{font-size: 14px;} ul{padding-left: 20px;}</style></head><body>
                <h1>Paket No: ${packageInfo.no}</h1>
                <p><strong>Müşteri:</strong> ${packageInfo.cariUnvan}</p>
                <p><strong>Konteyner:</strong> ${document.getElementById('container-no').textContent}</p>
                <hr>
                <strong>Ürünler:</strong>
                <ul>${itemsList}</ul>
                <p><strong>Toplam Miktar:</strong> ${packageInfo.miktar}</p>
                </body></html>
            `;
        };

        const resetCurrentPackage = () => {
            currentPackage = { items: {}, tanimsiz: 0 };
            updatePackageCounts();
            updatePackageDetails();
        };
        
        const handleDeletePackage = async () => {
             const selectedCount = pendingPackagesTable.querySelectorAll('.package-checkbox:checked').length;
             if (selectedCount === 0) {
                 showModal('Uyarı', 'Lütfen silmek için en az bir paket seçin.', [{text: 'Tamam', class: 'bg-blue-500 text-white', action: 'ok'}]);
                 return;
             }
             
             const result = await showModal('Onay', `${selectedCount} adet paket silinecek. Emin misiniz? Bu işlem geri alınamaz.`, [
                 {text: 'Vazgeç', class: 'bg-slate-200', action: 'cancel'},
                 {text: 'Evet, Sil', class: 'bg-red-500 text-white', action: 'confirm'}
             ]);

             if (result === 'confirm') {
                 const selectedPackageIds = Array.from(pendingPackagesTable.querySelectorAll('.package-checkbox:checked'))
                    .map(checkbox => parseInt(checkbox.closest('tr').dataset.id, 10));
                
                MOCK_PENDING_PACKAGES = MOCK_PENDING_PACKAGES.filter(pkg => !selectedPackageIds.includes(pkg.id));
                
                renderPendingPackages();
                packageCountEl.textContent = MOCK_PENDING_PACKAGES.length;
                showToast(`${selectedCount} paket silindi.`, 'success');
             }
        };

        // --- SEVKİYAT SAYFASI LOGIC ---
        const initializeSevkiyatPage = () => {
            renderShipmentPackages();
            renderContainerDetails();
        };

        const renderShipmentPackages = () => {
            shipmentPackagesTable.innerHTML = MOCK_SHIPMENT_PACKAGES.map(pkg => `
                 <tr class="hover:bg-slate-50">
                    <td class="p-2">${pkg.no}</td>
                    <td class="p-2">${pkg.musteri}</td>
                    <td class="p-2">${pkg.konteyner}</td>
                    <td class="p-2"><span class="px-2 py-1 text-xs rounded-full ${pkg.durum === 'Gönderildi' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">${pkg.durum}</span></td>
                    <td class="p-2">${pkg.urun}</td>
                    <td class="p-2 space-x-2">
                        <button title="Etiket Yazdır" class="text-blue-500">🖨️</button>
                        <button title="Konteyner Sil" class="text-red-500 supervisor-only">🗑️</button>
                    </td>
                </tr>
            `).join('');
        };
        
        const renderContainerDetails = () => {
            containerDetailsList.innerHTML = MOCK_SHIPMENT_PACKAGES
                .filter(p => p.konteyner === 'C000094')
                .map(p => `<li class="p-1">${p.no} - ${p.musteri} (${p.urun} ürün)</li>`)
                .join('');
        };

        // --- STOK SORGU SAYFASI LOGIC ---
        const initializeStokSorguPage = () => {
            renderStockQueryResults(Object.values(MOCK_STOCK));
            const categories = [...new Set(Object.values(MOCK_STOCK).map(s => s.kategori))];
            stockCategoryFilter.innerHTML = '<option>Tümü</option>' + categories.map(c => `<option>${c}</option>`).join('');
        };
        
        const renderStockQueryResults = (stockList) => {
            stockQueryResults.innerHTML = stockList.map(s => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-3">${s.kod}</td>
                    <td class="p-3">${s.isim}</td>
                    <td class="p-3">${s.miktar ?? 'N/A'}</td>
                    <td class="p-3">${s.depo}</td>
                    <td class="p-3 text-green-600">+10</td>
                </tr>
            `).join('');
        };

        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        tabNavigation.addEventListener('click', (e) => {
            if (e.target.matches('.tab-btn')) {
                switchTab(e.target.dataset.tab);
            }
        });
        
        customerSelect.addEventListener('change', () => {
             customerNameDisplay.textContent = customerSelect.options[customerSelect.selectedIndex].text.split(' - ')[1];
        });

        // Paketleme Sayfası Eventleri
        barcodeInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleBarcodeScan();
            }
            if (e.key === 'Escape') {
                resetCurrentPackage();
            }
        });
        quickAddGrid.addEventListener('click', (e) => {
            if(e.target.classList.contains('quick-add-btn')) {
                handleQuickAdd(e);
            }
        });
        savePackageBtn.addEventListener('click', handleSavePackage);
        deletePackageBtn.addEventListener('click', handleDeletePackage);

        // Klavye kısayolları
        document.addEventListener('keydown', (e) => {
            if (appScreen.style.display === 'flex' && document.getElementById('paketleme-page').classList.contains('active')) {
                if (e.key === 'F2') {
                    e.preventDefault();
                    savePackageBtn.click();
                }
            }
        });
    });
    </script>
</body>
</html>
