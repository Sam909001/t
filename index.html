<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --primary:#2c3e50; --secondary:#3498db; --accent:#e74c3c; --success:#2ecc71; --warning:#f39c12;
      --light:#ecf0f1; --dark:#34495e; --text:#2c3e50; --bg:#f5f7fa;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Segoe UI,Arial,sans-serif}
    html,body{height:100%}
    body{height:100vh;background:var(--bg);color:var(--text);overflow:hidden}

    /* Login */
    .login-container{display:flex;align-items:center;justify-content:center;height:100vh;background:linear-gradient(135deg,var(--primary) 0%,var(--dark) 100%)}
    .login-form{background:#fff;padding:2rem;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.18);width:100%;max-width:420px}
    .login-form h1{text-align:center;margin-bottom:1rem;color:var(--primary)}
    .form-group{margin-bottom:1rem}
    .form-group label{display:block;margin-bottom:.4rem;font-weight:600}
    .form-group input{width:100%;padding:.6rem;border:1px solid #ddd;border-radius:6px}

    .btn{padding:.55rem .9rem;border:0;border-radius:6px;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--secondary);color:#fff}
    .btn-warning{background:var(--warning);color:#fff}
    .btn-danger{background:var(--accent);color:#fff}
    .btn-link{background:none;color:var(--secondary);text-decoration:underline}

    /* App layout fills viewport */
    .app-container{display:none;flex-direction:column;height:100vh}
    .app-header{height:56px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;flex:0 0 56px}
    .tabs{display:flex;background:var(--dark);height:44px;align-items:center;flex:0 0 44px}
    .tab{padding:0 .9rem;color:#fff;cursor:pointer;display:flex;align-items:center;height:100%}
    .tab.active{background:var(--light);color:var(--primary);border-bottom:3px solid var(--secondary)}

    .tab-content{flex:1;display:flex;flex-direction:column;padding:12px;overflow:hidden}
    .tab-pane{display:none;height:100%;overflow:hidden}
    .tab-pane.active{display:block}

    .packaging-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:8px;border-bottom:1px solid #e6e6e6;gap:12px}
    .customer-info{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .info-group{display:flex;flex-direction:column}
    .info-group label{font-weight:700;font-size:.85rem;margin-bottom:6px}
    .info-group select,.info-group input{padding:.45rem;border:1px solid #ddd;border-radius:6px;font-size:.9rem}

    .action-buttons{display:flex;gap:8px}

    .packaging-content{display:flex;gap:12px;align-items:flex-start;height:calc(100% - 72px);padding-top:12px}
    .barcode-section{flex:0 0 23%;min-width:220px;background:#fff;padding:12px;border-radius:8px;display:flex;flex-direction:column;box-shadow:0 2px 8px rgba(0,0,0,.06);height:100%}
    .pending-packages{flex:1 1 50%;min-width:360px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:auto;height:100%}
    .package-details{flex:0 0 23%;min-width:220px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.06);display:flex;flex-direction:column;height:100%}

    .barcode-input{display:flex;margin-bottom:8px}
    .barcode-input input{flex:1;padding:.55rem;border:1px solid #ddd;border-radius:6px 0 0 6px}
    .barcode-input button{border:1px solid #ddd;background:var(--light);padding:0 .6rem;cursor:pointer}

    table.package-table{width:100%;border-collapse:collapse;font-size:.9rem}
    .package-table th,.package-table td{padding:.5rem;border-bottom:1px solid #eee;text-align:left}
    .package-table th{background:var(--light);font-weight:700}

    .quick-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .quick-btn{padding:.55rem;background:var(--light);border:1px solid #e6e6e6;border-radius:6px;cursor:pointer;position:relative}
    .quantity-badge{position:absolute;top:-8px;right:-8px;background:var(--secondary);color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:.72rem}

    .package-actions{margin-top:auto;display:flex;flex-direction:column;gap:8px}

    .app-footer{height:48px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 12px;flex:0 0 48px}

    /* Toasts */
    .toast-container{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:1100;pointer-events:none}
    .toast-item{pointer-events:auto;padding:10px 14px;border-radius:8px;color:#fff;box-shadow:0 6px 20px rgba(0,0,0,.12);opacity:0;transform:translateY(-8px);transition:all .25s}
    .toast-item.show{opacity:1;transform:translateY(0)}
    .toast-success{background:var(--success)}
    .toast-error{background:var(--accent)}
    .toast-warning{background:var(--warning)}
    .toast-info{background:var(--secondary)}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.45);z-index:1050;justify-content:center;align-items:center;padding:16px}
    .modal-content{background:#fff;border-radius:8px;padding:12px;max-width:900px;width:100%;max-height:90vh;overflow:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:8px;border-bottom:1px solid #eee;margin-bottom:8px}
    .modal-close{background:none;border:0;font-size:1.2rem;cursor:pointer}

    .customer-list{max-height:420px;overflow:auto;border:1px solid #eee;border-radius:6px}
    .customer-item{padding:10px;border-bottom:1px solid #f1f1f1;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .customer-item:hover{background:#fafafa}
    .customer-item.selected{background:#e8f4ff}

    .quantity-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.45);z-index:1060;justify-content:center;align-items:center;padding:12px}
    .quantity-content{background:#fff;padding:12px;border-radius:8px;max-width:380px;width:100%}

    .offline-indicator{position:fixed;left:16px;bottom:16px;padding:8px 12px;border-radius:8px;background:var(--accent);color:#fff;z-index:1100;display:none}

    @media (max-width:900px){
      .packaging-content{flex-direction:column;height:auto}
      .barcode-section,.pending-packages,.package-details{width:100%}
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="login-container" id="loginScreen">
    <div class="login-form">
      <h1>ProClean - Oturum Aç</h1>
      <div class="form-group">
        <label for="username">Kullanıcı Adı</label>
        <input id="username" type="text" placeholder="Kullanıcı adınızı girin" />
      </div>
      <div class="form-group">
        <label for="password">Şifre</label>
        <input id="password" type="password" placeholder="Şifrenizi girin" />
      </div>
      <div style="display:flex;gap:8px;justify-content:center;align-items:center">
        <button id="loginBtn" class="btn btn-primary" type="button">Giriş Yap</button>
        <button class="btn-link" type="button">Şifremi Unuttum</button>
      </div>
    </div>
  </div>

  <!-- App -->
  <div class="app-container" id="appContainer" aria-hidden="true">
    <div class="app-header">
      <div class="app-title">ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</div>
      <div class="user-info">
        <span id="userRole">Operatör: </span>
        <button id="logoutBtn" class="btn btn-danger" type="button">Çıkış Yap</button>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Ana Sekmeler">
      <div class="tab active" data-tab="packaging" role="tab" aria-selected="true">Paketleme</div>
      <div class="tab" data-tab="shipping" role="tab">Sevkiyat</div>
      <div class="tab" data-tab="stock" role="tab">Stok Sorgu</div>
    </div>

    <div class="tab-content" role="main">
      <!-- Packaging -->
      <div class="tab-pane active" id="packagingTab">
        <div class="packaging-header">
          <div class="customer-info">
            <div class="info-group">
              <label for="customer">Müşteri</label>
              <select id="customer" aria-label="Müşteri seçimi"></select>
            </div>
            <div class="info-group">
              <label for="personnel">Personel</label>
              <select id="personnel">
                <option value="user1">Paket1 - Ahmet Yılmaz</option>
                <option value="user2">Paket2 - Mehmet Demir</option>
              </select>
            </div>
            <div class="info-group">
              <label>Müşteri Adı</label>
              <span><strong id="customerName">Lütfen müşteri seçin</strong></span>
            </div>
          </div>

          <div class="action-buttons">
            <button id="btnCustomerSelect" class="btn btn-primary" type="button">Müşteri Seç</button>
            <button id="btnShowAllCustomers" class="btn" type="button">Tüm Müş. Göster</button>
            <button id="btnDailyReport" class="btn btn-warning" type="button">İş Sonu Raporu</button>
          </div>
        </div>

        <div class="packaging-content">
          <div class="barcode-section" id="barcodeSection">
            <h3>Paket Oluştur</h3>
            <div class="barcode-input">
              <input id="barcodeInput" type="text" placeholder="Barkodu okutun veya girin" aria-label="Barkod girdisi" />
              <button id="btnBarcodeSearch" type="button" title="Ara"><i class="fas fa-search"></i></button>
              <button id="btnBarcodeClear" type="button" title="Temizle"><i class="fas fa-times"></i></button>
            </div>
            <div class="barcode-counter" style="margin-bottom:8px">
              <span>Okutulan barkod sayısı: <strong id="barcodeCount">0</strong></span>
            </div>
            <div style="margin-top:auto"><svg id="barcodePreview"></svg></div>
          </div>

          <div class="pending-packages" id="pendingPackages">
            <h3>Paket Detayları</h3>
            <table class="package-table" aria-describedby="packagesTableBody">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllPackages" aria-label="Tümünü seç"></th>
                  <th>Sıra</th><th>Paket No</th><th>T. Miktar</th><th>P. Zamanı</th><th>Cari Kod</th><th>Cari Ünvan</th><th>Paketleyen</th>
                </tr>
              </thead>
              <tbody id="packagesTableBody"></tbody>
            </table>
          </div>

          <div class="package-details" id="packageDetails">
            <h3>Hızlı Ürün Ekleme</h3>

            <!-- removed static lines; dynamic summary shown only when relevant -->
            <div id="dynamicPackageSummary" style="margin-bottom:0.6rem"></div>

            <div class="quick-buttons" id="quickButtons" aria-live="polite"></div>

            <div class="package-actions">
              <button id="btnManual" class="btn" type="button">MANUEL</button>
              <div class="definition-panel" id="definitionPanel" style="margin-top:8px">
                <p>Tanımlı Adet: <span style="color:blue;" id="definedCount">0</span></p>
                <p>Ortalama Adet: <span id="averageCount">0</span></p>
              </div>
              <button id="btnSavePackage" class="btn btn-primary" type="button">(F2) Paketle / Kaydet</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Shipping -->
      <div class="tab-pane" id="shippingTab">
        <h2 style="margin-bottom:8px">Sevkiyat Yönetimi</h2>
        <div style="display:flex;gap:10px;align-items:flex-end;margin-bottom:10px">
          <div class="info-group">
            <label for="shippingFilter">Filtrele</label>
            <select id="shippingFilter">
              <option value="all">Tümü</option>
              <option value="pending">Bekleyen</option>
              <option value="shipped">Sevk Edilen</option>
            </select>
          </div>
          <button id="btnFilterShipping" class="btn btn-primary" type="button">Uygula</button>
        </div>

        <div style="overflow:auto;height:calc(100% - 80px)">
          <table class="package-table" style="width:100%">
            <thead><tr><th>Konteyner No</th><th>Müşteri</th><th>Paket Sayısı</th><th>Toplam Adet</th><th>Oluşturulma Tarihi</th><th>Durum</th><th>İşlemler</th></tr></thead>
            <tbody id="shippingTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Stock -->
      <div class="tab-pane" id="stockTab">
        <h2 style="margin-bottom:8px">Stok Sorgulama</h2>
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <input id="stockSearch" type="text" placeholder="Ürün adı veya koduna göre ara..." aria-label="Stok ara"/>
          <button id="btnSearchStock" class="btn btn-primary" type="button">Ara</button>
          <button id="btnClearStock" class="btn" type="button">Temizle</button>
        </div>

        <div style="overflow:auto;height:calc(100% - 180px)">
          <table class="stock-table" style="width:100%;border-collapse:collapse">
            <thead><tr><th>Stok Kodu</th><th>Ürün Adı</th><th>Mevcut Adet</th><th>Birim</th><th>Son Güncelleme</th><th>Durum</th></tr></thead>
            <tbody id="stockTableBody"></tbody>
          </table>
        </div>

        <div class="file-upload" style="margin-top:12px">
          <h3>Stok Dosyası Yükle</h3>
          <input type="file" id="stockFileUpload" accept=".xlsx,.xls,.csv" style="display:none">
          <label for="stockFileUpload" class="btn btn-primary" role="button"><i class="fas fa-upload"></i> Dosya Seç</label>
          <span id="selectedFileName" style="margin-left:10px"></span>
          <button id="btnUploadStock" class="btn btn-primary" type="button" style="margin-left:8px">Yükle</button>
        </div>
      </div>
    </div>

    <div class="app-footer" role="contentinfo">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnPrintLabel" class="btn" type="button"><i class="fas fa-print"></i> Etiket Bas</button>
        <button id="btnSelectAll" class="btn" type="button">Tümünü Seç</button>
        <button id="btnClearSelection" class="btn" type="button">Seçimi Kaldır</button>
        <button id="btnDeletePackage" class="btn btn-danger" type="button">Paket Sil</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnLoadContainer" class="btn" type="button">Mev. K.</button>
        <button id="btnCreateContainer" class="btn" type="button">Yeni K.</button>
        <span>Konteyner No: <span id="containerNumber">C000094</span></span>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnDeleteContainer" class="btn btn-danger" type="button">Konteyner Sil</button>
        <button id="btnSendToRamp" class="btn btn-success" type="button">Kon. Rampaya Gönder</button>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="false"></div>

  <!-- Offline indicator -->
  <div class="offline-indicator" id="offlineIndicator"><i class="fas fa-wifi"></i> Çevrimdışı moddasınız</div>

  <!-- Customer modal -->
  <div class="modal" id="customerModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Müşteri Listesi</h3>
        <button class="modal-close" id="modalCloseBtn" aria-label="Kapat">&times;</button>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="modalCustomerSearch" type="text" placeholder="Müşteri ara..." style="flex:1;padding:.5rem;border:1px solid #ddd;border-radius:6px" />
        <button id="modalSearchBtn" class="btn btn-primary" type="button">Ara</button>
      </div>

      <div class="customer-list" id="customerList" role="list"></div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="modalConfirmBtn" class="btn btn-primary" type="button">Seç</button>
        <button id="modalCancelBtn" class="btn" type="button">İptal</button>
      </div>

      <hr style="margin:12px 0" />
      <div>
        <h4>Müşteri Yönetimi</h4>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="newCustomerCode" placeholder="Müşteri Kodu" style="flex:1;padding:.45rem;border:1px solid #ddd;border-radius:6px" />
          <input id="newCustomerName" placeholder="Müşteri Adı" style="flex:2;padding:.45rem;border:1px solid #ddd;border-radius:6px" />
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="newCustomerEmail" type="email" placeholder="E-posta" style="flex:2;padding:.45rem;border:1px solid #ddd;border-radius:6px" />
          <button id="btnAddCustomer" class="btn btn-primary" type="button">Müşteri Ekle</button>
          <button id="btnDeleteCustomer" class="btn btn-danger" type="button">Müşteri Sil</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quantity modal -->
  <div class="quantity-modal" id="quantityModal" aria-hidden="true" role="dialog">
    <div class="quantity-content">
      <h3 id="quantityProductName">Ürün Miktarı</h3>
      <input id="quantityInput" type="number" min="1" value="1" style="width:100%;padding:.6rem;border:1px solid #ddd;border-radius:6px;margin-top:10px" />
      <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
        <button id="btnConfirmQuantity" class="btn btn-primary" type="button">Tamam</button>
        <button id="btnCancelQuantity" class="btn" type="button">İptal</button>
      </div>
    </div>
  </div>

  <!-- Manual modal -->
  <div class="modal" id="manualModal" aria-hidden="true" role="dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Manuel Ürün Ekleme</h3>
        <button class="modal-close" id="manualClose" aria-label="Kapat">&times;</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="manualProductCode" placeholder="Ürün Kodu" style="padding:.5rem;border:1px solid #ddd;border-radius:6px" />
        <input id="manualProductName" placeholder="Ürün Adı" style="padding:.5rem;border:1px solid #ddd;border-radius:6px" />
        <input id="manualQuantity" type="number" min="1" value="1" style="padding:.5rem;border:1px solid #ddd;border-radius:6px" />
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btnAddManual" class="btn btn-primary" type="button">Ekle</button>
          <button id="btnCancelManual" class="btn" type="button">İptal</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert modal -->
  <div class="modal" id="alertModal" aria-hidden="true" role="alertdialog">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="alertTitle" style="color:var(--primary)">Uyarı</h3>
        <button class="modal-close" id="alertClose" aria-label="Kapat">&times;</button>
      </div>
      <div id="alertMessage" style="margin-bottom:12px"></div>
      <div style="text-align:right">
        <button id="alertOk" class="btn btn-primary" type="button">Tamam</button>
      </div>
    </div>
  </div>

  <script>
    // -----------------------
    // Data (demo)
    // -----------------------
    const users = [
      { username: "operator", password: "1234", role: "operator", name: "Ahmet Yılmaz" },
      { username: "supervisor", password: "1234", role: "supervisor", name: "Mehmet Demir" }
    ];

    let customers = [
      { code: "P0006", name: "LALELİ HAMİT", email: "hamit@lalelitextile.com" },
      { code: "P0007", name: "BEYOĞLU TEKSTİL", email: "info@beyoglutextile.com" },
      { code: "P0008", name: "ŞİŞLİ OTEL", email: "reservations@sisliotel.com" }
    ];

    let packages = [
      { id: 1, packageNo: "PKG-0001", totalQuantity: 5, packageTime: "12.05.2023 14:30", customerCode: "P0006", customerName: "Laleli Hamit", packer: "Ahmet Yılmaz", selected: false },
      { id: 2, packageNo: "PKG-0002", totalQuantity: 3, packageTime: "12.05.2023 14:45", customerCode: "P0006", customerName: "Laleli Hamit", packer: "Ahmet Yılmaz", selected: false }
    ];

    const products = [
      { id: 1, name: "ÇARŞAF", code: "CHS-001", type: "Çarşaf" },
      { id: 2, name: "HAVLU", code: "HVL-001", type: "Havlu" },
      { id: 3, name: "ALEZ", code: "ALZ-001", type: "Alez" },
      { id: 4, name: "BÜYÜK ÇARŞAF YIKAMA", code: "BCY-001", type: "Büyük Çarşaf" },
      { id: 5, name: "NEVRESİM", code: "NVR-001", type: "Nevresim" },
      { id: 6, name: "PİKE", code: "PIK-001", type: "Pike" },
      { id: 7, name: "YASTIK", code: "YST-001", type: "Yastık" },
      { id: 8, name: "YASTIK KILIFI", code: "YKL-001", type: "Yastık Kılıfı" },
      { id: 9, name: "DİĞER", code: "DGR-001", type: "Diğer" }
    ];

    let stockItems = [
      { code: "CHS-001", name: "Çarşaf", quantity: 150, unit: "Adet", lastUpdate: "01.06.2023", status: "Yeterli" },
      { code: "HVL-001", name: "Havlu", quantity: 230, unit: "Adet", lastUpdate: "01.06.2023", status: "Yeterli" }
    ];

    let containers = [
      { id: 1, containerNo: "C000094", customer: "LALELİ HAMİT", packageCount: 2, totalQuantity: 8, createdAt: "12.05.2023", status: "Bekliyor" }
    ];

    // -----------------------
    // State & DOM refs
    // -----------------------
    let currentUser = null;
    let selectedCustomer = null;
    let selectedCustomerInModal = null;
    let selectedPackage = null;
    let barcodeCount = 0;
    let quickProductQuantities = {};
    let currentContainer = "C000094";
    let selectedProductForQuantity = null;
    let pendingOperations = [];

    const loginScreen = document.getElementById('loginScreen');
    const appContainer = document.getElementById('appContainer');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userRoleEl = document.getElementById('userRole');

    const customerSelect = document.getElementById('customer');
    const customerNameSpan = document.getElementById('customerName');
    const packagesTableBody = document.getElementById('packagesTableBody');
    const shippingTableBody = document.getElementById('shippingTableBody');
    const quickButtonsContainer = document.getElementById('quickButtons');
    const barcodeCountSpan = document.getElementById('barcodeCount');
    const selectAllCheckbox = document.getElementById('selectAllPackages');
    const stockTableBody = document.getElementById('stockTableBody');
    const stockSearchInput = document.getElementById('stockSearch');
    const stockFileUpload = document.getElementById('stockFileUpload');
    const selectedFileName = document.getElementById('selectedFileName');
    const toastContainer = document.getElementById('toastContainer');

    // modal refs
    const customerModal = document.getElementById('customerModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const customerListEl = document.getElementById('customerList');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalCustomerSearch = document.getElementById('modalCustomerSearch');
    const modalSearchBtn = document.getElementById('modalSearchBtn');

    const quantityModal = document.getElementById('quantityModal');
    const quantityInput = document.getElementById('quantityInput');
    const quantityProductName = document.getElementById('quantityProductName');
    const btnConfirmQuantity = document.getElementById('btnConfirmQuantity');
    const btnCancelQuantity = document.getElementById('btnCancelQuantity');

    const manualModal = document.getElementById('manualModal');
    const manualClose = document.getElementById('manualClose');
    const btnAddManual = document.getElementById('btnAddManual');
    const btnCancelManual = document.getElementById('btnCancelManual');

    const alertModal = document.getElementById('alertModal');
    const alertTitle = document.getElementById('alertTitle');
    const alertMessage = document.getElementById('alertMessage');
    const alertOk = document.getElementById('alertOk');
    const alertClose = document.getElementById('alertClose');

    // buttons
    const btnCustomerSelect = document.getElementById('btnCustomerSelect');
    const btnShowAllCustomers = document.getElementById('btnShowAllCustomers');
    const btnDailyReport = document.getElementById('btnDailyReport');
    const btnBarcodeSearch = document.getElementById('btnBarcodeSearch');
    const btnBarcodeClear = document.getElementById('btnBarcodeClear');
    const btnManual = document.getElementById('btnManual');
    const btnSavePackage = document.getElementById('btnSavePackage');
    const btnSearchStock = document.getElementById('btnSearchStock');
    const btnClearStock = document.getElementById('btnClearStock');
    const btnUploadStock = document.getElementById('btnUploadStock');
    const btnSelectAll = document.getElementById('btnSelectAll');
    const btnClearSelection = document.getElementById('btnClearSelection');
    const btnDeletePackage = document.getElementById('btnDeletePackage');
    const btnPrintLabel = document.getElementById('btnPrintLabel');
    const btnLoadContainer = document.getElementById('btnLoadContainer');
    const btnCreateContainer = document.getElementById('btnCreateContainer');
    const btnDeleteContainer = document.getElementById('btnDeleteContainer');
    const btnSendToRamp = document.getElementById('btnSendToRamp');
    const btnFilterShipping = document.getElementById('btnFilterShipping');

    const btnAddCustomer = document.getElementById('btnAddCustomer');
    const btnDeleteCustomer = document.getElementById('btnDeleteCustomer');

    // -----------------------
    // Toast & Alert helpers
    // -----------------------
    function createToastElement(message, type) {
      const el = document.createElement('div');
      el.className = `toast-item toast-${type}`;
      el.textContent = message;
      el.setAttribute('role', 'status');
      if (type === 'success') el.classList.add('toast-success');
      else if (type === 'error') el.classList.add('toast-error');
      else if (type === 'warning') el.classList.add('toast-warning');
      else el.classList.add('toast-info');
      return el;
    }

    function showToast(message, type = 'info', duration = 3000) {
      const el = createToastElement(message, type);
      toastContainer.appendChild(el);
      requestAnimationFrame(()=> el.classList.add('show'));
      if (duration > 0) setTimeout(()=> { el.classList.remove('show'); setTimeout(()=> el.remove(), 260); }, duration);
      return el;
    }

    function showAlert(message, title = 'Uyarı', type = 'info') {
      alertTitle.textContent = title;
      alertMessage.textContent = message;
      if (type === 'error') alertTitle.style.color = 'var(--accent)';
      else if (type === 'success') alertTitle.style.color = 'var(--success)';
      else alertTitle.style.color = 'var(--primary)';
      alertModal.style.display = 'flex';
      alertModal.setAttribute('aria-hidden', 'false');
    }

    function hideAlert() {
      alertModal.style.display = 'none';
      alertModal.setAttribute('aria-hidden', 'true');
    }

    // -----------------------
    // Persistence helpers (localStorage + IndexedDB init)
    // -----------------------
    function saveDataToLocalStorage() {
      try {
        localStorage.setItem('customers', JSON.stringify(customers));
        localStorage.setItem('packages', JSON.stringify(packages));
        localStorage.setItem('stockItems', JSON.stringify(stockItems));
        localStorage.setItem('containers', JSON.stringify(containers));
      } catch (e) { console.warn(e); }
    }

    function loadDataFromLocalStorage() {
      try {
        const a = localStorage.getItem('customers'), b = localStorage.getItem('packages'), c = localStorage.getItem('stockItems'), d = localStorage.getItem('containers');
        if (a) customers = JSON.parse(a);
        if (b) packages = JSON.parse(b);
        if (c) stockItems = JSON.parse(c);
        if (d) containers = JSON.parse(d);
      } catch (e) { console.warn('loadDataFromLocalStorage', e); }
    }

    function initIndexedDB() {
      try {
        const request = indexedDB.open("ProCleanDB", 1);
        request.onupgradeneeded = function(e) {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('customers')) db.createObjectStore('customers', { keyPath: 'code' });
          if (!db.objectStoreNames.contains('packages')) db.createObjectStore('packages', { keyPath: 'id', autoIncrement: true });
          if (!db.objectStoreNames.contains('stockItems')) db.createObjectStore('stockItems', { keyPath: 'code' });
          if (!db.objectStoreNames.contains('containers')) db.createObjectStore('containers', { keyPath: 'id', autoIncrement: true });
        };
        request.onsuccess = function() { loadDataFromIndexedDB(); };
        request.onerror = function(e) { console.warn('IndexedDB init error', e); };
      } catch (err) { console.warn('initIndexedDB exception', err); }
    }

    function loadDataFromIndexedDB() {
      try {
        const request = indexedDB.open("ProCleanDB", 1);
        request.onsuccess = function(event) {
          const db = event.target.result;
          try {
            const cReq = db.transaction(["customers"], "readonly").objectStore("customers").getAll();
            cReq.onsuccess = () => { if (cReq.result.length) { customers = cReq.result; populateCustomerDropdown(); } };
          } catch(e){}
          try {
            const pReq = db.transaction(["packages"], "readonly").objectStore("packages").getAll();
            pReq.onsuccess = () => { if (pReq.result.length) { packages = pReq.result; populatePackagesTable(); } };
          } catch(e) {}
          try {
            const sReq = db.transaction(["stockItems"], "readonly").objectStore("stockItems").getAll();
            sReq.onsuccess = () => { if (sReq.result.length) { stockItems = sReq.result; populateStockTable(); } };
          } catch(e) {}
          try {
            const contReq = db.transaction(["containers"], "readonly").objectStore("containers").getAll();
            contReq.onsuccess = () => { if (contReq.result.length) { containers = contReq.result; populateShippingTable(); } };
          } catch(e){}
        };
        request.onerror = function(e) { console.warn('loadDataFromIndexedDB error', e); };
      } catch (err) { console.warn('loadDataFromIndexedDB exception', err); }
    }

    function saveDataToIndexedDB() {
      try {
        const request = indexedDB.open("ProCleanDB", 1);
        request.onsuccess = function(event) {
          const db = event.target.result;
          try { const t1 = db.transaction(["customers"], "readwrite").objectStore("customers"); customers.forEach(c => t1.put(c)); } catch(e){}
          try { const t2 = db.transaction(["packages"], "readwrite").objectStore("packages"); packages.forEach(p => t2.put(p)); } catch(e){}
          try { const t3 = db.transaction(["stockItems"], "readwrite").objectStore("stockItems"); stockItems.forEach(s => t3.put(s)); } catch(e){}
          try { const t4 = db.transaction(["containers"], "readwrite").objectStore("containers"); containers.forEach(cn => t4.put(cn)); } catch(e){}
        };
        request.onerror = function(e) { console.warn('saveDataToIndexedDB error', e); };
      } catch (err) { console.warn('saveDataToIndexedDB exception', err); }
    }

    // -----------------------
    // Online/offline queue
    // -----------------------
    function checkOnlineStatus() {
      const offlineEl = document.getElementById('offlineIndicator');
      if (navigator.onLine) { if (offlineEl) offlineEl.style.display='none'; syncPendingData(); }
      else if (offlineEl) offlineEl.style.display='block';
    }

    function queueOperation(op) {
      pendingOperations.push({ op, timestamp: new Date().toISOString() });
      try { localStorage.setItem('pendingOperations', JSON.stringify(pendingOperations)); } catch(e){}
      showToast('İşlem çevrimdışıyken kuyruğa alındı', 'warning');
    }

    function syncPendingData() {
      if (!navigator.onLine || !pendingOperations.length) return;
      setTimeout(()=> { pendingOperations = []; localStorage.removeItem('pendingOperations'); showToast('Çevrimiçi senkronizasyon tamamlandı','success'); }, 700);
    }

    // -----------------------
    // UI population & helpers
    // -----------------------
    function populateCustomerDropdown() {
      if (!customerSelect) return;
      customerSelect.innerHTML = '';
      customers.forEach(customer => {
        const opt = document.createElement('option');
        opt.value = customer.code;
        opt.textContent = `${customer.code} - ${customer.name}`;
        customerSelect.appendChild(opt);
      });
      if (customers.length > 0) {
        const codeToSelect = selectedCustomer ? selectedCustomer.code : customers[0].code;
        customerSelect.value = codeToSelect;
        updateCustomerInfo(codeToSelect);
      }
    }

    function updateCustomerInfo(customerCode) {
      const customer = customers.find(c => c.code === customerCode);
      if (customer) { selectedCustomer = customer; customerNameSpan.textContent = customer.name; }
    }

    function populatePackagesTable() {
      packagesTableBody.innerHTML = '';
      packages.forEach(pkg => {
        const row = document.createElement('tr');
        row.innerHTML = `<td><input type="checkbox" data-id="${pkg.id}" ${pkg.selected ? 'checked' : ''}></td>
                         <td>${pkg.id}</td><td>${pkg.packageNo}</td><td>${pkg.totalQuantity}</td><td>${pkg.packageTime}</td><td>${pkg.customerCode}</td><td>${pkg.customerName}</td><td>${pkg.packer}</td>`;
        packagesTableBody.appendChild(row);
        const cb = row.querySelector('input[type="checkbox"]');
        cb.addEventListener('change', function(){
          const packageId = parseInt(this.dataset.id);
          const idx = packages.findIndex(p => p.id === packageId);
          if (idx !== -1) packages[idx].selected = this.checked;
          const allChecked = Array.from(document.querySelectorAll('#packagesTableBody input[type="checkbox"]')).every(cb=>cb.checked);
          selectAllCheckbox.checked = allChecked;
          if (this.checked) showPackageDetails(packageId);
        });
      });
    }

    function populateShippingTable() {
      shippingTableBody.innerHTML = '';
      containers.forEach(container => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${container.containerNo}</td><td>${container.customer}</td><td>${container.packageCount}</td><td>${container.totalQuantity}</td><td>${container.createdAt}</td><td>${container.status}</td><td><button class="btn btn-primary" data-id="${container.id}">Detay</button> <button class="btn btn-success" data-send="${container.id}">Sevk Et</button></td>`;
        shippingTableBody.appendChild(row);
      });
      shippingTableBody.querySelectorAll('button[data-id]').forEach(b => b.addEventListener('click', function(){ viewContainerDetails(parseInt(this.dataset.id)); }));
      shippingTableBody.querySelectorAll('button[data-send]').forEach(b => b.addEventListener('click', function(){ changeContainerStatus(parseInt(this.dataset.send), 'shipped'); }));
    }

    function populateStockTable() {
      stockTableBody.innerHTML = '';
      stockItems.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${item.code}</td><td>${item.name}</td><td>${item.quantity}</td><td>${item.unit}</td><td>${item.lastUpdate}</td><td>${item.status}</td>`;
        stockTableBody.appendChild(row);
      });
    }
    // Fix: define searchStock if missing and wire button + Enter key.
// Paste this inside your existing <script> (after stockItems and populateStockTable are defined).
if (typeof searchStock === 'undefined') {
  function searchStock() {
    try {
      const input = document.getElementById('stockSearch');
      const tbody = document.getElementById('stockTableBody');
      if (!tbody) return;
      const term = (input && input.value ? input.value.trim().toLowerCase() : '');
      // If no search term, restore full table
      if (!term) {
        // populateStockTable is expected to exist in your script
        if (typeof populateStockTable === 'function') {
          populateStockTable();
          return;
        } else {
          tbody.innerHTML = '';
          return;
        }
      }
      // Filter stockItems (expects stockItems array exists)
      const filtered = (Array.isArray(stockItems) ? stockItems : []).filter(item => {
        const code = (item.code || '').toString().toLowerCase();
        const name = (item.name || '').toString().toLowerCase();
        return code.includes(term) || name.includes(term);
      });
      // Render filtered rows
      tbody.innerHTML = '';
      filtered.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${item.code || ''}</td>
                        <td>${item.name || ''}</td>
                        <td>${item.quantity != null ? item.quantity : ''}</td>
                        <td>${item.unit || ''}</td>
                        <td>${item.lastUpdate || ''}</td>
                        <td>${item.status || ''}</td>`;
        tbody.appendChild(tr);
      });
      // If no results, optionally show a message row
      if (filtered.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" style="text-align:center;color:#666;padding:12px">Eşleşen stok bulunamadı</td>`;
        tbody.appendChild(tr);
      }
    } catch (err) {
      console.error('searchStock error', err);
      // fallback: try to call original alert/toast functions if present
      if (typeof showAlert === 'function') showAlert('Stok aranırken hata oluştu: ' + (err.message||err), 'Hata', 'error');
      else alert('Stok aranırken hata: ' + (err.message||err));
    }
  }

  // Wire the search button (if exists) - id="btnSearchStock"
  const _btnSearch = document.getElementById('btnSearchStock');
  if (_btnSearch && !_btnSearch._searchBound) {
    _btnSearch.addEventListener('click', searchStock);
    _btnSearch._searchBound = true;
  }

  // Wire Enter on input field stockSearch
  const _stockInput = document.getElementById('stockSearch');
  if (_stockInput && !_stockInput._enterBound) {
    _stockInput.addEventListener('keypress', function(e){
      if (e.key === 'Enter') {
        e.preventDefault();
        searchStock();
      }
    });
    _stockInput._enterBound = true;
  }
}

    // -----------------------
    // Customer modal
    // -----------------------
    function renderCustomerList(filter = '') {
      customerListEl.innerHTML = '';
      const term = (filter || '').toLowerCase();
      const list = term ? customers.filter(c => c.name.toLowerCase().includes(term) || c.code.toLowerCase().includes(term) || (c.email||'').toLowerCase().includes(term)) : customers;
      list.forEach(c => {
        const div = document.createElement('div');
        div.className = 'customer-item';
        div.innerHTML = `<div><strong>${c.code}</strong> - ${c.name}<br/><small>${c.email||''}</small></div>`;
        if (selectedCustomer && selectedCustomer.code === c.code) div.classList.add('selected');
        div.addEventListener('click', function(){
          document.querySelectorAll('.customer-item').forEach(i=>i.classList.remove('selected'));
          div.classList.add('selected');
          selectedCustomerInModal = c;
        });
        customerListEl.appendChild(div);
      });
    }

    function showCustomerSelection() {
      renderCustomerList();
      modalCustomerSearch.value = '';
      customerModal.style.display = 'flex';
      customerModal.setAttribute('aria-hidden', 'false');
    }

    function closeCustomerModal() {
      customerModal.style.display = 'none';
      customerModal.setAttribute('aria-hidden', 'true');
      selectedCustomerInModal = null;
    }

    function confirmSelectCustomer() {
      if (!selectedCustomerInModal) { showToast('Lütfen bir müşteri seçin', 'warning'); return; }
      selectedCustomer = selectedCustomerInModal;
      populateCustomerDropdown();
      customerSelect.value = selectedCustomer.code;
      updateCustomerInfo(selectedCustomer.code);
      closeCustomerModal();
      showToast(`${selectedCustomer.name} seçildi`, 'success');
    }

    function addNewCustomer() {
      const code = document.getElementById('newCustomerCode').value.trim();
      const name = document.getElementById('newCustomerName').value.trim();
      const email = document.getElementById('newCustomerEmail').value.trim();
      if (!code || !name) { showToast('Müşteri kodu ve adı zorunludur', 'error'); return; }
      if (customers.some(c => c.code === code)) { showToast('Bu müşteri kodu zaten mevcut', 'error'); return; }
      const newCustomer = { code, name, email };
      customers.push(newCustomer);
      saveDataToLocalStorage();
      renderCustomerList();
      populateCustomerDropdown();
      document.getElementById('newCustomerCode').value = '';
      document.getElementById('newCustomerName').value = '';
      document.getElementById('newCustomerEmail').value = '';
      showToast(`${name} eklendi`, 'success');
    }

    function deleteSelectedCustomer() {
      if (!selectedCustomerInModal) { showToast('Lütfen silmek için bir müşteri seçin', 'error'); return; }
      if (!confirm(`${selectedCustomerInModal.name} müşterisini silmek istediğinize emin misiniz?`)) return;
      customers = customers.filter(c => c.code !== selectedCustomerInModal.code);
      saveDataToLocalStorage();
      closeCustomerModal();
      populateCustomerDropdown();
      showToast('Müşteri silindi', 'success');
    }

    // -----------------------
    // Quick product buttons & quantity handling
    // -----------------------
    function createQuickProductButtons() {
      quickButtonsContainer.innerHTML = '';
      quickProductQuantities = {};
      products.forEach(p => {
        quickProductQuantities[p.id] = 0;
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'quick-btn';
        button.dataset.productId = p.id;
        button.textContent = p.name;
        const badge = document.createElement('span');
        badge.className = 'quantity-badge';
        badge.id = `badge-${p.id}`;
        badge.textContent = '0';
        badge.style.display = 'none';
        button.appendChild(badge);
        button.addEventListener('click', function() {
          selectedProductForQuantity = p;
          showQuantityModal(p);
        });
        quickButtonsContainer.appendChild(button);
      });
    }

    function showQuantityModal(product) {
      if (!product) return;
      quantityProductName.textContent = product.name;
      quantityInput.value = quickProductQuantities[product.id] || 1;
      quantityModal.style.display = 'flex';
      quantityModal.setAttribute('aria-hidden', 'false');
      quantityInput.focus();
      quantityInput.select();
    }

    function closeQuantityModal() {
      quantityModal.style.display = 'none';
      quantityModal.setAttribute('aria-hidden', 'true');
      selectedProductForQuantity = null;
      const b = document.getElementById('barcodeInput'); if (b) b.focus();
    }

    function confirmQuantity() {
      if (!selectedProductForQuantity) { closeQuantityModal(); return; }
      const qty = parseInt(quantityInput.value) || 1;
      quickProductQuantities[selectedProductForQuantity.id] = qty;
      const badge = document.getElementById(`badge-${selectedProductForQuantity.id}`);
      if (badge) { badge.textContent = qty; badge.style.display = qty > 0 ? 'flex' : 'none'; }
      updatePackageDetails(selectedProductForQuantity.id);
      showToast(`${selectedProductForQuantity.name} için ${qty} adet ayarlandı`, 'success');
      closeQuantityModal();
    }

    // -----------------------
    // Manual product add
    // -----------------------
    function closeManualModal() {
      manualModal.style.display = 'none';
      manualModal.setAttribute('aria-hidden', 'true');
      document.getElementById('manualProductCode').value = '';
      document.getElementById('manualProductName').value = '';
      document.getElementById('manualQuantity').value = '1';
    }

    function addManualProduct() {
      try {
        const code = document.getElementById('manualProductCode').value.trim();
        const name = document.getElementById('manualProductName').value.trim();
        const quantity = parseInt(document.getElementById('manualQuantity').value) || 1;
        if (!code || !name) { showToast('Ürün kodu ve adı zorunludur', 'error'); return; }
        const newProduct = { id: products.length + 1, name, code, type: "Manuel" };
        products.push(newProduct);
        quickProductQuantities[newProduct.id] = quantity;
        const button = document.createElement('button');
        button.className = 'quick-btn';
        button.type = 'button';
        button.dataset.productId = newProduct.id;
        button.textContent = newProduct.name;
        const newBadge = document.createElement('span');
        newBadge.className = 'quantity-badge';
        newBadge.id = `badge-${newProduct.id}`;
        newBadge.textContent = quantity;
        newBadge.style.display = 'block';
        button.appendChild(newBadge);
        button.addEventListener('click', function(){ selectedProductForQuantity = newProduct; showQuantityModal(newProduct); });
        quickButtonsContainer.appendChild(button);
        updatePackageDetails(newProduct.id);
        showToast(`${name} eklendi ve ${quantity} adet atandı`, 'success');
        closeManualModal();
      } catch (err) {
        console.error('addManualProduct error', err);
        showAlert('Manuel ürün eklenirken hata: ' + (err.message||err), 'Hata', 'error');
      }
    }

    // -----------------------
    // Package handling
    // -----------------------
    function updatePackageDetails(productId) {
      const definedCount = Object.values(quickProductQuantities).reduce((s,q)=>s+q,0);
      document.getElementById('definedCount').textContent = definedCount;
      const productCount = Object.values(quickProductQuantities).filter(q=>q>0).length;
      document.getElementById('averageCount').textContent = productCount > 0 ? (definedCount/productCount).toFixed(1) : '0';

      const summary = document.getElementById('dynamicPackageSummary');
      summary.innerHTML = '';
      const product = products.find(p => p.id === productId);
      if (selectedPackage) {
        summary.innerHTML = `<p><strong>Paket:</strong> ${selectedPackage.packageNo}</p><p><strong>Toplam Adet:</strong> ${selectedPackage.totalQuantity}</p>`;
      } else if (product) {
        summary.innerHTML = `<p><strong>Ürün:</strong> ${product.name} (${product.code || '-'})</p><p><strong>Tip:</strong> ${product.type || '-'}</p><p><strong>Seçili Adet:</strong> ${quickProductQuantities[product.id] || 0}</p>`;
      }
    }

    function showPackageDetails(packageId) {
      const pkg = packages.find(p => p.id === packageId);
      if (!pkg) return;
      selectedPackage = pkg;
      const summary = document.getElementById('dynamicPackageSummary');
      summary.innerHTML = `<p><strong>Paket:</strong> ${pkg.packageNo}</p><p><strong>Toplam Adet:</strong> ${pkg.totalQuantity}</p>`;
    }

    function savePackage() {
      try {
        if (!selectedCustomer) { showAlert('Lütfen önce bir müşteri seçin','Uyarı','warning'); return; }
        const newPackage = {
          id: packages.length + 1,
          packageNo: `PKG-${String(packages.length + 1).padStart(4,'0')}`,
          totalQuantity: Object.values(quickProductQuantities).reduce((s,q)=>s+q,0),
          packageTime: new Date().toLocaleString('tr-TR'),
          customerCode: selectedCustomer.code,
          customerName: selectedCustomer.name,
          packer: currentUser ? currentUser.name : 'Unknown',
          selected: false
        };
        packages.push(newPackage);
        const currentContainerObj = containers.find(c=>c.containerNo===currentContainer);
        if (currentContainerObj) { currentContainerObj.packageCount += 1; currentContainerObj.totalQuantity += newPackage.totalQuantity; populateShippingTable(); }
        populatePackagesTable();
        if (!navigator.onLine) queueOperation({ type:'savePackage', payload:newPackage });
        Object.keys(quickProductQuantities).forEach(id=>{ quickProductQuantities[id]=0; const badge=document.getElementById(`badge-${id}`); if (badge){ badge.textContent='0'; badge.style.display='none'; } });
        document.getElementById('dynamicPackageSummary').innerHTML = '';
        document.getElementById('definedCount').textContent='0';
        document.getElementById('averageCount').textContent='0';
        selectedPackage = null;
        saveDataToIndexedDB();
        saveDataToLocalStorage();
        showToast('Paket başarıyla kaydedildi','success');
      } catch (err) {
        console.error('savePackage', err);
        showAlert('Paket kaydedilirken hata oluştu: ' + (err.message||err), 'Hata', 'error');
      }
    }

    // -----------------------
    // Barcode processing
    // -----------------------
    function searchBarcode() {
      const val = document.getElementById('barcodeInput').value.trim();
      if (val) { processBarcode(val); document.getElementById('barcodeInput').value=''; }
    }
    function clearBarcode() { const b = document.getElementById('barcodeInput'); if (b) { b.value=''; b.focus(); } }
    function processBarcode(barcode) {
      barcodeCount++; barcodeCountSpan.textContent = barcodeCount;
      showToast('Barkod okutuldu: ' + barcode, 'success');
      try { JsBarcode("#barcodePreview", barcode, { format: "CODE128", displayValue:true, fontSize:14, height:36 }); } catch(e){}
      const randomProductId = Math.floor(Math.random()*products.length)+1;
      quickProductQuantities[randomProductId] = (quickProductQuantities[randomProductId]||0)+1;
      const badge = document.getElementById(`badge-${randomProductId}`);
      if (badge) { badge.textContent = quickProductQuantities[randomProductId]; badge.style.display='block'; }
      updatePackageDetails(randomProductId);
    }

    // -----------------------
    // Shipping / containers / printing
    // -----------------------
    function printLabel() {
      try {
        const selected = packages.filter(p=>p.selected);
        if (!selected.length) { showAlert('Lütfen yazdırmak için bir paket seçin','Uyarı','warning'); return; }
        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>Paket Etiketleri</title><style>body{font-family:Arial, sans-serif}.label{width:300px;height:150px;border:1px solid #000;margin:10px;padding:10px;display:inline-block;page-break-inside:avoid}</style><script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script></head><body>');
        selected.forEach(pkg => {
          printWindow.document.write(`<div class="label"><h3>${pkg.customerName}</h3><p>Paket No: ${pkg.packageNo}</p><p>Adet: ${pkg.totalQuantity}</p><svg id="barcode-${pkg.id}"></svg><script>JsBarcode("#barcode-${pkg.id}", "${pkg.packageNo}", { format: "CODE128", displayValue:true, fontSize:12, height:30 });<\/script></div>`);
        });
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        setTimeout(()=>printWindow.print(), 500);
        showToast(`${selected.length} paket için etiket yazdırılıyor...`,'info');
      } catch (e) { console.error('printLabel', e); showAlert('Etiket yazdırılırken hata oluştu: ' + (e.message||e), 'Hata', 'error'); }
    }

    function loadCurrentContainer(){ showToast('Mevcut konteyner bilgileri yüklendi','success'); }
    function createNewContainer() {
      const newContainerNumber = `C${String(Math.floor(Math.random()*1000000)).padStart(6,'0')}`;
      document.getElementById('containerNumber').textContent = newContainerNumber; currentContainer = newContainerNumber;
      const newContainer = { id: containers.length+1, containerNo: newContainerNumber, customer: selectedCustomer ? selectedCustomer.name : 'Belirtilmemiş', packageCount:0, totalQuantity:0, createdAt: new Date().toLocaleDateString('tr-TR'), status:'Bekliyor' };
      containers.push(newContainer); populateShippingTable(); saveDataToLocalStorage(); showToast(`Yeni konteyner oluşturuldu: ${newContainerNumber}`,'success');
    }
    function deleteContainer() {
      if (!confirm('Konteyneri silmek istediğinize emin misiniz?')) return;
      const idx = containers.findIndex(c => c.containerNo === currentContainer);
      if (idx !== -1) containers.splice(idx,1);
      document.getElementById('containerNumber').textContent='Yok'; currentContainer = null; populateShippingTable(); saveDataToLocalStorage(); showToast('Konteyner silindi','success');
    }
    function changeContainerStatus(containerId, status) {
      const idx = containers.findIndex(c => c.id === containerId);
      if (idx === -1) return;
      containers[idx].status = status === 'shipped' ? 'Sevk Edildi' : 'Bekliyor';
      populateShippingTable(); saveDataToIndexedDB(); saveDataToLocalStorage(); showToast('Konteyner durumu güncellendi','success');
    }
    function viewContainerDetails(id) {
      const c = containers.find(x=>x.id===id);
      if (c) showAlert(`Konteyner No: ${c.containerNo}\nMüşteri: ${c.customer}\nPaket Sayısı: ${c.packageCount}\nToplam Adet: ${c.totalQuantity}\nDurum: ${c.status}`, 'Konteyner Detayı', 'info');
    }
    function filterShipping() {
      const filterValue = document.getElementById('shippingFilter').value;
      let filtered = containers;
      if (filterValue==='pending') filtered = containers.filter(c=>c.status==='Bekliyor');
      else if (filterValue==='shipped') filtered = containers.filter(c=>c.status==='Sevk Edildi');
      shippingTableBody.innerHTML = '';
      filtered.forEach(container=>{
        const row = document.createElement('tr');
        row.innerHTML = `<td>${container.containerNo}</td><td>${container.customer}</td><td>${container.packageCount}</td><td>${container.totalQuantity}</td><td>${container.createdAt}</td><td>${container.status}</td><td><button class="btn btn-primary" data-id="${container.id}">Detay</button> <button class="btn btn-success" data-send="${container.id}">Sevk Et</button></td>`;
        shippingTableBody.appendChild(row);
      });
      shippingTableBody.querySelectorAll('button[data-id]').forEach(b => b.addEventListener('click', function(){ viewContainerDetails(parseInt(this.dataset.id)); }));
      shippingTableBody.querySelectorAll('button[data-send]').forEach(b => b.addEventListener('click', function(){ changeContainerStatus(parseInt(this.dataset.send), 'shipped'); }));
    }

    // -----------------------
    // Stock import
    // -----------------------
    function getFieldFromRow(row, possibleKeys) {
      if (!row) return undefined;
      if (Array.isArray(row)) return undefined;
      for (const key of possibleKeys) { if (Object.prototype.hasOwnProperty.call(row, key) && row[key] !== undefined && row[key] !== '') return row[key]; }
      const lowerKeys = Object.keys(row).reduce((acc,k)=>{ acc[k.toLowerCase().replace(/\s+/g,'')] = k; return acc; }, {});
      for (const key of possibleKeys) { const normalized = key.toLowerCase().replace(/\s+/g,''); if (lowerKeys[normalized]) return row[lowerKeys[normalized]]; }
      return undefined;
    }

    function processStockData(data) {
      if (!Array.isArray(data) || data.length === 0) { showAlert('Dosyada geçerli stok verisi bulunamadı', 'Hata', 'error'); return; }
      const newStockItems=[];
      data.forEach(row=>{
        const code = getFieldFromRow(row, ['Stok Kodu','StokKodu','code','kod','Code']);
        const name = getFieldFromRow(row, ['Ürün Adı','Urun Adı','name','ürün','Product']);
        const qtyRaw = getFieldFromRow(row, ['Mevcut Adet','MevcutAdet','quantity','qty','Adet']);
        const unit = getFieldFromRow(row, ['Birim','unit']) || 'Adet';
        const quantity = parseInt(String(qtyRaw||'0').replace(/[^0-9\-]/g,'')) || 0;
        if (code && name) newStockItems.push({ code:String(code).trim(), name:String(name).trim(), quantity, unit, lastUpdate: new Date().toLocaleDateString('tr-TR'), status: quantity>50 ? 'Yeterli' : 'Az' });
      });
      if (newStockItems.length>0) {
        const map={}; stockItems.forEach(i=>map[i.code]=i); newStockItems.forEach(ns=>map[ns.code]=ns); stockItems = Object.values(map);
        populateStockTable();
        saveDataToIndexedDB(); saveDataToLocalStorage();
        showToast('Stok bilgileri güncellendi','success');
      } else { showAlert('Dosyada geçerli stok verisi bulunamadı','Hata','error'); }
      selectedFileName.textContent=''; stockFileUpload.value='';
    }

    function uploadStockFile() {
      const file = stockFileUpload.files[0];
      if (!file) { showAlert('Lütfen önce bir dosya seçin', 'Uyarı', 'warning'); return; }
      const ext = file.name.split('.').pop().toLowerCase();
      if (ext==='csv') {
        Papa.parse(file, { complete: function(results){ processStockData(results.data); }, header:true, skipEmptyLines:true, error: function(err){ showAlert('CSV okuma hatası: '+err.message,'Hata','error'); } });
      } else if (ext==='xlsx' || ext==='xls') {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
            processStockData(jsonData);
          } catch(err) { showAlert('Excel okuma hatası: '+err.message,'Hata','error'); }
        };
        reader.onerror = function(e){ showAlert('Dosya okunamadı','Hata','error'); };
        reader.readAsArrayBuffer(file);
      } else { showAlert('Sadece CSV veya Excel dosyaları desteklenmektedir','Hata','error'); return; }
      showToast(`${file.name} dosyası işleniyor...`,'info');
    }

    // -----------------------
    // Selection helpers
    // -----------------------
    function selectAllPackages() {
      selectAllCheckbox.checked = true;
      document.querySelectorAll('#packagesTableBody input[type="checkbox"]').forEach(cb=>{ cb.checked=true; const id=parseInt(cb.dataset.id); const idx=packages.findIndex(p=>p.id===id); if (idx!==-1) packages[idx].selected=true; });
    }
    function clearSelection() {
      selectAllCheckbox.checked = false;
      document.querySelectorAll('#packagesTableBody input[type="checkbox"]').forEach(cb=>{ cb.checked=false; const id=parseInt(cb.dataset.id); const idx=packages.findIndex(p=>p.id===id); if (idx!==-1) packages[idx].selected=false; });
      document.getElementById('dynamicPackageSummary').innerHTML = '';
      selectedPackage = null;
    }

    function deletePackage() {
      const selectedPackages = packages.filter(p=>p.selected);
      if (selectedPackages.length===0) { showAlert('Lütfen silmek için bir paket seçin','Uyarı','warning'); return; }
      if (!confirm(`${selectedPackages.length} paketi silmek istediğinize emin misiniz?`)) return;
      const removed = selectedPackages.map(p=>p.id);
      packages = packages.filter(p=>!p.selected);
      populatePackagesTable(); saveDataToIndexedDB(); saveDataToLocalStorage();
      showToast(`${removed.length} paket silindi`,'success');
    }

    // -----------------------
    // Login & logout (fixed)
    // -----------------------
    function login() {
      try {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const user = users.find(u => u.username === username && u.password === password);
        if (user) {
          currentUser = user;
          userRoleEl.textContent = `Operatör: ${user.name}`;
          loginScreen.style.display='none'; appContainer.style.display='flex'; appContainer.setAttribute('aria-hidden','false');
          // initialize app (events, populate) - run once
          try { initApp(); } catch(e) { console.warn('initApp on login', e); }
          showToast('Başarıyla giriş yapıldı','success');
        } else showAlert('Kullanıcı adı veya şifre hatalı','Giriş Hatası','error');
      } catch (err) {
        console.error('login error', err);
        showAlert('Giriş sırasında hata: ' + (err.message||err), 'Hata', 'error');
      }
    }

    function logout() {
      try {
        if (!confirm('Çıkış yapmak istediğinize emin misiniz?')) return;
        currentUser = null;
        appContainer.style.display='none'; appContainer.setAttribute('aria-hidden','true'); loginScreen.style.display='flex';
        document.getElementById('username').value=''; document.getElementById('password').value='';
        // close modals
        closeCustomerModal(); closeManualModal(); closeQuantityModal(); hideAlert();
        userRoleEl.textContent = '';
        showToast('Çıkış yapıldı','success');
      } catch (err) {
        console.error('logout error', err);
        showAlert('Çıkış sırasında hata: ' + (err.message || err), 'Hata', 'error');
      }
    }

    // -----------------------
    // Report generation
    // -----------------------
    function generateDailyReport() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        const margin = 40;
        doc.setFontSize(18); doc.setTextColor(44,62,80);
        doc.text('ProClean - Günlük İş Sonu Raporu', doc.internal.pageSize.getWidth()/2, margin, { align:'center' });
        doc.setFontSize(10);
        const today = new Date().toLocaleDateString('tr-TR');
        doc.text(`Tarih: ${today}`, margin, margin + 30);
        doc.setFontSize(12);
        doc.text('Müşteri Bilgileri', margin, margin + 60);
        doc.setFontSize(10);
        doc.text(`Seçili Müşteri: ${selectedCustomer ? selectedCustomer.name : 'Yok'}`, margin, margin + 80);

        const tableColumns = [
          { header: 'No', dataKey: 'no' },
          { header: 'Paket No', dataKey: 'packageNo' },
          { header: 'Adet', dataKey: 'totalQuantity' },
          { header: 'Müşteri', dataKey: 'customerName' },
          { header: 'Paket Zamanı', dataKey: 'packageTime' },
          { header: 'Paketleyen', dataKey: 'packer' }
        ];
        const tableRows = packages.map((p, idx) => ({ no: idx+1, packageNo: p.packageNo, totalQuantity: p.totalQuantity, customerName: p.customerName, packageTime: p.packageTime, packer: p.packer }));
        doc.autoTable({
          startY: margin + 100,
          head: [tableColumns.map(c=>c.header)],
          body: tableRows.map(r => tableColumns.map(c => r[c.dataKey])),
          styles: { fontSize:9, textColor:[44,62,80], cellPadding:6 },
          headStyles: { fillColor: [52,152,219], textColor:255, halign:'center' },
          margin: { left: margin, right: margin }
        });
        const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : margin + 100;
        doc.setFontSize(11);
        doc.text(`Toplam Paket Sayısı: ${packages.length}`, margin, finalY + 30);
        const fileName = `proclean_rapor_${today.replace(/\./g,'_')}.pdf`;
        doc.save(fileName);
        showToast('Rapor oluşturuldu ve indirildi','success');
      } catch (err) {
        console.error('generateDailyReport', err);
        showAlert('Rapor oluşturulurken hata oluştu: ' + (err.message||err), 'Hata', 'error');
      }
    }

    // -----------------------
    // Initialization (wire events that must exist before login)
    // -----------------------
    // Ensure login button is wired immediately (prevents "can't log in" issue)
    if (loginBtn) loginBtn.addEventListener('click', login);

    function initApp() {
      // populate UI and wire app events (safe to call multiple times)
      try {
        loadDataFromLocalStorage();
        populateCustomerDropdown();
        populatePackagesTable();
        populateShippingTable();
        createQuickProductButtons();
        populateStockTable();
        initIndexedDB();

        // draw initial barcode preview
        try { JsBarcode("#barcodePreview", "PKG-0001", { format: "CODE128", displayValue:true, fontSize:14, height:36 }); } catch(e){}

        // App-level event wiring (idempotent)
        logoutBtn.removeEventListener('click', logout); logoutBtn.addEventListener('click', logout);
        document.querySelectorAll('.tab').forEach(tab => {
          tab.removeEventListener('click', tab._tabHandler);
          tab._tabHandler = () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            const name = tab.dataset.tab;
            const pane = document.getElementById(name + 'Tab');
            if (pane) pane.classList.add('active');
          };
          tab.addEventListener('click', tab._tabHandler);
        });

        // packaging interactions
        btnCustomerSelect.removeEventListener('click', showCustomerSelection); btnCustomerSelect.addEventListener('click', showCustomerSelection);
        btnShowAllCustomers.removeEventListener('click', showCustomerSelection); btnShowAllCustomers.addEventListener('click', showCustomerSelection);
        btnDailyReport.removeEventListener('click', generateDailyReport); btnDailyReport.addEventListener('click', generateDailyReport);
        btnBarcodeSearch.removeEventListener('click', searchBarcode); btnBarcodeSearch.addEventListener('click', searchBarcode);
        btnBarcodeClear.removeEventListener('click', clearBarcode); btnBarcodeClear.addEventListener('click', clearBarcode);

        const bInput = document.getElementById('barcodeInput');
        if (bInput) {
          bInput.removeEventListener('keypress', bInput._enterHandler);
          bInput._enterHandler = function(e){ if (e.key==='Enter') { processBarcode(this.value); this.value=''; } };
          bInput.addEventListener('keypress', bInput._enterHandler);
        }

        selectAllCheckbox.removeEventListener('change', selectAllCheckbox._handler);
        selectAllCheckbox._handler = function() {
          document.querySelectorAll('#packagesTableBody input[type="checkbox"]').forEach(cb => {
            cb.checked = this.checked;
            const pkgId = parseInt(cb.dataset.id);
            const idx = packages.findIndex(p => p.id === pkgId);
            if (idx !== -1) packages[idx].selected = this.checked;
          });
        };
        selectAllCheckbox.addEventListener('change', selectAllCheckbox._handler);

        // modal events
        modalCloseBtn.removeEventListener('click', closeCustomerModal); modalCloseBtn.addEventListener('click', closeCustomerModal);
        modalCancelBtn.removeEventListener('click', closeCustomerModal); modalCancelBtn.addEventListener('click', closeCustomerModal);
        modalConfirmBtn.removeEventListener('click', confirmSelectCustomer); modalConfirmBtn.addEventListener('click', confirmSelectCustomer);
        modalSearchBtn.removeEventListener('click', function(){}); modalSearchBtn.addEventListener('click', function(){ renderCustomerList(modalCustomerSearch.value.trim()); });
        modalCustomerSearch.removeEventListener('keypress', modalCustomerSearch._handler);
        modalCustomerSearch._handler = function(e){ if (e.key==='Enter') renderCustomerList(modalCustomerSearch.value.trim()); };
        modalCustomerSearch.addEventListener('keypress', modalCustomerSearch._handler);

        // quantity modal
        btnConfirmQuantity.removeEventListener('click', confirmQuantity); btnConfirmQuantity.addEventListener('click', confirmQuantity);
        btnCancelQuantity.removeEventListener('click', closeQuantityModal); btnCancelQuantity.addEventListener('click', closeQuantityModal);

        // manual modal
        btnManual.removeEventListener('click', ()=>{}); btnManual.addEventListener('click', ()=>{ manualModal.style.display='flex'; manualModal.setAttribute('aria-hidden','false'); });
        manualClose.removeEventListener('click', closeManualModal); manualClose.addEventListener('click', closeManualModal);
        btnCancelManual.removeEventListener('click', closeManualModal); btnCancelManual.addEventListener('click', closeManualModal);
        btnAddManual.removeEventListener('click', addManualProduct); btnAddManual.addEventListener('click', addManualProduct);

        // stock handling
        btnSearchStock.removeEventListener('click', searchStock); btnSearchStock.addEventListener('click', searchStock);
        btnClearStock.removeEventListener('click', clearStockSearch); btnClearStock.addEventListener('click', clearStockSearch);
        btnUploadStock.removeEventListener('click', uploadStockFile); btnUploadStock.addEventListener('click', uploadStockFile);
        stockFileUpload.removeEventListener('change', stockFileUpload._handler); stockFileUpload._handler = function(){ selectedFileName.textContent = this.files.length ? this.files[0].name : ''; }; stockFileUpload.addEventListener('change', stockFileUpload._handler);

        // footer buttons
        btnSelectAll.removeEventListener('click', selectAllPackages); btnSelectAll.addEventListener('click', selectAllPackages);
        btnClearSelection.removeEventListener('click', clearSelection); btnClearSelection.addEventListener('click', clearSelection);
        btnDeletePackage.removeEventListener('click', deletePackage); btnDeletePackage.addEventListener('click', deletePackage);
        btnPrintLabel.removeEventListener('click', printLabel); btnPrintLabel.addEventListener('click', printLabel);
        btnLoadContainer.removeEventListener('click', loadCurrentContainer); btnLoadContainer.addEventListener('click', loadCurrentContainer);
        btnCreateContainer.removeEventListener('click', createNewContainer); btnCreateContainer.addEventListener('click', createNewContainer);
        btnDeleteContainer.removeEventListener('click', deleteContainer); btnDeleteContainer.addEventListener('click', deleteContainer);
        btnSendToRamp.removeEventListener('click', sendToRamp); btnSendToRamp.addEventListener('click', sendToRamp);
        btnFilterShipping.removeEventListener('click', filterShipping); btnFilterShipping.addEventListener('click', filterShipping);

        // customer management
        btnAddCustomer.removeEventListener('click', addNewCustomer); btnAddCustomer.addEventListener('click', addNewCustomer);
        btnDeleteCustomer.removeEventListener('click', deleteSelectedCustomer); btnDeleteCustomer.addEventListener('click', deleteSelectedCustomer);

        // keyboard shortcuts
        document.removeEventListener('keydown', document._keyHandler);
        document._keyHandler = function(e){
          if (e.key === 'F2') { e.preventDefault(); savePackage(); }
          if (e.key === 'Escape') { closeQuantityModal(); closeManualModal(); closeCustomerModal(); hideAlert(); }
        };
        document.addEventListener('keydown', document._keyHandler);

        // online/offline
        window.addEventListener('online', checkOnlineStatus);
        window.addEventListener('offline', checkOnlineStatus);
        checkOnlineStatus();

        // try register service worker quietly
        if ('serviceWorker' in navigator) {
          try { navigator.serviceWorker.register('/sw.js').catch(()=>{}); } catch(e) {}
        }
      } catch (err) {
        console.error('initApp error', err);
        showAlert('Uygulama başlatılırken bir hata oluştu: ' + (err.message || err), 'Hata', 'error');
      }
    }

    // Attach login wiring early (already done above), attach logout fallback
    if (logoutBtn) logoutBtn.addEventListener('click', logout);

    // On load: show login
    window.addEventListener('load', function(){
      loginScreen.style.display = 'flex';
      appContainer.style.display = 'none';
      setTimeout(()=>{ const u = document.getElementById('username'); if (u) u.focus(); }, 150);
    });

    // Global error handler
    window.onerror = function(msg, url, lineNo, columnNo, error) {
      console.error('Global error', msg, url, lineNo, columnNo, error);
      showAlert(`Beklenmeyen hata: ${msg} (Satır ${lineNo})`, 'Hata', 'error');
      return false;
    };
  </script>
</body>
</html>
