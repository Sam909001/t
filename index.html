<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
            --text: #2c3e50;
            --bg: #f5f7fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* Login Screen */
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%); }
        .login-form { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .login-form h1 { text-align: center; margin-bottom: 1.5rem; color: var(--primary); }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display:block; margin-bottom:0.5rem; font-weight:500; }
        .form-group input { width:100%; padding:0.8rem; border:1px solid #ddd; border-radius:5px; font-size:1rem; }

        .btn { padding:0.6rem 1rem; border:none; border-radius:5px; cursor:pointer; font-size:0.9rem; font-weight:600; transition:all .3s; display: inline-block; text-align: center; }
        .btn-primary { background:var(--secondary); color:#fff; }
        .btn-primary:hover { background:#2980b9; }
        .btn-link { background:none; color:var(--secondary); text-decoration:underline; padding:0.5rem; }

        /* Main */
        .app-container { display:none; flex-direction:column; height:100vh; }

        /* Header */
        .app-header { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; }
        .app-title { font-size:1.3rem; font-weight:600; }
        .user-info { display:flex; align-items:center; gap:0.8rem; }

        /* FIXED: Logout button should be fully clickable */
        .user-info button {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            background: var(--accent);
            color: white;
            min-width: 100px;
        }
        .user-info button:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        /* Tabs */
        .tabs { display:flex; background-color:var(--dark); }
        .tab { padding:0.8rem 1.5rem; color:white; cursor:pointer; font-weight:500; border-bottom:3px solid transparent; font-size:0.9rem; }
        .tab.active { background:var(--light); color:var(--primary); border-bottom:3px solid var(--secondary); }

        /* Content - FIXED: Better height calculation to avoid scrolling */
        .tab-content { flex-grow:1; padding:1.2rem; overflow-y:auto; height: calc(100vh - 200px); }
        .tab-pane { display:none; }
        .tab-pane.active { display:block; }

        /* UPDATED: More compact customer info section */
        .packaging-header { display:flex; justify-content:space-between; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; align-items: center; }
        .customer-info { display:flex; gap:0.8rem; align-items: center; flex-wrap: wrap; }
        .info-group { display:flex; flex-direction:column; margin-bottom: 0; }
        .info-group label { font-weight:600; margin-bottom:0.2rem; font-size:0.8rem; }
        .info-group select, .info-group input { padding:0.4rem; border:1px solid #ddd; border-radius:5px; font-size:0.8rem; height: auto; }
        .info-group span { font-size: 0.9rem; }
        .action-buttons { display:flex; gap:0.6rem; }

        /* UPDATED: Better responsive layout with optimized heights */
        .packaging-content {
            display: flex;
            gap: 1.2rem;
            align-items: flex-start;
            height: calc(100vh - 280px);
            padding-bottom: 10px;
        }
        .barcode-section { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .pending-packages { flex: 0 0 50%; min-width: 360px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); overflow-y:auto; }
        .package-details { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); display:flex; flex-direction:column; }

        .barcode-input { display:flex; margin-bottom:0.8rem; }
        .barcode-input input { flex-grow:1; padding:0.6rem; border:1px solid #ddd; border-radius:5px 0 0 5px; font-size:1rem; }
        .barcode-input button { padding:0 0.8rem; border:1px solid #ddd; background:var(--light); cursor:pointer; }

        .package-table { width:100%; border-collapse:collapse; font-size:0.85rem; }
        .package-table th, .package-table td { padding:0.5rem; text-align:left; border-bottom:1px solid #ddd; }
        .package-table th { background:var(--light); font-weight:600; }
        .package-table tr:hover { background:#f9f9f9; }

        .quick-buttons { display:grid; grid-template-columns:repeat(3, 1fr); gap:0.4rem; margin-top:0.8rem; }
        .quick-btn { padding:0.6rem 0.4rem; background:var(--light); border:1px solid #ddd; border-radius:5px; cursor:pointer; text-align:center; font-size:0.8rem; position:relative; }
        .quantity-badge { position:absolute; top:-5px; right:-5px; background:var(--secondary); color:white; border-radius:50%; width:18px; height:18px; font-size:0.7rem; display:flex; align-items:center; justify-content:center; }

        .package-actions { margin-top:auto; display:flex; flex-direction:column; gap:0.6rem; }

        .btn-success { background:var(--success); color:white; }
        .btn-warning { background:var(--warning); color:white; }
        .btn-danger { background:var(--accent); color:white; }

        /* Shipping status styles */
        .status-beklemede { background: var(--warning); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }
        .status-sevk-edildi { background: var(--success); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }
        
        /* FIXED: Added missing stock status styles */
        .status-kritik { background: var(--accent); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }
        .status-az-stok { background: var(--warning); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }
        .status-stokta { background: var(--success); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }

        .app-footer { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; font-size:0.85rem; }
        .container-info { display:flex; align-items:center; gap:0.8rem; }

        .toast { position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:5px; color:white; z-index:1000; opacity:0; transform:translateY(-20px); transition:all .3s; }
        .toast.show { opacity:1; transform:translateY(0); }
        .toast.success { background:var(--success); } .toast.error { background:var(--accent); } .toast.warning { background:var(--warning); }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; }
        .modal-close { background:none; border:none; font-size:1.5rem; cursor:pointer; }

        .customer-list { max-height:300px; overflow-y:auto; margin-bottom:1rem; }
        .customer-item { padding:0.8rem; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
        .customer-item:hover { background:#f5f5f5; } .customer-item.selected { background:#e3f2fd; }

        .quantity-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center; }
        .quantity-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:300px; text-align:center; }
        .quantity-input { width:100%; padding:0.8rem; margin:1rem 0; border:1px solid #ddd; border-radius:5px; font-size:1.2rem; text-align:center; }
        .quantity-buttons { display:flex; justify-content:center; gap:0.8rem; margin-top:1rem; }

        .stock-search { display:flex; gap:0.8rem; margin-bottom:1.2rem; }
        .stock-search input { flex-grow:1; padding:0.8rem; border:1px solid #ddd; border-radius:5px; }
        .stock-table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .stock-table th, .stock-table td { padding:0.8rem; text-align:left; border-bottom:1px solid #ddd; } .stock-table th { background:var(--light); font-weight:600; } .stock-table tr:hover { background:#f9f9f9; }

        .file-upload { margin-top:1.2rem; padding:1.2rem; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .upload-button { display:inline-block; padding:0.8rem 1.5rem; background:var(--secondary); color:white; border-radius:5px; cursor:pointer; margin-top:0.8rem; }
        .upload-button:hover { background:#2980b9; }

        .offline-indicator { position:fixed; bottom:20px; left:20px; padding:0.8rem 1.2rem; background:var(--accent); color:white; border-radius:5px; z-index:1000; display:none; }

        /* Email modal styles */
        .email-settings { margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 5px; }
        .email-settings label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .email-settings input[type="email"] { width: 100%; padding: 0.5rem; margin-bottom: 0.8rem; border: 1px solid #ddd; border-radius: 3px; }

        /* Form row styles */
        .form-row { display: flex; gap: 0.5rem; margin-bottom: 0.8rem; }
        .form-row input { flex: 1; }

        /* NEW: Offline status in header */
        .connection-status { 
            display: flex; 
            align-items: center; 
            margin-right: 15px; 
            font-size: 0.85rem; 
        }
        .online-status { color: var(--success); }
        .offline-status { color: var(--accent); }

        /* NEW: Email settings panel */
        .email-config-panel {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid #ddd;
        }
        .email-config-panel h4 {
            margin-bottom: 0.8rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.5rem;
        }

        /* Responsive */
        @media (max-width:1200px) {
            .barcode-section, .package-details { min-width:200px; }
            .pending-packages { flex: 1 1 60%; }
        }
        @media (max-width:900px) {
            .packaging-content { flex-direction:column; height:auto; }
            .barcode-section, .pending-packages, .package-details { flex: 1 1 auto; width:100%; min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <div class="login-form">
            <h1>ProClean - Oturum Aç</h1>
            <div class="form-group">
                <label for="username">Kullanıcı Adı</label>
                <input type="text" id="username" placeholder="Kullanıcı adınızı girin">
            </div>
            <div class="form-group">
                <label for="password">Şifre</label>
                <input type="password" id="password" placeholder="Şifrenizi girin">
            </div>
            <button type="button" class="btn btn-primary" id="loginBtn" onclick="loginUser()">Giriş Yap</button>
            <div style="text-align:center; margin-top:1rem;">
                <button type="button" class="btn-link">Şifremi Unuttum</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="app-header">
            <div class="app-title">ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</div>
            <div style="display: flex; align-items: center;">
                <div class="connection-status" id="connectionStatus">
                    <i class="fas fa-wifi online-status" id="onlineIcon"></i>
                    <i class="fas fa-wifi-slash offline-status" id="offlineIcon" style="display: none;"></i>
                    <span id="connectionText">Çevrimiçi</span>
                </div>
                <div class="user-info">
                    <span id="userRole">Operatör: Ahmet Yılmaz</span>
                    <button type="button" id="logoutBtn" class="btn btn-danger" onclick="logout()">Çıkış Yap</button>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('packaging')">Paketleme</div>
            <div class="tab" onclick="switchTab('shipping')">Sevkiyat</div>
            <div class="tab" onclick="switchTab('stock')">Stok Sorgu</div>
            <div class="tab" onclick="switchTab('settings')">Ayarlar</div>
        </div>

        <div class="tab-content">
            <div class="tab-pane active" id="packagingTab">
                <!-- Packaging tab content remains the same as before -->
                <div class="packaging-header">
                    <div class="customer-info">
                        <div class="info-group">
                            <label for="customer">Müşteri</label>
                            <select id="customer"></select>
                        </div>
                        <div class="info-group">
                            <label for="personnel">Personel</label>
                            <select id="personnel">
                                <option value="user1">Paket1 - Ahmet Yılmaz</option>
                                <option value="user2">Paket2 - Mehmet Demir</option>
                            </select>
                        </div>
                        <div class="info-group">
                            <label>Müşteri Adı</label>
                            <span><strong id="customerName">Lütfen müşteri seçin</strong></span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="showCustomerSelection()">Müşteri Seç</button>
                        <button type="button" class="btn" onclick="showAllCustomers()">Tüm Müş. Göster</button>
                        <button type="button" class="btn btn-warning" onclick="generateDailyReport()">İş Sonu Raporu</button>
                    </div>
                </div>

                <div class="packaging-content">
                    <div class="barcode-section" id="barcodeSection">
                        <h3>Paket Oluştur</h3>
                        <div class="barcode-input">
                            <input type="text" id="barcodeInput" placeholder="Barkodu okutun veya girin" autofocus>
                            <button type="button" onclick="searchBarcode()"><i class="fas fa-search"></i></button>
                            <button type="button" onclick="clearBarcode()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="barcode-counter">
                            <span>Okutulan barkod sayısı: <strong id="barcodeCount">0</strong></span>
                        </div>
                        <div class="barcode-preview"><svg id="barcode"></svg></div>
                    </div>

                    <div class="pending-packages" id="pendingPackages">
                        <h3>Paket Detayları</h3>
                        <table class="package-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllPackages"></th>
                                    <th>Sıra</th>
                                    <th>Paket No</th>
                                    <th>T. Miktar</th>
                                    <th>P. Zamanı</th>
                                    <th>Cari Kod</th>
                                    <th>Cari Ünvan</th>
                                    <th>Paketleyen</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTableBody"></tbody>
                        </table>
                    </div>

                    <div class="package-details" id="packageDetails">
                        <h3>Hızlı Ürün Ekleme</h3>
                        <div class="quick-buttons" id="quickButtons"></div>

                        <div class="package-actions">
                            <button type="button" class="btn" onclick="showManualEntry()">MANUEL</button>
                            <div class="definition-panel">
                                <p>Tanımsız Adet: <span style="color: red;" id="undefinedCount">0</span></p>
                                <p>Tanımlı Adet: <span style="color: blue;" id="definedCount">0</span></p>
                                <p>Ortalama Adet: <span id="averageCount">0</span></p>
                            </div>
                            <button type="button" class="btn btn-success" onclick="savePackage()">(F2) Paketle / Kaydet</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="shippingTab">
                <!-- Shipping tab content remains the same as before -->
                <h2>Sevkiyat Yönetimi</h2>
                <div class="shipping-controls">
                    <div class="info-group">
                        <label for="shippingFilter">Filtrele</label>
                        <select id="shippingFilter">
                            <option value="all">Tümü</option>
                            <option value="beklemede">Beklemede</option>
                            <option value="sevk-edildi">Sevk Edildi</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="filterShipping()">Uygula</button>
                </div>

                <table class="package-table">
                    <thead>
                        <tr>
                            <th>Konteyner No</th>
                            <th>Müşteri</th>
                            <th>Paket Sayısı</th>
                            <th>Toplam Adet</th>
                            <th>Oluşturulma Tarihi</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="shippingTableBody"></tbody>
                </table>
            </div>

            <div class="tab-pane" id="stockTab">
                <!-- Stock tab content remains the same as before -->
                <h2>Stok Sorgulama</h2>
                <div class="stock-search">
                    <input type="text" id="stockSearch" placeholder="Ürün adı veya koduna göre ara...">
                    <button type="button" class="btn btn-primary" onclick="searchStock()">Ara</button>
                    <button type="button" class="btn" onclick="clearStockSearch()">Temizle</button>
                </div>

                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>Stok Kodu</th>
                            <th>Ürün Adı</th>
                            <th>Mevcut Adet</th>
                            <th>Birim</th>
                            <th>Son Güncelleme</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody"></tbody>
                </table>

                <div class="file-upload">
                    <h3>Stok Dosyası Yükle</h3>
                    <p>Stok bilgilerini güncellemek için bir Excel veya CSV dosyası yükleyin.</p>
                    <input type="file" id="stockFileUpload" accept=".xlsx,.xls,.csv" style="display:none;">
                    <label for="stockFileUpload" class="upload-button" role="button"><i class="fas fa-upload"></i> Dosya Seç</label>
                    <span id="selectedFileName" style="margin-left:10px;"></span>
                    <button type="button" class="btn btn-primary" onclick="uploadStockFile()" style="margin-top:10px;">Yükle</button>
                    <p style="margin-top:8px; font-size:0.85rem; color:#666">Desteklenen başlık örnekleri: "Stok Kodu", "Ürün Adı", "Mevcut Adet" veya "code", "name", "quantity"</p>
                </div>
            </div>

            <!-- NEW: Settings Tab for Email Configuration -->
            <div class="tab-pane" id="settingsTab">
                <h2>Uygulama Ayarları</h2>
                
                <div class="email-config-panel">
                    <h4>E-posta Ayarları</h4>
                    <div class="form-group">
                        <label for="emailServiceID">EmailJS Service ID</label>
                        <input type="text" id="emailServiceID" placeholder="service_xxxxx">
                    </div>
                    <div class="form-group">
                        <label for="emailTemplateID">EmailJS Template ID</label>
                        <input type="text" id="emailTemplateID" placeholder="template_xxxxx">
                    </div>
                    <div class="form-group">
                        <label for="emailUserID">EmailJS User ID</label>
                        <input type="text" id="emailUserID" placeholder="user_xxxxx">
                    </div>
                    <div class="form-group">
                        <label for="defaultEmail">Varsayılan E-posta Adresi</label>
                        <input type="email" id="defaultEmail" placeholder="rapor@firma.com">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveEmailSettings()">Ayarları Kaydet</button>
                    <button type="button" class="btn" onclick="testEmailSettings()">E-posta Testi</button>
                </div>

                <div class="email-config-panel">
                    <h4>Çevrimdışı Mod Ayarları</h4>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="offlineMode" checked>
                            Çevrimdışı modu etkinleştir
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoSync" checked>
                            İnternet bağlantısı geri geldiğinde otomatik senkronize et
                        </label>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveOfflineSettings()">Ayarları Kaydet</button>
                    <button type="button" class="btn" onclick="clearOfflineData()">Çevrimdışı Veriyi Temizle</button>
                </div>
            </div>
        </div>

        <div class="app-footer">
            <div class="footer-actions">
                <button type="button" class="btn" onclick="printLabel()"><i class="fas fa-print"></i> Etiket Bas</button>
                <button type="button" class="btn" onclick="selectAllPackages()">Tümünü Seç</button>
                <button type="button" class="btn" onclick="clearSelection()">Seçimi Kaldır</button>
                <button type="button" class="btn btn-danger" onclick="deletePackage()">Paket Sil</button>
            </div>
            <div class="container-info">
                <button type="button" class="btn" onclick="loadCurrentContainer()">Mev. K.</button>
                <button type="button" class="btn" onclick="createNewContainer()">Yeni K.</button>
                <span>Konteyner No: <span id="containerNumber">C000094</span></span>
            </div>
            <div class="footer-actions">
                <button type="button" class="btn btn-danger" onclick="deleteContainer()">Konteyner Sil</button>
                <button type="button" class="btn btn-success" onclick="sendToRamp()">Kon. Rampaya Gönder</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="offline-indicator" id="offlineIndicator"><i class="fas fa-wifi"></i> Çevrimdışı moddasınız</div>

    <!-- Customer Selection Modal -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Müşteri Seçimi</h3>
                <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <div class="customer-list" id="customerList"></div>
                <div class="add-customer-form">
                    <h4>Müşteri Yönetimi</h4>
                    <div class="form-row">
                        <input type="text" id="newCustomerCode" placeholder="Müşteri Kodu">
                        <input type="text" id="newCustomerName" placeholder="Müşteri Adı">
                    </div>
                    <div class="form-row">
                        <input type="email" id="newCustomerEmail" placeholder="E-posta">
                        <button type="button" class="btn btn-primary" onclick="addNewCustomer()">Müşteri Ekle</button>
                        <button type="button" class="btn btn-danger" onclick="deleteSelectedCustomer()">Müşteri Sil</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Customers Modal -->
    <div class="modal" id="allCustomersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tüm Müşteriler</h3>
                <button type="button" class="modal-close" onclick="closeAllCustomersModal()">&times;</button>
            </div>
            <div class="customer-list" id="allCustomersList" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Daily Report Email Modal -->
    <div class="modal" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>İş Sonu Raporu Gönder</h3>
                <button type="button" class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="email-settings">
                <label for="reportEmail">E-posta Adresi:</label>
                <input type="email" id="reportEmail" placeholder="rapor@firma.com">
                <button type="button" class="btn btn-primary" onclick="sendDailyReport()">Raporu Gönder</button>
                <button type="button" class="btn" onclick="previewReport()">Raporu Önizle</button>
            </div>
        </div>
    </div>

    <div class="quantity-modal" id="quantityModal">
        <div class="quantity-content">
            <h3 id="quantityProductName">Ürün Miktarı</h3>
            <input type="number" id="quantityInput" class="quantity-input" min="1" value="1">
            <div class="quantity-buttons">
                <button type="button" class="btn btn-primary" onclick="confirmQuantity()">Tamam</button>
                <button type="button" class="btn" onclick="closeQuantityModal()">İptal</button>
            </div>
        </div>
    </div>

    <div class="modal" id="manualModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manuel Ürün Ekleme</h3>
                <button type="button" class="modal-close" onclick="closeManualModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="manualProductCode">Ürün Kodu</label>
                <input type="text" id="manualProductCode" placeholder="Ürün kodunu girin">
            </div>
            <div class="form-group">
                <label for="manualProductName">Ürün Adı</label>
                <input type="text" id="manualProductName" placeholder="Ürün adını girin">
            </div>
            <div class="form-group">
                <label for="manualQuantity">Miktar</label>
                <input type="number" id="manualQuantity" min="1" value="1">
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-primary" onclick="addManualProduct()">Ekle</button>
                <button type="button" class="btn" onclick="closeManualModal()">İptal</button>
            </div>
        </div>
    </div>

    <script>
        // --- App Data & DOM refs ---
        const users = [
            { username: "operator", password: "1234", role: "operator", name: "Ahmet Yılmaz" },
            { username: "supervisor", password: "1234", role: "supervisor", name: "Mehmet Demir" }
        ];

        let customers = [
            { code: "P0006", name: "LALELİ HAMİT", email: "hamit@lalelitextile.com" },
            { code: "P0007", name: "BEYOĞLU TEKSTİL", email: "info@beyoglutextile.com" },
            { code: "P0008", name: "ŞİŞLİ OTEL", email: "reservations@sisliotel.com" },
            { code: "P0009", name: "KADIKÖY GIDA", email: "siparis@kadikoyglda.com" },
            { code: "P0010", name: "ATAŞEHIR LTD", email: "muhasebe@atasehirltd.com" }
        ];

        let packages = [
            { id: 1, packageNo: "PKG-0001", totalQuantity: 5, packageTime: "12.05.2023 14:30", customerCode: "P0006", customerName: "LALELİ HAMİT", packer: "Ahmet Yılmaz", selected: false },
            { id: 2, packageNo: "PKG-0002", totalQuantity: 3, packageTime: "12.05.2023 14:45", customerCode: "P0006", customerName: "LALELİ HAMİT", packer: "Ahmet Yılmaz", selected: false }
        ];

        // ENHANCED: Containers now have proper status handling
        let containers = [
            { id: 1, containerNo: "C000094", customer: "LALELİ HAMİT", packageCount: 2, totalQuantity: 8, createdAt: "12.05.2023", status: "beklemede", packages: [1, 2] },
            { id: 2, containerNo: "C000095", customer: "BEYOĞLU TEKSTİL", packageCount: 1, totalQuantity: 4, createdAt: "13.05.2023", status: "sevk-edildi", packages: [] }
        ];

        const products = [
            { code: "PRD001", name: "Gömlek", quantity: 0 },
            { code: "PRD002", name: "Pantolon", quantity: 0 },
            { code: "PRD003", name: "Ceket", quantity: 0 },
            { code: "PRD004", name: "Elbise", quantity: 0 },
            { code: "PRD005", name: "Tişört", quantity: 0 },
            { code: "PRD006", name: "Etek", quantity: 0 },
            { code: "PRD007", name: "Kravat", quantity: 0 },
            { code: "PRD008", name: "Şapka", quantity: 0 },
            { code: "PRD009", name: "Çorap", quantity: 0 }
        ];

        let stockItems = [
            { code: "STK001", name: "Temizlik Maddesi A", quantity: 150, unit: "Adet", lastUpdate: "12.05.2023", status: "Stokta" },
            { code: "STK002", name: "Deterjan Premium", quantity: 75, unit: "Kg", lastUpdate: "11.05.2023", status: "Az Stok" },
            { code: "STK003", name: "Yumuşatıcı", quantity: 200, unit: "Lt", lastUpdate: "10.05.2023", status: "Stokta" },
            { code: "STK004", name: "Leke Çıkarıcı", quantity: 5, unit: "Adet", lastUpdate: "12.05.2023", status: "Kritik" }
        ];

        // Global state
        let currentUser = null;
        let selectedCustomerInModal = null;
        let selectedPackage = null;
        let currentContainer = "C000094";
        let currentQuantityProduct = null;
        let barcodeCount = 0;
        let isOnline = true;
        let pendingEmails = [];
        let emailConfig = {
            serviceID: '',
            templateID: '',
            userID: '',
            defaultEmail: ''
        };

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const toast = document.getElementById('toast');
        const modal = document.getElementById('customerModal');
        const allCustomersModal = document.getElementById('allCustomersModal');
        const emailModal = document.getElementById('emailModal');
        const quantityModal = document.getElementById('quantityModal');
        const manualModal = document.getElementById('manualModal');
        const selectAllCheckbox = document.getElementById('selectAllPackages');
        const offlineIndicator = document.getElementById('offlineIndicator');
        const onlineIcon = document.getElementById('onlineIcon');
        const offlineIcon = document.getElementById('offlineIcon');
        const connectionText = document.getElementById('connectionText');

        // Initialize EmailJS with placeholder values
        emailjs.init("user_your_user_id_here"); // This will be updated from saved settings

        function initApp() {
            populateCustomerDropdown();
            populateQuickButtons();
            populatePackagesTable();
            populateStockTable();
            populateShippingTable();
            setupEventListeners();
            loadEmailSettings();
            checkConnection();
            registerServiceWorker();
            
            // Set up online/offline event listeners
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOfflineStatus);
        }

        function setupEventListeners() {
            // Barcode input
            document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchBarcode();
                }
            });

            // Stock search
            document.getElementById('stockSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchStock();
                }
            });

            // File upload
            document.getElementById('stockFileUpload').addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name || '';
                document.getElementById('selectedFileName').textContent = fileName;
            });

            // Select all packages
            selectAllCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    selectAllPackages();
                } else {
                    clearSelection();
                }
            });

            // F2 key for save package
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F2') {
                    e.preventDefault();
                    savePackage();
                }
            });

            // ESC key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    closeAllCustomersModal();
                    closeEmailModal();
                    closeQuantityModal();
                    closeManualModal();
                }
            });
        }

        // NEW: Service Worker Registration for Offline Functionality
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('Service Worker registered with scope:', registration.scope);
                }).catch(function(error) {
                    console.log('Service Worker registration failed:', error);
                });
            }
        }

        // NEW: Online/Offline Status Handling
        function checkConnection() {
            isOnline = navigator.onLine;
            updateConnectionUI();
        }

        function handleOnlineStatus() {
            isOnline = true;
            showToast('İnternet bağlantısı geri geldi', 'success');
            updateConnectionUI();
            
            // Process any pending emails
            processPendingEmails();
            
            // Sync any offline data
            syncOfflineData();
        }

        function handleOfflineStatus() {
            isOnline = false;
            showToast('İnternet bağlantısı kesildi. Çevrimdışı moda geçiliyor.', 'warning');
            updateConnectionUI();
        }

        function updateConnectionUI() {
            if (isOnline) {
                offlineIndicator.style.display = 'none';
                onlineIcon.style.display = 'inline';
                offlineIcon.style.display = 'none';
                connectionText.textContent = 'Çevrimiçi';
                connectionText.className = 'online-status';
            } else {
                offlineIndicator.style.display = 'block';
                onlineIcon.style.display = 'none';
                offlineIcon.style.display = 'inline';
                connectionText.textContent = 'Çevrimdışı';
                connectionText.className = 'offline-status';
            }
        }

        // NEW: Email Settings Management
        function loadEmailSettings() {
            const savedSettings = localStorage.getItem('emailConfig');
            if (savedSettings) {
                emailConfig = JSON.parse(savedSettings);
                document.getElementById('emailServiceID').value = emailConfig.serviceID || '';
                document.getElementById('emailTemplateID').value = emailConfig.templateID || '';
                document.getElementById('emailUserID').value = emailConfig.userID || '';
                document.getElementById('defaultEmail').value = emailConfig.defaultEmail || '';
                
                // Reinitialize EmailJS with saved user ID
                if (emailConfig.userID) {
                    emailjs.init(emailConfig.userID);
                }
            }
        }

        function saveEmailSettings() {
            emailConfig.serviceID = document.getElementById('emailServiceID').value;
            emailConfig.templateID = document.getElementById('emailTemplateID').value;
            emailConfig.userID = document.getElementById('emailUserID').value;
            emailConfig.defaultEmail = document.getElementById('defaultEmail').value;
            
            localStorage.setItem('emailConfig', JSON.stringify(emailConfig));
            
            // Reinitialize EmailJS with new user ID
            if (emailConfig.userID) {
                emailjs.init(emailConfig.userID);
            }
            
            showToast('E-posta ayarları kaydedildi', 'success');
        }

        function testEmailSettings() {
            if (!emailConfig.serviceID || !emailConfig.templateID || !emailConfig.userID) {
                showToast('Lütfen tüm e-posta ayarlarını yapılandırın', 'error');
                return;
            }
            
            const testEmail = emailConfig.defaultEmail || 'test@example.com';
            
            const templateParams = {
                to_email: testEmail,
                subject: 'ProClean E-posta Testi',
                message: 'Bu bir test e-posta\'sıdır. E-posta ayarlarınız düzgün çalışıyor.',
                date: new Date().toLocaleDateString('tr-TR')
            };

            emailjs.send(emailConfig.serviceID, emailConfig.templateID, templateParams)
                .then(function(response) {
                    showToast('Test e-posta\'sı başarıyla gönderildi', 'success');
                }, function(error) {
                    showToast('E-posta gönderilemedi: ' + JSON.stringify(error), 'error');
                });
        }

        // NEW: Offline Data Management
        function saveOfflineSettings() {
            const offlineMode = document.getElementById('offlineMode').checked;
            const autoSync = document.getElementById('autoSync').checked;
            
            localStorage.setItem('offlineMode', offlineMode);
            localStorage.setItem('autoSync', autoSync);
            
            showToast('Çevrimdışı ayarları kaydedildi', 'success');
        }

        function clearOfflineData() {
            if (confirm('Tüm çevrimdışı veriler silinecek. Emin misiniz?')) {
                localStorage.removeItem('offline_packages');
                localStorage.removeItem('offline_containers');
                localStorage.removeItem('pending_emails');
                showToast('Çevrimdışı veriler temizlendi', 'success');
            }
        }

        function syncOfflineData() {
            // Check if there's any offline data to sync
            const offlinePackages = JSON.parse(localStorage.getItem('offline_packages') || '[]');
            const offlineContainers = JSON.parse(localStorage.getItem('offline_containers') || '[]');
            
            if (offlinePackages.length > 0 || offlineContainers.length > 0) {
                showToast('Çevrimdışı veriler senkronize ediliyor...', 'warning');
                
                // Add offline packages to main packages array
                offlinePackages.forEach(pkg => {
                    packages.push(pkg);
                });
                
                // Add offline containers to main containers array
                offlineContainers.forEach(container => {
                    containers.push(container);
                });
                
                // Clear offline data
                localStorage.removeItem('offline_packages');
                localStorage.removeItem('offline_containers');
                
                // Update UI
                populatePackagesTable();
                populateShippingTable();
                
                showToast('Çevrimdışı veriler senkronize edildi', 'success');
            }
        }

        function processPendingEmails() {
            const pending = JSON.parse(localStorage.getItem('pending_emails') || '[]');
            
            if (pending.length > 0) {
                showToast(`${pending.length} bekleyen e-posta işleniyor...`, 'warning');
                
                pending.forEach(email => {
                    emailjs.send(emailConfig.serviceID, emailConfig.templateID, email.params)
                        .then(function(response) {
                            showToast(`E-posta gönderildi: ${email.params.subject}`, 'success');
                            // Remove from pending array
                            pendingEmails = pendingEmails.filter(e => e !== email);
                            localStorage.setItem('pending_emails', JSON.stringify(pendingEmails));
                        }, function(error) {
                            showToast(`E-posta gönderilemedi: ${email.params.subject}`, 'error');
                        });
                });
            }
        }

        // MODIFIED: Save package function to handle offline mode
        function savePackage() {
            const selectedCustomerCode = document.getElementById('customer').value;
            const selectedCustomer = customers.find(c => c.code === selectedCustomerCode);

            if (!selectedCustomer) {
                showToast('Lütfen bir müşteri seçin', 'error');
                return;
            }

            const totalQuantity = products.reduce((sum, p) => sum + p.quantity, 0);
            if (totalQuantity === 0) {
                showToast('Paket için en az bir ürün ekleyin', 'error');
                return;
            }

            const packageNo = `PKG-${String(packages.length + 1).padStart(4, '0')}`;
            const newPackage = {
                id: packages.length + 1,
                packageNo,
                totalQuantity,
                packageTime: new Date().toLocaleString('tr-TR'),
                customerCode: selectedCustomer.code,
                customerName: selectedCustomer.name,
                packer: currentUser?.name || 'Bilinmiyor',
                selected: false
            };

            if (isOnline) {
                packages.push(newPackage);
            } else {
                // Save to offline storage
                const offlinePackages = JSON.parse(localStorage.getItem('offline_packages') || '[]');
                offlinePackages.push(newPackage);
                localStorage.setItem('offline_packages', JSON.stringify(offlinePackages));
                showToast('Paket çevrimdışı depolandı. İnternet bağlantısı geri geldiğinde senkronize edilecek.', 'warning');
            }

            // Reset products
            products.forEach(p => p.quantity = 0);
            barcodeCount = 0;

            populatePackagesTable();
            populateQuickButtons();
            clearBarcode();
            document.getElementById('barcodeCount').textContent = '0';
            updateDefinitionCounts();

            showToast(`Paket kaydedildi: ${packageNo}`, 'success');
        }

        // MODIFIED: Send daily report to handle offline mode
        function sendDailyReport() {
            const email = document.getElementById('reportEmail').value || emailConfig.defaultEmail;
            if (!email) {
                showToast('Lütfen e-posta adresini girin', 'error');
                return;
            }

            const reportData = {
                date: new Date().toLocaleDateString('tr-TR'),
                totalPackages: packages.length,
                totalItems: packages.reduce((sum, pkg) => sum + pkg.totalQuantity, 0),
                containers: containers.length,
                customers: [...new Set(packages.map(p => p.customerName))].length,
                operator: currentUser?.name || 'Bilinmiyor'
            };

            const templateParams = {
                to_email: email,
                subject: `ProClean İş Sonu Raporu - ${reportData.date}`,
                message: `
                    Tarih: ${reportData.date}
                    Operatör: ${reportData.operator}
                    Toplam Paket Sayısı: ${reportData.totalPackages}
                    Toplam Ürün Adedi: ${reportData.totalItems}
                    Konteyner Sayısı: ${reportData.containers}
                    Müşteri Sayısı: ${reportData.customers}
                `,
                date: reportData.date
            };

            if (isOnline && emailConfig.serviceID && emailConfig.templateID) {
                emailjs.send(emailConfig.serviceID, emailConfig.templateID, templateParams)
                    .then(function(response) {
                        showToast('Rapor e-posta ile gönderildi: ' + email, 'success');
                        closeEmailModal();
                    }, function(error) {
                        showToast('E-posta gönderilemedi: ' + JSON.stringify(error), 'error');
                    });
            } else {
                // Save to pending emails for sending later
                pendingEmails.push({ params: templateParams, timestamp: new Date().getTime() });
                localStorage.setItem('pending_emails', JSON.stringify(pendingEmails));
                showToast('E-posta çevrimdışı kuyruğa alındı. İnternet bağlantısı geri geldiğinde gönderilecek.', 'warning');
                closeEmailModal();
            }
        }

        // The rest of the functions remain the same as in the original code
        // (populateCustomerDropdown, populateQuickButtons, populatePackagesTable, etc.)
        // ... [All the other functions from the original code] ...

        function loginUser() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = user;
                document.getElementById('userRole').textContent = `Operatör: ${user.name}`;
                loginScreen.style.display = 'none';
                appContainer.style.display = 'flex';
                initApp();
                showToast('Başarıyla giriş yapıldı', 'success');
            } else {
                showToast('Kullanıcı adı veya şifre hatalı', 'error');
            }
        }

        function logout() {
            currentUser = null;
            appContainer.style.display = 'none';
            loginScreen.style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';

            // Close any open modals
            closeModal();
            closeAllCustomersModal();
            closeEmailModal();
            closeQuantityModal();
            closeManualModal();

            showToast('Başarıyla çıkış yapıldı', 'success');
        }

        // Auto-save every 30 seconds
        setInterval(autoSave, 30000);

        // On load
        window.onload = function() {
            loginScreen.style.display = 'flex';
            appContainer.style.display = 'none';
            loadAutoSave();
        };

        // Service Worker file content would be in a separate sw.js file
        // For simplicity, we're including it here as a string and would
        // need to be registered properly in a production environment
    </script>

    <script>
        // This would normally be in a separate sw.js file
        const serviceWorkerContent = `
        const CACHE_NAME = 'proclean-v1';
        const urlsToCache = [
            '/',
            '/styles/main.css',
            '/script/main.js'
        ];

        self.addEventListener('install', function(event) {
            event.waitUntil(
                caches.open(CACHE_NAME)
                    .then(function(cache) {
                        return cache.addAll(urlsToCache);
                    })
            );
        });

        self.addEventListener('fetch', function(event) {
            event.respondWith(
                caches.match(event.request)
                    .then(function(response) {
                        if (response) {
                            return response;
                        }
                        return fetch(event.request);
                    }
                )
            );
        });
        `;
    </script>
</body>
</html>
