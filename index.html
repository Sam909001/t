<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>

    <!-- Local libraries -->
    <script src="libs/JsBarcode.all.min.js"></script>
    <script src="libs/jspdf.umd.min.js"></script>
    <script src="libs/jspdf.plugin.autotable.min.js"></script>
    <script src="libs/papaparse.min.js"></script>
    <script src="libs/xlsx.full.min.js"></script>
    
    <!-- Local styles -->
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/modals.css">

    <!-- Critical CSS to prevent white screen -->
    <style>
        .login-container { 
            display: flex; /* Ensure login screen is visible initially */
        }
        .app-container {
            display: none; /* Hide app container initially */
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <!-- Loading overlay to prevent white screen -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div style="font-size: 24px; margin-bottom: 20px; color: #2c3e50;">
                ProClean Yükleniyor...
            </div>
            <div style="color: #7f8c8d;">
                Lütfen bekleyin
            </div>
        </div>
    </div>

    <!-- API Key Giriş Modalı -->
    <div class="api-key-modal" id="apiKeyModal">
        <div class="api-key-content">
            <h2>Supabase API Anahtarı Gerekli</h2>
            <p>Uygulamayı kullanabilmek için geçerli bir Supabase API anahtarı girmeniz gerekiyor.</p>
            <input type="text" id="apiKeyInput" class="api-key-input" placeholder="Supabase API Anahtarınızı girin">
            <div class="quantity-buttons">
                <button type="button" class="btn btn-primary" onclick="saveApiKey()">Kaydet</button>
                <button type="button" class="btn btn-secondary" onclick="showApiKeyHelp()">Yardım</button>
            </div>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                API anahtarını nasıl alacağınızı bilmiyorsanız "Yardım" butonuna tıklayın.
            </p>
        </div>
    </div>

    <div class="login-container" id="loginScreen">
        <div class="login-form">
            <h1>ProClean - Oturum Aç</h1>
            <div class="form-group">
                <label for="email">E-posta</label>
                <input type="email" id="email" placeholder="E-posta adresinizi girin" required>
                <div class="validation-error" id="emailError">Geçerli bir e-posta adresi girin</div>
            </div>
            <div class="form-group">
                <label for="password">Şifre</label>
                <input type="password" id="password" placeholder="Şifrenizi girin" required>
                <div class="validation-error" id="passwordError">Şifre gereklidir</div>
            </div>
            <button type="button" class="btn btn-primary" id="loginBtn">Giriş Yap</button>
            <div style="margin-top: 1rem; text-align: center;">
                <a href="#" onclick="showApiKeyModal()" style="color: #3498db; text-decoration: underline; font-size: 0.9rem;">API Anahtarını Yönet</a>
            </div>
        </div>
    </div>

    <!-- Main app container (will be populated by JavaScript) -->
    <div id="app-container-placeholder"></div>

    <!-- Alert container -->
    <div class="alert-container" id="alertContainer"></div>

    <!-- Toast -->
    <div class="toast" id="toast" role="status" aria-live="polite"></div>
    <div class="offline-indicator" id="offlineIndicator">Çevrimdışı Mod</div>

    <!-- Print Label Container (hidden) -->
    <div id="printContainer" style="display:none;"></div>

        <!-- Load components -->
    <script src="src/components/header.html" type="text/html" id="header-template"></script>
    <script src="src/components/modals.html" type="text/html" id="modals-template"></script>
    <script src="src/components/tabs.html" type="text/html" id="tabs-template"></script>

    

    <!-- Load scripts in CORRECT ORDER -->
    <script src="scripts/domUtils.js"></script>
    <script src="scripts/debug.js"></script>
    <script src="scripts/fallback.js"></script>
    <script src="scripts/supabase.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/app.js"></script>
    <script src="scripts/barcode.js"></script>
    <script src="scripts/printing.js"></script>
    <script src="scripts/inventory.js"></script>
    <script src="scripts/reports.js"></script>

    <!-- Initialize app -->
    <script>
        // Function to load HTML components properly
        async function loadHTMLComponent(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to load ${url}: ${response.status}`);
                }
                const html = await response.text();
                
                // Extract content from script tag if it's wrapped
                const template = document.createElement('template');
                template.innerHTML = html;
                
                // Check if it's wrapped in a script tag
                const scriptTag = template.content.querySelector('script[type="text/html"]');
                if (scriptTag) {
                    return scriptTag.textContent;
                }
                return html;
            } catch (error) {
                console.error('Error loading component:', error);
                showAlert(`Bileşen yüklenirken hata oluştu: ${url}`, 'error');
                return null;
            }
        }

        // In your HTML file, update the loadComponents function:

async function loadComponents() {
    console.log('Loading components...');
    
    try {
        // Load tabs component
        const tabsHTML = await loadHTMLComponent('components/tabs.html');
        if (tabsHTML) {
            document.getElementById('app-container-placeholder').innerHTML = tabsHTML;
            console.log('Tabs component loaded');
            
            // After loading tabs, retry finding elements
            setTimeout(() => {
                retryMissingElements();
            }, 100);
        }
        
        // Load modals component
        const modalsHTML = await loadHTMLComponent('components/modals.html');
        if (modalsHTML) {
            let modalsContainer = document.getElementById('modals-container');
            if (!modalsContainer) {
                modalsContainer = document.createElement('div');
                modalsContainer.id = 'modals-container';
                document.body.appendChild(modalsContainer);
            }
            modalsContainer.innerHTML = modalsHTML;
            console.log('Modals component loaded');
        }
        
    } catch (error) {
        console.error('Failed to load components:', error);
    }
}


        
        async function initializeApplication() {
            console.log('Initializing application...');
            
            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
            
            try {
                // Load components first
                await loadComponents();
                
                // Initialize Supabase
                if (typeof initializeSupabase === 'function') {
                    const supabaseClient = initializeSupabase();
                    if (!supabaseClient) {
                        showApiKeyModal();
                    }
                }
                
                // Set up auth listener
                if (typeof setupAuthListener === 'function') {
                    setupAuthListener();
                }
                
                // Set up event listeners
                if (typeof setupEventListeners === 'function') {
                    setupEventListeners();
                }
                
                // Hide loading overlay
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
                
                console.log('Application initialized successfully');
                
            } catch (error) {
                console.error('Application initialization failed:', error);
                
                // Hide loading overlay
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
                
                showAlert('Uygulama başlatılırken hata oluştu. Sayfayı yenileyin.', 'error');
                
                // Show fallback
                if (typeof showFallbackLoader === 'function') {
                    showFallbackLoader();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded, starting application...');
            initializeApplication();
        });
    </script>
</body>
</html>
