<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
            --text: #2c3e50;
            --bg: #f5f7fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html,body { height:100%; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* Login Screen */
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%); }
        .login-form { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .login-form h1 { text-align: center; margin-bottom: 1.5rem; color: var(--primary); }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display:block; margin-bottom:0.5rem; font-weight:500; }
        .form-group input { width:100%; padding:0.8rem; border:1px solid #ddd; border-radius:5px; font-size:1rem; }

        .btn { padding:0.6rem 1rem; border:none; border-radius:5px; cursor:pointer; font-size:0.9rem; font-weight:600; transition:all .3s; display:inline-block; text-align:center; }
        .btn-primary { background:var(--secondary); color:#fff; }
        .btn-primary:hover { background:#2980b9; }
        .btn-link { background:none; color:var(--secondary); text-decoration:underline; padding:0.5rem; }

        /* Main */
        .app-container { display:none; flex-direction:column; height:100vh; }

        /* Header */
        .app-header { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; }
        .app-title { font-size:1.3rem; font-weight:600; }
        .user-info { display:flex; align-items:center; gap:0.8rem; }

        .user-info button {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            background: var(--accent);
            color: white;
            min-width: 100px;
        }
        .user-info button:hover { background: #c0392b; transform: translateY(-1px); }

        /* Tabs */
        .tabs { display:flex; background-color:var(--dark); }
        .tab { padding:0.8rem 1.5rem; color:white; cursor:pointer; font-weight:500; border-bottom:3px solid transparent; font-size:0.9rem; }
        .tab.active { background:var(--light); color:var(--primary); border-bottom:3px solid var(--secondary); }

        /* Content */
        .tab-content { flex-grow:1; padding:1.2rem; overflow:hidden; }
        .tab-pane { display:none; height: calc(100vh - 200px); overflow:auto; }
        .tab-pane.active { display:block; }

        .packaging-header { display:flex; justify-content:space-between; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; align-items: center; }
        .customer-info { display:flex; gap:0.8rem; align-items: center; flex-wrap: wrap; }
        .info-group { display:flex; flex-direction:column; margin-bottom: 0; }
        .info-group label { font-weight:600; margin-bottom:0.2rem; font-size:0.8rem; }
        .info-group select, .info-group input { padding:0.4rem; border:1px solid #ddd; border-radius:5px; font-size:0.8rem; height: auto; }
        .info-group span { font-size: 0.9rem; }
        .action-buttons { display:flex; gap:0.6rem; }

        .packaging-content {
            display: flex;
            gap: 1.2rem;
            align-items: flex-start;
            padding-bottom: 10px;
        }
        .barcode-section { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .pending-packages { flex: 0 0 50%; min-width: 360px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); overflow:auto; }
        .package-details { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); display:flex; flex-direction:column; }

        .barcode-input { display:flex; margin-bottom:0.8rem; }
        .barcode-input input { flex-grow:1; padding:0.6rem; border:1px solid #ddd; border-radius:5px 0 0 5px; font-size:1rem; }
        .barcode-input button { padding:0 0.8rem; border:1px solid #ddd; background:var(--light); cursor:pointer; }

        .package-table { width:100%; border-collapse:collapse; font-size:0.85rem; }
        .package-table th, .package-table td { padding:0.5rem; text-align:left; border-bottom:1px solid #ddd; }
        .package-table th { background:var(--light); font-weight:600; }
        .package-table tr:hover { background:#f9f9f9; }

        .quick-buttons { display:grid; grid-template-columns:repeat(3, 1fr); gap:0.4rem; margin-top:0.8rem; }
        .quick-btn { padding:0.6rem 0.4rem; background:var(--light); border:1px solid #ddd; border-radius:5px; cursor:pointer; text-align:center; font-size:0.8rem; position:relative; }
        .quantity-badge { position:absolute; top:-5px; right:-5px; background:var(--secondary); color:white; border-radius:50%; width:18px; height:18px; font-size:0.7rem; display:flex; align-items:center; justify-content:center; }

        .package-actions { margin-top:auto; display:flex; flex-direction:column; gap:0.6rem; }

        .btn-success { background:var(--success); color:white; }
        .btn-warning { background:var(--warning); color:white; }
        .btn-danger { background:var(--accent); color:white; }

        .status-beklemede { background: var(--warning); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }
        .status-sevk-edildi { background: var(--success); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }

        .app-footer { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; font-size:0.85rem; }
        .container-info { display:flex; align-items:center; gap:0.8rem; }

        /* Toast styles */
        .toast { position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:5px; color:white; z-index:1000; opacity:0; transform:translateY(-20px); transition:all .3s; }
        .toast.show { opacity:1; transform:translateY(0); }
        .toast.success { background:var(--success); } .toast.error { background:var(--accent); } .toast.warning { background:var(--warning); }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; }
        .modal-close { background:none; border:none; font-size:1.5rem; cursor:pointer; }

        .customer-list { max-height:300px; overflow-y:auto; margin-bottom:1rem; }
        .customer-item { padding:0.8rem; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
        .customer-item:hover { background:#f5f5f5; } .customer-item.selected { background:#e3f2fd; }

        .quantity-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center; }
        .quantity-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:300px; text-align:center; }
        .quantity-input { width:100%; padding:0.8rem; margin:1rem 0; border:1px solid #ddd; border-radius:5px; font-size:1.2rem; text-align:center; }
        .quantity-buttons { display:flex; justify-content:center; gap:0.8rem; margin-top:1rem; }

        .stock-search { display:flex; gap:0.8rem; margin-bottom:1.2rem; }
        .stock-search input { flex-grow:1; padding:0.8rem; border:1px solid #ddd; border-radius:5px; }
        .stock-table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .stock-table th, .stock-table td { padding:0.8rem; text-align:left; border-bottom:1px solid #ddd; } .stock-table th { background:var(--light); font-weight:600; } .stock-table tr:hover { background:#f9f9f9; }

        .file-upload { margin-top:1.2rem; padding:1.2rem; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .upload-button { display:inline-block; padding:0.8rem 1.5rem; background:var(--secondary); color:white; border-radius:5px; cursor:pointer; margin-top:0.8rem; }
        .upload-button:hover { background:#2980b9; }

        .offline-indicator { position:fixed; bottom:20px; left:20px; padding:0.8rem 1.2rem; background:var(--accent); color:white; border-radius:5px; z-index:1000; display:none; }

        /* Stock status classes */
        .status-kritik { background:#c0392b;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }
        .status-az-stok { background:#f39c12;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }
        .status-stokta { background:#2ecc71;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }

        /* Responsive */
        @media (max-width:1200px) {
            .barcode-section, .package-details { min-width:200px; }
            .pending-packages { flex: 1 1 60%; }
        }
        @media (max-width:900px) {
            .packaging-content { flex-direction:column; height:auto; }
            .barcode-section, .pending-packages, .package-details { flex: 1 1 auto; width:100%; min-width: auto; }
            .tab-pane { height: auto; }
        }
        /* Add to existing CSS */
        .package-table tr.selected {
            background-color: #e3f2fd !important;
            font-weight: bold;
        }

        .package-table tr.selected:hover {
            background-color: #bbdefb !important;
        }
        
        .api-key-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }
        
        .api-key-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        
        .api-key-input {
            width: 100%;
            padding: 0.8rem;
            margin: 1rem 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        /* Add these styles to your existing CSS */

/* Desktop app styling */
.app-container {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    margin: 20px;
    height: calc(100vh - 40px);
}

.app-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.tabs {
    background: linear-gradient(to bottom, #3a5169 0%, #2c3e50 100%);
}

.tab {
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
}

.tab:hover {
    background: rgba(255, 255, 255, 0.1);
}

.tab.active {
    background: var(--light);
    color: var(--primary);
    border-bottom: 3px solid var(--secondary);
    font-weight: bold;
}

/* Form elements styling */
select, input {
    border: 1px solid #d1d1d1;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 14px;
    transition: all 0.3s;
}

select:focus, input:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

/* Button styling */
.btn {
    border-radius: 4px;
    padding: 8px 16px;
    font-weight: 600;
    transition: all 0.3s;
    border: none;
    cursor: pointer;
}

.btn-primary {
    background: linear-gradient(to bottom, var(--secondary) 0%, #2980b9 100%);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.btn-primary:hover {
    background: linear-gradient(to bottom, #2980b9 0%, #2573a7 100%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

.btn-success {
    background: linear-gradient(to bottom, var(--success) 0%, #27ae60 100%);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.btn-success:hover {
    background: linear-gradient(to bottom, #27ae60 0%, #229954 100%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

.btn-warning {
    background: linear-gradient(to bottom, var(--warning) 0%, #e67e22 100%);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.btn-warning:hover {
    background: linear-gradient(to bottom, #e67e22 0%, #d35400 100%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

.btn-danger {
    background: linear-gradient(to bottom, var(--accent) 0%, #c0392b 100%);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.btn-danger:hover {
    background: linear-gradient(to bottom, #c0392b 0%, #a93226 100%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

/* Card styling */
.barcode-section, .pending-packages, .package-details {
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    background: white;
}

/* Table styling */
.package-table, .stock-table {
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
}

.package-table th, .stock-table th {
    background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
    padding: 12px 15px;
    font-weight: 600;
    text-align: left;
}

.package-table td, .stock-table td {
    padding: 10px 15px;
    border-bottom: 1px solid #e9ecef;
}

.package-table tr:last-child td, .stock-table tr:last-child td {
    border-bottom: none;
}

.package-table tr:hover, .stock-table tr:hover {
    background: #f8f9fa;
}

/* Modal styling */
.modal-content {
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Admin only elements */
.admin-only {
    display: none;
}
    </style>
</head>
<body>
    <div class="api-key-modal" id="apiKeyModal">
        <div class="api-key-content">
            <h2>Supabase API Anahtarı Gerekli</h2>
            <p>Uygulamayı kullanabilmek için geçerli bir Supabase API anahtarı girmeniz gerekiyor.</p>
            <input type="text" id="apiKeyInput" class="api-key-input" placeholder="Supabase API Anahtarınızı girin">
            <div class="quantity-buttons">
                <button type="button" class="btn btn-primary" onclick="saveApiKey()">Kaydet</button>
                <button type="button" class="btn btn-secondary" onclick="showApiKeyHelp()">Yardım</button>
            </div>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                API anahtarını nasıl alacağınızı bilmiyorsanız "Yardım" butonuna tıklayın.
            </p>
        </div>
    </div>

    <div class="login-container" id="loginScreen">
        <div class="login-form">
            <h1>ProClean - Oturum Aç</h1>
            <div class="form-group">
                <label for="email">E-posta</label>
                <input type="email" id="email" placeholder="E-posta adresinizi girin">
            </div>
            <div class="form-group">
                <label for="password">Şifre</label>
                <input type="password" id="password" placeholder="Şifrenizi girin">
            </div>
            <button type="button" class="btn btn-primary" id="loginBtn">Giriş Yap</button>
            <div style="margin-top: 1rem; text-align: center;">
                <a href="#" onclick="showApiKeyModal()" style="color: #3498db; text-decoration: underline; font-size: 0.9rem;">API Anahtarını Yönet</a>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer" aria-hidden="true">
        <div class="app-header">
            <div class="app-title">ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</div>
            <div class="user-info">
                <span id="userRole">Operatör: Yükleniyor...</span>
                <button type="button" id="logoutBtn" class="btn btn-danger">Çıkış Yap</button>
            </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Ana Sekmeler">
            <div class="tab active" data-tab="packaging" role="tab">Paketleme</div>
            <div class="tab" data-tab="shipping" role="tab">Sevkiyat</div>
            <div class="tab" data-tab="stock" role="tab">Stok Sorgu</div>
            <div class="tab admin-only" data-tab="reports" role="tab">Raporlar</div>
        </div>

        <div class="tab-content">
            <div class="tab-pane active" id="packagingTab">
                <div class="packaging-header">
                    <div class="customer-info">
                        <div class="info-group">
                            <label for="customerSelect">Müşteri Seçimi</label>
                            <select id="customerSelect">
                                <option value="">Müşteri seçin...</option>
                            </select>
                        </div>
                        <div class="info-group">
                            <label for="personnelSelect">Personel</label>
                            <select id="personnelSelect">
                                <option value="">Personel seçin...</option>
                            </select>
                        </div>
                        <div class="info-group">
                            <label>Tarih</label>
                            <span id="currentDate">-</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="showAllCustomers()">Müşteri Yönetimi</button>
                        <button type="button" class="btn btn-warning" onclick="generateDailyReport()">İş Sonu Raporu</button>
                        <button type="button" class="btn btn-success" onclick="sendToRamp()">Konteynere Ekle</button>
                    </div>
                </div>

                <div class="packaging-content">
                    <div class="barcode-section">
                        <h3>Barkod Okuma</h3>
                        <div class="barcode-input">
                            <input type="text" id="barcodeInput" placeholder="Barkod okutun veya girin" autofocus>
                            <button type="button" onclick="processBarcode()"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="barcodeResult">
                            <div id="scannedBarcodesDisplay" style="margin-top: 10px; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        
                        <div class="quick-buttons">
                            <div class="quick-btn" onclick="openQuantityModal('Büyük Çarşaf')" data-product="Büyük çarşaf">
                                <span>Büyük çarşaf</span>
                                <div class="quantity-badge" id="Büyük Çarşaf-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Çarşaf')" data-product="Çarşaf">
                                <span>Çarşaf</span>
                                <div class="quantity-badge" id="Çarşaf-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Büyük Nevresim')" data-product="Büyük Nevresim">
                                <span>Büyük Nevresim</span>
                                <div class="quantity-badge" id="Büyük Nevresim-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Nevresim')" data-product="Nevresim">
                                <span>Nevresim</span>
                                <div class="quantity-badge" id="Nevresim-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Büyük Havlu')" data-product="Büyük Havlu">
                                <span>Büyük Havlu</span>
                                <div class="quantity-badge" id="Büyük Havlu-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Havlu')" data-product="Havlu">
                                <span>Havlu</span>
                                <div class="quantity-badge" id="Havlu-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Yastık')" data-product="Yastık">
                                <span>Yastık</span>
                                <div class="quantity-badge" id="Yastık-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Yastık Kılıfı')" data-product="Yastık Kılıfı">
                                <span>Yastık Kılıfı</span>
                                <div class="quantity-badge" id="Yastık Kılıfı-quantity">0</div>
                            </div>
                             <div class="quick-btn" onclick="openQuantityModal('Alez')" data-product="Alez">
                                <span>Alez</span>
                                <div class="quantity-badge" id="Alez-quantity">0</div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="openManualEntry()" style="width:100%; margin-top:1rem;">Manuel Giriş</button>
                    </div>

                    <div class="pending-packages">
                        <h3>Bekleyen Paketler</h3>
                        <table class="package-table">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAllPackages" onchange="toggleSelectAll()">
                                    </th>
                                    <th>Paket No</th>
                                    <th>Müşteri</th>
                                    <th>Adet</th>
                                    <th>Tarih</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTableBody">
                                </tbody>
                        </table>
                    </div>

                    <div class="package-details">
                        <h3>Paket Detayları</h3>
                        <div id="packageDetailContent">
                            <p style="text-align:center; color:#666; margin:2rem 0;">Paket seçin</p>
                        </div>
                        
                        <div class="package-actions">
                            <button type="button" class="btn btn-success" onclick="completePackage()">Paketle</button>
                            <button type="button" class="btn btn-warning" onclick="printLabel()">Etiket Yazdır</button>
                            <button type="button" class="btn btn-danger" onclick="deleteSelectedPackages()">Sil</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="shippingTab">
                <div class="packaging-header">
                    <div class="customer-info">
                        <div class="info-group">
                            <label for="shippingFilter">Durum Filtresi</label>
                            <select id="shippingFilter" onchange="filterShipping()">
                                <option value="all">Tümü</option>
                                <option value="beklemede">Beklemede</option>
                                <option value="sevk-edildi">Sevk Edildi</option>
                            </select>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="createNewContainer()">Yeni Konteyner</button>
                        <button type="button" class="btn btn-warning" onclick="loadCurrentContainer()">Mevcut Konteyner</button>
                        <button type="button" class="btn btn-danger" onclick="deleteContainer()">Konteyner Sil</button>
                    </div>
                </div>

                <table class="package-table">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAllShipping" onchange="toggleSelectAllShipping()">
                            </th>
                            <th>Konteyner No</th>
                            <th>Müşteri</th>
                            <th>Paket Sayısı</th>
                            <th>Toplam Adet</th>
                            <th>Tarih</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="shippingTableBody">
                        </tbody>
                </table>
            </div>

            <div class="tab-pane" id="stockTab">
                <div class="stock-search">
                    <input type="text" id="stockSearch" placeholder="Stok ara..." oninput="searchStock()">
                    <button type="button" class="btn btn-primary" onclick="clearStockSearch()">Temizle</button>
                </div>

                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>Stok Kodu</th>
                            <th>Ürün Adı</th>
                            <th>Mevcut Adet</th>
                            <th>Birim</th>
                            <th>Durum</th>
                            <th>Son Güncelleme</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                        </tbody>
                </table>

                <div class="file-upload">
                    <h3>Stok Dosyası Yükle</h3>
                    <p>Excel (.xlsx, .xls) veya CSV (.csv) dosyası seçin</p>
                    <input type="file" id="stockFileUpload" accept=".xlsx,.xls,.csv" onchange="document.getElementById('selectedFileName').textContent = this.files[0] ? this.files[0].name : ''">
                    <div>
                        <span id="selectedFileName"></span>
                    </div>
                    <button type="button" class="upload-button" onclick="uploadStockFile()">
                        <i class="fas fa-upload"></i> Dosya Yükle
                    </button>
                </div>
            </div>

            <div class="tab-pane admin-only" id="reportsTab">
                <div class="packaging-header">
                    <h3>Raporlar</h3>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="generateCustomReport()">Özel Rapor</button>
                        <button type="button" class="btn btn-warning" onclick="exportReports()">Raporları Dışa Aktar</button>
                    </div>
                </div>

                <div class="report-filters">
                    <div class="info-group">
                        <label for="reportType">Rapor Türü</label>
                        <select id="reportType">
                            <option value="daily">Günlük Rapor</option>
                            <option value="weekly">Haftalık Rapor</option>
                            <option value="monthly">Aylık Rapor</option>
                            <option value="custom">Özel Rapor</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label for="startDate">Başlangıç Tarihi</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="info-group">
                        <label for="endDate">Bitiş Tarihi</label>
                        <input type="date" id="endDate">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="loadReports()">Raporları Yükle</button>
                </div>

                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>Rapor Tarihi</th>
                            <th>Rapor Türü</th>
                            <th>Paket Sayısı</th>
                            <th>Toplam Adet</th>
                            <th>Oluşturan</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="app-footer">
            <div class="container-info">
                <span>Aktif Konteyner: <strong id="containerNumber">Yok</strong></span>
                <span>|</span>
                <span>Toplam Paket: <strong id="totalPackages">0</strong></span>
                <span>|</span>
                <span>ProClean © 2025</span>
            </div>
            <div id="connectionStatus">Çevrimiçi</div>
        </div>
    </div>

    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Müşteri Seç</h3>
                <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="customer-list" id="customerList">
                </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">İptal</button>
            </div>
        </div>
    </div>

    <div class="modal" id="allCustomersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Müşteri Yönetimi</h3>
                <button type="button" class="modal-close" onclick="closeAllCustomersModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="newCustomerCode">Müşteri Kodu</label>
                <input type="text" id="newCustomerCode" placeholder="Örn: P0005">
            </div>
            <div class="form-group">
                <label for="newCustomerName">Müşteri Adı</label>
                <input type="text" id="newCustomerName" placeholder="Müşteri adını girin">
            </div>
            <div class="form-group">
                <label for="newCustomerEmail">E-posta (İsteğe bağlı)</label>
                <input type="email" id="newCustomerEmail" placeholder="E-posta adresini girin">
            </div>
            <button type="button" class="btn btn-primary" onclick="addNewCustomer()">Müşteri Ekle</button>
            
            <hr style="margin: 1.5rem 0;">
            <h4>Mevcut Müşteriler</h4>
            <div class="customer-list" id="allCustomersList">
                </div>
        </div>
    </div>

    <div class="modal" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>İş Sonu Raporu Gönder</h3>
                <button type="button" class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="reportEmail">E-posta Adresi</label>
                <input type="email" id="reportEmail" placeholder="Rapor gönderilecek e-posta">
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" onclick="sendDailyReport()">Rapor Gönder</button>
                <button type="button" class="btn btn-warning" onclick="previewReport()">Önizleme</button>
                <button type="button" class="btn btn-secondary" onclick="closeEmailModal()">İptal</button>
            </div>
        </div>
    </div>

    <div class="quantity-modal" id="quantityModal">
        <div class="quantity-content">
            <h3 id="quantityModalTitle">Adet Girin</h3>
            <input type="number" id="quantityInput" class="quantity-input" min="1" placeholder="Adet">
            <div class="quantity-buttons">
                <button type="button" class="btn btn-primary" onclick="confirmQuantity()">Onayla</button>
                <button type="button" class="btn btn-secondary" onclick="closeQuantityModal()">İptal</button>
            </div>
        </div>
    </div>

    <div class="modal" id="manualModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manuel Ürün Girişi</h3>
                <button type="button" class="modal-close" onclick="closeManualModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="manualProduct">Ürün Adı</label>
                <input type="text" id="manualProduct" placeholder="Ürün adını girin">
            </div>
            <div class="form-group">
                <label for="manualQuantity">Adet</label>
                <input type="number" id="manualQuantity" min="1" placeholder="Adet girin">
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" onclick="addManualProduct()">Ekle</button>
                <button type="button" class="btn btn-secondary" onclick="closeManualModal()">İptal</button>
            </div>
        </div>
    </div>

        <div class="toast" id="toast" role="status" aria-live="polite"></div>
    <div class="offline-indicator" id="offlineIndicator">Çevrimdışı Mod</div>

    <script>
        // Supabase initialization - Varsayılan değerler
        const SUPABASE_URL = 'https://viehnigcbosgsxgehgnn.supabase.co';
        let SUPABASE_ANON_KEY = null;
        let supabase = null;
        
        // Global state variables
        let selectedCustomer = null;
        let currentPackage = { items: {} }; // Holds manually added items
        let currentContainer = null;
        let selectedProduct = null;
        let currentUser = null;
        let scannedBarcodes = []; // Holds barcodes for the current package
        let offlineQueue = [];
        let isOnline = true;

        // Elementleri bir defa tanımla
        const elements = {
            loginScreen: document.getElementById('loginScreen'),
            appContainer: document.getElementById('appContainer'),
            loginButton: document.getElementById('loginBtn'),
            emailInput: document.getElementById('email'),
            passwordInput: document.getElementById('password'),
            customerSelect: document.getElementById('customerSelect'),
            personnelSelect: document.getElementById('personnelSelect'),
            currentDate: document.getElementById('currentDate'),
            barcodeInput: document.getElementById('barcodeInput'),
            packagesTableBody: document.getElementById('packagesTableBody'),
            packageDetailContent: document.getElementById('packageDetailContent'),
            shippingTableBody: document.getElementById('shippingTableBody'),
            stockTableBody: document.getElementById('stockTableBody'),
            customerList: document.getElementById('customerList'),
            allCustomersList: document.getElementById('allCustomersList'),
            toast: document.getElementById('toast'),
            containerNumber: document.getElementById('containerNumber'),
            totalPackages: document.getElementById('totalPackages'),
            shippingFilter: document.getElementById('shippingFilter'),
            stockSearch: document.getElementById('stockSearch'),
            selectAllPackages: document.getElementById('selectAllPackages'),
            apiKeyModal: document.getElementById('apiKeyModal'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            quantityInput: document.getElementById('quantityInput'),
            quantityModal: document.getElementById('quantityModal'),
            quantityModalTitle: document.getElementById('quantityModalTitle'),
            scannedBarcodesDisplay: document.getElementById('scannedBarcodesDisplay'),
            connectionStatus: document.getElementById('connectionStatus')
        };
        
        // =================================================================================
        // CORE & UTILITY FUNCTIONS
        // =================================================================================

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function handleSupabaseError(error, context) {
            console.error(`Supabase error in ${context}:`, error);
            showToast(`${context}: ${error.message}`, 'error');
        }
        
        function initializeSupabase() {
            if (!SUPABASE_ANON_KEY) {
                showApiKeyModal();
                return null;
            }
            try {
                return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } catch (error) {
                console.error('Supabase initialization error:', error);
                showToast('Supabase başlatılamadı. API anahtarını kontrol edin.', 'error');
                showApiKeyModal();
                return null;
            }
        }

        async function initApp() {
            elements.currentDate.textContent = new Date().toLocaleDateString('tr-TR');
            
            await populateCustomers();
            await populatePersonnel();
            loadAppState();
            
            await populatePackagesTable();
            await populateStockTable();
            await populateShippingTable();
            
            await testConnection();
            
            setInterval(saveAppState, 5000); 
            setupOfflineSupport();
            loadOfflineQueue();
        }

        // =================================================================================
        // API KEY & AUTHENTICATION
        // =================================================================================

        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showToast('Lütfen bir API anahtarı girin', 'error');
                return;
            }
            
            localStorage.setItem('procleanApiKey', apiKey);
            SUPABASE_ANON_KEY = apiKey;
            supabase = initializeSupabase();
            
            if (supabase) {
                document.getElementById('apiKeyModal').style.display = 'none';
                showToast('API anahtarı kaydedildi', 'success');
                setupAuthListener(); // Re-setup listener after getting key
            }
        }
        
        function showApiKeyModal() {
            document.getElementById('apiKeyInput').value = SUPABASE_ANON_KEY || '';
            document.getElementById('apiKeyModal').style.display = 'flex';
        }

        function showApiKeyHelp() {
            const helpContent = `
                <h1>Supabase API Anahtarı Nasıl Alınır?</h1>
                <div style="margin-bottom: 20px; padding: 15px; background: #f5f7fa; border-radius: 5px;">
                    <h3>1. Supabase hesabınıza giriş yapın</h3>
                    <p><a href="https://supabase.com/dashboard" target="_blank">https://supabase.com/dashboard</a></p>
                </div>
                <div style="margin-bottom: 20px; padding: 15px; background: #f5f7fa; border-radius: 5px;">
                    <h3>2. Projenizi seçin veya yeni proje oluşturun</h3>
                </div>
                <div style="margin-bottom: 20px; padding: 15px; background: #f5f7fa; border-radius: 5px;">
                    <h3>3. Sol menüden Settings (Ayarlar) > API yolunu izleyin</h3>
                </div>
                <div style="margin-bottom: 20px; padding: 15px; background: #f5f7fa; border-radius: 5px;">
                    <h3>4. "Project API Keys" bölümündeki "anon" veya "public" anahtarını kopyalayın</h3>
                    <p>Bu, 'SUPABASE_ANON_KEY' olarak da bilinir. Bu anahtarı uygulamadaki API anahtarı alanına yapıştırın.</p>
                </div>
            `;
            const helpWindow = window.open('', '_blank');
            helpWindow.document.write(`<html><head><title>API Anahtarı Yardımı</title><style>body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }</style></head><body>${helpContent}</body></html>`);
        }

        async function testConnection() {
            if (!supabase) return;
            try {
                const { error } = await supabase.from('customers').select('id').limit(1);
                if (error) throw error;
                console.log('Supabase connection test successful.');
            } catch (e) {
                handleSupabaseError(e, 'Veritabanı bağlantı testi başarısız');
            }
        }

        async function login() {
            if (!supabase) {
                showToast('Lütfen önce API anahtarını girin.', 'error');
                showApiKeyModal();
                return;
            }

            const email = elements.emailInput.value;
            const password = elements.passwordInput.value;
            if (!email || !password) {
                showToast('Lütfen e-posta ve şifrenizi girin.', 'error');
                return;
            }

            elements.loginButton.disabled = true;
            elements.loginButton.textContent = 'Giriş yapılıyor...';

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                // Auth state change will handle the rest
            } catch (error) {
                handleSupabaseError(error, 'Giriş başarısız');
            } finally {
                elements.loginButton.disabled = false;
                elements.loginButton.textContent = 'Giriş Yap';
            }
        }

        function applyRoleBasedPermissions(role) {
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            const displayStyle = (role === 'admin') ? 'block' : 'none';
            adminOnlyElements.forEach(el => el.style.display = displayStyle);
        }

        async function logout() {
            if (!supabase) return;
            const { error } = await supabase.auth.signOut();
            if (error) {
                handleSupabaseError(error, 'Çıkış yapılamadı');
            } else {
                showToast('Başarıyla çıkış yapıldı.', 'success');
                clearAppState();
                // Auth state change will handle UI switch
            }
        }

        function setupAuthListener() {
            if (!supabase) return;
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (session && session.user) {
                    const { data: userData, error } = await supabase
                        .from('personnel')
                        .select('role, name, id')
                        .eq('email', session.user.email)
                        .single();

                    if (error && error.code !== 'PGRST116') { // Ignore "No rows found"
                        handleSupabaseError(error, 'Kullanıcı rolü alınamadı');
                    }
                    
                    currentUser = {
                        email: session.user.email,
                        uid: session.user.id,
                        name: userData?.name || session.user.email.split('@')[0],
                        role: userData?.role || 'operator',
                        personnel_id: userData?.id
                    };

                    document.getElementById('userRole').textContent = `${currentUser.role === 'admin' ? 'Yönetici' : 'Operatör'}: ${currentUser.name}`;
                    applyRoleBasedPermissions(currentUser.role);
                    
                    elements.loginScreen.style.display = 'none';
                    elements.appContainer.style.display = 'flex';
                    
                    if(event !== 'INITIAL_SESSION') initApp();

                } else {
                    currentUser = null;
                    elements.loginScreen.style.display = 'flex';
                    elements.appContainer.style.display = 'none';
                }
            });
        }
        
        // =================================================================================
        // STATE MANAGEMENT
        // =================================================================================

        function saveAppState() {
            const state = {
                selectedCustomerId: selectedCustomer ? selectedCustomer.id : null,
                selectedPersonnelId: elements.personnelSelect.value,
                currentContainer: currentContainer,
            };
            localStorage.setItem('procleanState', JSON.stringify(state));
        }

        function loadAppState() {
            const savedState = localStorage.getItem('procleanState');
            if (savedState) {
                const state = JSON.parse(savedState);
                if (state.selectedCustomerId) elements.customerSelect.value = state.selectedCustomerId;
                if (state.selectedPersonnelId) elements.personnelSelect.value = state.selectedPersonnelId;
                if (state.currentContainer) {
                    currentContainer = state.currentContainer;
                    elements.containerNumber.textContent = currentContainer;
                }
            }
        }

        function clearAppState() {
            localStorage.removeItem('procleanState');
            selectedCustomer = null;
            elements.customerSelect.value = '';
            elements.personnelSelect.value = '';
            currentContainer = null;
            elements.containerNumber.textContent = 'Yok';
            resetPackageCreationState();
        }

        function resetPackageCreationState() {
            currentPackage = { items: {} };
            scannedBarcodes = [];
            document.querySelectorAll('.quantity-badge').forEach(badge => badge.textContent = '0');
            displayScannedBarcodes();
            document.getElementById('packageDetailContent').innerHTML = '<p style="text-align:center; color:#666; margin:2rem 0;">Paket seçin</p>';
        }

        // =================================================================================
        // OFFLINE SUPPORT
        // =================================================================================

        function setupOfflineSupport() {
            const updateOnlineStatus = () => {
                isOnline = navigator.onLine;
                document.getElementById('offlineIndicator').style.display = isOnline ? 'none' : 'block';
                elements.connectionStatus.textContent = isOnline ? 'Çevrimiçi' : 'Çevrimdışı';
                if (isOnline) {
                    showToast('Çevrimiçi moda geçildi. Veriler senkronize ediliyor...', 'success');
                    syncOfflineData();
                } else {
                    showToast('Çevrimdışı moda geçildi. Değişiklikler kaydedilecek.', 'warning');
                }
            };
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus(); // Initial check
        }

        function loadOfflineQueue() {
            const queue = localStorage.getItem('procleanOfflineQueue');
            if (queue) offlineQueue = JSON.parse(queue);
            console.log('Offline queue loaded:', offlineQueue.length, 'items');
        }

        function saveOfflineQueue() {
            localStorage.setItem('procleanOfflineQueue', JSON.stringify(offlineQueue));
        }

        function addToOfflineQueue(type, data) {
            offlineQueue.push({ type, data, timestamp: new Date().toISOString() });
            saveOfflineQueue();
        }

        async function syncOfflineData() {
            if (offlineQueue.length === 0 || !isOnline) return;
            showToast(`Çevrimdışı veriler senkronize ediliyor (${offlineQueue.length} öğe)...`, 'warning');
            
            const remainingItems = [];
            let successfullySynced = 0;

            for (const item of offlineQueue) {
                try {
                    if (item.type === 'package') {
                        const { package: packageData, items: packageItems } = item.data;
                        
                        // 1. Insert package
                        const { data: newPackage, error: packageError } = await supabase
                            .from('packages').insert([packageData]).select().single();
                        if (packageError) throw packageError;

                        // 2. Prepare and insert package items with the new ID
                        if (packageItems && packageItems.length > 0) {
                            const itemsForDb = packageItems.map(pi => ({
                                package_id: newPackage.id,
                                product_name: pi.product_name,
                                quantity: pi.quantity,
                                barcode: pi.barcode,
                                scanned_by: packageData.personnel_id
                            }));
                            const { error: itemsError } = await supabase.from('package_items').insert(itemsForDb);
                            if (itemsError) throw itemsError;
                        }
                        successfullySynced++;
                    }
                } catch (error) {
                    console.error('Error syncing item, it will be kept in queue:', item, error);
                    remainingItems.push(item);
                }
            }

            offlineQueue = remainingItems;
            saveOfflineQueue();

            if (successfullySynced > 0) {
                showToast(`${successfullySynced} çevrimdışı öğe senkronize edildi.`, 'success');
                await populatePackagesTable();
                await populateShippingTable();
            }
            if (remainingItems.length > 0) {
                showToast(`${remainingItems.length} öğe senkronize edilemedi, daha sonra denenecek.`, 'error');
            }
        }

        // =================================================================================
        // DATA POPULATION FUNCTIONS
        // =================================================================================

        async function populateCustomers() {
            try {
                const { data, error } = await supabase.from('customers').select('*').order('name');
                if (error) throw error;
                elements.customerSelect.innerHTML = '<option value="">Müşteri seçin...</option>';
                data.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = `${c.name} (${c.code})`;
                    elements.customerSelect.appendChild(option);
                });
            } catch (error) {
                handleSupabaseError(error, 'Müşteriler yüklenemedi');
            }
        }

        async function populatePersonnel() {
            try {
                const { data, error } = await supabase.from('personnel').select('*').order('name');
                if (error) throw error;
                elements.personnelSelect.innerHTML = '<option value="">Personel seçin...</option>';
                data.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    elements.personnelSelect.appendChild(option);
                });
            } catch (error) {
                handleSupabaseError(error, 'Personel yüklenemedi');
            }
        }

        async function populatePackagesTable() {
            try {
                const { data, error } = await supabase.from('packages')
                    .select(`*, customers (name, code), personnel (name)`)
                    .is('container_id', null).order('created_at', { ascending: false });
                if (error) throw error;

                elements.packagesTableBody.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(pkg => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="checkbox" value="${pkg.id}" onchange="updatePackageSelection()"></td>
                            <td>${pkg.package_no}</td>
                            <td>${pkg.customers?.name || 'N/A'}</td>
                            <td>${pkg.total_items}</td>
                            <td>${new Date(pkg.created_at).toLocaleDateString('tr-TR')}</td>
                            <td><span class="status-${pkg.status}">${pkg.status}</span></td>
                        `;
                        row.onclick = (e) => { if (e.target.type !== 'checkbox') selectPackage(pkg.id); };
                        elements.packagesTableBody.appendChild(row);
                    });
                    elements.totalPackages.textContent = data.length;
                } else {
                    elements.packagesTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Bekleyen paket yok</td></tr>';
                    elements.totalPackages.textContent = 0;
                }
            } catch (error) {
                handleSupabaseError(error, 'Paketler yüklenemedi');
            }
        }
        
        async function populateShippingTable() {
            try {
                const filter = elements.shippingFilter?.value || 'all';
                let query = supabase.from('containers').select(`*, packages (customers (name))`);
                if (filter !== 'all') query = query.eq('status', filter);
                
                const { data, error } = await query.order('created_at', { ascending: false });
                if (error) throw error;

                elements.shippingTableBody.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(c => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="checkbox" value="${c.id}"></td>
                            <td>${c.container_no}</td>
                            <td>${c.packages[0]?.customers?.name || c.customer || 'N/A'}</td>
                            <td>${c.package_count || 0}</td>
                            <td>${c.total_items || 0}</td>
                            <td>${new Date(c.created_at).toLocaleDateString('tr-TR')}</td>
                            <td><span class="status-${c.status}">${c.status}</span></td>
                            <td>
                                <button onclick="shipContainer('${c.id}')" class="btn btn-success">Sevk Et</button>
                            </td>
                        `;
                        elements.shippingTableBody.appendChild(row);
                    });
                } else {
                    elements.shippingTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Sevkiyat verisi yok</td></tr>';
                }
            } catch (error) {
                handleSupabaseError(error, 'Sevkiyat verileri yüklenemedi');
            }
        }

        async function populateStockTable() {
            try {
                const { data, error } = await supabase.from('stock_items').select('*').order('name');
                if (error) throw error;

                elements.stockTableBody.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(item => {
                        let statusClass = 'status-stokta', statusText = 'Stokta';
                        if (item.quantity <= 0) { statusClass = 'status-kritik'; statusText = 'Kritik'; } 
                        else if (item.quantity < 10) { statusClass = 'status-az-stok'; statusText = 'Az Stok'; }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.code}</td>
                            <td>${item.name}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit || 'Adet'}</td>
                            <td><span class="${statusClass}">${statusText}</span></td>
                            <td>${new Date(item.updated_at).toLocaleDateString('tr-TR')}</td>
                        `;
                        elements.stockTableBody.appendChild(row);
                    });
                } else {
                    elements.stockTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Stok verisi yok</td></tr>';
                }
            } catch (error) {
                handleSupabaseError(error, 'Stok verileri yüklenemedi');
            }
        }

        // =================================================================================
        // PACKAGING TAB OPERATIONS
        // =================================================================================

        function processBarcode() {
            const barcode = elements.barcodeInput.value.trim();
            if (!barcode) return;
            if (!selectedCustomer) {
                showToast('Önce müşteri seçin', 'error');
                return;
            }

            scannedBarcodes.push({ barcode, created_at: new Date().toISOString() });
            showToast(`Barkod eklendi: ${barcode}`, 'success');
            
            elements.barcodeInput.value = '';
            elements.barcodeInput.focus();
            displayScannedBarcodes();
        }

        function displayScannedBarcodes() {
            const container = elements.scannedBarcodesDisplay;
            container.innerHTML = '';
            if (scannedBarcodes.length === 0) {
                container.innerHTML = '<p style="color:#666; text-align:center; font-size:0.8rem;">Barkod bekleniyor</p>';
                return;
            }
            const list = document.createElement('ul');
            list.style = 'list-style: none; padding: 0; margin: 0; font-size: 0.8rem;';
            scannedBarcodes.forEach(item => {
                const li = document.createElement('li');
                li.style = 'padding: 5px; border-bottom: 1px solid #eee;';
                li.textContent = item.barcode;
                list.appendChild(li);
            });
            container.appendChild(list);
        }

        async function completePackage() {
            if (!selectedCustomer) {
                showToast('Önce müşteri seçin', 'error');
                return;
            }

            const manualItemCount = Object.values(currentPackage.items).reduce((sum, qty) => sum + qty, 0);
            const totalQuantity = manualItemCount + scannedBarcodes.length;

            if (totalQuantity === 0) {
                showToast('Pakete ürün ekleyin', 'error');
                return;
            }

            const packageNo = `PKG-${Date.now()}`;
            const personnelId = elements.personnelSelect.value || currentUser?.personnel_id || null;
            
            const packageData = {
                package_no: packageNo,
                customer_id: selectedCustomer.id,
                personnel_id: personnelId,
                total_items: totalQuantity,
                status: 'beklemede',
                packer: currentUser?.name || 'Bilinmeyen',
                created_at: new Date().toISOString()
            };

            const itemsToSave = [];
            // Manual items
            for (const [productName, quantity] of Object.entries(currentPackage.items)) {
                itemsToSave.push({ product_name: productName, quantity: quantity, barcode: null });
            }
            // Scanned items
            scannedBarcodes.forEach(item => {
                itemsToSave.push({ product_name: 'Okutulan Ürün', quantity: 1, barcode: item.barcode });
            });

            if (!isOnline) {
                addToOfflineQueue('package', { package: packageData, items: itemsToSave });
                showToast(`Paket çevrimdışı oluşturuldu: ${packageNo}`, 'warning');
                resetPackageCreationState();
                return;
            }

            try {
                // Online: Insert package then items
                const { data: newPackage, error: pkgError } = await supabase.from('packages').insert([packageData]).select().single();
                if (pkgError) throw pkgError;

                const packageItemsForDb = itemsToSave.map(item => ({
                    ...item,
                    package_id: newPackage.id,
                    scanned_by: personnelId
                }));

                const { error: itemsError } = await supabase.from('package_items').insert(packageItemsForDb);
                if (itemsError) {
                    // Attempt to delete the package if items fail to insert
                    await supabase.from('packages').delete().eq('id', newPackage.id);
                    throw itemsError;
                }

                showToast(`Paket oluşturuldu: ${packageNo}`, 'success');
                resetPackageCreationState();
                await populatePackagesTable();
            } catch (error) {
                handleSupabaseError(error, 'Paket oluşturulamadı');
            }
        }
        
        async function selectPackage(packageId) {
            document.querySelectorAll('#packagesTableBody tr').forEach(row => row.classList.remove('selected'));
            const selectedRow = Array.from(document.querySelectorAll('#packagesTableBody tr')).find(row => row.querySelector(`input[value="${packageId}"]`));
            if (selectedRow) selectedRow.classList.add('selected');
            
            try {
                const { data: pkg, error: pkgError } = await supabase.from('packages')
                    .select('*, customers(name), personnel(name)').eq('id', packageId).single();
                if (pkgError) throw pkgError;
                
                const { data: items, error: itemsError } = await supabase.from('package_items')
                    .select('*').eq('package_id', packageId);
                if (itemsError) throw itemsError;

                let itemsHtml = '<p>Bu pakette ürün detayı yok.</p>';
                if (items && items.length > 0) {
                    itemsHtml = `
                        <h5>Ürünler (${items.reduce((sum, i) => sum + i.quantity, 0)} adet):</h5>
                        <ul style="max-height: 200px; overflow-y: auto; list-style-position: inside; padding-left: 5px;">
                            ${items.map(item => `<li>${item.barcode || item.product_name}: ${item.quantity} adet</li>`).join('')}
                        </ul>
                    `;
                }

                elements.packageDetailContent.innerHTML = `
                    <h4>Paket: ${pkg.package_no}</h4>
                    <p><strong>Müşteri:</strong> ${pkg.customers?.name || 'N/A'}</p>
                    <p><strong>Toplam Adet:</strong> ${pkg.total_items}</p>
                    <p><strong>Paketleyen:</strong> ${pkg.personnel?.name || pkg.packer || 'Bilinmiyor'}</p>
                    <hr>${itemsHtml}
                `;
            } catch (error) {
                handleSupabaseError(error, 'Paket detayları alınamadı');
                elements.packageDetailContent.innerHTML = '<p>Detaylar yüklenemedi.</p>';
            }
        }
        
        async function deleteSelectedPackages() {
            const packageIds = Array.from(document.querySelectorAll('#packagesTableBody input:checked')).map(cb => cb.value);
            if (packageIds.length === 0) return;
            if (!confirm(`${packageIds.length} paketi silmek istediğinize emin misiniz?`)) return;

            try {
                // Must delete items before packages due to foreign key constraints
                const { error: itemsError } = await supabase.from('package_items').delete().in('package_id', packageIds);
                if (itemsError) throw itemsError;

                const { error: pkgError } = await supabase.from('packages').delete().in('id', packageIds);
                if (pkgError) throw pkgError;

                showToast(`${packageIds.length} paket silindi`, 'success');
                await populatePackagesTable();
                resetPackageCreationState();
            } catch (error) {
                handleSupabaseError(error, 'Paketler silinemedi');
            }
        }

        // =================================================================================
        // SHIPPING TAB OPERATIONS
        // =================================================================================
        
        async function sendToRamp() {
            const packageIds = Array.from(document.querySelectorAll('#packagesTableBody input:checked')).map(cb => cb.value);
            if (packageIds.length === 0) {
                showToast('Konteynere eklemek için paket seçin', 'error');
                return;
            }

            try {
                if (!currentContainer) {
                    await createNewContainer(false); // Create a new container silently
                }
                
                const { data: container, error: containerError } = await supabase.from('containers')
                    .select('id').eq('container_no', currentContainer).single();
                if (containerError) throw containerError;
                
                const { error: updateError } = await supabase.from('packages')
                    .update({ container_id: container.id, status: 'sevk-edildi' }).in('id', packageIds);
                if (updateError) throw updateError;
                
                // Recalculate container totals
                await updateContainerTotals(container.id);

                showToast(`${packageIds.length} paket konteynere eklendi`, 'success');
                await populatePackagesTable();
                await populateShippingTable();
            } catch (error) {
                handleSupabaseError(error, 'Paketler konteynere eklenemedi');
            }
        }
        
        async function updateContainerTotals(containerId) {
            const { data: packages, error } = await supabase.from('packages')
                .select('total_items, customers(name)').eq('container_id', containerId);
            
            if (error) {
                console.error("Could not update container totals", error);
                return;
            }

            const totalItems = packages.reduce((sum, p) => sum + p.total_items, 0);
            const packageCount = packages.length;
            const customerName = packages.length > 0 ? packages[0].customers.name : '';

            await supabase.from('containers').update({
                total_items: totalItems,
                package_count: packageCount,
                customer: customerName
            }).eq('id', containerId);
        }

        async function createNewContainer(showSuccessToast = true) {
            try {
                const containerNo = `CONT-${Date.now().toString().slice(-6)}`;
                const { data, error } = await supabase.from('containers')
                    .insert({ container_no: containerNo, status: 'beklemede' }).select().single();
                if (error) throw error;
                
                elements.containerNumber.textContent = data.container_no;
                currentContainer = data.container_no;
                saveAppState();
                
                if(showSuccessToast) showToast(`Yeni konteyner oluşturuldu: ${containerNo}`, 'success');
                await populateShippingTable();
            } catch (error) {
                handleSupabaseError(error, 'Yeni konteyner oluşturulamadı');
            }
        }

        async function shipContainer(containerId) {
            if (!confirm("Bu konteyneri sevk etmek istediğinize emin misiniz?")) return;
            try {
                const { error } = await supabase.from('containers').update({ status: 'sevk-edildi' }).eq('id', containerId);
                if (error) throw error;
                showToast('Konteyner sevk edildi', 'success');
                await populateShippingTable();
            } catch (error) {
                handleSupabaseError(error, 'Konteyner sevk edilemedi');
            }
        }

        // =================================================================================
        // OTHER FUNCTIONS (STOCK, REPORTS, UI)
        // =================================================================================

        function openQuantityModal(product) {
            selectedProduct = product;
            elements.quantityModalTitle.textContent = `${product} - Adet Girin`;
            elements.quantityInput.value = '';
            elements.quantityModal.style.display = 'flex';
            elements.quantityInput.focus();
        }

        function confirmQuantity() {
            const quantity = parseInt(elements.quantityInput.value);
            if (!quantity || quantity <= 0) {
                showToast('Geçerli bir adet girin', 'error');
                return;
            }
            const badge = document.getElementById(`${selectedProduct}-quantity`);
            if (badge) badge.textContent = (parseInt(badge.textContent) || 0) + quantity;
            currentPackage.items[selectedProduct] = (currentPackage.items[selectedProduct] || 0) + quantity;
            showToast(`${selectedProduct}: ${quantity} adet eklendi`, 'success');
            closeQuantityModal();
        }
        
        async function generateDailyReport() {
            try {
                const today = new Date();
                const startOfDay = new Date(today.setHours(0, 0, 0, 0)).toISOString();
                const endOfDay = new Date(today.setHours(23, 59, 59, 999)).toISOString();

                const { data: packages, error } = await supabase.from('packages')
                    .select(`*, customers (name)`).gte('created_at', startOfDay).lte('created_at', endOfDay);
                if (error) throw error;

                const reportData = {
                    date: new Date().toLocaleDateString('tr-TR'),
                    totalPackages: packages.length,
                    totalItems: packages.reduce((sum, pkg) => sum + pkg.total_items, 0),
                    packages: packages,
                    operator: currentUser?.name || 'Bilinmiyor'
                };
                
                // This is a placeholder for a backend function. In a real app,
                // this logic would be on a server that can securely send emails.
                console.log("Generated Report Data:", reportData);
                showToast("Rapor oluşturuldu ve e-posta gönderim ekranı açıldı.", "success");

                document.getElementById('reportEmail').value = selectedCustomer?.email || '';
                document.getElementById('emailModal').style.display = 'flex';
                
                // We'll pass the generated data via a global variable for preview/send simulation
                window.currentReportData = reportData;

            } catch (error) {
                handleSupabaseError(error, 'Günlük rapor oluşturulamadı');
            }
        }

        function sendDailyReport() {
             const email = document.getElementById('reportEmail').value;
            if (!email) {
                showToast('Lütfen e-posta adresini girin', 'error');
                return;
            }
            // Simulate sending email
            showToast(`Rapor ${email} adresine gönderiliyor... (Simülasyon)`, 'warning');
            setTimeout(() => {
                showToast(`Rapor başarıyla gönderildi.`, 'success');
                closeEmailModal();
            }, 2000);
        }

        function previewReport() {
            if (!window.currentReportData) {
                showToast("Önce rapor oluşturun.", "error");
                return;
            }
            const reportData = window.currentReportData;
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <html><head><title>İş Sonu Raporu - ${reportData.date}</title>
                <style>body{font-family:Arial} table{width:100%; border-collapse:collapse; margin-top:20px} th,td{border:1px solid #ddd; padding:8px}</style></head>
                <body><h1>ProClean - İş Sonu Raporu</h1><p><strong>Tarih:</strong> ${reportData.date} | <strong>Operatör:</strong> ${reportData.operator}</p>
                <h2>Özet</h2><ul><li>Toplam Paket Sayısı: ${reportData.totalPackages}</li><li>Toplam Ürün Adedi: ${reportData.totalItems}</li></ul>
                <h2>Paket Detayları</h2><table><thead><tr><th>Paket No</th><th>Müşteri</th><th>Adet</th></tr></thead><tbody>
                ${reportData.packages.map(p => `<tr><td>${p.package_no}</td><td>${p.customers.name}</td><td>${p.total_items}</td></tr>`).join('')}
                </tbody></table></body></html>
            `);
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // Modal closing functions
        function closeEmailModal() { document.getElementById('emailModal').style.display = 'none'; }
        function closeModal() { document.getElementById('customerModal').style.display = 'none'; }
        function closeAllCustomersModal() { document.getElementById('allCustomersModal').style.display = 'none'; }
        function closeQuantityModal() { document.getElementById('quantityModal').style.display = 'none'; }
        function closeManualModal() { document.getElementById('manualModal').style.display = 'none'; }
        
        // =================================================================================
        // EVENT LISTENERS & INITIALIZATION
        // =================================================================================

        document.addEventListener('DOMContentLoaded', function() {
            const savedApiKey = localStorage.getItem('procleanApiKey');
            if (savedApiKey) {
                SUPABASE_ANON_KEY = savedApiKey;
                supabase = initializeSupabase();
                if (supabase) {
                    setupAuthListener();
                }
            } else {
                showApiKeyModal();
            }
            
            elements.loginButton.addEventListener('click', login);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            const handleEnter = (e, func) => { if (e.key === 'Enter') func(); };
            elements.emailInput.addEventListener('keypress', e => handleEnter(e, login));
            elements.passwordInput.addEventListener('keypress', e => handleEnter(e, login));
            elements.quantityInput.addEventListener('keypress', e => handleEnter(e, confirmQuantity));
            elements.barcodeInput.addEventListener('keypress', e => handleEnter(e, processBarcode));
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            elements.customerSelect.addEventListener('change', function() {
                if (this.value) {
                    const opt = this.options[this.selectedIndex];
                    selectedCustomer = {
                        id: this.value,
                        name: opt.textContent.split(' (')[0],
                        code: opt.textContent.match(/\(([^)]+)\)/)?.[1] || ''
                    };
                    showToast(`Müşteri seçildi: ${selectedCustomer.name}`, 'success');
                } else {
                    selectedCustomer = null;
                }
            });
        });

    </script>
</body>
</html>
