<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
            --text: #2c3e50;
            --bg: #f5f7fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html,body { height:100%; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* Login Screen */
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%); }
        .login-form { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .login-form h1 { text-align: center; margin-bottom: 1.5rem; color: var(--primary); }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display:block; margin-bottom:0.5rem; font-weight:500; }
        .form-group input { width:100%; padding:0.8rem; border:1px solid #ddd; border-radius:5px; font-size:1rem; }

        .btn { padding:0.6rem 1rem; border:none; border-radius:5px; cursor:pointer; font-size:0.9rem; font-weight:600; transition:all .3s; display:inline-block; text-align:center; }
        .btn-primary { background:var(--secondary); color:#fff; }
        .btn-primary:hover { background:#2980b9; }
        .btn-link { background:none; color:var(--secondary); text-decoration:underline; padding:0.5rem; }

        /* Main */
        .app-container { display:none; flex-direction:column; height:100vh; }

        /* Header */
        .app-header { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; }
        .app-title { font-size:1.3rem; font-weight:600; }
        .user-info { display:flex; align-items:center; gap:0.8rem; }

        .user-info button {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            background: var(--accent);
            color: white;
            min-width: 100px;
        }
        .user-info button:hover { background: #c0392b; transform: translateY(-1px); }

        /* Tabs */
        .tabs { display:flex; background-color:var(--dark); }
        .tab { padding:0.8rem 1.5rem; color:white; cursor:pointer; font-weight:500; border-bottom:3px solid transparent; font-size:0.9rem; }
        .tab.active { background:var(--light); color:var(--primary); border-bottom:3px solid var(--secondary); }

        /* Content */
        .tab-content { flex-grow:1; padding:1.2rem; overflow:hidden; }
        .tab-pane { display:none; height: calc(100vh - 200px); overflow:auto; }
        .tab-pane.active { display:block; }

        .packaging-header { display:flex; justify-content:space-between; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; align-items: center; }
        .customer-info { display:flex; gap:0.8rem; align-items: center; flex-wrap: wrap; }
        .info-group { display:flex; flex-direction:column; margin-bottom: 0; }
        .info-group label { font-weight:600; margin-bottom:0.2rem; font-size:0.8rem; }
        .info-group select, .info-group input { padding:0.4rem; border:1px solid #ddd; border-radius:5px; font-size:0.8rem; height: auto; }
        .info-group span { font-size: 0.9rem; }
        .action-buttons { display:flex; gap:0.6rem; }

        .packaging-content {
            display: flex;
            gap: 1.2rem;
            align-items: flex-start;
            padding-bottom: 10px;
        }
        .barcode-section { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .pending-packages { flex: 0 0 50%; min-width: 360px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); overflow:auto; }
        .package-details { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); display:flex; flex-direction:column; }

        .barcode-input { display:flex; margin-bottom:0.8rem; }
        .barcode-input input { flex-grow:1; padding:0.6rem; border:1px solid #ddd; border-radius:5px 0 0 5px; font-size:1rem; }
        .barcode-input button { padding:0 0.8rem; border:1px solid #ddd; background:var(--light); cursor:pointer; }

        .package-table { width:100%; border-collapse:collapse; font-size:0.85rem; }
        .package-table th, .package-table td { padding:0.5rem; text-align:left; border-bottom:1px solid #ddd; }
        .package-table th { background:var(--light); font-weight:600; }
        .package-table tr:hover { background:#f9f9f9; }

        .quick-buttons { display:grid; grid-template-columns:repeat(3, 1fr); gap:0.4rem; margin-top:0.8rem; }
        .quick-btn { padding:0.6rem 0.4rem; background:var(--light); border:1px solid #ddd; border-radius:5px; cursor:pointer; text-align:center; font-size:0.8rem; position:relative; }
        .quantity-badge { position:absolute; top:-5px; right:-5px; background:var(--secondary); color:white; border-radius:50%; width:18px; height:18px; font-size:0.7rem; display:flex; align-items:center; justify-content:center; }

        .package-actions { margin-top:auto; display:flex; flex-direction:column; gap:0.6rem; }

        .btn-success { background:var(--success); color:white; }
        .btn-warning { background:var(--warning); color:white; }
        .btn-danger { background:var(--accent); color:white; }

        .status-beklemede { background: var(--warning); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }
        .status-sevk-edildi { background: var(--success); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }

        .app-footer { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; font-size:0.85rem; }
        .container-info { display:flex; align-items:center; gap:0.8rem; }

        /* Toast styles */
        .toast { position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:5px; color:white; z-index:1000; opacity:0; transform:translateY(-20px); transition:all .3s; }
        .toast.show { opacity:1; transform:translateY(0); }
        .toast.success { background:var(--success); } .toast.error { background:var(--accent); } .toast.warning { background:var(--warning); }

        /* Customer folder styles for sevkiyat */
        .customer-folder {
            background: white;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .customer-folder-header {
            background: var(--primary);
            color: white;
            padding: 0.8rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        
        .customer-folder-header:hover {
            background: var(--dark);
        }
        
        .customer-folder-content {
            display: none;
            padding: 0;
        }
        
        .customer-folder.expanded .customer-folder-content {
            display: block;
        }
        
        .customer-folder-toggle {
            transition: transform 0.3s;
        }
        
        .customer-folder.expanded .customer-folder-toggle {
            transform: rotate(90deg);
        }
        
        .customer-package-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .customer-package-table th,
        .customer-package-table td {
            padding: 0.6rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .customer-package-table th {
            background: var(--light);
            font-weight: 600;
        }
        
        .customer-summary {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .customer-folder-actions {
            display: flex;
            gap: 0.5rem;
        }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; }
        .modal-close { background:none; border:none; font-size:1.5rem; cursor:pointer; }

        .customer-list { max-height:300px; overflow-y:auto; margin-bottom:1rem; }
        .customer-item { padding:0.8rem; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
        .customer-item:hover { background:#f5f5f5; } .customer-item.selected { background:#e3f2fd; }

        .quantity-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center; }
        .quantity-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:300px; text-align:center; }
        .quantity-input { width:100%; padding:0.8rem; margin:1rem 0; border:1px solid #ddd; border-radius:5px; font-size:1.2rem; text-align:center; }
        .quantity-buttons { display:flex; justify-content:center; gap:0.8rem; margin-top:1rem; }

        .stock-search { display:flex; gap:0.8rem; margin-bottom:1.2rem; }
        .stock-search input { flex-grow:1; padding:0.8rem; border:1px solid #ddd; border-radius:5px; }
        .stock-table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .stock-table th, .stock-table td { padding:0.8rem; text-align:left; border-bottom:1px solid #ddd; } 
        .stock-table th { background:var(--light); font-weight:600; } 
        .stock-table tr:hover { background:#f9f9f9; }
        .editable-field:focus { background:#fff3cd !important; border:1px solid #ffc107 !important; outline:none; }
        .editable-field:hover { background:#f8f9fa; }

        .file-upload { margin-top:1.2rem; padding:1.2rem; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .upload-button { display:inline-block; padding:0.8rem 1.5rem; background:var(--secondary); color:white; border-radius:5px; cursor:pointer; margin-top:0.8rem; }
        .upload-button:hover { background:#2980b9; }

        .offline-indicator { position:fixed; bottom:20px; left:20px; padding:0.8rem 1.2rem; background:var(--accent); color:white; border-radius:5px; z-index:1000; display:none; }

        /* Stock status classes */
        .status-kritik { background:#c0392b;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }
        .status-az-stok { background:#f39c12;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }
        .status-stokta { background:#2ecc71;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }

        /* Responsive */
        @media (max-width:1200px) {
            .barcode-section, .package-details { min-width:200px; }
            .pending-packages { flex: 1 1 60%; }
        }
        @media (max-width:900px) {
            .packaging-content { flex-direction:column; height:auto; }
            .barcode-section, .pending-packages, .package-details { flex: 1 1 auto; width:100%; min-width: auto; }
            .tab-pane { height: auto; }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <div class="login-form">
            <h1>ProClean - Oturum Aç</h1>
            <div class="form-group">
                <label for="email">E-posta</label>
                <input type="email" id="email" placeholder="E-posta adresinizi girin">
            </div>
            <div class="form-group">
                <label for="password">Şifre</label>
                <input type="password" id="password" placeholder="Şifrenizi girin">
            </div>
            <button type="button" class="btn btn-primary" id="loginBtn">Giriş Yap</button>
        </div>
    </div>
        <div style="margin-top: 1rem; text-align: center;">
        <a href="#" onclick="signupInstead()" style="color: #3498db; text-decoration: underline; font-size: 0.9rem;">
            Yeni hesap oluştur
        </a>
    </div>
</div>

    <div class="app-container" id="appContainer" aria-hidden="true">
        <div class="app-header">
            <div class="app-title">ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</div>
            <div class="user-info">
                <span id="userRole">Operatör: Yükleniyor...</span>
                <button type="button" id="logoutBtn" class="btn btn-danger">Çıkış Yap</button>
            </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Ana Sekmeler">
            <div class="tab active" data-tab="packaging" role="tab">Paketleme</div>
            <div class="tab" data-tab="shipping" role="tab">Sevkiyat</div>
            <div class="tab" data-tab="stock" role="tab">Stok Sorgu</div>
        </div>

        <div class="tab-content">
            <div class="tab-pane active" id="packagingTab">
                <div class="packaging-header">
                    <div class="customer-info">
                        <div class="info-group">
                            <label for="customerSelect">Müşteri Seçimi</label>
                            <select id="customerSelect">
                                <option value="">Müşteri seçin...</option>
                            </select>
                        </div>
                        <div class="info-group">
                            <label for="personnelSelect">Personel</label>
                            <select id="personnelSelect">
                                <option value="">Personel seçin...</option>
                            </select>
                        </div>
                        <div class="info-group">
                            <label>Tarih</label>
                            <span id="currentDate">-</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="showAllCustomers()">Müşteri Yönetimi</button>
                        <button type="button" class="btn btn-warning" onclick="generateDailyReport()">İş Sonu Raporu</button>
                    </div>
                </div>

                <div class="packaging-content">
                    <div class="barcode-section">
                        <h3>Barkod Okuma</h3>
                        <div class="barcode-input">
                            <input type="text" id="barcodeInput" placeholder="Barkod okutun veya girin" autofocus>
                            <button type="button" onclick="processBarcode()"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="barcodeResult"></div>
                        
                        <div class="quick-buttons">
                            <div class="quick-btn" onclick="openQuantityModal('elbise')" data-product="elbise">
                                <span>Elbise</span>
                                <div class="quantity-badge" id="elbise-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('gömlek')" data-product="gömlek">
                                <span>Gömlek</span>
                                <div class="quantity-badge" id="gömlek-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('pantolon')" data-product="pantolon">
                                <span>Pantolon</span>
                                <div class="quantity-badge" id="pantolon-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('mont')" data-product="mont">
                                <span>Mont</span>
                                <div class="quantity-badge" id="mont-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('takım')" data-product="takım">
                                <span>Takım</span>
                                <div class="quantity-badge" id="takım-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('diğer')" data-product="diğer">
                                <span>Diğer</span>
                                <div class="quantity-badge" id="diğer-quantity">0</div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="openManualEntry()" style="width:100%; margin-top:1rem;">Manuel Giriş</button>
                    </div>

                    <div class="pending-packages">
                        <h3>Bekleyen Paketler</h3>
                        <table class="package-table">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAllPackages" onchange="toggleSelectAll()">
                                    </th>
                                    <th>Paket No</th>
                                    <th>Müşteri</th>
                                    <th>Adet</th>
                                    <th>Tarih</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTableBody">
                                <!-- Packages will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="package-details">
                        <h3>Paket Detayları</h3>
                        <div id="packageDetailContent">
                            <p style="text-align:center; color:#666; margin:2rem 0;">Paket seçin</p>
                        </div>
                        
                        <div class="package-actions">
                            <button type="button" class="btn btn-success" onclick="completePackage()">Paketle</button>
                            <button type="button" class="btn btn-warning" onclick="printLabel()">Etiket Yazdır</button>
                            <button type="button" class="btn btn-danger" onclick="deleteSelectedPackages()">Sil</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="shippingTab">
                <div class="packaging-header">
                    <div class="customer-info">
                        <div class="info-group">
                            <label for="shippingViewToggle">Görünüm</label>
                            <select id="shippingViewToggle" onchange="toggleShippingView()">
                                <option value="folders">Müşteri Klasörleri</option>
                                <option value="containers">Konteyner Listesi</option>
                            </select>
                        </div>
                        <div class="info-group">
                            <label for="shippingFilter">Durum Filtresi</label>
                            <select id="shippingFilter" onchange="filterShipping()">
                                <option value="all">Tümü</option>
                                <option value="beklemede">Beklemede</option>
                                <option value="sevk-edildi">Sevk Edildi</option>
                            </select>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="createNewContainer()">Yeni Konteyner</button>
                        <button type="button" class="btn btn-warning" onclick="loadCurrentContainer()">Mevcut Konteyner</button>
                        <button type="button" class="btn btn-danger" onclick="deleteContainer()">Konteyner Sil</button>
                    </div>
                </div>

                <!-- Customer Folders View -->
                <div id="customerFoldersView" style="display: block;">
                    <!-- Customer folders will be populated here -->
                </div>

                <!-- Traditional Container Table View -->
                <div id="containerTableView" style="display: none;">
                    <table class="package-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllShipping" onchange="toggleSelectAllShipping()">
                                </th>
                                <th>Konteyner No</th>
                                <th>Müşteri</th>
                                <th>Paket Sayısı</th>
                                <th>Toplam Adet</th>
                                <th>Tarih</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="shippingTableBody">
                            <!-- Shipping data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane" id="stockTab">
                <div class="stock-search">
                    <input type="text" id="stockSearch" placeholder="Stok ara..." oninput="searchStock()">
                    <button type="button" class="btn btn-primary" onclick="clearStockSearch()">Temizle</button>
                    <button type="button" class="btn btn-info" onclick="generateDailyReport()" style="margin-left: 0.5rem;">
                        <i class="fas fa-file-pdf"></i> Günlük Rapor PDF
                    </button>
                    <button type="button" class="btn btn-warning" onclick="showEmailConfigModal()" style="margin-left: 0.5rem;">
                        <i class="fas fa-envelope-open-text"></i> Email Ayarları
                    </button>
                </div>

                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>Stok Kodu</th>
                            <th>Ürün Adı</th>
                            <th>Mevcut Adet</th>
                            <th>Birim</th>
                            <th>Durum</th>
                            <th>Son Güncelleme</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                        <!-- Stock data will be populated here -->
                    </tbody>
                </table>

                <div class="file-upload">
                    <h3>Stok Dosyası Yükle</h3>
                    <p>Excel (.xlsx, .xls) veya CSV (.csv) dosyası seçin</p>
                    <input type="file" id="stockFileUpload" accept=".xlsx,.xls,.csv" onchange="document.getElementById('selectedFileName').textContent = this.files[0] ? this.files[0].name : ''">
                    <div>
                        <span id="selectedFileName"></span>
                    </div>
                    <button type="button" class="upload-button" onclick="uploadStockFile()">
                        <i class="fas fa-upload"></i> Dosya Yükle
                    </button>
                </div>
            </div>
        </div>

        <div class="app-footer">
            <div class="container-info">
                <span>Aktif Konteyner: <strong id="containerNumber">Yok</strong></span>
                <span>|</span>
                <span>Toplam Paket: <strong id="totalPackages">0</strong></span>
                <span>|</span>
                <span>ProClean © 2025</span>
            </div>
            <div>Çevrimiçi</div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Müşteri Seç</h3>
                <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="customer-list" id="customerList">
                <!-- Customers will be populated here -->
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">İptal</button>
            </div>
        </div>
    </div>

    <!-- All Customers Modal -->
    <div class="modal" id="allCustomersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Müşteri Yönetimi</h3>
                <button type="button" class="modal-close" onclick="closeAllCustomersModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="newCustomerCode">Müşteri Kodu</label>
                <input type="text" id="newCustomerCode" placeholder="Örn: P0005">
            </div>
            <div class="form-group">
                <label for="newCustomerName">Müşteri Adı</label>
                <input type="text" id="newCustomerName" placeholder="Müşteri adını girin">
            </div>
            <div class="form-group">
                <label for="newCustomerEmail">E-posta (İsteğe bağlı)</label>
                <input type="email" id="newCustomerEmail" placeholder="E-posta adresini girin">
            </div>
            <button type="button" class="btn btn-primary" onclick="addNewCustomer()">Müşteri Ekle</button>
            
            <hr style="margin: 1.5rem 0;">
            <h4>Mevcut Müşteriler</h4>
            <div class="customer-list" id="allCustomersList">
                <!-- All customers will be populated here -->
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div class="modal" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>İş Sonu Raporu Gönder</h3>
                <button type="button" class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="reportEmail">E-posta Adresi</label>
                <input type="email" id="reportEmail" placeholder="Rapor gönderilecek e-posta">
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" onclick="sendDailyReport()">Rapor Gönder</button>
                <button type="button" class="btn btn-warning" onclick="previewReport()">Önizleme</button>
                <button type="button" class="btn btn-secondary" onclick="closeEmailModal()">İptal</button>
            </div>
        </div>
    </div>

    <!-- Quantity Modal -->
    <div class="quantity-modal" id="quantityModal">
        <div class="quantity-content">
            <h3 id="quantityModalTitle">Adet Girin</h3>
            <input type="number" id="quantityInput" class="quantity-input" min="1" placeholder="Adet">
            <div class="quantity-buttons">
                <button type="button" class="btn btn-primary" onclick="confirmQuantity()">Onayla</button>
                <button type="button" class="btn btn-secondary" onclick="closeQuantityModal()">İptal</button>
            </div>
        </div>
    </div>

    <!-- Manual Entry Modal -->
    <div class="modal" id="manualModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manuel Ürün Girişi</h3>
                <button type="button" class="modal-close" onclick="closeManualModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="manualProduct">Ürün Adı</label>
                <input type="text" id="manualProduct" placeholder="Ürün adını girin">
            </div>
            <div class="form-group">
                <label for="manualQuantity">Adet</label>
                <input type="number" id="manualQuantity" min="1" placeholder="Adet girin">
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" onclick="addManualProduct()">Ekle</button>
                <button type="button" class="btn btn-secondary" onclick="closeManualModal()">İptal</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>
    <div class="offline-indicator" id="offlineIndicator">Çevrimdışı Mod</div>

<script>
// Supabase initialization
const SUPABASE_URL = 'https://viehnigcbosgsxgehgnn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpZWhuaWdjYm9zZ3N4Z2VoZ25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1Mzg3MzgsImV4cCI6MjA3MzExNDczOH0.iZX8Z5mUjHc_LZpmH5EtFe0C7k4A_1zX8UoM7iDs5FM';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
console.log('Supabase client initialized successfully');

// Global variables
let currentUser = null;
let selectedCustomer = null;
let currentPackage = {};
let packages = [];
let containers = [];
let currentContainer = null;
let selectedProduct = null;

// DOM elements
const elements = {
    loginScreen: document.getElementById('loginScreen'),
    appContainer: document.getElementById('appContainer'),
    userRole: document.getElementById('userRole'),
    customerSelect: document.getElementById('customerSelect'),
    personnelSelect: document.getElementById('personnelSelect'),
    currentDate: document.getElementById('currentDate'),
    barcodeInput: document.getElementById('barcodeInput'),
    packagesTableBody: document.getElementById('packagesTableBody'),
    stockTableBody: document.getElementById('stockTableBody'),
    shippingTableBody: document.getElementById('shippingTableBody'),
    shippingViewToggle: document.getElementById('shippingViewToggle'),
    containerNumber: document.getElementById('containerNumber'),
    totalPackages: document.getElementById('totalPackages'),
    customerModal: document.getElementById('customerModal'),
    allCustomersModal: document.getElementById('allCustomersModal'),
    emailModal: document.getElementById('emailModal'),
    quantityModal: document.getElementById('quantityModal'),
    manualModal: document.getElementById('manualModal'),
    customerList: document.getElementById('customerList'),
    allCustomersList: document.getElementById('allCustomersList'),
    stockSearch: document.getElementById('stockSearch'),
    selectedFileName: document.getElementById('selectedFileName'),
    reportEmail: document.getElementById('reportEmail'),
    quantityInput: document.getElementById('quantityInput'),
    quantityModalTitle: document.getElementById('quantityModalTitle'),
    toast: document.getElementById('toast'),
    selectAllCheckbox: document.getElementById('selectAllPackages')
};

// Authentication functions
async function login() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!email || !password) {
        showToast("Lütfen e-posta ve şifre girin", "error");
        return;
    }

    try {
        showToast("Giriş yapılıyor...", "warning");
        
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) {
            console.error('Supabase login error:', error);
            
            // Check if it's a user not found error (user needs to be created)
            if (error.message.includes('Invalid login credentials') || 
                error.message.includes('Email not confirmed') ||
                error.message.includes('User not found')) {
                
                // Offer to create the user
                if (confirm('Kullanıcı bulunamadı. Yeni kullanıcı oluşturmak ister misiniz?')) {
                    await createUser(email, password);
                    return;
                }
            }
            
            showToast("Giriş başarısız: " + error.message, "error");
            return;
        }

        if (data.user) {
            showToast("Giriş başarılı!", "success");
            console.log('Login successful:', data.user.email);
        }
        
    } catch (e) {
        console.error('Login catch error:', e);
        showToast("Giriş başarısız: " + e.message, "error");
    }
}

// Add this function to create a new user
async function createUser(email, password) {
    try {
        showToast("Kullanıcı oluşturuluyor...", "warning");
        
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password,
        });

        if (error) {
            console.error('Signup error:', error);
            showToast("Kullanıcı oluşturulamadı: " + error.message, "error");
            return;
        }

        if (data.user) {
            showToast("Kullanıcı oluşturuldu! Lütfen giriş yapın.", "success");
            // Auto-fill the login form
            document.getElementById('email').value = email;
            document.getElementById('password').value = '';
        }
        
    } catch (error) {
        console.error('Create user error:', error);
        showToast("Kullanıcı oluşturma hatası", "error");
    }
}
async function logout() {
    if (supabase) {
        try {
            await supabase.auth.signOut();
            console.log('Supabase logout successful');
        } catch (error) {
            console.error('Logout error:', error);
        }
    }
    
    currentUser = null;
    elements.appContainer.style.display = 'none';
    elements.appContainer.setAttribute('aria-hidden','true');
    elements.loginScreen.style.display = 'flex';
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
    closeModal(); closeAllCustomersModal(); closeEmailModal(); closeQuantityModal(); closeManualModal();
    showToast('Başarıyla çıkış yapıldı', 'success');
}

    function signupInstead() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    if (!email) {
        showToast("Lütfen e-posta adresinizi girin", "error");
        document.getElementById('email').focus();
        return;
    }
    
    if (!password) {
        showToast("Lütfen şifre oluşturun", "error");
        document.getElementById('password').focus();
        return;
    }
    
    createUser(email, password);
}

// Test Supabase connection
async function testConnection() {
    try {
        const { data, error } = await supabase.from('customers').select('count').limit(1);
        if (error) {
            console.error('Supabase connection error:', error);
            showToast('Veritabanı bağlantı hatası', 'error');
        } else {
            console.log('Supabase connection successful');
        }
    } catch (error) {
        console.error('Connection test failed:', error);
        showToast('Bağlantı testi başarısız', 'error');
    }
}

// Initialize application
async function initApp() {
    elements.currentDate.textContent = new Date().toLocaleDateString('tr-TR');
    
    // Populate dropdowns
    await populateCustomers();
    await populatePersonnel();
    
    // Load data
    await populatePackagesTable();
    await populateStockTable();
    await populateShippingTable();
    
    // Test connection
    await testConnection();
}

// Data loading functions
async function populateCustomers() {
    try {
        elements.customerSelect.innerHTML = '<option value="">Müşteri seçin...</option>';
        
        const { data: customers, error } = await supabase
            .from('customers')
            .select('*')
            .order('name');

        if (error) {
            console.error('Error loading customers:', error);
            showToast('Müşteri verileri yüklenemedi', 'error');
            return;
        }

        if (customers && customers.length > 0) {
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} (${customer.code})`;
                elements.customerSelect.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Error in populateCustomers:', error);
        showToast('Müşteri yükleme hatası', 'error');
    }
}

async function populatePersonnel() {
    try {
        elements.personnelSelect.innerHTML = '<option value="">Personel seçin...</option>';
        
        const { data: personnel, error } = await supabase
            .from('personnel')
            .select('*')
            .order('name');

        if (error) {
            console.error('Error loading personnel:', error);
            // Add default current user
            const option = document.createElement('option');
            option.value = currentUser?.uid || 'default';
            option.textContent = currentUser?.name || 'Mevcut Kullanıcı';
            option.selected = true;
            elements.personnelSelect.appendChild(option);
            return;
        }

        if (personnel && personnel.length > 0) {
            personnel.forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = person.name;
                elements.personnelSelect.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Error in populatePersonnel:', error);
        // Add default current user
        const option = document.createElement('option');
        option.value = currentUser?.uid || 'default';
        option.textContent = currentUser?.name || 'Mevcut Kullanıcı';
        option.selected = true;
        elements.personnelSelect.appendChild(option);
    }
}

async function populateProducts() {
    try {
        const { data: products, error } = await supabase
            .from('products')
            .select('*')
            .order('name');

        if (error) {
            console.error('Error loading products:', error);
            return;
        }

        // Update quick buttons with actual products if needed
        // This would require modifying the quick buttons section
        
    } catch (error) {
        console.error('Error in populateProducts:', error);
    }
}

async function populatePackagesTable() {
    try {
        elements.packagesTableBody.innerHTML = '';
        
        const { data: packages, error } = await supabase
            .from('packages')
            .select(`
                *,
                customers (name, code)
            `)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading packages:', error);
            showToast('Paket verileri yüklenemedi', 'error');
            return;
        }

        if (packages && packages.length > 0) {
            packages.forEach(pkg => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" value="${pkg.id}" onchange="updatePackageSelection()"></td>
                    <td>${pkg.package_no}</td>
                    <td>${pkg.customers?.name || 'N/A'}</td>
                    <td>${pkg.total_quantity}</td>
                    <td>${new Date(pkg.created_at).toLocaleDateString('tr-TR')}</td>
                    <td><span class="status-${pkg.status}">${pkg.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</span></td>
                `;
                row.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        selectPackage(pkg);
                    }
                };
                elements.packagesTableBody.appendChild(row);
            });
            
            elements.totalPackages.textContent = packages.length;
        } else {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="6" style="text-align:center; color:#666;">Henüz paket yok</td>';
            elements.packagesTableBody.appendChild(row);
        }
        
    } catch (error) {
        console.error('Error in populatePackagesTable:', error);
        showToast('Paket tablosu yükleme hatası', 'error');
    }
}

// Real Email System with Supabase Integration
const EMAIL_CONFIG = {
    serviceId: 'service_proclean', // Will be set from environment
    templateId: 'template_proclean',
    userId: 'user_proclean'
};

// Initialize EmailJS
async function initializeEmailSystem() {
    try {
        // Initialize EmailJS
        if (typeof emailjs !== 'undefined') {
            emailjs.init(EMAIL_CONFIG.userId);
            console.log('EmailJS initialized successfully');
        } else {
            console.error('EmailJS library not loaded');
        }
    } catch (error) {
        console.error('Error initializing email system:', error);
    }
}

// Send real email function
async function sendEmail(recipientEmail, subject, message, type = 'notification') {
    try {
        if (!recipientEmail || !subject || !message) {
            throw new Error('Email, konu ve mesaj gerekli');
        }

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(recipientEmail)) {
            throw new Error('Geçersiz email adresi');
        }

        // Prepare email data
        const emailData = {
            to_email: recipientEmail,
            subject: subject,
            message: message,
            from_name: 'ProClean Çamaşırhane',
            company_name: 'ProClean Çamaşırhane Yönetim Sistemi',
            timestamp: new Date().toLocaleString('tr-TR'),
            type: type
        };

        // Send email using EmailJS
        const response = await emailjs.send(
            EMAIL_CONFIG.serviceId,
            EMAIL_CONFIG.templateId,
            emailData
        );

        // Log email to database
        await logEmailToDatabase(recipientEmail, subject, message, type, 'sent');

        console.log('Email sent successfully:', response);
        return { success: true, message: 'Email başarıyla gönderildi' };

    } catch (error) {
        console.error('Error sending email:', error);
        
        // Log failed email to database
        await logEmailToDatabase(recipientEmail, subject, message, type, 'failed', error.message);
        
        throw new Error('Email gönderme hatası: ' + error.message);
    }
}

// Log email to Supabase database
async function logEmailToDatabase(recipientEmail, subject, message, type, status, errorMessage = null) {
    try {
        const emailLog = {
            recipient_email: recipientEmail,
            subject: subject,
            message: message,
            type: type,
            status: status,
            error_message: errorMessage,
            sent_at: new Date().toISOString(),
            user_email: supabase.auth.user()?.email || 'system'
        };

        const { error } = await supabase
            .from('email_logs')
            .insert([emailLog]);

        if (error) {
            console.error('Error logging email to database:', error);
        }
    } catch (error) {
        console.error('Error in logEmailToDatabase:', error);
    }
}

// Send package ready notification
async function sendPackageReadyNotification(packageData, customerEmail) {
    try {
        if (!customerEmail) {
            throw new Error('Müşteri email adresi bulunamadı');
        }

        const subject = `Paketiniz Hazır - ${packageData.package_no}`;
        const message = `
Sayın ${packageData.customers?.name || 'Müşteri'},

Paketiniz hazır ve teslim alınabilir:

📦 Paket No: ${packageData.package_no}
📅 Hazırlanma Tarihi: ${new Date(packageData.created_at).toLocaleDateString('tr-TR')}
📋 Toplam Adet: ${packageData.total_quantity}
🏷️ Durum: ${packageData.status === 'beklemede' ? 'Teslim Bekliyor' : 'Teslim Edildi'}

Paketinizi teslim almak için lütfen paket numaranızı belirterek firmamıza başvurun.

Teşekkür ederiz,
ProClean Çamaşırhane Ekibi
        `;

        const result = await sendEmail(customerEmail, subject, message, 'package_ready');
        showToast('Müşteriye bildirim emaili gönderildi', 'success');
        return result;

    } catch (error) {
        console.error('Error sending package ready notification:', error);
        showToast('Email gönderme hatası: ' + error.message, 'error');
        throw error;
    }
}

// Send daily report via email
async function sendDailyReportEmail(recipientEmail) {
    try {
        // Fetch daily data
        const today = new Date().toISOString().split('T')[0];
        
        const [packagesResponse, containersResponse, stockResponse] = await Promise.all([
            supabase.from('packages').select('*, customers(name)').gte('created_at', today),
            supabase.from('containers').select('*').gte('created_at', today),
            supabase.from('stock_items').select('*').lte('quantity', 10)
        ]);

        const todayPackages = packagesResponse.data || [];
        const todayContainers = containersResponse.data || [];
        const lowStock = stockResponse.data || [];

        const subject = `ProClean Günlük Rapor - ${new Date().toLocaleDateString('tr-TR')}`;
        const message = `
📊 GÜNLÜK RAPOR - ${new Date().toLocaleDateString('tr-TR')}

📦 GÜNÜN ÖZETİ:
• Bugün oluşturulan paketler: ${todayPackages.length}
• Bugün oluşturulan konteynerler: ${todayContainers.length}
• Düşük stok uyarısı: ${lowStock.length} ürün

⚠️ KRİTİK STOKLAR:
${lowStock.filter(s => s.quantity <= 3).map(item => 
    `• ${item.name}: ${item.quantity} ${item.unit || 'adet'}`
).join('\n') || 'Kritik stok yok'}

📋 DÜŞÜK STOKLAR:
${lowStock.filter(s => s.quantity > 3 && s.quantity <= 10).map(item => 
    `• ${item.name}: ${item.quantity} ${item.unit || 'adet'}`
).join('\n') || 'Düşük stok yok'}

Detaylı rapor için sisteme giriş yapın.

ProClean Çamaşırhane Yönetim Sistemi
        `;

        const result = await sendEmail(recipientEmail, subject, message, 'daily_report');
        showToast('Günlük rapor emaili gönderildi', 'success');
        return result;

    } catch (error) {
        console.error('Error sending daily report email:', error);
        showToast('Günlük rapor email hatası: ' + error.message, 'error');
        throw error;
    }
}

// Send low stock alert
async function sendLowStockAlert(adminEmail) {
    try {
        const { data: lowStock, error } = await supabase
            .from('stock_items')
            .select('*')
            .lte('quantity', 5)
            .order('quantity');

        if (error) throw error;

        if (lowStock && lowStock.length > 0) {
            const subject = '⚠️ ProClean Stok Uyarısı';
            const criticalItems = lowStock.filter(item => item.quantity <= 2);
            const lowItems = lowStock.filter(item => item.quantity > 2);

            const message = `
🚨 STOK UYARISI - ${new Date().toLocaleDateString('tr-TR')}

⛔ KRİTİK STOKLAR (≤2):
${criticalItems.map(item => 
    `• ${item.name} (${item.code}): ${item.quantity} ${item.unit || 'adet'}`
).join('\n') || 'Kritik stok yok'}

⚠️ DÜŞÜK STOKLAR (3-5):
${lowItems.map(item => 
    `• ${item.name} (${item.code}): ${item.quantity} ${item.unit || 'adet'}`
).join('\n') || 'Düşük stok yok'}

Lütfen acil olarak stok tedariği yapın.

ProClean Stok Yönetim Sistemi
            `;

            const result = await sendEmail(adminEmail, subject, message, 'stock_alert');
            showToast('Stok uyarı emaili gönderildi', 'success');
            return result;
        }

    } catch (error) {
        console.error('Error sending low stock alert:', error);
        showToast('Stok uyarı email hatası: ' + error.message, 'error');
        throw error;
    }
}

// Email configuration modal
function showEmailConfigModal() {
    const modal = document.getElementById('emailConfigModal');
    if (!modal) {
        // Create email config modal
        const modalHTML = `
            <div class="modal" id="emailConfigModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Email Ayarları</h3>
                        <span class="close" onclick="closeEmailConfigModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="emailConfigForm">
                            <div class="form-group">
                                <label>Service ID:</label>
                                <input type="text" id="emailServiceId" placeholder="EmailJS Service ID" required>
                            </div>
                            <div class="form-group">
                                <label>Template ID:</label>
                                <input type="text" id="emailTemplateId" placeholder="EmailJS Template ID" required>
                            </div>
                            <div class="form-group">
                                <label>User ID:</label>
                                <input type="text" id="emailUserId" placeholder="EmailJS User ID" required>
                            </div>
                            <div class="form-group">
                                <label>Test Email:</label>
                                <input type="email" id="testEmail" placeholder="test@example.com">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeEmailConfigModal()">İptal</button>
                        <button class="btn btn-primary" onclick="saveEmailConfig()">Kaydet</button>
                        <button class="btn btn-info" onclick="testEmailConfig()">Test Et</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    document.getElementById('emailConfigModal').style.display = 'flex';
}

function closeEmailConfigModal() {
    document.getElementById('emailConfigModal').style.display = 'none';
}

function saveEmailConfig() {
    const serviceId = document.getElementById('emailServiceId').value.trim();
    const templateId = document.getElementById('emailTemplateId').value.trim();
    const userId = document.getElementById('emailUserId').value.trim();
    
    if (!serviceId || !templateId || !userId) {
        showToast('Tüm alanları doldurun', 'error');
        return;
    }
    
    EMAIL_CONFIG.serviceId = serviceId;
    EMAIL_CONFIG.templateId = templateId;
    EMAIL_CONFIG.userId = userId;
    
    // Save to localStorage
    localStorage.setItem('proclean_email_config', JSON.stringify(EMAIL_CONFIG));
    
    // Reinitialize EmailJS
    initializeEmailSystem();
    
    showToast('Email ayarları kaydedildi', 'success');
    closeEmailConfigModal();
}

async function testEmailConfig() {
    const testEmail = document.getElementById('testEmail').value.trim();
    if (!testEmail) {
        showToast('Test email adresi girin', 'error');
        return;
    }
    
    try {
        await sendEmail(testEmail, 'ProClean Test Email', 'Bu bir test emailidir. Email sistemi çalışıyor!', 'test');
        showToast('Test emaili gönderildi!', 'success');
    } catch (error) {
        showToast('Test email hatası: ' + error.message, 'error');
    }
}

// Generate Professional Daily Report PDF
async function generateDailyReport() {
    try {
        showToast('Günlük rapor oluşturuluyor...', 'info');
        
        // Fetch all data for the report
        const [packagesResponse, containersResponse, customersResponse, stockResponse] = await Promise.all([
            supabase.from('packages').select('*, customers(name, code)').order('created_at', { ascending: false }),
            supabase.from('containers').select('*').order('created_at', { ascending: false }),
            supabase.from('customers').select('*').order('name'),
            supabase.from('stock_items').select('*').in('quantity', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]).order('quantity')
        ]);
        
        const packages = packagesResponse.data || [];
        const containers = containersResponse.data || [];
        const customers = customersResponse.data || [];
        const criticalStock = stockResponse.data || [];
        
        // Create PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Header
        const today = new Date().toLocaleDateString('tr-TR');
        doc.setFontSize(20);
        doc.setTextColor(44, 62, 80);
        doc.text('ProClean Çamaşırhane', 105, 20, { align: 'center' });
        doc.setFontSize(16);
        doc.text('Günlük Durum Raporu', 105, 30, { align: 'center' });
        doc.setFontSize(12);
        doc.text(`Rapor Tarihi: ${today}`, 105, 40, { align: 'center' });
        
        let yPos = 55;
        
        // Summary Section
        doc.setFontSize(14);
        doc.setTextColor(52, 73, 94);
        doc.text('📊 GÜNLÜK ÖZET', 20, yPos);
        yPos += 10;
        
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        const todayPackages = packages.filter(p => new Date(p.created_at).toDateString() === new Date().toDateString());
        const pendingPackages = packages.filter(p => p.status === 'beklemede');
        const criticalStockCount = criticalStock.filter(s => s.quantity <= 3).length;
        const lowStockCount = criticalStock.filter(s => s.quantity > 3 && s.quantity <= 10).length;
        
        doc.text(`• Bugün oluşturulan paketler: ${todayPackages.length}`, 25, yPos);
        doc.text(`• Beklemede olan paketler: ${pendingPackages.length}`, 25, yPos + 7);
        doc.text(`• Aktif konteynerler: ${containers.length}`, 25, yPos + 14);
        doc.text(`• Toplam müşteri sayısı: ${customers.length}`, 25, yPos + 21);
        doc.text(`• Kritik stok (≤3): ${criticalStockCount}`, 25, yPos + 28);
        doc.text(`• Düşük stok (4-10): ${lowStockCount}`, 25, yPos + 35);
        
        yPos += 50;
        
        // Packages Section
        if (packages.length > 0) {
            doc.setFontSize(14);
            doc.setTextColor(52, 73, 94);
            doc.text('📦 PAKET DURUMU', 20, yPos);
            yPos += 10;
            
            const packageTableData = packages.slice(0, 15).map(pkg => [
                pkg.package_no,
                pkg.customers?.name || 'N/A',
                pkg.total_quantity.toString(),
                new Date(pkg.created_at).toLocaleDateString('tr-TR'),
                pkg.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['Paket No', 'Müşteri', 'Adet', 'Tarih', 'Durum']],
                body: packageTableData,
                styles: { fontSize: 9 },
                headStyles: { fillColor: [52, 73, 94] },
                margin: { left: 20, right: 20 }
            });
            
            yPos = doc.lastAutoTable.finalY + 15;
        }
        
        // Add new page if needed
        if (yPos > 220) {
            doc.addPage();
            yPos = 20;
        }
        
        // Critical Stock Section
        if (criticalStock.length > 0) {
            doc.setFontSize(14);
            doc.setTextColor(231, 76, 60);
            doc.text('⚠️ KRİTİK & DÜŞÜK STOK', 20, yPos);
            yPos += 10;
            
            const stockTableData = criticalStock.map(item => {
                const status = item.quantity <= 3 ? 'KRİTİK' : 'DÜŞÜK';
                return [
                    item.code,
                    item.name,
                    item.quantity.toString(),
                    item.unit || 'Adet',
                    status
                ];
            });
            
            doc.autoTable({
                startY: yPos,
                head: [['Stok Kodu', 'Ürün Adı', 'Miktar', 'Birim', 'Durum']],
                body: stockTableData,
                styles: { fontSize: 9 },
                headStyles: { fillColor: [231, 76, 60] },
                bodyStyles: {
                    fillColor: (rowIndex, columnIndex, cell) => {
                        return stockTableData[rowIndex][4] === 'KRİTİK' ? [255, 235, 235] : [255, 248, 235];
                    }
                },
                margin: { left: 20, right: 20 }
            });
            
            yPos = doc.lastAutoTable.finalY + 15;
        }
        
        // Add new page if needed
        if (yPos > 220) {
            doc.addPage();
            yPos = 20;
        }
        
        // Containers Section
        if (containers.length > 0) {
            doc.setFontSize(14);
            doc.setTextColor(52, 73, 94);
            doc.text('📦 KONTEYNER DURUMU', 20, yPos);
            yPos += 10;
            
            const containerTableData = containers.slice(0, 10).map(container => [
                container.container_no,
                container.package_count?.toString() || '0',
                container.total_quantity?.toString() || '0',
                new Date(container.created_at).toLocaleDateString('tr-TR'),
                container.status || 'Aktif'
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['Konteyner No', 'Paket Sayısı', 'Toplam Adet', 'Oluşturma Tarihi', 'Durum']],
                body: containerTableData,
                styles: { fontSize: 9 },
                headStyles: { fillColor: [52, 73, 94] },
                margin: { left: 20, right: 20 }
            });
            
            yPos = doc.lastAutoTable.finalY + 15;
        }
        
        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text(`ProClean Çamaşırhane Yönetim Sistemi - Sayfa ${i}/${pageCount}`, 105, 285, { align: 'center' });
            doc.text(`Rapor oluşturma: ${new Date().toLocaleString('tr-TR')}`, 105, 292, { align: 'center' });
        }
        
        // Save PDF
        const fileName = `ProClean_Gunluk_Rapor_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
        
        showToast('Günlük rapor başarıyla oluşturuldu!', 'success');
        
    } catch (error) {
        console.error('Error generating daily report:', error);
        showToast('Rapor oluşturma hatası: ' + error.message, 'error');
    }
}

// Update stock field function for inline editing
async function updateStockField(input) {
    const field = input.dataset.field;
    const id = input.dataset.id;
    const newValue = input.value.trim();
    
    if (!newValue) {
        showToast('Alan boş bırakılamaz', 'error');
        input.focus();
        return;
    }
    
    try {
        // Prepare update data
        const updateData = { updated_at: new Date().toISOString() };
        
        if (field === 'quantity') {
            updateData[field] = parseInt(newValue);
            if (isNaN(updateData[field]) || updateData[field] < 0) {
                showToast('Geçerli bir sayı girin', 'error');
                input.focus();
                return;
            }
        } else {
            updateData[field] = newValue;
        }
        
        // Update in database
        const { error } = await supabase
            .from('stock_items')
            .update(updateData)
            .eq('id', id);
            
        if (error) {
            console.error('Error updating stock:', error);
            showToast('Stok güncelleme hatası: ' + error.message, 'error');
            return;
        }
        
        showToast(`${field === 'code' ? 'Stok kodu' : field === 'name' ? 'Ürün adı' : 'Miktar'} güncellendi`, 'success');
        
        // Refresh the table to update status colors
        setTimeout(() => populateStockTable(), 500);
        
    } catch (error) {
        console.error('Error in updateStockField:', error);
        showToast('Güncelleme hatası', 'error');
    }
}

async function populateStockTable() {
    try {
        elements.stockTableBody.innerHTML = '';
        
        const { data: stockItems, error } = await supabase
            .from('stock_items')
            .select('*')
            .order('name');

        if (error) {
            console.error('Error loading stock:', error);
            showToast('Stok verileri yüklenemedi', 'error');
            return;
        }

        if (stockItems && stockItems.length > 0) {
            stockItems.forEach(item => {
                const status = item.quantity <= 0 ? 'kritik' : 
                              item.quantity <= 10 ? 'az-stok' : 'stokta';
                              
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="text" value="${item.code}" 
                               class="editable-field" 
                               data-field="code" 
                               data-id="${item.id}"
                               onblur="updateStockField(this)" 
                               style="border:none;background:transparent;width:100%;font-family:inherit;">
                    </td>
                    <td>
                        <input type="text" value="${item.name}" 
                               class="editable-field" 
                               data-field="name" 
                               data-id="${item.id}"
                               onblur="updateStockField(this)" 
                               style="border:none;background:transparent;width:100%;font-family:inherit;">
                    </td>
                    <td>
                        <input type="number" value="${item.quantity}" 
                               class="editable-field" 
                               data-field="quantity" 
                               data-id="${item.id}"
                               onblur="updateStockField(this)" 
                               min="0"
                               style="border:none;background:transparent;width:100%;font-family:inherit;">
                    </td>
                    <td>${item.unit || 'Adet'}</td>
                    <td><span class="status-${status}">${status === 'kritik' ? 'Kritik' : status === 'az-stok' ? 'Az Stok' : 'Stokta'}</span></td>
                    <td>${item.updated_at ? new Date(item.updated_at).toLocaleDateString('tr-TR') : 'N/A'}</td>
                `;
                elements.stockTableBody.appendChild(row);
            });
        } else {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="6" style="text-align:center; color:#666;">Stok verisi yok</td>';
            elements.stockTableBody.appendChild(row);
        }
        
    } catch (error) {
        console.error('Error in populateStockTable:', error);
        showToast('Stok tablosu yükleme hatası', 'error');
    }
}

// Toggle between folder view and container table view
function toggleShippingView() {
    const viewToggle = document.getElementById('shippingViewToggle');
    const foldersView = document.getElementById('customerFoldersView');
    const tableView = document.getElementById('containerTableView');
    
    if (viewToggle.value === 'folders') {
        foldersView.style.display = 'block';
        tableView.style.display = 'none';
        renderCustomerFolders();
    } else {
        foldersView.style.display = 'none';
        tableView.style.display = 'block';
        populateContainerTable();
    }
}

// Render customer folders with packages ready for shipment
async function renderCustomerFolders() {
    try {
        const foldersContainer = document.getElementById('customerFoldersView');
        foldersContainer.innerHTML = '<div style="text-align:center; padding:2rem;">Yükleniyor...</div>';
        
        // Fetch packages that are ready for shipment (beklemede status)
        const { data: packages, error } = await supabase
            .from('packages')
            .select(`
                *,
                customers (name, code)
            `)
            .eq('status', 'beklemede')
            .order('created_at', { ascending: false });
            
        if (error) {
            console.error('Error loading packages for shipping:', error);
            showToast('Sevkiyat paketleri yüklenemedi', 'error');
            return;
        }
        
        // Group packages by customer
        const customerGroups = {};
        
        if (packages && packages.length > 0) {
            packages.forEach(pkg => {
                const customerName = pkg.customers?.name || 'Müşteri Yok';
                if (!customerGroups[customerName]) {
                    customerGroups[customerName] = {
                        customer: pkg.customers || { name: 'Müşteri Yok', code: 'N/A' },
                        packages: [],
                        totalPackages: 0,
                        totalQuantity: 0
                    };
                }
                customerGroups[customerName].packages.push(pkg);
                customerGroups[customerName].totalPackages++;
                customerGroups[customerName].totalQuantity += pkg.total_quantity || 0;
            });
        }
        
        // Create customer folder structure
        const foldersHTML = `
            <div style="padding: 1rem;">
                <h3 style="margin-bottom: 1rem; color: var(--primary);">
                    <i class="fas fa-shipping-fast"></i> Sevkiyat Hazır Paketler - Müşteri Bazlı
                </h3>
                <div class="customer-folders-container">
                    ${Object.keys(customerGroups).length > 0 ? 
                        Object.entries(customerGroups).map(([customerName, data]) => `
                            <div class="customer-folder" data-customer="${escapeHtml(customerName)}">
                                <div class="customer-folder-header" onclick="toggleCustomerFolder(${JSON.stringify(customerName)})">
                                    <div>
                                        <i class="fas fa-chevron-right customer-folder-toggle"></i>
                                        <strong style="margin-left: 0.5rem;">${escapeHtml(customerName)}</strong>
                                        <span class="customer-summary" style="margin-left: 1rem;">
                                            (${data.totalPackages} paket, ${data.totalQuantity} adet)
                                        </span>
                                    </div>
                                    <div class="customer-folder-actions">
                                        <button onclick="event.stopPropagation(); createContainerForCustomer(${JSON.stringify(customerName)})" class="btn btn-primary btn-sm">
                                            <i class="fas fa-box"></i> Konteyner Oluştur
                                        </button>
                                        <button onclick="event.stopPropagation(); selectAllCustomerPackages(${JSON.stringify(customerName)})" class="btn btn-secondary btn-sm">
                                            <i class="fas fa-check-square"></i> Tümünü Seç
                                        </button>
                                    </div>
                                </div>
                                <div class="customer-folder-content">
                                    <table class="customer-package-table">
                                        <thead>
                                            <tr>
                                                <th><input type="checkbox" onchange="toggleCustomerPackages(${JSON.stringify(customerName)}, this.checked)"></th>
                                                <th>Paket No</th>
                                                <th>Adet</th>
                                                <th>Tarih</th>
                                                <th>Durum</th>
                                                <th>İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.packages.map(pkg => `
                                                <tr>
                                                    <td><input type="checkbox" value="${pkg.id}" data-customer="${escapeHtml(customerName)}" class="package-checkbox"></td>
                                                    <td>${escapeHtml(pkg.package_no)}</td>
                                                    <td>${pkg.total_quantity}</td>
                                                    <td>${new Date(pkg.created_at).toLocaleDateString('tr-TR')}</td>
                                                    <td><span class="status-${pkg.status}">Sevkiyat Hazır</span></td>
                                                    <td>
                                                        <button onclick="viewPackageDetails('${pkg.id}')" class="btn btn-info btn-sm" title="Detaylar">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `).join('') : 
                        '<div style="text-align:center; color:#666; padding:3rem;">
                            <i class="fas fa-box-open" style="font-size:3rem; margin-bottom:1rem; opacity:0.5;"></i>
                            <h4>Sevkiyat için hazır paket yok</h4>
                            <p>Paketleme sekmesinden paketleri tamamlayın.</p>
                        </div>'
                    }
                </div>
            </div>
        `;
        
        foldersContainer.innerHTML = foldersHTML;
        
    } catch (error) {
        console.error('Error in renderCustomerFolders:', error);
        showToast('Müşteri klasörleri yükleme hatası', 'error');
    }
}

// Original container table view (for traditional view)
async function populateContainerTable() {
    try {
        elements.shippingTableBody.innerHTML = '';
        
        const filter = elements.shippingFilter?.value || 'all';
        let query = supabase.from('containers').select('*');
        
        if (filter !== 'all') {
            query = query.eq('status', filter);
        }
        
        const { data: containers, error } = await query.order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading containers:', error);
            showToast('Sevkiyat verileri yüklenemedi', 'error');
            return;
        }

        if (containers && containers.length > 0) {
            containers.forEach(container => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" value="${container.id}"></td>
                    <td>${container.container_no}</td>
                    <td>${container.customer || 'N/A'}</td>
                    <td>${container.package_count || 0}</td>
                    <td>${container.total_quantity || 0}</td>
                    <td>${container.created_at ? new Date(container.created_at).toLocaleDateString('tr-TR') : 'N/A'}</td>
                    <td><span class="status-${container.status}">${container.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</span></td>
                    <td>
                        <button onclick="sendToRamp('${container.container_no}')" class="btn btn-warning btn-sm">Rampaya Gönder</button>
                        <button onclick="shipContainer('${container.container_no}')" class="btn btn-success btn-sm">Sevk Et</button>
                    </td>
                `;
                elements.shippingTableBody.appendChild(row);
            });
        } else {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="8" style="text-align:center; color:#666;">Sevkiyat verisi yok</td>';
            elements.shippingTableBody.appendChild(row);
        }
        
    } catch (error) {
        console.error('Error in populateContainerTable:', error);
        showToast('Konteyner tablosu yükleme hatası', 'error');
    }
}

// Main function that decides which view to populate
async function populateShippingTable() {
    const viewToggle = document.getElementById('shippingViewToggle');
    if (viewToggle && viewToggle.value === 'folders') {
        await renderCustomerFolders();
    } else {
        await populateContainerTable();
    }
}

// Customer operations
async function showCustomers() {
    try {
        elements.customerList.innerHTML = '';
        
        const { data: customers, error } = await supabase
            .from('customers')
            .select('*')
            .order('name');

        if (error) {
            console.error('Error loading customers:', error);
            showToast('Müşteri verileri yüklenemedi', 'error');
            return;
        }

        if (customers && customers.length > 0) {
            customers.forEach(customer => {
                const div = document.createElement('div');
                div.className = 'customer-item';
                div.innerHTML = `
                    <div>
                        <strong>${customer.name}</strong><br>
                        <small>${customer.code}</small>
                    </div>
                `;
                div.onclick = () => selectCustomerFromModal(customer);
                elements.customerList.appendChild(div);
            });
        }
        
        elements.customerModal.style.display = 'flex';
    } catch (error) {
        console.error('Error in showCustomers:', error);
        showToast('Müşteri listesi yükleme hatası', 'error');
    }
}

async function showAllCustomers() {
    try {
        elements.allCustomersList.innerHTML = '';
        
        const { data: customers, error } = await supabase
            .from('customers')
            .select('*')
            .order('name');

        if (error) {
            console.error('Error loading customers:', error);
            showToast('Müşteri verileri yüklenemedi', 'error');
            return;
        }

        if (customers && customers.length > 0) {
            customers.forEach(customer => {
                const div = document.createElement('div');
                div.className = 'customer-item';
                div.innerHTML = `
                    <div>
                        <strong>${customer.name}</strong> (${customer.code})<br>
                        <small>${customer.email || 'E-posta yok'}</small>
                    </div>
                    <button onclick="deleteCustomer('${customer.id}')" class="btn btn-danger btn-sm">Sil</button>
                `;
                elements.allCustomersList.appendChild(div);
            });
        }
        
        elements.allCustomersModal.style.display = 'flex';
    } catch (error) {
        console.error('Error in showAllCustomers:', error);
        showToast('Müşteri yönetimi yükleme hatası', 'error');
    }
}

async function addNewCustomer() {
    const code = document.getElementById('newCustomerCode').value.trim();
    const name = document.getElementById('newCustomerName').value.trim();
    const email = document.getElementById('newCustomerEmail').value.trim();

    if (!code || !name) {
        showToast('Müşteri kodu ve adı gerekli', 'error');
        return;
    }

    try {
        const { error } = await supabase
            .from('customers')
            .insert([{ code, name, email: email || null }]);

        if (error) {
            console.error('Error adding customer:', error);
            showToast('Müşteri eklenirken hata: ' + error.message, 'error');
            return;
        }

        showToast('Müşteri başarıyla eklendi', 'success');
        
        // Clear form
        document.getElementById('newCustomerCode').value = '';
        document.getElementById('newCustomerName').value = '';
        document.getElementById('newCustomerEmail').value = '';
        
        // Refresh lists
        await populateCustomers();
        await showAllCustomers();
        
    } catch (error) {
        console.error('Error in addNewCustomer:', error);
        showToast('Müşteri ekleme hatası', 'error');
    }
}

async function deleteCustomer(customerId) {
    if (!confirm('Bu müşteriyi silmek istediğinize emin misiniz?')) return;

    try {
        const { error } = await supabase
            .from('customers')
            .delete()
            .eq('id', customerId);

        if (error) {
            console.error('Error deleting customer:', error);
            showToast('Müşteri silinirken hata: ' + error.message, 'error');
            return;
        }

        showToast('Müşteri başarıyla silindi', 'success');
        
        // Refresh lists
        await populateCustomers();
        await showAllCustomers();
        
    } catch (error) {
        console.error('Error in deleteCustomer:', error);
        showToast('Müşteri silme hatası', 'error');
    }
}

function selectCustomerFromModal(customer) {
    selectedCustomer = customer;
    elements.customerSelect.value = customer.id;
    closeModal();
    showToast(`Müşteri seçildi: ${customer.name}`, 'success');
}

// Package operations
function processBarcode() {
    const barcode = elements.barcodeInput.value.trim();
    if (!barcode) {
        showToast('Barkod girin', 'error');
        return;
    }

    // Process barcode logic here
    showToast(`Barkod işlendi: ${barcode}`, 'success');
    elements.barcodeInput.value = '';
    elements.barcodeInput.focus();
}

function openQuantityModal(product) {
    selectedProduct = product;
    elements.quantityModalTitle.textContent = `${product} - Adet Girin`;
    elements.quantityInput.value = '';
    elements.quantityModal.style.display = 'flex';
    elements.quantityInput.focus();
}

function confirmQuantity() {
    const quantity = parseInt(elements.quantityInput.value);
    if (!quantity || quantity <= 0) {
        showToast('Geçerli bir adet girin', 'error');
        return;
    }

    // Update quantity badge
    const badge = document.getElementById(`${selectedProduct}-quantity`);
    if (badge) {
        const currentQuantity = parseInt(badge.textContent) || 0;
        badge.textContent = currentQuantity + quantity;
    }

    // Add to current package
    if (!currentPackage.items) currentPackage.items = {};
    currentPackage.items[selectedProduct] = (currentPackage.items[selectedProduct] || 0) + quantity;

    showToast(`${selectedProduct}: ${quantity} adet eklendi`, 'success');
    closeQuantityModal();
}

function openManualEntry() {
    elements.manualModal.style.display = 'flex';
    document.getElementById('manualProduct').focus();
}

function addManualProduct() {
    const product = document.getElementById('manualProduct').value.trim();
    const quantity = parseInt(document.getElementById('manualQuantity').value);

    if (!product || !quantity || quantity <= 0) {
        showToast('Ürün adı ve geçerli adet girin', 'error');
        return;
    }

    // Add to current package
    if (!currentPackage.items) currentPackage.items = {};
    currentPackage.items[product] = (currentPackage.items[product] || 0) + quantity;

    showToast(`${product}: ${quantity} adet eklendi`, 'success');
    
    // Clear form
    document.getElementById('manualProduct').value = '';
    document.getElementById('manualQuantity').value = '';
    closeManualModal();
}

async function completePackage() {
    if (!selectedCustomer) {
        showToast('Önce müşteri seçin', 'error');
        return;
    }

    if (!currentPackage.items || Object.keys(currentPackage.items).length === 0) {
        showToast('Pakete ürün ekleyin', 'error');
        return;
    }

    try {
        const packageNo = `PKG-${Date.now()}`;
        const totalQuantity = Object.values(currentPackage.items).reduce((sum, qty) => sum + qty, 0);
        const selectedPersonnel = elements.personnelSelect.value;

        const { error } = await supabase
            .from('packages')
            .insert([{
                package_no: packageNo,
                customer_id: selectedCustomer.id,
                items: currentPackage.items,
                total_quantity: totalQuantity,
                status: 'beklemede',
                packer: selectedPersonnel || currentUser?.name || 'Bilinmeyen',
                created_at: new Date().toISOString()
            }]);

        if (error) {
            console.error('Error creating package:', error);
            showToast('Paket oluşturulurken hata: ' + error.message, 'error');
            return;
        }

        showToast(`Paket oluşturuldu: ${packageNo}`, 'success');
        
        // Reset current package and quantities
        currentPackage = {};
        document.querySelectorAll('.quantity-badge').forEach(badge => {
            badge.textContent = '0';
        });
        
        // Refresh packages table
        await populatePackagesTable();
        
    } catch (error) {
        console.error('Error in completePackage:', error);
        showToast('Paket oluşturma hatası', 'error');
    }
}

// Global variable to store selected package
let selectedPackage = null;

function selectPackage(pkg) {
    // Store the selected package globally
    selectedPackage = pkg;
    
    // Remove previous selection styling
    document.querySelectorAll('#packagesTableBody tr').forEach(row => {
        row.classList.remove('selected');
    });
    
    // Find and highlight the selected row
    const rows = document.querySelectorAll('#packagesTableBody tr');
    rows.forEach(row => {
        const packageNo = row.cells[1]?.textContent;
        if (packageNo === pkg.package_no) {
            row.classList.add('selected');
            row._packageData = pkg; // Store package data on the row
        }
    });
    
    // Update package details panel
    const detailContent = document.getElementById('packageDetailContent');
    detailContent.innerHTML = `
        <h4>Paket: ${pkg.package_no}</h4>
        <p><strong>Müşteri:</strong> ${pkg.customers?.name || 'N/A'}</p>
        <p><strong>Toplam Adet:</strong> ${pkg.total_quantity}</p>
        <p><strong>Tarih:</strong> ${new Date(pkg.created_at).toLocaleDateString('tr-TR')}</p>
        <p><strong>Durum:</strong> ${pkg.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</p>
        ${pkg.items ? `
            <h5>Ürünler:</h5>
            <ul>
                ${Object.entries(pkg.items).map(([product, quantity]) => 
                    `<li>${product}: ${quantity} adet</li>`
                ).join('')}
            </ul>
        ` : ''}
    `;
}

// Barcode generation function
function generateBarcode(text) {
    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    JsBarcode(svg, text, {
        format: "CODE128",
        lineColor: "#000",
        width: 2,
        height: 40,
        displayValue: true
    });
    return svg.outerHTML;
}

// Print label function - NO DUPLICATION
// Add printing flag to prevent duplication
let isPrinting = false;

function printLabel() {
    if (!selectedPackage) {
        showToast('Etiket yazdırmak için önce bir paket seçin', 'error');
        return;
    }

    // Prevent multiple print requests
    if (isPrinting) {
        showToast('Etiket zaten yazdırılıyor, lütfen bekleyin', 'warning');
        return;
    }

    isPrinting = true;
    const printButton = document.querySelector('button[onclick="printLabel()"]');
    if (printButton) {
        printButton.disabled = true;
        printButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yazdırılıyor...';
    }

    try {
        // Generate barcode for the selected package
        const barcodeSvg = generateBarcode(selectedPackage.package_no);
        
        // Create printable content
        const printContent = `
            <div style="text-align:center; font-family:Arial; padding:20px; border:2px solid #000; width:350px; margin:auto;">
                <h2 style="color:#2c3e50; margin-bottom:15px;">ProClean</h2>
                <hr style="margin:10px 0;">
                <p style="margin:8px 0;"><strong>Paket No:</strong> ${selectedPackage.package_no}</p>
                <p style="margin:8px 0;"><strong>Müşteri:</strong> ${selectedPackage.customers?.name || 'N/A'}</p>
                <p style="margin:8px 0;"><strong>Toplam Adet:</strong> ${selectedPackage.total_quantity}</p>
                <p style="margin:8px 0;"><strong>Tarih:</strong> ${new Date(selectedPackage.created_at).toLocaleDateString('tr-TR')}</p>
                <hr style="margin:15px 0;">
                <div style="margin:15px 0;">${barcodeSvg}</div>
                <small style="color:#666;">ProClean Çamaşırhane Yönetim Sistemi</small>
            </div>
        `;
        
        // Open print window
        const printWindow = window.open('', '_blank', 'width=400,height=600');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Paket Etiketi - ${selectedPackage.package_no}</title>
                    <style>
                        body { 
                            display:flex; 
                            justify-content:center; 
                            align-items:center; 
                            height:100vh; 
                            margin:0; 
                            background:#f5f5f5;
                        }
                        @media print {
                            body { background:white; }
                        }
                    </style>
                </head>
                <body onload="setTimeout(() => { window.print(); }, 500);">
                    ${printContent}
                </body>
            </html>
        `);
        printWindow.document.close();
        
        showToast(`Etiket yazdırılıyor: ${selectedPackage.package_no}`, 'success');
        
        // Reset printing state after delay
        setTimeout(() => {
            isPrinting = false;
            if (printButton) {
                printButton.disabled = false;
                printButton.innerHTML = 'Etiket Yazdır';
            }
        }, 2000);
        
    } catch (error) {
        console.error('Error printing label:', error);
        showToast('Etiket yazdırılırken hata oluştu', 'error');
        
        // Reset printing state on error
        isPrinting = false;
        if (printButton) {
            printButton.disabled = false;
            printButton.innerHTML = 'Etiket Yazdır';
        }
    }
}

async function deleteSelectedPackages() {
    const checkboxes = document.querySelectorAll('#packagesTableBody input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        showToast('Silinecek paket seçin', 'error');
        return;
    }

    if (!confirm(`${checkboxes.length} paketi silmek istediğinize emin misiniz?`)) return;

    try {
        const packageIds = Array.from(checkboxes).map(cb => cb.value);
        
        const { error } = await supabase
            .from('packages')
            .delete()
            .in('id', packageIds);

        if (error) {
            console.error('Error deleting packages:', error);
            showToast('Paketler silinirken hata: ' + error.message, 'error');
            return;
        }

        showToast(`${packageIds.length} paket silindi`, 'success');
        await populatePackagesTable();
        
    } catch (error) {
        console.error('Error in deleteSelectedPackages:', error);
        showToast('Paket silme hatası', 'error');
    }
}

function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('#packagesTableBody input[type="checkbox"]');
    const selectAll = elements.selectAllCheckbox.checked;
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
    });
}

function updatePackageSelection() {
    const checkboxes = document.querySelectorAll('#packagesTableBody input[type="checkbox"]');
    const checkedBoxes = document.querySelectorAll('#packagesTableBody input[type="checkbox"]:checked');
    
    elements.selectAllCheckbox.checked = checkboxes.length > 0 && checkboxes.length === checkedBoxes.length;
}

// Shipping operations
async function sendToRamp(containerNo) {
    try {
        const selectedPackages = Array.from(document.querySelectorAll('#packagesTableBody input[type="checkbox"]:checked'))
            .map(cb => ({ id: cb.value }));
        
        if (selectedPackages.length === 0) {
            showToast('Rampaya göndermek için paket seçin', 'error');
            return;
        }

        // Create or update container
        const { data: newContainer, error } = await supabase
            .from('containers')
            .insert([{
                container_no: containerNo,
                customer: selectedCustomer?.name || '',
                package_count: selectedPackages.length,
                total_quantity: selectedPackages.length, // This should be calculated properly
                status: 'beklemede',
                package_ids: selectedPackages.map(p => p.id)
            }])
            .select();

        if (error) {
            console.error('Error creating container:', error);
            showToast('Konteyner oluşturulurken hata: ' + error.message, 'error');
            return;
        }

        // Update packages with container reference
        for (const pkg of selectedPackages) {
            await supabase
                .from('packages')
                .update({ container_id: newContainer[0].id })
                .eq('id', pkg.id);
        }

        showToast(`${selectedPackages.length} paket rampaya gönderildi`, 'success');
        await populateShippingTable();
        
    } catch (error) {
        console.error('Error sending to ramp:', error);
        showToast('Rampaya gönderilirken hata oluştu', 'error');
    }
}

async function shipContainer(containerNo) {
    try {
        await supabase
            .from('containers')
            .update({ status: 'sevk-edildi' })
            .eq('container_no', containerNo);

        showToast(`Konteyner ${containerNo} sevk edildi`, 'success');
        await populateShippingTable();
        
    } catch (error) {
        console.error('Error shipping container:', error);
        showToast('Konteyner sevk edilirken hata oluştu', 'error');
    }
}

function filterShipping() {
    populateShippingTable();
}

// Customer folder management functions for sevkiyat
function toggleCustomerFolder(customerName) {
    const folder = document.querySelector(`[data-customer="${customerName}"]`);
    if (folder) {
        folder.classList.toggle('expanded');
    }
}

function toggleCustomerPackages(customerName, checked) {
    const checkboxes = document.querySelectorAll(`input[data-customer="${customerName}"].package-checkbox`);
    checkboxes.forEach(checkbox => {
        checkbox.checked = checked;
    });
}

function selectAllCustomerPackages(customerName) {
    const selectAllCheckbox = document.querySelector(`[data-customer="${customerName}"] thead input[type="checkbox"]`);
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = true;
        toggleCustomerPackages(customerName, true);
    }
    showToast(`${customerName} için tüm paketler seçildi`, 'success');
}

// View package details
async function viewPackageDetails(packageId) {
    try {
        const { data: pkg, error } = await supabase
            .from('packages')
            .select(`
                *,
                customers (name, code)
            `)
            .eq('id', packageId)
            .single();
            
        if (error) throw error;
        
        const detailsHTML = `
            <div style="padding: 1rem;">
                <h4>${pkg.package_no}</h4>
                <p><strong>Müşteri:</strong> ${pkg.customers?.name || 'N/A'}</p>
                <p><strong>Toplam Adet:</strong> ${pkg.total_quantity}</p>
                <p><strong>Tarih:</strong> ${new Date(pkg.created_at).toLocaleDateString('tr-TR')}</p>
                ${pkg.items ? `
                    <h5>Ürünler:</h5>
                    <ul>
                        ${Object.entries(pkg.items).map(([product, quantity]) => 
                            `<li>${product}: ${quantity} adet</li>`
                        ).join('')}
                    </ul>
                ` : ''}
            </div>
        `;
        
        // You could show this in a modal or update the package details section
        showToast('Paket detayları konsola yazdırıldı', 'info');
        console.log('Package Details:', pkg);
        
    } catch (error) {
        console.error('Error viewing package details:', error);
        showToast('Paket detayları yüklenemedi', 'error');
    }
}

async function createContainerForCustomer(customerName) {
    try {
        const selectedPackages = Array.from(document.querySelectorAll(`input[data-customer="${customerName}"].package-checkbox:checked`))
            .map(cb => cb.value);
        
        if (selectedPackages.length === 0) {
            showToast(`${customerName} için paket seçin`, 'error');
            return;
        }

        if (!confirm(`${customerName} için ${selectedPackages.length} paket ile konteyner oluşturulsun mu?`)) {
            return;
        }

        const timestamp = new Date().getTime();
        const containerNo = `CONT-${customerName.substring(0, 3).toUpperCase()}-${timestamp.toString().slice(-6)}`;
        
        // Create container
        const { data: newContainer, error } = await supabase
            .from('containers')
            .insert([{
                container_no: containerNo,
                customer: customerName,
                package_count: selectedPackages.length,
                total_quantity: await calculateTotalQuantityForPackages(selectedPackages),
                status: 'beklemede',
                package_ids: selectedPackages
            }])
            .select();

        if (error) throw error;

        // Update packages with container reference and mark as shipped
        await supabase
            .from('packages')
            .update({ 
                container_id: newContainer[0].id,
                status: 'sevk-edildi'
            })
            .in('id', selectedPackages);

        showToast(`${customerName} için konteyner oluşturuldu: ${containerNo}`, 'success');
        
        // Refresh the shipping view
        await renderCustomerFolders();
        
    } catch (error) {
        console.error('Error creating container for customer:', error);
        showToast('Konteyner oluşturulurken hata oluştu', 'error');
    }
}

async function addToContainer(packageId) {
    try {
        if (!currentContainer) {
            showToast('Önce bir konteyner seçin veya oluşturun', 'error');
            return;
        }

        await supabase
            .from('packages')
            .update({ container_id: currentContainer })
            .eq('id', packageId);

        showToast('Paket konteynere eklendi', 'success');
        await populateShippingTable();
        
    } catch (error) {
        console.error('Error adding package to container:', error);
        showToast('Paket eklenirken hata oluştu', 'error');
    }
}

async function calculateTotalQuantityForPackages(packageIds) {
    try {
        const { data: packages, error } = await supabase
            .from('packages')
            .select('total_quantity')
            .in('id', packageIds);

        if (error) throw error;

        return packages.reduce((sum, pkg) => sum + (pkg.total_quantity || 0), 0);
    } catch (error) {
        console.error('Error calculating total quantity:', error);
        return packageIds.length; // Fallback
    }
}

// Stock operations
function searchStock() {
    const searchTerm = elements.stockSearch.value.toLowerCase();
    const rows = elements.stockTableBody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function clearStockSearch() {
    elements.stockSearch.value = '';
    const rows = elements.stockTableBody.querySelectorAll('tr');
    rows.forEach(row => {
        row.style.display = '';
    });
}

async function uploadStockFile() {
    const fileInput = document.getElementById('stockFileUpload');
    const file = fileInput.files[0];
    if (!file) {
        showToast('Lütfen bir dosya seçin', 'error');
        return;
    }

    showToast('Dosya yükleniyor...', 'warning');

    try {
        let stockData = [];
        
        if (file.name.endsWith('.csv')) {
            const text = await file.text();
            stockData = Papa.parse(text, { header: true }).data;
        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            stockData = XLSX.utils.sheet_to_json(worksheet);
        }

        for (const item of stockData) {
            const code = item['Stok Kodu'] || item['code'] || item['StokKodu'] || '';
            const name = item['Ürün Adı'] || item['name'] || item['ÜrünAdı'] || item['product'] || '';
            const quantity = parseInt(item['Mevcut Adet'] || item['quantity'] || item['MevcutAdet'] || 0);
            const unit = item['Birim'] || item['unit'] || 'Adet';
            
            if (!code || !name) continue;

            await supabase
                .from('stock_items')
                .upsert({
                    code: code,
                    name: name,
                    quantity: quantity,
                    unit: unit,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'code' });
        }

        showToast('Stok dosyası başarıyla yüklendi', 'success');
        elements.selectedFileName.textContent = '';
        fileInput.value = '';
        
        await populateStockTable();
        
    } catch (error) {
        console.error('Error uploading stock file:', error);
        showToast('Dosya yüklenirken hata oluştu', 'error');
    }
}

// Report operations
function generateDailyReport() {
    elements.emailModal.style.display = 'flex';
}

function closeEmailModal() {
    elements.emailModal.style.display = 'none';
}

async function sendDailyReport() {
    const email = elements.reportEmail.value;
    if (!email) {
        showToast('Lütfen e-posta adresini girin', 'error');
        return;
    }

    showToast('Rapor gönderiliyor...', 'warning');
    
    // Simulate email sending
    setTimeout(() => {
        showToast(`Rapor ${email} adresine gönderildi`, 'success');
        closeEmailModal();
    }, 2000);
}

async function previewReport() {
    await populatePackagesTable();
    
    const reportData = {
        date: new Date().toLocaleDateString('tr-TR'),
        totalPackages: packages.length,
        totalItems: packages.reduce((sum, pkg) => sum + pkg.total_quantity, 0),
        containers: containers.length,
        customers: [...new Set(packages.map(p => p.customers?.name))].length,
        operator: currentUser?.name || 'Bilinmiyor'
    };

    const reportWindow = window.open('', '_blank');
    reportWindow.document.write(`
        <html>
        <head>
            <title>İş Sonu Raporu - ${reportData.date}</title>
            <style>
                body { font-family: Arial; margin: 20px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
            </style>
        </head>
        <body>
            <h1>ProClean - İş Sonu Raporu</h1>
            <p><strong>Tarih:</strong> ${reportData.date} | <strong>Operatör:</strong> ${reportData.operator}</p>
            
            <h2>Özet</h2>
            <ul>
                <li>Toplam Paket Sayısı: ${reportData.totalPackages}</li>
                <li>Toplam Ürün Adedi: ${reportData.totalItems}</li>
                <li>Konteyner Sayısı: ${reportData.containers}</li>
                <li>Müşteri Sayısı: ${reportData.customers}</li>
            </ul>
            
            <h2>Paket Detayları</h2>
            <table>
                <thead>
                    <tr>
                        <th>Paket No</th>
                        <th>Müşteri</th>
                        <th>Adet</th>
                        <th>Zaman</th>
                        <th>Paketleyen</th>
                    </tr>
                </thead>
                <tbody>
                    ${packages.map(pkg => `
                        <tr>
                            <td>${escapeHtml(pkg.package_no)}</td>
                            <td>${escapeHtml(pkg.customers?.name || 'N/A')}</td>
                            <td>${pkg.total_quantity}</td>
                            <td>${new Date(pkg.created_at).toLocaleString('tr-TR')}</td>
                            <td>${escapeHtml(pkg.packer)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </body>
        </html>
    `);
    reportWindow.document.close();
}

// Container operations
function loadCurrentContainer() {
    showToast('Mevcut konteyner yüklendi', 'success');
}

async function createNewContainer() {
    try {
        const timestamp = new Date().getTime();
        const containerNo = `CONT-${timestamp.toString().slice(-6)}`;
        
        const { data: newContainer, error } = await supabase
            .from('containers')
            .insert([{
                container_no: containerNo,
                customer: '',
                package_count: 0,
                total_quantity: 0,
                status: 'beklemede',
                package_ids: []
            }])
            .select();

        if (error) throw error;

        elements.containerNumber.textContent = containerNo;
        currentContainer = containerNo;
        
        showToast(`Yeni konteyner oluşturuldu: ${containerNo}`, 'success');
        await populateShippingTable();
        
    } catch (error) {
        console.error('Error creating container:', error);
        showToast('Konteyner oluşturulurken hata oluştu', 'error');
    }
}

async function deleteContainer() {
    if (!confirm('Konteyneri silmek istediğinize emin misiniz?')) return;

    try {
        await supabase
            .from('containers')
            .delete()
            .eq('container_no', currentContainer);

        elements.containerNumber.textContent = 'Yok';
        currentContainer = null;
        
        showToast('Konteyner silindi', 'success');
        await populateShippingTable();
        
    } catch (error) {
        console.error('Error deleting container:', error);
        showToast('Konteyner silinirken hata oluştu', 'error');
    }
}

// Utility functions
function switchTab(tabName) {
    // Hide all tab panes
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    // Deactivate all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Activate selected tab
    const selectedTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
    const selectedPane = document.getElementById(`${tabName}Tab`);
    
    if (selectedTab && selectedPane) {
        selectedTab.classList.add('active');
        selectedPane.classList.add('active');
    }
}

function closeAllModals() {
    elements.customerModal.style.display = 'none';
    elements.allCustomersModal.style.display = 'none';
    elements.emailModal.style.display = 'none';
    elements.quantityModal.style.display = 'none';
    elements.manualModal.style.display = 'none';
}

function closeModal() {
    elements.customerModal.style.display = 'none';
}

function closeAllCustomersModal() {
    elements.allCustomersModal.style.display = 'none';
}

function closeQuantityModal() {
    elements.quantityModal.style.display = 'none';
}

function closeManualModal() {
    elements.manualModal.style.display = 'none';
}

function showToast(message, type = 'success', duration = 3000) {
    elements.toast.textContent = message;
    elements.toast.className = `toast ${type} show`;
    
    setTimeout(() => {
        elements.toast.classList.remove('show');
    }, duration);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize auth state listener
supabase.auth.onAuthStateChange((event, session) => {
    console.log('Auth state change:', event, session?.user?.email || 'No user');
    
    if (session) {
        currentUser = {
            email: session.user.email,
            uid: session.user.id,
            name: session.user.email.split('@')[0]
        };
        
        elements.userRole.textContent = `Operatör: ${currentUser.name}`;
        elements.loginScreen.style.display = "none";
        elements.appContainer.style.display = "flex";
        
        initApp();
    } else {
        elements.loginScreen.style.display = "flex";
        elements.appContainer.style.display = "none";
    }
});

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Login button event
    document.getElementById('loginBtn').addEventListener('click', login);
    
    // Logout button event
    document.getElementById('logoutBtn').addEventListener('click', logout);
    
    // Enter key for login
    document.getElementById('email').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') login();
    });
    document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') login();
    });
    
    // Quantity modal enter key
    elements.quantityInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') confirmQuantity();
    });
    
    // Barcode input enter key
    elements.barcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') processBarcode();
    });
    
    // Tab click events
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName);
        });
    });
    
    // Customer select change
    elements.customerSelect.addEventListener('change', function() {
        const customerId = this.value;
        if (customerId) {
            // Find customer from populated options
            const selectedOption = this.options[this.selectedIndex];
            selectedCustomer = {
                id: customerId,
                name: selectedOption.textContent.split(' (')[0],
                code: selectedOption.textContent.match(/\(([^)]+)\)/)?.[1] || ''
            };
            showToast(`Müşteri seçildi: ${selectedCustomer.name}`, 'success');
        } else {
            selectedCustomer = null;
        }
    });
    
    // Initial state
    elements.loginScreen.style.display = 'flex';
    elements.appContainer.style.display = 'none';
    
    // Initialize shipping view toggle
    const shippingViewToggle = document.getElementById('shippingViewToggle');
    if (shippingViewToggle) {
        shippingViewToggle.addEventListener('change', toggleShippingView);
    }
});

console.log('ProClean application initialized with Supabase authentication');
</script>
</body>
</html>
