<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
            --text: #2c3e50;
            --bg: #f5f7fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html,body { height:100%; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* Enhanced Offline Indicators */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(45deg, var(--warning), #e67e22);
            color: white;
            padding: 12px;
            text-align: center;
            z-index: 10000;
            font-weight: bold;
            display: none;
            animation: pulse 2s infinite;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .sync-progress {
            position: fixed;
            top: 60px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            display: none;
            min-width: 280px;
        }

        .sync-progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .sync-progress-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .connection-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--success);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .connection-indicator.offline {
            background: var(--warning);
        }

        .connection-indicator.syncing {
            background: var(--secondary);
            animation: pulse 1.5s infinite;
        }

        .connection-indicator.error {
            background: var(--accent);
        }

        /* Login Screen */
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%); }
        .login-form { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .login-form h1 { text-align: center; margin-bottom: 1.5rem; color: var(--primary); }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display:block; margin-bottom:0.5rem; font-weight:500; }
        .form-group input { width:100%; padding:0.8rem; border:1px solid #ddd; border-radius:5px; font-size:1rem; }

        .btn { padding:0.6rem 1rem; border:none; border-radius:5px; cursor:pointer; font-size:0.9rem; font-weight:600; transition:all .3s; display:inline-block; text-align:center; }
        .btn-primary { background:var(--secondary); color:#fff; }
        .btn-primary:hover { background:#2980b9; }
        .btn-link { background:none; color:var(--secondary); text-decoration:underline; padding:0.5rem; }

        /* Main */
        .app-container { display:none; flex-direction:column; height:100vh; }

        /* Enhanced Header */
        .app-header { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
            color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; 
        }
        .app-title { font-size:1.3rem; font-weight:600; }
        .user-info { display:flex; align-items:center; gap:0.8rem; }

        .user-info button {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 100px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            font-size: 0.8rem;
            margin-right: 10px;
        }

        .sync-status.online {
            background: var(--success);
        }

        .sync-status.offline {
            background: var(--warning);
        }

        .sync-status.syncing {
            background: var(--secondary);
            animation: pulse 1.5s infinite;
        }

        .sync-queue-badge {
            background: var(--accent);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7rem;
            margin-left: 5px;
            display: none;
        }

        .user-info button:hover { background: #c0392b; transform: translateY(-1px); }

        /* Tabs */
        .tabs { display:flex; background-color:var(--dark); }
        .tab { padding:0.8rem 1.5rem; color:white; cursor:pointer; font-weight:500; border-bottom:3px solid transparent; font-size:0.9rem; }
        .tab.active { background:var(--light); color:var(--primary); border-bottom:3px solid var(--secondary); }

        /* Content */
        .tab-content { flex-grow:1; padding:1.2rem; overflow:hidden; }
        .tab-pane { display:none; height: calc(100vh - 200px); overflow:auto; }
        .tab-pane.active { display:block; }

        .packaging-header { display:flex; justify-content:space-between; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; align-items: center; }
        .customer-info { display:flex; gap:0.8rem; align-items: center; flex-wrap: wrap; }
        .info-group { display:flex; flex-direction:column; margin-bottom: 0; }
        .info-group label { font-weight:600; margin-bottom:0.2rem; font-size:0.8rem; }
        .info-group select, .info-group input { padding:0.4rem; border:1px solid #ddd; border-radius:5px; font-size:0.8rem; height: auto; }
        .info-group span { font-size: 0.9rem; }
        .action-buttons { display:flex; gap:0.6rem; }

        .packaging-content {
            display: flex;
            gap: 1.2rem;
            align-items: flex-start;
            padding-bottom: 10px;
        }
        .barcode-section { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .pending-packages { flex: 0 0 50%; min-width: 360px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); overflow:auto; }
        .package-details { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); display:flex; flex-direction:column; }

        .barcode-input { display:flex; margin-bottom:0.8rem; }
        .barcode-input input { flex-grow:1; padding:0.6rem; border:1px solid #ddd; border-radius:5px 0 0 5px; font-size:1rem; }
        .barcode-input button { padding:0 0.8rem; border:1px solid #ddd; background:var(--light); cursor:pointer; }

        .package-table { width:100%; border-collapse:collapse; font-size:0.85rem; }
        .package-table th, .package-table td { padding:0.5rem; text-align:left; border-bottom:1px solid #ddd; }
        .package-table th { background:var(--light); font-weight:600; }
        .package-table tr:hover { background:#f9f9f9; }

        .quick-buttons { display:grid; grid-template-columns:repeat(3, 1fr); gap:0.4rem; margin-top:0.8rem; }
        .quick-btn { padding:0.6rem 0.4rem; background:var(--light); border:1px solid #ddd; border-radius:5px; cursor:pointer; text-align:center; font-size:0.8rem; position:relative; }
        .quantity-badge { position:absolute; top:-5px; right:-5px; background:var(--secondary); color:white; border-radius:50%; width:18px; height:18px; font-size:0.7rem; display:flex; align-items:center; justify-content:center; }

        .package-actions { margin-top:auto; display:flex; flex-direction:column; gap:0.6rem; }

        .btn-success { background:var(--success); color:white; }
        .btn-warning { background:var(--warning); color:white; }
        .btn-danger { background:var(--accent); color:white; }

        .status-beklemede { background: var(--warning); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }
        .status-sevk-edildi { background: var(--success); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }

        .app-footer { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; font-size:0.85rem; }
        .container-info { display:flex; align-items:center; gap:0.8rem; }

        /* Enhanced Toast System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            pointer-events: none;
        }

        .toast { 
            background: var(--success); color: white; padding: 12px 20px; border-radius: 6px; 
            margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0; transform: translateX(100%); transition: all 0.3s ease;
            pointer-events: auto; cursor: pointer;
            max-width: 350px; word-wrap: break-word;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.error { background: var(--accent); }
        .toast.warning { background: var(--warning); }
        .toast.success { background: var(--success); }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; }
        .modal-close { background:none; border:none; font-size:1.5rem; cursor:pointer; }

        .customer-list { max-height:300px; overflow-y:auto; margin-bottom:1rem; }
        .customer-item { padding:0.8rem; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
        .customer-item:hover { background:#f5f5f5; } .customer-item.selected { background:#e3f2fd; }

        .quantity-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center; }
        .quantity-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:300px; text-align:center; }
        .quantity-input { width:100%; padding:0.8rem; margin:1rem 0; border:1px solid #ddd; border-radius:5px; font-size:1.2rem; text-align:center; }
        .quantity-buttons { display:flex; justify-content:center; gap:0.8rem; margin-top:1rem; }

        .stock-search { display:flex; gap:0.8rem; margin-bottom:1.2rem; }
        .stock-search input { flex-grow:1; padding:0.8rem; border:1px solid #ddd; border-radius:5px; }
        .stock-table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .stock-table th, .stock-table td { padding:0.8rem; text-align:left; border-bottom:1px solid #ddd; } .stock-table th { background:var(--light); font-weight:600; } .stock-table tr:hover { background:#f9f9f9; }

        .file-upload { margin-top:1.2rem; padding:1.2rem; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .upload-button { display:inline-block; padding:0.8rem 1.5rem; background:var(--secondary); color:white; border-radius:5px; cursor:pointer; margin-top:0.8rem; }
        .upload-button:hover { background:#2980b9; }

        /* Stock status classes */
        .status-kritik { background:#c0392b;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }
        .status-az-stok { background:#f39c12;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }
        .status-stokta { background:#2ecc71;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }

        /* Responsive */
        @media (max-width:1200px) {
            .barcode-section, .package-details { min-width:200px; }
            .pending-packages { flex: 1 1 60%; }
        }
        @media (max-width:900px) {
            .packaging-content { flex-direction:column; height:auto; }
            .barcode-section, .pending-packages, .package-details { flex: 1 1 auto; width:100%; min-width: auto; }
            .tab-pane { height: auto; }
        }

        .package-table tr.selected {
            background-color: #e3f2fd !important;
            font-weight: bold;
        }

        .package-table tr.selected:hover {
            background-color: #bbdefb !important;
        }
        
        .api-key-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }
        
        .api-key-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        
        .api-key-input {
            width: 100%;
            padding: 0.8rem;
            margin: 1rem 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        /* Desktop app styling */
        .app-container {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: 20px;
            height: calc(100vh - 40px);
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tabs {
            background: linear-gradient(to bottom, #3a5169 0%, #2c3e50 100%);
        }

        .tab {
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            background: var(--light);
            color: var(--primary);
            border-bottom: 3px solid var(--secondary);
            font-weight: bold;
        }

        /* Form elements styling */
        select, input {
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            transition: all 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Enhanced Offline Banner -->
    <div class="offline-banner" id="offlineBanner">
        <i class="fas fa-wifi-slash"></i>
        Çevrimdışı moddasınız. Veriler yerel olarak kaydediliyor ve bağlantı sağlandığında senkronize edilecek.
    </div>

    <!-- Enhanced Sync Progress -->
    <div class="sync-progress" id="syncProgress">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-sync-alt" style="animation: spin 1s linear infinite;"></i>
            <span id="syncMessage">Senkronizasyon devam ediyor...</span>
        </div>
        <div class="sync-progress-bar">
            <div class="sync-progress-fill" id="syncProgressFill"></div>
        </div>
        <div style="font-size: 0.8rem; margin-top: 8px;" id="syncDetails">0/0 öğe işlendi</div>
    </div>

    <!-- Connection Indicator -->
    <div class="connection-indicator online" id="connectionIndicator">
        <i class="fas fa-wifi" id="connectionIcon"></i>
        <span id="connectionStatus">Çevrimiçi</span>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- API Key Giriş Modalı -->
    <div class="api-key-modal" id="apiKeyModal">
        <div class="api-key-content">
            <h2>Supabase API Anahtarı Gerekli</h2>
            <p>Uygulamayı kullanabilmek için geçerli bir Supabase API anahtarı girmeniz gerekiyor.</p>
            <input type="text" id="apiKeyInput" class="api-key-input" placeholder="Supabase API Anahtarınızı girin">
            <div class="quantity-buttons">
                <button type="button" class="btn btn-primary" onclick="saveApiKey()">Kaydet</button>
                <button type="button" class="btn btn-secondary" onclick="showApiKeyHelp()">Yardım</button>
            </div>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                API anahtarını nasıl alacağınızı bilmiyorsanız "Yardım" butonuna tıklayın.
            </p>
        </div>
    </div>

    <div class="login-container" id="loginScreen">
        <div class="login-form">
            <h1>ProClean - Oturum Aç</h1>
            <div class="form-group">
                <label for="email">E-posta</label>
                <input type="email" id="email" placeholder="E-posta adresinizi girin">
            </div>
            <div class="form-group">
                <label for="password">Şifre</label>
                <input type="password" id="password" placeholder="Şifrenizi girin">
            </div>
            <button type="button" class="btn btn-primary" id="loginBtn">Giriş Yap</button>
            <div style="margin-top: 1rem; text-align: center;">
                <a href="#" onclick="showApiKeyModal()" style="color: #3498db; text-decoration: underline; font-size: 0.9rem;">API Anahtarını Yönet</a>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer" aria-hidden="true">
        <div class="app-header">
            <div class="app-title">ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</div>
            <div class="user-info">
                <div class="sync-status online" id="syncStatus">
                    <i class="fas fa-cloud" id="syncIcon"></i>
                    <span id="syncText">Senkronize</span>
                    <span class="sync-queue-badge" id="syncQueueBadge">0</span>
                </div>
                <span id="userRole">Operatör: Yükleniyor...</span>
                <button type="button" id="syncBtn" class="btn btn-warning" style="display: none; background: var(--warning); color: white;">
                    <i class="fas fa-sync-alt"></i> Senkronize Et
                </button>
                <button type="button" id="logoutBtn" class="btn btn-danger" style="background: var(--accent); color: white;">Çıkış Yap</button>
            </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Ana Sekmeler">
            <div class="tab active" data-tab="packaging" role="tab">Paketleme</div>
            <div class="tab" data-tab="shipping" role="tab">Sevkiyat</div>
            <div class="tab" data-tab="stock" role="tab">Stok Sorgu</div>
        </div>

        <div class="tab-content">
            <div class="tab-pane active" id="packagingTab">
                <div class="packaging-header">
                    <div class="customer-info">
                        <div class="info-group">
                            <label for="customerSelect">Müşteri Seçimi</label>
                            <select id="customerSelect">
                                <option value="">Müşteri seçin...</option>
                            </select>
                        </div>
                        <div class="info-group">
                            <label for="personnelSelect">Personel</label>
                            <select id="personnelSelect">
                                <option value="">Personel seçin...</option>
                            </select>
                        </div>
                        <div class="info-group">
                            <label>Tarih</label>
                            <span id="currentDate">-</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="showAllCustomers()">Müşteri Yönetimi</button>
                        <button type="button" class="btn btn-warning" onclick="generateDailyReport()">İş Sonu Raporu</button>
                        <button type="button" class="btn btn-success" onclick="sendToRamp()">Konteynere Ekle</button>
                    </div>
                </div>

                <div class="packaging-content">
                    <div class="barcode-section">
                        <h3>Barkod Okuma</h3>
                        <div class="barcode-input">
                            <input type="text" id="barcodeInput" placeholder="Barkod okutun veya girin" autofocus>
                            <button type="button" onclick="processBarcode()"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="barcodeResult"></div>
                        
                        <div class="quick-buttons">
                            <div class="quick-btn" onclick="openQuantityModal('Büyük Çarşaf')" data-product="Büyük çarşaf">
                                <span>Büyük çarşaf</span>
                                <div class="quantity-badge" id="Büyük Çarşaf-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Çarşaf')" data-product="Çarşaf">
                                <span>Çarşaf</span>
                                <div class="quantity-badge" id="Çarşaf-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Büyük Nevresim')" data-product="Büyük Nevresim">
                                <span>Büyük Nevresim</span>
                                <div class="quantity-badge" id="Büyük Nevresim-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Nevresim')" data-product="Nevresim">
                                <span>Nevresim</span>
                                <div class="quantity-badge" id="Nevresim-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Büyük Havlu')" data-product="Büyük Havlu">
                                <span>Büyük Havlu</span>
                                <div class="quantity-badge" id="Büyük Havlu-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Havlu')" data-product="Havlu">
                                <span>Havlu</span>
                                <div class="quantity-badge" id="Havlu-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Yastık')" data-product="Yastık">
                                <span>Yastık</span>
                                <div class="quantity-badge" id="Yastık-quantity">0</div>
                            </div>
                            <div class="quick-btn" onclick="openQuantityModal('Yastık Kılıfı')" data-product="Yastık Kılıfı">
                                <span>Yastık Kılıfı</span>
                                <div class="quantity-badge" id="Yastık Kılıfı-quantity">0</div>
                            </div>
                             <div class="quick-btn" onclick="openQuantityModal('Alez')" data-product="Alez">
                                <span>Alez</span>
                                <div class="quantity-badge" id="Alez-quantity">0</div>
                            </div>
                        </div>

                        <div class="package-actions">
                            <button type="button" class="btn btn-success" onclick="completePackage()">Paketi Tamamla</button>
                            <button type="button" class="btn btn-warning" onclick="openManualEntry()">Manuel Giriş</button>
                            <button type="button" class="btn btn-danger" onclick="clearCurrentPackage()">Temizle</button>
                        </div>
                    </div>

                    <div class="pending-packages">
                        <h3>Bekleyen Paketler <span id="totalPackages" style="background: var(--secondary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">0</span></h3>
                        <table class="package-table">
                            <thead>
                                <tr>
                                    <th>Seç</th>
                                    <th>Paket No</th>
                                    <th>Müşteri</th>
                                    <th>Adet</th>
                                    <th>Tarih</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTableBody">
                                <tr>
                                    <td colspan="6" style="text-align:center; color:#666;">Henüz paket yok</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="package-details">
                        <h3>Paket Detayları</h3>
                        <div id="packageDetailContent">
                            <p style="text-align:center; color:#666; margin:2rem 0;">Paket seçin</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="shippingTab">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Sevkiyat Yönetimi</h2>
                    <div>
                        <select id="shippingFilter" onchange="populateShippingTable()">
                            <option value="all">Tüm Sevkiyatlar</option>
                            <option value="beklemede">Beklemede</option>
                            <option value="sevk-edildi">Sevk Edildi</option>
                        </select>
                    </div>
                </div>
                
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>Seç</th>
                            <th>Konteyner No</th>
                            <th>Müşteri</th>
                            <th>Paket Sayısı</th>
                            <th>Toplam Adet</th>
                            <th>Tarih</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="shippingTableBody">
                        <tr>
                            <td colspan="8" style="text-align:center; color:#666;">Sevkiyat verisi yok</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="tab-pane" id="stockTab">
                <div class="stock-search">
                    <input type="text" placeholder="Stok ara..." onkeyup="filterStock()">
                    <button type="button" class="btn btn-warning" onclick="uploadStockFile()">Dosya Yükle</button>
                    <button type="button" class="btn btn-primary" onclick="downloadStockTemplate()">Şablon İndir</button>
                </div>
                
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>Stok Kodu</th>
                            <th>Ürün Adı</th>
                            <th>Mevcut Adet</th>
                            <th>Birim</th>
                            <th>Durum</th>
                            <th>Son Güncelleme</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                        <tr>
                            <td colspan="6" style="text-align:center; color:#666;">Stok verisi yok</td>
                        </tr>
                    </tbody>
                </table>

                <div class="file-upload">
                    <h4>Stok Dosyası Yükleme</h4>
                    <p>CSV veya Excel dosyası seçin. Dosya sütunları: Stok Kodu, Ürün Adı, Mevcut Adet, Birim</p>
                    <input type="file" id="stockFileInput" accept=".csv,.xlsx,.xls" onchange="handleStockFileUpload(this)">
                    <div id="selectedFileName"></div>
                </div>
            </div>
        </div>

        <div class="app-footer">
            <div class="container-info">
                <span>Konteyner: <strong id="containerNumber">Yok</strong></span>
                <span>Toplam Paket: <strong id="totalPackagesCount">0</strong></span>
                <span>Sevkiyat: <strong id="totalShipments">0</strong></span>
            </div>
            <div>
                <span>ProClean v2.1 - Çevrimdışı Destekli</span>
            </div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Müşteri Seçimi</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="customer-list" id="customerList">
                <!-- Customer list will be populated here -->
            </div>
        </div>
    </div>

    <!-- All Customers Modal -->
    <div class="modal" id="allCustomersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Müşteri Yönetimi</h3>
                <button class="modal-close" onclick="closeAllCustomersModal()">&times;</button>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <h4>Yeni Müşteri Ekle</h4>
                <input type="text" id="newCustomerCode" placeholder="Müşteri Kodu" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #ddd; border-radius: 5px;">
                <input type="text" id="newCustomerName" placeholder="Müşteri Adı" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #ddd; border-radius: 5px;">
                <input type="email" id="newCustomerEmail" placeholder="E-posta" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #ddd; border-radius: 5px;">
                <button type="button" class="btn btn-success" onclick="addNewCustomer()">Müşteri Ekle</button>
            </div>
            
            <h4>Mevcut Müşteriler</h4>
            <div class="customer-list" id="allCustomersList">
                <!-- All customers list will be populated here -->
            </div>
        </div>
    </div>

    <!-- Quantity Modal -->
    <div class="quantity-modal" id="quantityModal">
        <div class="quantity-content">
            <h3 id="quantityModalTitle">Adet Girin</h3>
            <input type="number" id="quantityInput" class="quantity-input" placeholder="Adet" min="1">
            <div class="quantity-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeQuantityModal()">İptal</button>
                <button type="button" class="btn btn-success" onclick="confirmQuantity()">Onayla</button>
            </div>
        </div>
    </div>

    <!-- Manual Entry Modal -->
    <div class="modal" id="manualModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manuel Ürün Girişi</h3>
                <button class="modal-close" onclick="closeManualModal()">&times;</button>
            </div>
            <input type="text" id="manualProduct" placeholder="Ürün Adı" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #ddd; border-radius: 5px;">
            <input type="number" id="manualQuantity" placeholder="Adet" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #ddd; border-radius: 5px;">
            <button type="button" class="btn btn-success" onclick="addManualProduct()">Ekle</button>
        </div>
    </div>

    <!-- Email Modal -->
    <div class="modal" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>İş Sonu Raporu Gönder</h3>
                <button class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <input type="email" id="reportEmail" placeholder="E-posta adresi" style="width: 100%; padding: 0.5rem; margin: 1rem 0; border: 1px solid #ddd; border-radius: 5px;">
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn btn-primary" onclick="previewReport()">Önizleme</button>
                <button type="button" class="btn btn-success" onclick="sendDailyReport()">Gönder</button>
            </div>
        </div>
    </div>

<script>
// ==================== ENHANCED OFFLINE SYSTEM ====================
// ProClean Professional Offline Enhancement v2.1.0

// Global variables - keeping originals
let supabase = null;
let currentUser = null;
let selectedCustomer = null;
let selectedProduct = null;
let currentContainer = null;
let currentPackage = {};
let selectedPackageId = null;
let isOnline = navigator.onLine;

// Enhanced offline storage
let offlineDB = null;
let syncQueue = [];
let offlineCache = {
    packages: [],
    customers: [],
    stockItems: [],
    containers: [],
    personnel: []
};

// ==================== OFFLINE DATABASE SETUP ====================
class OfflineDatabase {
    constructor() {
        this.dbName = 'ProCleanOfflineDB';
        this.version = 1;
        this.db = null;
    }

    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                this.db = request.result;
                resolve();
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // Create object stores for caching
                if (!db.objectStoreNames.contains('packages')) {
                    const packagesStore = db.createObjectStore('packages', { keyPath: 'id' });
                    packagesStore.createIndex('customer_id', 'customer_id', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('customers')) {
                    const customersStore = db.createObjectStore('customers', { keyPath: 'id' });
                    customersStore.createIndex('code', 'code', { unique: true });
                }
                
                if (!db.objectStoreNames.contains('stockItems')) {
                    db.createObjectStore('stockItems', { keyPath: 'id' });
                }
                
                if (!db.objectStoreNames.contains('containers')) {
                    db.createObjectStore('containers', { keyPath: 'id' });
                }
                
                if (!db.objectStoreNames.contains('syncQueue')) {
                    db.createObjectStore('syncQueue', { keyPath: 'id', autoIncrement: true });
                }
                
                if (!db.objectStoreNames.contains('offlineOperations')) {
                    db.createObjectStore('offlineOperations', { keyPath: 'id', autoIncrement: true });
                }
            };
        });
    }

    async saveToCache(storeName, data) {
        const transaction = this.db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        return store.put(data);
    }

    async getFromCache(storeName, key = null) {
        const transaction = this.db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        
        if (key) {
            return new Promise((resolve) => {
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
            });
        } else {
            return new Promise((resolve) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
            });
        }
    }

    async addToSyncQueue(operation) {
        const transaction = this.db.transaction(['syncQueue'], 'readwrite');
        const store = transaction.objectStore('syncQueue');
        return store.add(operation);
    }

    async getSyncQueue() {
        return this.getFromCache('syncQueue');
    }

    async clearSyncQueue() {
        const transaction = this.db.transaction(['syncQueue'], 'readwrite');
        const store = transaction.objectStore('syncQueue');
        return store.clear();
    }
}

// ==================== ENHANCED CONNECTION MANAGEMENT ====================
function updateOfflineStatus() {
    isOnline = navigator.onLine;
    const indicator = document.getElementById('connectionIndicator');
    const icon = document.getElementById('connectionIcon');
    const status = document.getElementById('connectionStatus');
    const banner = document.getElementById('offlineBanner');
    const syncBtn = document.getElementById('syncBtn');
    const syncStatus = document.getElementById('syncStatus');
    const syncIcon = document.getElementById('syncIcon');
    const syncText = document.getElementById('syncText');
    
    if (isOnline) {
        indicator.className = 'connection-indicator online';
        icon.className = 'fas fa-wifi';
        status.textContent = 'Çevrimiçi';
        banner.style.display = 'none';
        syncBtn.style.display = 'none';
        
        syncStatus.className = 'sync-status online';
        syncIcon.className = 'fas fa-cloud';
        syncText.textContent = 'Senkronize';
        
        // Auto-sync when coming back online
        setTimeout(() => {
            if (syncQueue.length > 0) {
                processSyncQueue();
            }
        }, 2000);
        
    } else {
        indicator.className = 'connection-indicator offline';
        icon.className = 'fas fa-wifi-slash';
        status.textContent = 'Çevrimdışı';
        banner.style.display = 'block';
        syncBtn.style.display = 'inline-block';
        
        syncStatus.className = 'sync-status offline';
        syncIcon.className = 'fas fa-cloud-slash';
        syncText.textContent = 'Çevrimdışı';
        
        showToast('Çevrimdışı moda geçildi. İşlemler yerel olarak kaydediliyor.', 'warning', 5000);
    }
    
    updateSyncQueueIndicator();
}

function updateSyncQueueIndicator() {
    const badge = document.getElementById('syncQueueBadge');
    if (syncQueue.length > 0) {
        badge.textContent = syncQueue.length;
        badge.style.display = 'inline';
    } else {
        badge.style.display = 'none';
    }
}

// ==================== ENHANCED SYNC QUEUE PROCESSING ====================
async function addToSyncQueue(operation, table, data, operationType = 'insert') {
    const syncItem = {
        id: Date.now() + Math.random(),
        operation,
        table,
        data,
        operationType,
        timestamp: new Date().toISOString(),
        attempts: 0
    };
    
    syncQueue.push(syncItem);
    
    if (offlineDB) {
        await offlineDB.addToSyncQueue(syncItem);
    }
    
    updateSyncQueueIndicator();
    
    // Show sync progress if offline
    if (!isOnline) {
        showToast(`İşlem çevrimdışı kuyruğuna eklendi: ${operation}`, 'warning');
    }
}

async function processSyncQueue() {
    if (!isOnline || syncQueue.length === 0) {
        return;
    }
    
    const syncProgress = document.getElementById('syncProgress');
    const syncMessage = document.getElementById('syncMessage');
    const syncDetails = document.getElementById('syncDetails');
    const progressFill = document.getElementById('syncProgressFill');
    
    syncProgress.style.display = 'block';
    
    // Update sync status
    const syncStatus = document.getElementById('syncStatus');
    const syncIcon = document.getElementById('syncIcon');
    const syncText = document.getElementById('syncText');
    
    syncStatus.className = 'sync-status syncing';
    syncIcon.className = 'fas fa-sync-alt';
    syncIcon.style.animation = 'spin 1s linear infinite';
    syncText.textContent = 'Senkronize ediliyor...';
    
    let processedCount = 0;
    const totalCount = syncQueue.length;
    
    for (let i = syncQueue.length - 1; i >= 0; i--) {
        const item = syncQueue[i];
        
        try {
            syncMessage.textContent = `${item.operation} senkronize ediliyor...`;
            syncDetails.textContent = `${processedCount + 1}/${totalCount} öğe işlendi`;
            progressFill.style.width = `${((processedCount + 1) / totalCount) * 100}%`;
            
            // Execute the sync operation
            await executeSyncOperation(item);
            
            // Remove from queue
            syncQueue.splice(i, 1);
            processedCount++;
            
        } catch (error) {
            console.error('Sync error:', error);
            item.attempts = (item.attempts || 0) + 1;
            
            // Remove after 3 attempts
            if (item.attempts >= 3) {
                syncQueue.splice(i, 1);
                showToast(`Senkronizasyon başarısız: ${item.operation}`, 'error');
            }
        }
        
        // Small delay for UI update
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    // Clear IndexedDB sync queue
    if (offlineDB) {
        await offlineDB.clearSyncQueue();
    }
    
    // Hide sync progress and update status
    setTimeout(() => {
        syncProgress.style.display = 'none';
        updateOfflineStatus();
        
        if (processedCount > 0) {
            showToast(`${processedCount} öğe başarıyla senkronize edildi`, 'success');
        }
    }, 1000);
}

async function executeSyncOperation(item) {
    switch (item.operationType) {
        case 'insert':
            const { error: insertError } = await supabase
                .from(item.table)
                .insert([item.data]);
            if (insertError) throw insertError;
            break;
            
        case 'update':
            const { error: updateError } = await supabase
                .from(item.table)
                .update(item.data)
                .eq('id', item.data.id);
            if (updateError) throw updateError;
            break;
            
        case 'delete':
            const { error: deleteError } = await supabase
                .from(item.table)
                .delete()
                .eq('id', item.data.id);
            if (deleteError) throw deleteError;
            break;
            
        default:
            throw new Error(`Unknown operation type: ${item.operationType}`);
    }
}

// ==================== ENHANCED DATA OPERATIONS ====================
async function offlineInsert(table, data) {
    // Add to local cache
    if (!offlineCache[table]) offlineCache[table] = [];
    offlineCache[table].push(data);
    
    // Save to IndexedDB
    if (offlineDB) {
        await offlineDB.saveToCache(table, data);
    }
    
    // Add to sync queue if offline
    if (!isOnline) {
        await addToSyncQueue(`Create ${table}`, table, data, 'insert');
    } else {
        // Direct insert if online
        const { error } = await supabase.from(table).insert([data]);
        if (error) throw error;
    }
}

async function offlineUpdate(table, data) {
    // Update local cache
    if (offlineCache[table]) {
        const index = offlineCache[table].findIndex(item => item.id === data.id);
        if (index !== -1) {
            offlineCache[table][index] = { ...offlineCache[table][index], ...data };
        }
    }
    
    // Save to IndexedDB
    if (offlineDB) {
        await offlineDB.saveToCache(table, data);
    }
    
    // Add to sync queue if offline
    if (!isOnline) {
        await addToSyncQueue(`Update ${table}`, table, data, 'update');
    } else {
        // Direct update if online
        const { error } = await supabase.from(table).update(data).eq('id', data.id);
        if (error) throw error;
    }
}

async function offlineSelect(table, options = {}) {
    if (isOnline) {
        // Try to fetch from Supabase first
        try {
            let query = supabase.from(table).select('*');
            
            if (options.eq) {
                query = query.eq(options.eq.column, options.eq.value);
            }
            
            if (options.order) {
                query = query.order(options.order.column, { ascending: options.order.ascending });
            }
            
            const { data, error } = await query;
            
            if (!error && data) {
                // Update cache with fresh data
                offlineCache[table] = data;
                
                // Save to IndexedDB
                if (offlineDB) {
                    for (const item of data) {
                        await offlineDB.saveToCache(table, item);
                    }
                }
                
                return data;
            }
        } catch (error) {
            console.warn('Online fetch failed, falling back to cache:', error);
        }
    }
    
    // Fallback to cache
    let result = offlineCache[table] || [];
    
    // Try IndexedDB if cache is empty
    if (result.length === 0 && offlineDB) {
        result = await offlineDB.getFromCache(table) || [];
        offlineCache[table] = result;
    }
    
    // Apply filters
    if (options.eq) {
        result = result.filter(item => item[options.eq.column] === options.eq.value);
    }
    
    // Apply ordering
    if (options.order) {
        result.sort((a, b) => {
            const aVal = a[options.order.column];
            const bVal = b[options.order.column];
            
            if (options.order.ascending) {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
    }
    
    return result;
}

// ==================== ENHANCED TOAST SYSTEM ====================
let toastCounter = 0;

function showToast(message, type = 'success', duration = 3000) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    
    toast.className = `toast ${type}`;
    toast.textContent = message;
    toast.id = `toast-${++toastCounter}`;
    
    // Add click to dismiss
    toast.onclick = () => {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    };
    
    container.appendChild(toast);
    
    // Show toast
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // Auto-hide
    setTimeout(() => {
        if (toast.classList.contains('show')) {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
    }, duration);
}

// ==================== ORIGINAL FUNCTIONS WITH OFFLINE ENHANCEMENT ====================

// Enhanced DOM elements object
const elements = {
    // Login elements
    loginScreen: document.getElementById('loginScreen'),
    appContainer: document.getElementById('appContainer'),
    email: document.getElementById('email'),
    password: document.getElementById('password'),
    loginBtn: document.getElementById('loginBtn'),
    logoutBtn: document.getElementById('logoutBtn'),
    
    // User info elements
    userRole: document.getElementById('userRole'),
    currentDate: document.getElementById('currentDate'),
    
    // Selection elements
    customerSelect: document.getElementById('customerSelect'),
    personnelSelect: document.getElementById('personnelSelect'),
    
    // Barcode elements
    barcodeInput: document.getElementById('barcodeInput'),
    
    // Package elements
    packagesTableBody: document.getElementById('packagesTableBody'),
    packageDetailContent: document.getElementById('packageDetailContent'),
    totalPackages: document.getElementById('totalPackages'),
    
    // Stock elements
    stockTableBody: document.getElementById('stockTableBody'),
    
    // Shipping elements
    shippingTableBody: document.getElementById('shippingTableBody'),
    shippingFilter: document.getElementById('shippingFilter'),
    
    // Modal elements
    customerModal: document.getElementById('customerModal'),
    allCustomersModal: document.getElementById('allCustomersModal'),
    quantityModal: document.getElementById('quantityModal'),
    manualModal: document.getElementById('manualModal'),
    emailModal: document.getElementById('emailModal'),
    
    // Form elements
    quantityModalTitle: document.getElementById('quantityModalTitle'),
    quantityInput: document.getElementById('quantityInput'),
    
    // Lists
    customerList: document.getElementById('customerList'),
    allCustomersList: document.getElementById('allCustomersList'),
    
    // Footer elements
    containerNumber: document.getElementById('containerNumber'),
    totalPackagesCount: document.getElementById('totalPackagesCount'),
    
    // Sync elements
    syncBtn: document.getElementById('syncBtn'),
    
    // Toast
    toast: document.getElementById('toast')
};

// Supabase configuration management (keeping original)
let SUPABASE_URL = '';
let SUPABASE_ANON_KEY = '';

function loadApiKey() {
    const savedKey = localStorage.getItem('supabaseKey');
    if (savedKey) {
        try {
            const keyData = JSON.parse(savedKey);
            SUPABASE_URL = keyData.url || '';
            SUPABASE_ANON_KEY = keyData.key || '';
            return SUPABASE_URL && SUPABASE_ANON_KEY;
        } catch (error) {
            console.error('API key parse error:', error);
            return false;
        }
    }
    return false;
}

function saveApiKey() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    
    if (!apiKey) {
        showToast('Lütfen API anahtarını girin', 'error');
        return;
    }
    
    // Simple validation
    if (!apiKey.includes('supabase') || apiKey.length < 50) {
        showToast('Geçersiz API anahtarı formatı', 'error');
        return;
    }
    
    try {
        // Extract URL and key (basic parsing)
        let url = '', key = '';
        
        if (apiKey.includes('://')) {
            // Full URL format
            const parts = apiKey.split('|');
            if (parts.length === 2) {
                url = parts[0];
                key = parts[1];
            } else {
                url = 'https://your-project.supabase.co';
                key = apiKey;
            }
        } else {
            // Just the key
            url = 'https://your-project.supabase.co';
            key = apiKey;
        }
        
        const keyData = { url, key };
        localStorage.setItem('supabaseKey', JSON.stringify(keyData));
        
        SUPABASE_URL = url;
        SUPABASE_ANON_KEY = key;
        
        supabase = initializeSupabase();
        
        if (supabase) {
            document.getElementById('apiKeyModal').style.display = 'none';
            showToast('API anahtarı kaydedildi', 'success');
            setupAuthListener();
        }
        
    } catch (error) {
        console.error('API key save error:', error);
        showToast('API anahtarı kaydedilirken hata oluştu', 'error');
    }
}

function showApiKeyModal() {
    document.getElementById('apiKeyModal').style.display = 'flex';
}

function showApiKeyHelp() {
    const helpWindow = window.open('', '_blank');
    helpWindow.document.write(`
        <html>
        <head><title>Supabase API Anahtarı Yardımı</title></head>
        <body style="font-family: Arial; padding: 20px;">
            <h2>Supabase API Anahtarı Nasıl Alınır?</h2>
            <ol>
                <li><a href="https://supabase.com" target="_blank">Supabase.com</a>'a gidin</li>
                <li>Hesabınızla giriş yapın</li>
                <li>Projenizi seçin</li>
                <li>Sol menüden "Settings" → "API" seçin</li>
                <li>"anon public" anahtarını kopyalayın</li>
                <li>Anahtarı uygulamaya yapıştırın</li>
            </ol>
            <p><strong>Not:</strong> URL|KEY formatında da girebilirsiniz. Örnek:<br>
            https://abc123.supabase.co|eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...</p>
        </body>
        </html>
    `);
}

function initializeSupabase() {
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
        console.error('Supabase configuration missing');
        return null;
    }
    
    try {
        return supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (error) {
        console.error('Supabase initialization error:', error);
        showToast('Supabase bağlantı hatası', 'error');
        return null;
    }
}

// Enhanced login function
async function login() {
    const email = elements.email.value.trim();
    const password = elements.password.value.trim();
    
    if (!email || !password) {
        showToast('E-posta ve şifre gerekli', 'error');
        return;
    }
    
    if (!supabase) {
        showToast('Supabase bağlantısı yok. API anahtarını kontrol edin.', 'error');
        return;
    }
    
    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) {
            console.error('Login error:', error);
            showToast('Giriş hatası: ' + error.message, 'error');
            return;
        }
        
        if (data?.user) {
            showToast('Giriş başarılı', 'success');
        }
        
    } catch (error) {
        console.error('Login error:', error);
        showToast('Giriş sırasında hata oluştu', 'error');
    }
}

// Enhanced logout function
async function logout() {
    if (!confirm('Çıkış yapmak istediğinize emin misiniz?')) return;
    
    try {
        if (supabase) {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Logout error:', error);
            }
        }
        
        // Clear state
        currentUser = null;
        selectedCustomer = null;
        clearAppState();
        
        showToast('Çıkış yapıldı', 'success');
        
    } catch (error) {
        console.error('Logout error:', error);
        showToast('Çıkış sırasında hata oluştu', 'error');
    }
}

// Enhanced data testing function
async function testConnection() {
    if (!supabase) {
        showToast('Supabase bağlantısı yok', 'error');
        return;
    }
    
    try {
        const { data, error } = await supabase
            .from('customers')
            .select('count(*)')
            .limit(1);
            
        if (error) {
            console.error('Connection test error:', error);
            showToast('Veritabanı bağlantı testi başarısız', 'warning');
        } else {
            console.log('Database connection successful');
        }
        
    } catch (error) {
        console.error('Connection test error:', error);
    }
}

// State management functions (keeping originals)
function saveAppState() {
    const state = {
        selectedCustomerId: selectedCustomer?.id || null,
        selectedPersonnelId: elements.personnelSelect?.value || null,
        currentContainer: currentContainer,
        currentPackage: currentPackage,
        timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('procleanState', JSON.stringify(state));
}

function loadAppState() {
    const savedState = localStorage.getItem('procleanState');
    if (savedState) {
        try {
            const state = JSON.parse(savedState);
            
            // Restore customer selection
            if (state.selectedCustomerId && elements.customerSelect) {
                elements.customerSelect.value = state.selectedCustomerId;
                const option = elements.customerSelect.querySelector(`option[value="${state.selectedCustomerId}"]`);
                if (option) {
                    selectedCustomer = {
                        id: state.selectedCustomerId,
                        name: option.textContent.split(' (')[0],
                        code: option.textContent.match(/\(([^)]+)\)/)?.[1] || ''
                    };
                }
            }
            
            // Restore personnel selection
            if (state.selectedPersonnelId && elements.personnelSelect) {
                elements.personnelSelect.value = state.selectedPersonnelId;
            }
            
            // Restore current container
            if (state.currentContainer) {
                currentContainer = state.currentContainer;
                if (elements.containerNumber) {
                    elements.containerNumber.textContent = currentContainer;
                }
            }
            
            // Restore current package
            if (state.currentPackage) {
                currentPackage = state.currentPackage;
            }
            
        } catch (error) {
            console.error('Error loading app state:', error);
        }
    }
}

function clearAppState() {
    localStorage.removeItem('procleanState');
    selectedCustomer = null;
    if (elements.customerSelect) elements.customerSelect.value = '';
    if (elements.personnelSelect) elements.personnelSelect.value = '';
    currentContainer = null;
    if (elements.containerNumber) elements.containerNumber.textContent = 'Yok';
    currentPackage = {};
    
    // Reset quantity badges
    document.querySelectorAll('.quantity-badge').forEach(badge => {
        badge.textContent = '0';
    });
    
    // Clear package details
    if (elements.packageDetailContent) {
        elements.packageDetailContent.innerHTML = 
            '<p style="text-align:center; color:#666; margin:2rem 0;">Paket seçin</p>';
    }
}

// Enhanced initialization function
async function initApp() {
    try {
        // Initialize offline database
        offlineDB = new OfflineDatabase();
        await offlineDB.init();
        
        // Load sync queue from IndexedDB
        syncQueue = await offlineDB.getSyncQueue() || [];
        updateSyncQueueIndicator();
        
        // Set current date
        if (elements.currentDate) {
            elements.currentDate.textContent = new Date().toLocaleDateString('tr-TR');
        }
        
        // Populate dropdowns with offline support
        await populateCustomers();
        await populatePersonnel();
        
        // Load saved state
        loadAppState();
        
        // Load data with offline fallback
        await populatePackagesTable();
        await populateStockTable();
        await populateShippingTable();
        
        // Test connection
        await testConnection();
        
        // Set up auto-save
        setInterval(saveAppState, 5000); // Save every 5 seconds
        
        console.log('ProClean enhanced offline app initialized');
        
    } catch (error) {
        console.error('App initialization error:', error);
        showToast('Uygulama başlatılırken hata oluştu', 'error');
    }
}

// Enhanced data loading functions with offline support
async function populateCustomers() {
    try {
        if (elements.customerSelect) {
            elements.customerSelect.innerHTML = '<option value="">Müşteri seçin...</option>';
        }
        
        // Use enhanced offline select
        const customers = await offlineSelect('customers', { order: { column: 'name', ascending: true } });
        
        if (customers && customers.length > 0) {
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} (${customer.code})`;
                if (elements.customerSelect) {
                    elements.customerSelect.appendChild(option);
                }
            });
        }
        
    } catch (error) {
        console.error('Error in populateCustomers:', error);
        showToast('Müşteri yükleme hatası', 'error');
    }
}

async function populatePersonnel() {
    try {
        if (elements.personnelSelect) {
            elements.personnelSelect.innerHTML = '<option value="">Personel seçin...</option>';
        }
        
        // Use enhanced offline select
        const personnel = await offlineSelect('personnel', { order: { column: 'name', ascending: true } });
        
        if (personnel && personnel.length > 0) {
            personnel.forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = person.name;
                if (elements.personnelSelect) {
                    elements.personnelSelect.appendChild(option);
                }
            });
        } else {
            // Add current user as default
            const option = document.createElement('option');
            option.value = currentUser?.uid || 'default';
            option.textContent = currentUser?.name || 'Mevcut Kullanıcı';
            option.selected = true;
            if (elements.personnelSelect) {
                elements.personnelSelect.appendChild(option);
            }
        }
        
    } catch (error) {
        console.error('Error in populatePersonnel:', error);
        // Add default current user on error
        if (elements.personnelSelect) {
            const option = document.createElement('option');
            option.value = currentUser?.uid || 'default';
            option.textContent = currentUser?.name || 'Mevcut Kullanıcı';
            option.selected = true;
            elements.personnelSelect.appendChild(option);
        }
    }
}

async function populatePackagesTable() {
    try {
        if (elements.packagesTableBody) {
            elements.packagesTableBody.innerHTML = '';
        }
        
        // Use enhanced offline select
        const packages = await offlineSelect('packages', { 
            order: { column: 'created_at', ascending: false }
        });
        
        if (packages && packages.length > 0) {
            packages.forEach(pkg => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" value="${pkg.id}" onchange="updatePackageSelection()"></td>
                    <td>${pkg.package_no}</td>
                    <td>${pkg.customer_name || 'N/A'}</td>
                    <td>${pkg.total_quantity}</td>
                    <td>${new Date(pkg.created_at).toLocaleDateString('tr-TR')}</td>
                    <td><span class="status-${pkg.status}">${pkg.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</span></td>
                `;
                row.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        selectPackage(pkg);
                    }
                };
                if (elements.packagesTableBody) {
                    elements.packagesTableBody.appendChild(row);
                }
            });
            
            if (elements.totalPackages) {
                elements.totalPackages.textContent = packages.length;
            }
            if (elements.totalPackagesCount) {
                elements.totalPackagesCount.textContent = packages.length;
            }
        } else {
            if (elements.packagesTableBody) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align:center; color:#666;">Henüz paket yok</td>';
                elements.packagesTableBody.appendChild(row);
            }
        }
        
    } catch (error) {
        console.error('Error in populatePackagesTable:', error);
        showToast('Paket tablosu yükleme hatası', 'error');
    }
}

async function populateStockTable() {
    try {
        if (elements.stockTableBody) {
            elements.stockTableBody.innerHTML = '';
        }
        
        // Use enhanced offline select
        const stockItems = await offlineSelect('stock_items', { 
            order: { column: 'name', ascending: true }
        });
        
        if (stockItems && stockItems.length > 0) {
            stockItems.forEach(item => {
                const row = document.createElement('tr');
                
                // Determine stock status
                let statusClass = 'status-stokta';
                let statusText = 'Stokta';
                
                if (item.quantity <= 0) {
                    statusClass = 'status-kritik';
                    statusText = 'Kritik';
                } else if (item.quantity < 10) {
                    statusClass = 'status-az-stok';
                    statusText = 'Az Stok';
                }
                
                row.innerHTML = `
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit || 'Adet'}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>${item.updated_at ? new Date(item.updated_at).toLocaleDateString('tr-TR') : 'N/A'}</td>
                `;
                if (elements.stockTableBody) {
                    elements.stockTableBody.appendChild(row);
                }
            });
        } else {
            if (elements.stockTableBody) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align:center; color:#666;">Stok verisi yok</td>';
                elements.stockTableBody.appendChild(row);
            }
        }
        
    } catch (error) {
        console.error('Error in populateStockTable:', error);
        showToast('Stok tablosu yükleme hatası', 'error');
    }
}

async function populateShippingTable() {
    try {
        if (elements.shippingTableBody) {
            elements.shippingTableBody.innerHTML = '';
        }
        
        const filter = elements.shippingFilter?.value || 'all';
        
        // Use enhanced offline select with filtering
        let containers = await offlineSelect('containers', { 
            order: { column: 'created_at', ascending: false }
        });
        
        if (filter !== 'all') {
            containers = containers.filter(container => container.status === filter);
        }
        
        if (containers && containers.length > 0) {
            containers.forEach(container => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" value="${container.id}"></td>
                    <td>${container.container_no}</td>
                    <td>${container.customer || 'N/A'}</td>
                    <td>${container.package_count || 0}</td>
                    <td>${container.total_quantity || 0}</td>
                    <td>${container.created_at ? new Date(container.created_at).toLocaleDateString('tr-TR') : 'N/A'}</td>
                    <td><span class="status-${container.status}">${container.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</span></td>
                    <td>
                        <button onclick="sendToRamp('${container.container_no}')" class="btn btn-warning btn-sm">Paket Ekle</button>
                        <button onclick="shipContainer('${container.container_no}')" class="btn btn-success btn-sm">Sevk Et</button>
                    </td>
                `;
                if (elements.shippingTableBody) {
                    elements.shippingTableBody.appendChild(row);
                }
            });
        } else {
            if (elements.shippingTableBody) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" style="text-align:center; color:#666;">Sevkiyat verisi yok</td>';
                elements.shippingTableBody.appendChild(row);
            }
        }
        
    } catch (error) {
        console.error('Error in populateShippingTable:', error);
        showToast('Sevkiyat tablosu yükleme hatası', 'error');
    }
}

// Enhanced customer operations with offline support
async function showAllCustomers() {
    try {
        if (elements.allCustomersList) {
            elements.allCustomersList.innerHTML = '';
        }
        
        const customers = await offlineSelect('customers', { 
            order: { column: 'name', ascending: true }
        });
        
        if (customers && customers.length > 0) {
            customers.forEach(customer => {
                const div = document.createElement('div');
                div.className = 'customer-item';
                div.innerHTML = `
                    <div>
                        <strong>${customer.name}</strong> (${customer.code})<br>
                        <small>${customer.email || 'E-posta yok'}</small>
                    </div>
                    <button onclick="deleteCustomer('${customer.id}')" class="btn btn-danger btn-sm">Sil</button>
                `;
                if (elements.allCustomersList) {
                    elements.allCustomersList.appendChild(div);
                }
            });
        }
        
        if (elements.allCustomersModal) {
            elements.allCustomersModal.style.display = 'flex';
        }
    } catch (error) {
        console.error('Error in showAllCustomers:', error);
        showToast('Müşteri yönetimi yükleme hatası', 'error');
    }
}

async function addNewCustomer() {
    const code = document.getElementById('newCustomerCode').value.trim();
    const name = document.getElementById('newCustomerName').value.trim();
    const email = document.getElementById('newCustomerEmail').value.trim();
    
    if (!code || !name) {
        showToast('Müşteri kodu ve adı gerekli', 'error');
        return;
    }
    
    try {
        const newCustomer = {
            id: Date.now().toString(),
            code,
            name,
            email: email || null,
            created_at: new Date().toISOString()
        };
        
        // Use enhanced offline insert
        await offlineInsert('customers', newCustomer);
        
        showToast('Müşteri başarıyla eklendi', 'success');
        
        // Clear form
        document.getElementById('newCustomerCode').value = '';
        document.getElementById('newCustomerName').value = '';
        document.getElementById('newCustomerEmail').value = '';
        
        // Refresh lists
        await populateCustomers();
        await showAllCustomers();
        
    } catch (error) {
        console.error('Error in addNewCustomer:', error);
        showToast('Müşteri ekleme hatası', 'error');
    }
}

async function deleteCustomer(customerId) {
    if (!confirm('Bu müşteriyi silmek istediğinize emin misiniz?')) return;
    
    try {
        // Remove from cache
        if (offlineCache.customers) {
            const index = offlineCache.customers.findIndex(c => c.id === customerId);
            if (index !== -1) {
                offlineCache.customers.splice(index, 1);
            }
        }
        
        // Add to sync queue if offline, or delete directly if online
        if (!isOnline) {
            await addToSyncQueue(`Delete customer`, 'customers', { id: customerId }, 'delete');
        } else {
            const { error } = await supabase.from('customers').delete().eq('id', customerId);
            if (error) throw error;
        }
        
        showToast('Müşteri başarıyla silindi', 'success');
        
        // Refresh lists
        await populateCustomers();
        await showAllCustomers();
        
    } catch (error) {
        console.error('Error in deleteCustomer:', error);
        showToast('Müşteri silme hatası', 'error');
    }
}

// Enhanced package operations with offline support
async function completePackage() {
    if (!selectedCustomer) {
        showToast('Önce müşteri seçin', 'error');
        return;
    }
    
    if (!currentPackage.items || Object.keys(currentPackage.items).length === 0) {
        showToast('Pakete ürün ekleyin', 'error');
        return;
    }
    
    try {
        const totalQuantity = Object.values(currentPackage.items).reduce((sum, qty) => sum + qty, 0);
        const packageNo = `PKG-${Date.now()}`;
        
        const newPackage = {
            id: Date.now().toString(),
            package_no: packageNo,
            customer_id: selectedCustomer.id,
            customer_name: selectedCustomer.name,
            total_quantity: totalQuantity,
            items: JSON.stringify(currentPackage.items),
            status: 'beklemede',
            created_at: new Date().toISOString(),
            packer: currentUser?.name || elements.personnelSelect?.selectedOptions[0]?.textContent || 'Bilinmiyor'
        };
        
        // Use enhanced offline insert
        await offlineInsert('packages', newPackage);
        
        showToast(`Paket tamamlandı: ${packageNo}`, 'success');
        
        // Clear current package
        clearCurrentPackage();
        
        // Refresh packages table
        await populatePackagesTable();
        
    } catch (error) {
        console.error('Error in completePackage:', error);
        showToast('Paket tamamlama hatası', 'error');
    }
}

// Keep all other original functions...
function selectCustomerFromModal(customer) {
    selectedCustomer = customer;
    if (elements.customerSelect) {
        elements.customerSelect.value = customer.id;
    }
    closeModal();
    showToast(`Müşteri seçildi: ${customer.name}`, 'success');
}

function processBarcode() {
    const barcode = elements.barcodeInput.value.trim();
    if (!barcode) {
        showToast('Barkod girin', 'error');
        return;
    }
    
    // Process barcode logic here
    showToast(`Barkod işlendi: ${barcode}`, 'success');
    elements.barcodeInput.value = '';
    elements.barcodeInput.focus();
}

function openQuantityModal(product) {
    selectedProduct = product;
    if (elements.quantityModalTitle) {
        elements.quantityModalTitle.textContent = `${product} - Adet Girin`;
    }
    if (elements.quantityInput) {
        elements.quantityInput.value = '';
    }
    if (elements.quantityModal) {
        elements.quantityModal.style.display = 'flex';
        elements.quantityInput.focus();
    }
}

function confirmQuantity() {
    const quantity = parseInt(elements.quantityInput.value);
    if (!quantity || quantity <= 0) {
        showToast('Geçerli bir adet girin', 'error');
        return;
    }
    
    // Update quantity badge
    const badge = document.getElementById(`${selectedProduct}-quantity`);
    if (badge) {
        const currentQuantity = parseInt(badge.textContent) || 0;
        badge.textContent = currentQuantity + quantity;
    }
    
    // Add to current package
    if (!currentPackage.items) currentPackage.items = {};
    currentPackage.items[selectedProduct] = (currentPackage.items[selectedProduct] || 0) + quantity;
    
    showToast(`${selectedProduct}: ${quantity} adet eklendi`, 'success');
    closeQuantityModal();
}

function clearCurrentPackage() {
    currentPackage = {};
    
    // Reset quantity badges
    document.querySelectorAll('.quantity-badge').forEach(badge => {
        badge.textContent = '0';
    });
    
    // Clear package details
    if (elements.packageDetailContent) {
        elements.packageDetailContent.innerHTML = 
            '<p style="text-align:center; color:#666; margin:2rem 0;">Paket seçin</p>';
    }
}

function selectPackage(pkg) {
    selectedPackageId = pkg.id;
    
    // Update package details display
    if (elements.packageDetailContent) {
        const itemsObj = typeof pkg.items === 'string' ? JSON.parse(pkg.items) : pkg.items;
        const itemsHtml = Object.entries(itemsObj || {})
            .map(([item, qty]) => `<li>${item}: ${qty} adet</li>`)
            .join('');
        
        elements.packageDetailContent.innerHTML = `
            <h4>${pkg.package_no}</h4>
            <p><strong>Müşteri:</strong> ${pkg.customer_name}</p>
            <p><strong>Toplam Adet:</strong> ${pkg.total_quantity}</p>
            <p><strong>Durum:</strong> <span class="status-${pkg.status}">${pkg.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</span></p>
            <p><strong>Tarih:</strong> ${new Date(pkg.created_at).toLocaleDateString('tr-TR')}</p>
            <p><strong>İçerik:</strong></p>
            <ul>${itemsHtml}</ul>
        `;
    }
}

// Modal functions
function closeModal() {
    if (elements.customerModal) elements.customerModal.style.display = 'none';
}

function closeAllCustomersModal() {
    if (elements.allCustomersModal) elements.allCustomersModal.style.display = 'none';
}

function closeQuantityModal() {
    if (elements.quantityModal) elements.quantityModal.style.display = 'none';
}

function closeManualModal() {
    if (elements.manualModal) elements.manualModal.style.display = 'none';
}

function closeEmailModal() {
    if (elements.emailModal) elements.emailModal.style.display = 'none';
}

// Utility functions
function switchTab(tabName) {
    // Hide all tab panes
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    // Deactivate all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Activate selected tab
    const selectedTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
    const selectedPane = document.getElementById(`${tabName}Tab`);
    
    if (selectedTab && selectedPane) {
        selectedTab.classList.add('active');
        selectedPane.classList.add('active');
    }
}

function updatePackageSelection() {
    // Implementation for package selection
}

// Stub functions for compatibility
function openManualEntry() {
    if (elements.manualModal) {
        elements.manualModal.style.display = 'flex';
    }
    document.getElementById('manualProduct')?.focus();
}

function addManualProduct() {
    const product = document.getElementById('manualProduct')?.value.trim();
    const quantity = parseInt(document.getElementById('manualQuantity')?.value);
    
    if (!product || !quantity || quantity <= 0) {
        showToast('Ürün adı ve geçerli adet girin', 'error');
        return;
    }
    
    // Add to current package
    if (!currentPackage.items) currentPackage.items = {};
    currentPackage.items[product] = (currentPackage.items[product] || 0) + quantity;
    
    showToast(`${product}: ${quantity} adet eklendi`, 'success');
    
    // Clear form
    if (document.getElementById('manualProduct')) document.getElementById('manualProduct').value = '';
    if (document.getElementById('manualQuantity')) document.getElementById('manualQuantity').value = '';
    
    closeManualModal();
}

function generateDailyReport() {
    if (elements.emailModal) {
        elements.emailModal.style.display = 'flex';
    }
}

async function sendDailyReport() {
    const email = document.getElementById('reportEmail')?.value;
    if (!email) {
        showToast('Lütfen e-posta adresini girin', 'error');
        return;
    }
    
    showToast('Rapor gönderiliyor...', 'warning');
    
    // Simulate email sending
    setTimeout(() => {
        showToast(`Rapor ${email} adresine gönderildi`, 'success');
        closeEmailModal();
    }, 2000);
}

async function previewReport() {
    // Implementation for report preview
    showToast('Rapor önizlemesi hazırlanıyor...', 'info');
}

function sendToRamp() {
    showToast('Konteynere ekleme işlemi', 'info');
}

function shipContainer(containerNo) {
    showToast(`Konteyner sevk edildi: ${containerNo}`, 'success');
}

function filterStock() {
    // Implementation for stock filtering
}

function uploadStockFile() {
    document.getElementById('stockFileInput')?.click();
}

function handleStockFileUpload(input) {
    const file = input.files[0];
    if (file) {
        showToast(`Dosya seçildi: ${file.name}`, 'success');
        // Implementation for file processing
    }
}

function downloadStockTemplate() {
    showToast('Şablon indiriliyor...', 'info');
    // Implementation for template download
}

// Initialize auth state listener (keeping original structure)
function setupAuthListener() {
    if (!supabase) return;
    
    supabase.auth.onAuthStateChange((event, session) => {
        console.log('Auth state change:', event, session?.user?.email || 'No user');
        
        if (session) {
            currentUser = {
                email: session.user.email,
                uid: session.user.id,
                name: session.user.email.split('@')[0]
            };
            
            if (elements.userRole) {
                elements.userRole.textContent = `Operatör: ${currentUser.name}`;
            }
            if (elements.loginScreen) elements.loginScreen.style.display = "none";
            if (elements.appContainer) elements.appContainer.style.display = "flex";
            
            initApp();
        } else {
            if (elements.loginScreen) elements.loginScreen.style.display = "flex";
            if (elements.appContainer) elements.appContainer.style.display = "none";
        }
    });
}

// ==================== EVENT LISTENERS ====================
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced connection monitoring
    window.addEventListener('online', updateOfflineStatus);
    window.addEventListener('offline', updateOfflineStatus);
    updateOfflineStatus(); // Initial check
    
    // API key management
    if (loadApiKey()) {
        supabase = initializeSupabase();
        if (supabase) {
            setupAuthListener();
        }
    } else {
        showApiKeyModal();
    }
    
    // Login/logout events
    if (elements.loginBtn) {
        elements.loginBtn.addEventListener('click', login);
    }
    if (elements.logoutBtn) {
        elements.logoutBtn.addEventListener('click', logout);
    }
    
    // Enter key events
    if (elements.email) {
        elements.email.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
    }
    if (elements.password) {
        elements.password.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
    }
    
    // Package input events
    if (elements.quantityInput) {
        elements.quantityInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') confirmQuantity();
        });
    }
    if (elements.barcodeInput) {
        elements.barcodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') processBarcode();
        });
    }
    
    // Tab navigation
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName);
        });
    });
    
    // Customer selection
    if (elements.customerSelect) {
        elements.customerSelect.addEventListener('change', function() {
            const customerId = this.value;
            if (customerId) {
                const selectedOption = this.options[this.selectedIndex];
                selectedCustomer = {
                    id: customerId,
                    name: selectedOption.textContent.split(' (')[0],
                    code: selectedOption.textContent.match(/\(([^)]+)\)/)?.[1] || ''
                };
                showToast(`Müşteri seçildi: ${selectedCustomer.name}`, 'success');
            } else {
                selectedCustomer = null;
            }
        });
    }
    
    // Enhanced sync button
    if (elements.syncBtn) {
        elements.syncBtn.addEventListener('click', async () => {
            if (!isOnline) {
                showToast('İnternet bağlantısı yok. Senkronizasyon için bağlantı gerekli.', 'error');
                return;
            }
            
            showToast('Manuel senkronizasyon başlatıldı...', 'info');
            await processSyncQueue();
        });
    }
    
    // Initial state
    if (elements.loginScreen) elements.loginScreen.style.display = 'flex';
    if (elements.appContainer) elements.appContainer.style.display = 'none';
    
    console.log('ProClean Enhanced Offline System initialized');
});

console.log('ProClean application enhanced with professional offline mode - v2.1.0');
</script>
</body>
</html>
