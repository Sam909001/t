<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
            --text: #2c3e50;
            --bg: #f5f7fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html,body { height:100%; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* Login Screen */
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%); }
        .login-form { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .login-form h1 { text-align: center; margin-bottom: 1.5rem; color: var(--primary); }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display:block; margin-bottom:0.5rem; font-weight:500; }
        .form-group input { width:100%; padding:0.8rem; border:1px solid #ddd; border-radius:5px; font-size:1rem; }

        .btn { padding:0.6rem 1rem; border:none; border-radius:5px; cursor:pointer; font-size:0.9rem; font-weight:600; transition:all .3s; display:inline-block; text-align:center; }
        .btn-primary { background:var(--secondary); color:#fff; }
        .btn-primary:hover { background:#2980b9; }
        .btn-link { background:none; color:var(--secondary); text-decoration:underline; padding:0.5rem; }

        /* Main */
        .app-container { display:none; flex-direction:column; height:100vh; }

        /* Header */
        .app-header { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; }
        .app-title { font-size:1.3rem; font-weight:600; }
        .user-info { display:flex; align-items:center; gap:0.8rem; }

        .user-info button {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            background: var(--accent);
            color: white;
            min-width: 100px;
        }
        .user-info button:hover { background: #c0392b; transform: translateY(-1px); }

        /* Tabs */
        .tabs { display:flex; background-color:var(--dark); }
        .tab { padding:0.8rem 1.5rem; color:white; cursor:pointer; font-weight:500; border-bottom:3px solid transparent; font-size:0.9rem; }
        .tab.active { background:var(--light); color:var(--primary); border-bottom:3px solid var(--secondary); }

        /* Content */
        .tab-content { flex-grow:1; padding:1.2rem; overflow:hidden; }
        .tab-pane { display:none; height: calc(100vh - 200px); overflow:auto; }
        .tab-pane.active { display:block; }

        .packaging-header { display:flex; justify-content:space-between; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; align-items: center; }
        .customer-info { display:flex; gap:0.8rem; align-items: center; flex-wrap: wrap; }
        .info-group { display:flex; flex-direction:column; margin-bottom: 0; }
        .info-group label { font-weight:600; margin-bottom:0.2rem; font-size:0.8rem; }
        .info-group select, .info-group input { padding:0.4rem; border:1px solid #ddd; border-radius:5px; font-size:0.8rem; height: auto; }
        .info-group span { font-size: 0.9rem; }
        .action-buttons { display:flex; gap:0.6rem; }

        .packaging-content {
            display: flex;
            gap: 1.2rem;
            align-items: flex-start;
            padding-bottom: 10px;
        }
        .barcode-section { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .pending-packages { flex: 0 0 50%; min-width: 360px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); overflow:auto; }
        .package-details { flex: 0 0 25%; min-width: 220px; background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); display:flex; flex-direction:column; }

        .barcode-input { display:flex; margin-bottom:0.8rem; }
        .barcode-input input { flex-grow:1; padding:0.6rem; border:1px solid #ddd; border-radius:5px 0 0 5px; font-size:1rem; }
        .barcode-input button { padding:0 0.8rem; border:1px solid #ddd; background:var(--light); cursor:pointer; }

        .package-table { width:100%; border-collapse:collapse; font-size:0.85rem; }
        .package-table th, .package-table td { padding:0.5rem; text-align:left; border-bottom:1px solid #ddd; }
        .package-table th { background:var(--light); font-weight:600; }
        .package-table tr:hover { background:#f9f9f9; }

        .quick-buttons { display:grid; grid-template-columns:repeat(3, 1fr); gap:0.4rem; margin-top:0.8rem; }
        .quick-btn { padding:0.6rem 0.4rem; background:var(--light); border:1px solid #ddd; border-radius:5px; cursor:pointer; text-align:center; font-size:0.8rem; position:relative; }
        .quantity-badge { position:absolute; top:-5px; right:-5px; background:var(--secondary); color:white; border-radius:50%; width:18px; height:18px; font-size:0.7rem; display:flex; align-items:center; justify-content:center; }

        .package-actions { margin-top:auto; display:flex; flex-direction:column; gap:0.6rem; }

        .btn-success { background:var(--success); color:white; }
        .btn-warning { background:var(--warning); color:white; }
        .btn-danger { background:var(--accent); color:white; }

        .status-beklemede { background: var(--warning); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }
        .status-sevk-edildi { background: var(--success); color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }

        .app-footer { background:var(--primary); color:white; padding:0.6rem 1.2rem; display:flex; justify-content:space-between; align-items:center; font-size:0.85rem; }
        .container-info { display:flex; align-items:center; gap:0.8rem; }

        /* Toast styles */
        .toast { position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:5px; color:white; z-index:1000; opacity:0; transform:translateY(-20px); transition:all .3s; }
        .toast.show { opacity:1; transform:translateY(0); }
        .toast.success { background:var(--success); } .toast.error { background:var(--accent); } .toast.warning { background:var(--warning); }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:1px solid #ddd; }
        .modal-close { background:none; border:none; font-size:1.5rem; cursor:pointer; }

        .customer-list { max-height:300px; overflow-y:auto; margin-bottom:1rem; }
        .customer-item { padding:0.8rem; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
        .customer-item:hover { background:#f5f5f5; } .customer-item.selected { background:#e3f2fd; }

        .quantity-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center; }
        .quantity-content { background:white; padding:1.5rem; border-radius:8px; width:90%; max-width:300px; text-align:center; }
        .quantity-input { width:100%; padding:0.8rem; margin:1rem 0; border:1px solid #ddd; border-radius:5px; font-size:1.2rem; text-align:center; }
        .quantity-buttons { display:flex; justify-content:center; gap:0.8rem; margin-top:1rem; }

        .stock-search { display:flex; gap:0.8rem; margin-bottom:1.2rem; }
        .stock-search input { flex-grow:1; padding:0.8rem; border:1px solid #ddd; border-radius:5px; }
        .stock-table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .stock-table th, .stock-table td { padding:0.8rem; text-align:left; border-bottom:1px solid #ddd; } .stock-table th { background:var(--light); font-weight:600; } .stock-table tr:hover { background:#f9f9f9; }

        .file-upload { margin-top:1.2rem; padding:1.2rem; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .upload-button { display:inline-block; padding:0.8rem 1.5rem; background:var(--secondary); color:white; border-radius:5px; cursor:pointer; margin-top:0.8rem; }
        .upload-button:hover { background:#2980b9; }

        .offline-indicator { position:fixed; bottom:20px; left:20px; padding:0.8rem 1.2rem; background:var(--accent); color:white; border-radius:5px; z-index:1000; display:none; }

        /* Stock status classes */
        .status-kritik { background:#c0392b;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }
        .status-az-stok { background:#f39c12;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }
        .status-stokta { background:#2ecc71;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8rem; }

        /* Responsive */
        @media (max-width:1200px) {
            .barcode-section, .package-details { min-width:200px; }
            .pending-packages { flex: 1 1 60%; }
        }
        @media (max-width:900px) {
            .packaging-content { flex-direction:column; height:auto; }
            .barcode-section, .pending-packages, .package-details { flex: 1 1 auto; width:100%; min-width: auto; }
            .tab-pane { height: auto; }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <div class="login-form">
            <h1>ProClean - Oturum Aç</h1>
            <div class="form-group">
                <label for="email">E-posta</label>
                <input type="email" id="email" placeholder="E-posta adresinizi girin">
            </div>
            <div class="form-group">
                <label for="password">Şifre</label>
                <input type="password" id="password" placeholder="Şifrenizi girin">
            </div>
            <button type="button" class="btn btn-primary" id="loginBtn">Giriş Yap</button>
        </div>
    </div>

    <div class="app-container" id="appContainer" aria-hidden="true">
        <div class="app-header">
            <div class="app-title">ProClean - Profesyonel Çamaşırhane Yönetim Sistemi</div>
            <div class="user-info">
                <span id="userRole">Operatör: Yükleniyor...</span>
                <button type="button" id="logoutBtn" class="btn btn-danger">Çıkış Yap</button>
            </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Ana Sekmeler">
            <div class="tab active" data-tab="packaging" role="tab">Paketleme</div>
            <div class="tab" data-tab="shipping" role="tab">Sevkiyat</div>
            <div class="tab" data-tab="stock" role="tab">Stok Sorgu</div>
        </div>

        <div class="tab-content">
            <div class="tab-pane active" id="packagingTab">
                <div class="packaging-header">
                    <div class="customer-info">
                        <div class="info-group">
                            <label for="customer">Müşteri</label>
                            <select id="customer"></select>
                        </div>
                        <div class="info-group">
                            <label for="personnel">Personel</label>
                            <select id="personnel"></select>
                        </div>
                        <div class="info-group">
                            <label>Müşteri Adı</label>
                            <span><strong id="customerName">Lütfen müşteri seçin</strong></span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" id="selectCustomerBtn">Müşteri Seç</button>
                        <button type="button" class="btn" id="showAllCustomersBtn">Tüm Müş. Göster</button>
                        <button type="button" class="btn btn-warning" id="generateReportBtn">İş Sonu Raporu</button>
                    </div>
                </div>

                <div class="packaging-content">
                    <div class="barcode-section" id="barcodeSection">
                        <h3>Paket Oluştur</h3>
                        <div class="barcode-input">
                            <input type="text" id="barcodeInput" placeholder="Barkodu okutun veya girin" autofocus>
                            <button type="button" id="searchBarcodeBtn"><i class="fas fa-search"></i></button>
                            <button type="button" id="clearBarcodeBtn"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="barcode-counter">
                            <span>Okutulan barkod sayısı: <strong id="barcodeCount">0</strong></span>
                        </div>
                        <div class="barcode-preview"><svg id="barcode"></svg></div>
                    </div>

                    <div class="pending-packages" id="pendingPackages">
                        <h3>Paket Detayları</h3>
                        <table class="package-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllPackages"></th>
                                    <th>Sıra</th>
                                    <th>Paket No</th>
                                    <th>T. Miktar</th>
                                    <th>P. Zamanı</th>
                                    <th>Cari Kod</th>
                                    <th>Cari Ünvan</th>
                                    <th>Paketleyen</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTableBody"></tbody>
                        </table>
                    </div>

                    <div class="package-details" id="packageDetails">
                        <h3>Hızlı Ürün Ekleme</h3>
                        <div class="quick-buttons" id="quickButtons"></div>

                        <div class="package-actions">
                            <button type="button" class="btn" id="manualEntryBtn">MANUEL</button>
                            <div class="definition-panel">
                                <p>Tanımsız Adet: <span style="color: red;" id="undefinedCount">0</span></p>
                                <p>Tanımlı Adet: <span style="color: blue;" id="definedCount">0</span></p>
                                <p>Ortalama Adet: <span id="averageCount">0</span></p>
                            </div>
                            <button type="button" class="btn btn-success" id="savePackageBtn">(F2) Paketle / Kaydet</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="shippingTab">
                <h2>Sevkiyat Yönetimi</h2>
                <div class="shipping-controls" style="display:flex; gap:10px; align-items:flex-end; margin-bottom:10px;">
                    <div class="info-group">
                        <label for="shippingFilter">Filtrele</label>
                        <select id="shippingFilter">
                            <option value="all">Tümü</option>
                            <option value="beklemede">Beklemede</option>
                            <option value="sevk-edildi">Sevk Edildi</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" id="filterShippingBtn">Uygula</button>
                </div>

                <table class="package-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>Konteyner No</th>
                            <th>Müşteri</th>
                            <th>Paket Sayısı</th>
                            <th>Toplam Adet</th>
                            <th>Oluşturulma Tarihi</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="shippingTableBody"></tbody>
                </table>
            </div>

            <div class="tab-pane" id="stockTab">
                <h2>Stok Sorgulama</h2>
                <div class="stock-search">
                    <input type="text" id="stockSearch" placeholder="Ürün adı veya koduna göre ara...">
                    <button type="button" class="btn btn-primary" id="searchStockBtn">Ara</button>
                    <button type="button" class="btn" id="clearStockSearchBtn">Temizle</button>
                </div>

                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>Stok Kodu</th>
                            <th>Ürün Adı</th>
                            <th>Mevcut Adet</th>
                            <th>Birim</th>
                            <th>Son Güncelleme</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody"></tbody>
                </table>

                <div class="file-upload">
                    <h3>Stok Dosyası Yükle</h3>
                    <p>Stok bilgilerini güncellemek için bir Excel veya CSV dosyası yükleyin.</p>
                    <input type="file" id="stockFileUpload" accept=".xlsx,.xls,.csv" style="display:none;">
                    <label for="stockFileUpload" class="upload-button" role="button"><i class="fas fa-upload"></i> Dosya Seç</label>
                    <span id="selectedFileName" style="margin-left:10px;"></span>
                    <button type="button" class="btn btn-primary" id="uploadStockBtn">Yükle</button>
                </div>
            </div>
        </div>

        <div class="app-footer">
            <div class="footer-actions">
                <button type="button" class="btn" id="printLabelBtn"><i class="fas fa-print"></i> Etiket Bas</button>
                <button type="button" class="btn" id="selectAllBtn">Tümünü Seç</button>
                <button type="button" class="btn" id="clearSelectionBtn">Seçimi Kaldır</button>
                <button type="button" class="btn btn-danger" id="deletePackageBtn">Paket Sil</button>
            </div>
            <div class="container-info">
                <button type="button" class="btn" id="loadContainerBtn">Mev. K.</button>
                <button type="button" class="btn" id="createContainerBtn">Yeni K.</button>
                <span>Konteyner No: <span id="containerNumber">C000094</span></span>
            </div>
            <div class="footer-actions">
                <button type="button" class="btn btn-danger" id="deleteContainerBtn">Konteyner Sil</button>
                <button type="button" class="btn btn-success" id="sendToRampBtn">Kon. Rampaya Gönder</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <div class="offline-indicator" id="offlineIndicator"><i class="fas fa-wifi"></i> Çevrimdışı moddasınız</div>

    <!-- Customer Selection Modal -->
    <div class="modal" id="customerModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Müşteri Seçimi</h3>
                <button type="button" class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            <div id="modalBody">
                <div class="customer-list" id="customerList"></div>
                <div class="add-customer-form">
                    <h4>Müşteri Yönetimi</h4>
                    <div class="form-row">
                        <input type="text" id="newCustomerCode" placeholder="Müşteri Kodu">
                        <input type="text" id="newCustomerName" placeholder="Müşteri Adı">
                    </div>
                    <div class="form-row">
                        <input type="email" id="newCustomerEmail" placeholder="E-posta">
                        <button type="button" class="btn btn-primary" id="addCustomerBtn">Müşteri Ekle</button>
                        <button type="button" class="btn btn-danger" id="deleteCustomerBtn">Müşteri Sil</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Customers Modal -->
    <div class="modal" id="allCustomersModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tüm Müşteriler</h3>
                <button type="button" class="modal-close" id="closeAllCustomersBtn">&times;</button>
            </div>
            <div class="customer-list" id="allCustomersList" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Daily Report Email Modal -->
    <div class="modal" id="emailModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>İş Sonu Raporu Gönder</h3>
                <button type="button" class="modal-close" id="closeEmailBtn">&times;</button>
            </div>
            <div class="email-settings">
                <label for="reportEmail">E-posta Adresi:</label>
                <input type="email" id="reportEmail" placeholder="rapor@firma.com">
                <div style="display:flex;gap:8px;margin-top:8px">
                    <button type="button" class="btn btn-primary" id="sendReportBtn">Raporu Gönder</button>
                    <button type="button" class="btn" id="previewReportBtn">Raporu Önizle</button>
                </div>
            </div>
        </div>
    </div>

    <div class="quantity-modal" id="quantityModal" aria-hidden="true">
        <div class="quantity-content">
            <h3 id="quantityProductName">Ürün Miktarı</h3>
            <input type="number" id="quantityInput" class="quantity-input" min="1" value="1">
            <div class="quantity-buttons">
                <button type="button" class="btn btn-primary" id="confirmQuantityBtn">Tamam</button>
                <button type="button" class="btn" id="cancelQuantityBtn">İptal</button>
            </div>
        </div>
    </div>

    <div class="modal" id="manualModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manuel Ürün Ekleme</h3>
                <button type="button" class="modal-close" id="closeManualBtn">&times;</button>
            </div>
            <div class="form-group">
                <label for="manualProductCode">Ürün Kodu</label>
                <input type="text" id="manualProductCode" placeholder="Ürün kodunu girin">
            </div>
            <div class="form-group">
                <label for="manualProductName">Ürün Adı</label>
                <input type="text" id="manualProductName" placeholder="Ürün adını girin">
            </div>
            <div class="form-group">
                <label for="manualQuantity">Miktar</label>
                <input type="number" id="manualQuantity" min="1" value="1">
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-primary" id="addManualBtn">Ekle</button>
                <button type="button" class="btn" id="cancelManualBtn">İptal</button>
            </div>
        </div>
    </div>

<script>
// Supabase initialization
const SUPABASE_URL = 'https://viehnigcbosgsxgehgnn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhbmFzZSIsInJlZiI6InZpZWhuaWdjYm9zZ3N4Z2VoZ25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1Mzg3MzgsImV4cCI6MjA3MzExNDczOH0.iZX8Z5mUjHc_LZpmH5EtFe0C7k4A_1zX8UoM7iDs5FM';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Global variables
let currentUser = null;
let customers = [];
let packages = [];
let containers = [];
let stockItems = [];
let products = [];
let selectedCustomerInModal = null;
let selectedPackage = null;
let currentContainer = "C000094";
let currentQuantityProduct = null;
let barcodeCount = 0;

// DOM Elements
const elements = {
    loginScreen: document.getElementById('loginScreen'),
    appContainer: document.getElementById('appContainer'),
    toast: document.getElementById('toast'),
    customerModal: document.getElementById('customerModal'),
    allCustomersModal: document.getElementById('allCustomersModal'),
    emailModal: document.getElementById('emailModal'),
    quantityModal: document.getElementById('quantityModal'),
    manualModal: document.getElementById('manualModal'),
    selectAllCheckbox: document.getElementById('selectAllPackages'),
    
    // Input fields
    email: document.getElementById('email'),
    password: document.getElementById('password'),
    customerSelect: document.getElementById('customer'),
    personnelSelect: document.getElementById('personnel'),
    customerName: document.getElementById('customerName'),
    barcodeInput: document.getElementById('barcodeInput'),
    stockSearch: document.getElementById('stockSearch'),
    reportEmail: document.getElementById('reportEmail'),
    quantityInput: document.getElementById('quantityInput'),
    manualProductCode: document.getElementById('manualProductCode'),
    manualProductName: document.getElementById('manualProductName'),
    manualQuantity: document.getElementById('manualQuantity'),
    newCustomerCode: document.getElementById('newCustomerCode'),
    newCustomerName: document.getElementById('newCustomerName'),
    newCustomerEmail: document.getElementById('newCustomerEmail'),
    
    // Buttons
    loginBtn: document.getElementById('loginBtn'),
    logoutBtn: document.getElementById('logoutBtn'),
    selectCustomerBtn: document.getElementById('selectCustomerBtn'),
    showAllCustomersBtn: document.getElementById('showAllCustomersBtn'),
    generateReportBtn: document.getElementById('generateReportBtn'),
    searchBarcodeBtn: document.getElementById('searchBarcodeBtn'),
    clearBarcodeBtn: document.getElementById('clearBarcodeBtn'),
    manualEntryBtn: document.getElementById('manualEntryBtn'),
    savePackageBtn: document.getElementById('savePackageBtn'),
    filterShippingBtn: document.getElementById('filterShippingBtn'),
    searchStockBtn: document.getElementById('searchStockBtn'),
    clearStockSearchBtn: document.getElementById('clearStockSearchBtn'),
    uploadStockBtn: document.getElementById('uploadStockBtn'),
    printLabelBtn: document.getElementById('printLabelBtn'),
    selectAllBtn: document.getElementById('selectAllBtn'),
    clearSelectionBtn: document.getElementById('clearSelectionBtn'),
    deletePackageBtn: document.getElementById('deletePackageBtn'),
    loadContainerBtn: document.getElementById('loadContainerBtn'),
    createContainerBtn: document.getElementById('createContainerBtn'),
    deleteContainerBtn: document.getElementById('deleteContainerBtn'),
    sendToRampBtn: document.getElementById('sendToRampBtn'),
    addCustomerBtn: document.getElementById('addCustomerBtn'),
    deleteCustomerBtn: document.getElementById('deleteCustomerBtn'),
    sendReportBtn: document.getElementById('sendReportBtn'),
    previewReportBtn: document.getElementById('previewReportBtn'),
    confirmQuantityBtn: document.getElementById('confirmQuantityBtn'),
    cancelQuantityBtn: document.getElementById('cancelQuantityBtn'),
    addManualBtn: document.getElementById('addManualBtn'),
    cancelManualBtn: document.getElementById('cancelManualBtn'),
    closeModalBtn: document.getElementById('closeModalBtn'),
    closeAllCustomersBtn: document.getElementById('closeAllCustomersBtn'),
    closeEmailBtn: document.getElementById('closeEmailBtn'),
    closeManualBtn: document.getElementById('closeManualBtn'),
    
    // Content areas
    quickButtons: document.getElementById('quickButtons'),
    packagesTableBody: document.getElementById('packagesTableBody'),
    shippingTableBody: document.getElementById('shippingTableBody'),
    stockTableBody: document.getElementById('stockTableBody'),
    customerList: document.getElementById('customerList'),
    allCustomersList: document.getElementById('allCustomersList'),
    userRole: document.getElementById('userRole'),
    barcodeCount: document.getElementById('barcodeCount'),
    containerNumber: document.getElementById('containerNumber'),
    undefinedCount: document.getElementById('undefinedCount'),
    definedCount: document.getElementById('definedCount'),
    averageCount: document.getElementById('averageCount'),
    selectedFileName: document.getElementById('selectedFileName')
};

// Initialize application
async function initApp() {
    setupEventListeners();
    await testConnection();
    await loadInitialData();
    setupTabNavigation();
}

// Test Supabase connection
async function testConnection() {
    try {
        const { data, error } = await supabase.from('customers').select('count').limit(1);
        if (error) {
            console.error('Supabase connection error:', error);
            showToast('Veritabanı bağlantı hatası', 'error');
            return false;
        }
        console.log('Supabase connected successfully');
        return true;
    } catch (e) {
        console.error('Connection test failed:', e);
        showToast('Bağlantı testi başarısız', 'error');
        return false;
    }
}

// Load initial data
async function loadInitialData() {
    try {
        await Promise.all([
            populateCustomerDropdown(),
            populatePersonnelDropdown(),
            populateProducts(),
            populatePackagesTable(),
            populateStockTable(),
            populateShippingTable()
        ]);
        showToast('Uygulama başlatıldı', 'success');
    } catch (error) {
        console.error('Error loading initial data:', error);
        showToast('Veriler yüklenirken hata oluştu', 'error');
    }
}

// Setup event listeners
function setupEventListeners() {
    // Auth events
    elements.loginBtn.addEventListener('click', handleLogin);
    elements.logoutBtn.addEventListener('click', handleLogout);
    elements.password.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
    });

    // Customer events
    elements.selectCustomerBtn.addEventListener('click', showCustomerSelection);
    elements.showAllCustomersBtn.addEventListener('click', showAllCustomers);
    elements.addCustomerBtn.addEventListener('click', addNewCustomer);
    elements.deleteCustomerBtn.addEventListener('click', deleteSelectedCustomer);
    elements.closeModalBtn.addEventListener('click', closeModal);
    elements.closeAllCustomersBtn.addEventListener('click', closeAllCustomersModal);

    // Package events
    elements.searchBarcodeBtn.addEventListener('click', searchBarcode);
    elements.clearBarcodeBtn.addEventListener('click', clearBarcode);
    elements.barcodeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchBarcode();
    });
    elements.manualEntryBtn.addEventListener('click', showManualEntry);
    elements.savePackageBtn.addEventListener('click', savePackage);
    elements.selectAllBtn.addEventListener('click', selectAllPackages);
    elements.clearSelectionBtn.addEventListener('click', clearSelection);
    elements.deletePackageBtn.addEventListener('click', deletePackage);
    elements.printLabelBtn.addEventListener('click', printLabel);

    // Shipping events
    elements.filterShippingBtn.addEventListener('click', filterShipping);
    elements.sendToRampBtn.addEventListener('click', sendToRamp);

    // Stock events
    elements.searchStockBtn.addEventListener('click', searchStock);
    elements.clearStockSearchBtn.addEventListener('click', clearStockSearch);
    elements.stockSearch.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchStock();
    });
    elements.uploadStockBtn.addEventListener('click', uploadStockFile);
    elements.stockFileUpload.addEventListener('change', (e) => {
        const fileName = e.target.files[0]?.name || '';
        elements.selectedFileName.textContent = fileName;
    });

    // Report events
    elements.generateReportBtn.addEventListener('click', generateDailyReport);
    elements.sendReportBtn.addEventListener('click', sendDailyReport);
    elements.previewReportBtn.addEventListener('click', previewReport);
    elements.closeEmailBtn.addEventListener('click', closeEmailModal);

    // Quantity modal events
    elements.confirmQuantityBtn.addEventListener('click', confirmQuantity);
    elements.cancelQuantityBtn.addEventListener('click', closeQuantityModal);

    // Manual modal events
    elements.addManualBtn.addEventListener('click', addManualProduct);
    elements.cancelManualBtn.addEventListener('click', closeManualModal);
    elements.closeManualBtn.addEventListener('click', closeManualModal);

    // Container events
    elements.loadContainerBtn.addEventListener('click', loadCurrentContainer);
    elements.createContainerBtn.addEventListener('click', createNewContainer);
    elements.deleteContainerBtn.addEventListener('click', deleteContainer);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.key === 'F2') { e.preventDefault(); savePackage(); }
        if (e.key === 'Escape') closeAllModals();
        if (e.ctrlKey && e.key === 's') { e.preventDefault(); savePackage(); }
        if (e.ctrlKey && e.key === 'p') { e.preventDefault(); printLabel(); }
        if (e.ctrlKey && e.key === 'n') { e.preventDefault(); createNewContainer(); }
    });
}

// Setup tab navigation
function setupTabNavigation() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            switchTab(tabName);
        });
    });
}

// Authentication functions
async function handleLogin() {
    const email = elements.email.value;
    const password = elements.password.value;

    if (!email || !password) {
        showToast("Lütfen e-posta ve şifre girin", "error");
        return;
    }

    try {
        showToast("Giriş yapılıyor...", "warning");
        
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) {
            console.error("Login error:", error);
            if (error.message.includes("Invalid login credentials")) {
                showToast("Geçersiz e-posta veya şifre", "error");
            } else if (error.message.includes("Email not confirmed")) {
                showToast("E-posta adresiniz doğrulanmamış", "error");
            } else {
                showToast("Giriş başarısız: " + error.message, "error");
            }
            return;
        }

        // Login successful
        currentUser = {
            email: data.user.email,
            uid: data.user.id,
            name: data.user.email.split('@')[0]
        };
        
        elements.userRole.textContent = `Operatör: ${currentUser.name}`;
        elements.loginScreen.style.display = "none";
        elements.appContainer.style.display = "flex";
        
        showToast("Giriş başarılı", "success");
        await initApp();
        
    } catch (e) {
        console.error("Login exception:", e);
        showToast("Giriş işlemi sırasında hata oluştu", "error");
    }
}

async function handleLogout() {
    try {
        await supabase.auth.signOut();
        currentUser = null;
        elements.appContainer.style.display = 'none';
        elements.loginScreen.style.display = 'flex';
        elements.email.value = '';
        elements.password.value = '';
        closeAllModals();
        showToast('Başarıyla çıkış yapıldı', 'success');
    } catch (error) {
        showToast('Çıkış yapılırken hata oluştu', 'error');
    }
}

// Data population functions
async function populateCustomerDropdown() {
    try {
        elements.customerSelect.innerHTML = '<option value="">Müşteri seçin...</option>';
        
        const { data: customers, error } = await supabase
            .from('customers')
            .select('*')
            .order('name');
        
        if (error) throw error;
        
        window.customers = customers;
        
        customers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = `${customer.code} - ${customer.name}`;
            option.setAttribute('data-name', customer.name);
            elements.customerSelect.appendChild(option);
        });

        elements.customerSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const customerName = selectedOption.getAttribute('data-name') || 'Lütfen müşteri seçin';
            elements.customerName.textContent = customerName;
        });
        
    } catch (error) {
        console.error('Error loading customers:', error);
        showToast('Müşteriler yüklenirken hata oluştu', 'error');
    }
}

async function populatePersonnelDropdown() {
    try {
        elements.personnelSelect.innerHTML = '<option value="">Personel seçin...</option>';
        
        const { data: personnel, error } = await supabase
            .from('personnel')
            .select('*')
            .order('name');
        
        if (error) {
            // If personnel table doesn't exist, use current user
            if (currentUser) {
                const option = document.createElement('option');
                option.value = currentUser.uid;
                option.textContent = `${currentUser.name} (Mevcut Kullanıcı)`;
                elements.personnelSelect.appendChild(option);
            }
            return;
        }
        
        personnel.forEach(person => {
            const option = document.createElement('option');
            option.value = person.id;
            option.textContent = `${person.code} - ${person.name}`;
            elements.personnelSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading personnel:', error);
    }
}

async function populateProducts() {
    try {
        const { data: products, error } = await supabase
            .from('products')
            .select('*')
            .order('name');
        
        if (error) throw error;
        
        window.products = products.map(product => ({
            ...product,
            quantity: 0
        }));
        
        populateQuickButtons();
        
    } catch (error) {
        console.error('Error loading products:', error);
        showToast('Ürünler yüklenirken hata oluştu', 'error');
        
        // Create sample products if table doesn't exist
        window.products = [
            { id: 1, code: 'TSHIRT', name: 'Tişört', quantity: 0 },
            { id: 2, code: 'PANT', name: 'Pantolon', quantity: 0 },
            { id: 3, code: 'TOWEL', name: 'Havlu', quantity: 0 },
            { id: 4, code: 'SHEET', name: 'Çarşaf', quantity: 0 },
            { id: 5, code: 'PILLOW', name: 'Yastık', quantity: 0 },
            { id: 6, code: 'BLANKET', name: 'Battaniye', quantity: 0 }
        ];
        
        populateQuickButtons();
    }
}

function populateQuickButtons() {
    elements.quickButtons.innerHTML = '';
    
    products.forEach(product => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'quick-btn';
        button.innerHTML = `${product.name}${product.quantity > 0 ? `<div class="quantity-badge">${product.quantity}</div>` : ''}`;
        button.addEventListener('click', () => openQuantityModal(product));
        elements.quickButtons.appendChild(button);
    });
}

async function populatePackagesTable() {
    try {
        elements.packagesTableBody.innerHTML = '';
        
        const { data: packages, error } = await supabase
            .from('packages')
            .select(`
                *,
                customers (code, name),
                personnel (code, name)
            `)
            .order('created_at', { ascending: false });

        if (error) throw error;
        
        window.packages = packages;

        if (packages.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="8" style="text-align:center;color:#666;padding:12px">Henüz paket bulunmamaktadır</td>`;
            elements.packagesTableBody.appendChild(row);
            return;
        }

        packages.forEach((pkg, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="checkbox" data-id="${pkg.id}"></td>
                <td>${index + 1}</td>
                <td>${escapeHtml(pkg.package_no)}</td>
                <td>${pkg.total_quantity}</td>
                <td>${new Date(pkg.created_at).toLocaleString('tr-TR')}</td>
                <td>${escapeHtml(pkg.customers?.code || 'N/A')}</td>
                <td>${escapeHtml(pkg.customers?.name || 'N/A')}</td>
                <td>${escapeHtml(pkg.packer)}</td>
            `;
            elements.packagesTableBody.appendChild(row);
        });
        
    } catch (error) {
        console.error('Error loading packages:', error);
        showToast('Paketler yüklenirken hata oluştu', 'error');
    }
}

async function populateStockTable() {
    try {
        elements.stockTableBody.innerHTML = '';
        
        const { data: stockItems, error } = await supabase
            .from('stock_items')
            .select('*')
            .order('name');
        
        if (error) throw error;
        
        window.stockItems = stockItems;

        if (stockItems.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="6" style="text-align:center;color:#666;padding:12px">Henüz stok kaydı bulunmamaktadır</td>`;
            elements.stockTableBody.appendChild(row);
            return;
        }
        
        stockItems.forEach(item => {
            const row = document.createElement('tr');
            const statusClass = item.quantity <= 10 ? 'status-kritik' : 
                               item.quantity <= 50 ? 'status-az-stok' : 'status-stokta';
            const statusText = item.quantity <= 10 ? 'Kritik' : 
                              item.quantity <= 50 ? 'Az Stok' : 'Stokta';
            
            row.innerHTML = `
                <td>${escapeHtml(item.code)}</td>
                <td>${escapeHtml(item.name)}</td>
                <td>${escapeHtml(item.quantity)}</td>
                <td>${escapeHtml(item.unit)}</td>
                <td>${new Date(item.updated_at).toLocaleDateString('tr-TR')}</td>
                <td><span class="${statusClass}">${statusText}</span></td>
            `;
            elements.stockTableBody.appendChild(row);
        });
        
    } catch (error) {
        console.error('Error loading stock:', error);
        showToast('Stok bilgileri yüklenirken hata oluştu', 'error');
    }
}

async function populateShippingTable() {
    try {
        elements.shippingTableBody.innerHTML = '';
        
        const filter = elements.shippingFilter.value || 'all';
        let query = supabase.from('containers').select('*');
        
        if (filter !== 'all') {
            query = query.eq('status', filter);
        }
        
        const { data: containers, error } = await query.order('created_at', { ascending: false });
        
        if (error) throw error;
        
        window.containers = containers;

        if (containers.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="7" style="text-align:center;color:#666;padding:12px">Henüz konteyner bulunmamaktadır</td>`;
            elements.shippingTableBody.appendChild(row);
            return;
        }
        
        containers.forEach(container => {
            const row = document.createElement('tr');
            const statusClass = container.status === 'beklemede' ? 'status-beklemede' : 'status-sevk-edildi';
            
            row.innerHTML = `
                <td>${escapeHtml(container.container_no)}</td>
                <td>${escapeHtml(container.customer)}</td>
                <td>${escapeHtml(container.package_count)}</td>
                <td>${escapeHtml(container.total_quantity)}</td>
                <td>${new Date(container.created_at).toLocaleDateString('tr-TR')}</td>
                <td><span class="${statusClass}">${container.status === 'beklemede' ? 'Beklemede' : 'Sevk Edildi'}</span></td>
                <td>
                    ${container.status === 'beklemede' ? 
                        `<button class="btn btn-success" data-container="${container.container_no}">Sevk Et</button>` :
                        `<span>Sevk Edildi</span>`
                    }
                </td>
            `;
            elements.shippingTableBody.appendChild(row);
        });
        
        // Add event listeners to ship buttons
        elements.shippingTableBody.querySelectorAll('button[data-container]').forEach(btn => {
            btn.addEventListener('click', () => {
                shipContainer(btn.getAttribute('data-container'));
            });
        });
        
    } catch (error) {
        console.error('Error loading shipping:', error);
        showToast('Sevkiyat bilgileri yüklenirken hata oluştu', 'error');
    }
}

// Customer operations
async function showCustomerSelection() {
    try {
        await populateCustomerModal();
        elements.customerModal.style.display = 'flex';
    } catch (error) {
        console.error('Error showing customer selection:', error);
        showToast('Müşteri seçimi açılırken hata oluştu', 'error');
    }
}

async function populateCustomerModal() {
    try {
        elements.customerList.innerHTML = '';
        
        const { data: customers, error } = await supabase
            .from('customers')
            .select('*')
            .order('name');
        
        if (error) throw error;
        
        customers.forEach(customer => {
            const item = document.createElement('div');
            item.className = 'customer-item';
            item.innerHTML = `
                <div>
                    <strong>${escapeHtml(customer.code)} - ${escapeHtml(customer.name)}</strong><br>
                    <small>E-posta: ${escapeHtml(customer.email || 'Belirtilmemiş')}</small>
                </div>
                <button class="btn btn-primary">Seç</button>
            `;
            
            const selectBtn = item.querySelector('button');
            selectBtn.addEventListener('click', () => {
                selectCustomer(customer);
            });
            
            elements.customerList.appendChild(item);
        });
        
    } catch (error) {
        console.error('Error populating customer modal:', error);
        showToast('Müşteri listesi yüklenirken hata oluştu', 'error');
    }
}

function selectCustomer(customer) {
    elements.customerSelect.value = customer.id;
    elements.customerName.textContent = customer.name;
    closeModal();
    showToast(`Müşteri seçildi: ${customer.name}`, 'success');
}

async function showAllCustomers() {
    try {
        elements.allCustomersList.innerHTML = '';
        
        const { data: customers, error } = await supabase
            .from('customers')
            .select('*')
            .order('name');
        
        if (error) throw error;
        
        customers.forEach(customer => {
            const item = document.createElement('div');
            item.className = 'customer-item';
            item.innerHTML = `
                <div>
                    <strong>${escapeHtml(customer.code)} - ${escapeHtml(customer.name)}</strong><br>
                    <small>E-posta: ${escapeHtml(customer.email || 'Belirtilmemiş')}</small>
                </div>
            `;
            elements.allCustomersList.appendChild(item);
        });

        elements.allCustomersModal.style.display = 'flex';
        
    } catch (error) {
        console.error('Error showing all customers:', error);
        showToast('Müşteri listesi yüklenirken hata oluştu', 'error');
    }
}

async function addNewCustomer() {
    const code = elements.newCustomerCode.value.trim();
    const name = elements.newCustomerName.value.trim();
    const email = elements.newCustomerEmail.value.trim();

    if (!code || !name) {
        showToast('Müşteri kodu ve adı gerekli', 'error');
        return;
    }

    try {
        const { error } = await supabase
            .from('customers')
            .insert([{ code, name, email: email || null }]);

        if (error) throw error;

        showToast(`Yeni müşteri eklendi: ${name}`, 'success');
        
        elements.newCustomerCode.value = '';
        elements.newCustomerName.value = '';
        elements.newCustomerEmail.value = '';
        
        await populateCustomerDropdown();
        await populateCustomerModal();
        
    } catch (error) {
        console.error('Error adding customer:', error);
        showToast('Müşteri eklenirken hata oluştu', 'error');
    }
}

async function deleteSelectedCustomer() {
    if (!selectedCustomerInModal) {
        showToast('Silmek için bir müşteri seçin', 'error');
        return;
    }

    if (!confirm(`${selectedCustomerInModal.name} müşterisini silmek istediğinize emin misiniz?`)) return;

    try {
        const { error } = await supabase
            .from('customers')
            .delete()
            .eq('id', selectedCustomerInModal.id);

        if (error) throw error;

        showToast('Müşteri silindi', 'success');
        selectedCustomerInModal = null;
        
        await populateCustomerDropdown();
        await populateCustomerModal();
        
    } catch (error) {
        console.error('Error deleting customer:', error);
        showToast('Müşteri silinirken hata oluştu', 'error');
    }
}

// Package operations
function searchBarcode() {
    const barcode = elements.barcodeInput.value.trim();
    if (!barcode) return;
    
    barcodeCount++;
    elements.barcodeCount.textContent = barcodeCount;

    try {
        JsBarcode("#barcode", barcode, { format: "CODE128", displayValue: true, fontSize: 12, height: 40 });
    } catch (e) {
        showToast('Geçersiz barkod formatı', 'error');
    }

    updateDefinitionCounts();
    showToast(`Barkod okundu: ${barcode}`, 'success');
    elements.barcodeInput.value = '';
}

function clearBarcode() {
    elements.barcodeInput.value = '';
    document.getElementById('barcode').innerHTML = '';
}

function openQuantityModal(product) {
    currentQuantityProduct = product;
    elements.quantityProductName.textContent = product.name;
    elements.quantityInput.value = 1;
    elements.quantityModal.style.display = 'flex';
    elements.quantityInput.focus();
}

function confirmQuantity() {
    const quantity = parseInt(elements.quantityInput.value, 10) || 0;
    if (quantity > 0 && currentQuantityProduct) {
        currentQuantityProduct.quantity += quantity;
        populateQuickButtons();
        updateDefinitionCounts();
        showToast(`${currentQuantityProduct.name}: ${quantity} adet eklendi`, 'success');
        closeQuantityModal();
    } else {
        showToast('Geçerli bir miktar girin', 'error');
    }
}

function closeQuantityModal() {
    elements.quantityModal.style.display = 'none';
    currentQuantityProduct = null;
}

function showManualEntry() {
    elements.manualModal.style.display = 'flex';
    elements.manualProductCode.focus();
}

function closeManualModal() {
    elements.manualModal.style.display = 'none';
    elements.manualProductCode.value = '';
    elements.manualProductName.value = '';
    elements.manualQuantity.value = '1';
}

async function addManualProduct() {
    const code = elements.manualProductCode.value.trim();
    const name = elements.manualProductName.value.trim();
    const quantity = parseInt(elements.manualQuantity.value, 10) || 0;

    if (!code || !name || quantity < 1) {
        showToast("Tüm alanlar gerekli ve miktar 1'den büyük olmalı", 'error');
        return;
    }

    try {
        let product = products.find(p => p.code === code);
        
        if (!product) {
            // Try to add to database first
            const { data: newProduct, error } = await supabase
                .from('products')
                .insert([{ code, name }])
                .select()
                .single();

            if (error) throw error;

            product = { ...newProduct, quantity: 0 };
            products.push(product);
        }

        product.quantity += quantity;
        populateQuickButtons();
        updateDefinitionCounts();
        closeManualModal();
        showToast(`${name}: ${quantity} adet eklendi`, 'success');
        
    } catch (error) {
        console.error('Error adding manual product:', error);
        showToast('Ürün eklenirken hata oluştu', 'error');
    }
}

function updateDefinitionCounts() {
    const defined = products.filter(p => p.quantity > 0).reduce((sum, p) => sum + p.quantity, 0);
    const undefinedCount = Math.max(0, barcodeCount - defined);
    const average = packages.length > 0 ? Math.round(packages.reduce((sum, p) => sum + p.total_quantity, 0) / packages.length) : 0;

    elements.definedCount.textContent = defined;
    elements.undefinedCount.textContent = undefinedCount;
    elements.averageCount.textContent = average;
}

async function savePackage() {
    const selectedCustomerId = elements.customerSelect.value;
    const selectedPersonnelId = elements.personnelSelect.value;

    if (!selectedCustomerId) {
        showToast('Lütfen bir müşteri seçin', 'error');
        return;
    }

    if (!selectedPersonnelId) {
        showToast('Lütfen bir personel seçin', 'error');
        return;
    }

    const totalQuantity = products.reduce((sum, p) => sum + p.quantity, 0);
    if (totalQuantity === 0) {
        showToast('Paket için en az bir ürün ekleyin', 'error');
        return;
    }

    try {
        const timestamp = new Date().getTime();
        const packageNo = `PKG-${timestamp.toString().slice(-6)}`;
        
        const { data: packageData, error: packageError } = await supabase
            .from('packages')
            .insert([{
                package_no: packageNo,
                total_quantity: totalQuantity,
                customer_id: selectedCustomerId,
                personnel_id: selectedPersonnelId,
                packer: currentUser?.name || 'Bilinmiyor'
            }])
            .select();

        if (packageError) throw packageError;

        // Save package items
        const packageItems = products
            .filter(p => p.quantity > 0)
            .map(p => ({
                package_id: packageData[0].id,
                product_id: p.id,
                quantity: p.quantity,
                product_code: p.code,
                product_name: p.name
            }));

        if (packageItems.length > 0) {
            const { error: itemsError } = await supabase
                .from('package_items')
                .insert(packageItems);

            if (itemsError) throw itemsError;
        }

        showToast(`Paket kaydedildi: ${packageNo}`, 'success');
        
        // Reset UI
        products.forEach(p => p.quantity = 0);
        barcodeCount = 0;
        populateQuickButtons();
        clearBarcode();
        elements.barcodeCount.textContent = '0';
        updateDefinitionCounts();
        
        await populatePackagesTable();
        
    } catch (error) {
        console.error('Error saving package:', error);
        showToast('Paket kaydedilirken hata oluştu', 'error');
    }
}

function selectAllPackages() {
    const checkboxes = elements.packagesTableBody.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
}

function clearSelection() {
    const checkboxes = elements.packagesTableBody.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
}

async function deletePackage() {
    const checkboxes = elements.packagesTableBody.querySelectorAll('input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        showToast('Lütfen silmek için bir paket seçin', 'error');
        return;
    }

    const packageIds = Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-id'));
    
    if (!confirm(`${packageIds.length} paketi silmek istediğinize emin misiniz?`)) return;

    try {
        for (const packageId of packageIds) {
            // First delete package items
            await supabase
                .from('package_items')
                .delete()
                .eq('package_id', packageId);
                
            // Then delete the package
            await supabase
                .from('packages')
                .delete()
                .eq('id', packageId);
        }

        showToast(`${packageIds.length} paket silindi`, 'success');
        await populatePackagesTable();
        
    } catch (error) {
        console.error('Error deleting package:', error);
        showToast('Paket silinirken hata oluştu', 'error');
    }
}

async function printLabel() {
    const checkboxes = elements.packagesTableBody.querySelectorAll('input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        showToast('Lütfen yazdırmak için bir paket seçin', 'error');
        return;
    }

    const packageIds = Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-id'));
    const selectedPackages = packages.filter(p => packageIds.includes(p.id));

    try {
        const { data: packageItems } = await supabase
            .from('package_items')
            .select('*')
            .in('package_id', packageIds);

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html><head><title>Paket Etiketleri</title><style>body{font-family:Arial}.label{width:300px;height:150px;border:1px solid #000;margin:10px;padding:10px;display:inline-block;page-break-inside:avoid}</style><script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script></head><body><h1>Paket Etiketleri</h1>
        `);

        selectedPackages.forEach(pkg => {
            const itemsForPackage = packageItems?.filter(item => item.package_id === pkg.id) || [];
            const itemsList = itemsForPackage.map(item => `${item.product_name}: ${item.quantity}`).join('<br>');
            
            printWindow.document.write(`
                <div class="label">
                    <h3>${escapeHtml(pkg.customers?.name || 'N/A')}</h3>
                    <p>Paket No: ${escapeHtml(pkg.package_no)}</p>
                    <p>Toplam Adet: ${pkg.total_quantity}</p>
                    <small>${itemsList}</small>
                    <svg id="barcode-${pkg.id}"></svg>
                    <script>JsBarcode("#barcode-${pkg.id}", "${pkg.package_no}", { format: "CODE128", displayValue:true, fontSize:12, height:30 });<\/script>
                </div>
            `);
        });

        printWindow.document.write('</body></html>');
        printWindow.document.close();
        setTimeout(() => printWindow.print(), 500);
        showToast(`${selectedPackages.length} paket için etiket yazdırılıyor...`, 'success');
        
    } catch (error) {
        console.error('Error printing labels:', error);
        showToast('Etiket yazdırılırken hata oluştu', 'error');
    }
}

// Shipping operations
async function sendToRamp() {
    const checkboxes = elements.packagesTableBody.querySelectorAll('input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        showToast('Lütfen rampaya göndermek için paket seçin', 'error');
        return;
    }

    const packageIds = Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-id'));
    const selectedPackages = packages.filter(p => packageIds.includes(p.id));
    
    if (!confirm('Seçilen paketleri rampaya göndermek istediğinize emin misiniz?')) return;

    try {
        const totalQuantity = selectedPackages.reduce((sum, pkg) => sum + pkg.total_quantity, 0);
        const timestamp = new Date().getTime();
        const containerNo = `CONT-${timestamp.toString().slice(-6)}`;
        
        const { data: newContainer, error: containerError } = await supabase
            .from('containers')
            .insert([{
                container_no: containerNo,
                customer: selectedPackages[0].customers?.name || 'Bilinmiyor',
                package_count: selectedPackages.length,
                total_quantity: totalQuantity,
                status: 'beklemede',
                package_ids: packageIds
            }])
            .select();

        if (containerError) throw containerError;

        // Update packages with container reference
        for (const pkg of selectedPackages) {
            await supabase
                .from('packages')
                .update({ container_id: newContainer[0].id })
                .eq('id', pkg.id);
        }

        showToast(`${selectedPackages.length} paket konteyner ile rampaya gönderildi`, 'success');
        await populatePackagesTable();
        await populateShippingTable();
        
    } catch (error) {
        console.error('Error sending to ramp:', error);
        showToast('Rampaya gönderilirken hata oluştu', 'error');
    }
}

async function shipContainer(containerNo) {
    try {
        await supabase
            .from('containers')
            .update({ status: 'sevk-edildi' })
            .eq('container_no', containerNo);

        showToast(`Konteyner ${containerNo} sevk edildi`, 'success');
        await populateShippingTable();
        
    } catch (error) {
        console.error('Error shipping container:', error);
        showToast('Konteyner sevk edilirken hata oluştu', 'error');
    }
}

function filterShipping() {
    populateShippingTable();
}

// Stock operations
function searchStock() {
    const searchTerm = elements.stockSearch.value.toLowerCase();
    const rows = elements.stockTableBody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function clearStockSearch() {
    elements.stockSearch.value = '';
    const rows = elements.stockTableBody.querySelectorAll('tr');
    rows.forEach(row => {
        row.style.display = '';
    });
}

async function uploadStockFile() {
    const fileInput = document.getElementById('stockFileUpload');
    const file = fileInput.files[0];
    if (!file) {
        showToast('Lütfen bir dosya seçin', 'error');
        return;
    }

    showToast('Dosya yükleniyor...', 'warning');

    try {
        let stockData = [];
        
        if (file.name.endsWith('.csv')) {
            const text = await file.text();
            stockData = Papa.parse(text, { header: true }).data;
        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            stockData = XLSX.utils.sheet_to_json(worksheet);
        }

        for (const item of stockData) {
            const code = item['Stok Kodu'] || item['code'] || item['StokKodu'] || '';
            const name = item['Ürün Adı'] || item['name'] || item['ÜrünAdı'] || item['product'] || '';
            const quantity = parseInt(item['Mevcut Adet'] || item['quantity'] || item['MevcutAdet'] || 0);
            const unit = item['Birim'] || item['unit'] || 'Adet';
            
            if (!code || !name) continue;

            await supabase
                .from('stock_items')
                .upsert({
                    code: code,
                    name: name,
                    quantity: quantity,
                    unit: unit,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'code' });
        }

        showToast('Stok dosyası başarıyla yüklendi', 'success');
        elements.selectedFileName.textContent = '';
        fileInput.value = '';
        
        await populateStockTable();
        
    } catch (error) {
        console.error('Error uploading stock file:', error);
        showToast('Dosya yüklenirken hata oluştu', 'error');
    }
}

// Report operations
function generateDailyReport() {
    elements.emailModal.style.display = 'flex';
}

function closeEmailModal() {
    elements.emailModal.style.display = 'none';
}

async function sendDailyReport() {
    const email = elements.reportEmail.value;
    if (!email) {
        showToast('Lütfen e-posta adresini girin', 'error');
        return;
    }

    showToast('Rapor gönderiliyor...', 'warning');
    
    // Simulate email sending
    setTimeout(() => {
        showToast(`Rapor ${email} adresine gönderildi`, 'success');
        closeEmailModal();
    }, 2000);
}

async function previewReport() {
    await populatePackagesTable();
    
    const reportData = {
        date: new Date().toLocaleDateString('tr-TR'),
        totalPackages: packages.length,
        totalItems: packages.reduce((sum, pkg) => sum + pkg.total_quantity, 0),
        containers: containers.length,
        customers: [...new Set(packages.map(p => p.customers?.name))].length,
        operator: currentUser?.name || 'Bilinmiyor'
    };

    const reportWindow = window.open('', '_blank');
    reportWindow.document.write(`
        <html>
        <head>
            <title>İş Sonu Raporu - ${reportData.date}</title>
            <style>
                body { font-family: Arial; margin: 20px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
            </style>
        </head>
        <body>
            <h1>ProClean - İş Sonu Raporu</h1>
            <p><strong>Tarih:</strong> ${reportData.date} | <strong>Operatör:</strong> ${reportData.operator}</p>
            
            <h2>Özet</h2>
            <ul>
                <li>Toplam Paket Sayısı: ${reportData.totalPackages}</li>
                <li>Toplam Ürün Adedi: ${reportData.totalItems}</li>
                <li>Konteyner Sayısı: ${reportData.containers}</li>
                <li>Müşteri Sayısı: ${reportData.customers}</li>
            </ul>
            
            <h2>Paket Detayları</h2>
            <table>
                <thead>
                    <tr>
                        <th>Paket No</th>
                        <th>Müşteri</th>
                        <th>Adet</th>
                        <th>Zaman</th>
                        <th>Paketleyen</th>
                    </tr>
                </thead>
                <tbody>
                    ${packages.map(pkg => `
                        <tr>
                            <td>${escapeHtml(pkg.package_no)}</td>
                            <td>${escapeHtml(pkg.customers?.name || 'N/A')}</td>
                            <td>${pkg.total_quantity}</td>
                            <td>${new Date(pkg.created_at).toLocaleString('tr-TR')}</td>
                            <td>${escapeHtml(pkg.packer)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </body>
        </html>
    `);
    reportWindow.document.close();
}

// Container operations
function loadCurrentContainer() {
    showToast('Mevcut konteyner yüklendi', 'success');
}

async function createNewContainer() {
    try {
        const timestamp = new Date().getTime();
        const containerNo = `CONT-${timestamp.toString().slice(-6)}`;
        
        const { data: newContainer, error } = await supabase
            .from('containers')
            .insert([{
                container_no: containerNo,
                customer: '',
                package_count: 0,
                total_quantity: 0,
                status: 'beklemede',
                package_ids: []
            }])
            .select();

        if (error) throw error;

        elements.containerNumber.textContent = containerNo;
        currentContainer = containerNo;
        
        showToast(`Yeni konteyner oluşturuldu: ${containerNo}`, 'success');
        await populateShippingTable();
        
    } catch (error) {
        console.error('Error creating container:', error);
        showToast('Konteyner oluşturulurken hata oluştu', 'error');
    }
}

async function deleteContainer() {
    if (!confirm('Konteyneri silmek istediğinize emin misiniz?')) return;

    try {
        await supabase
            .from('containers')
            .delete()
            .eq('container_no', currentContainer);

        elements.containerNumber.textContent = 'Yok';
        currentContainer = null;
        
        showToast('Konteyner silindi', 'success');
        await populateShippingTable();
        
    } catch (error) {
        console.error('Error deleting container:', error);
        showToast('Konteyner silinirken hata oluştu', 'error');
    }
}

// Utility functions
function switchTab(tabName) {
    // Hide all tab panes
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    // Deactivate all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Activate selected tab
    const selectedTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
    const selectedPane = document.getElementById(`${tabName}Tab`);
    
    if (selectedTab && selectedPane) {
        selectedTab.classList.add('active');
        selectedPane.classList.add('active');
    }
}

function closeAllModals() {
    elements.customerModal.style.display = 'none';
    elements.allCustomersModal.style.display = 'none';
    elements.emailModal.style.display = 'none';
    elements.quantityModal.style.display = 'none';
    elements.manualModal.style.display = 'none';
}

function closeModal() {
    elements.customerModal.style.display = 'none';
}

function closeAllCustomersModal() {
    elements.allCustomersModal.style.display = 'none';
}

function showToast(message, type = 'success', duration = 3000) {
    elements.toast.textContent = message;
    elements.toast.className = `toast ${type} show`;
    
    setTimeout(() => {
        elements.toast.classList.remove('show');
    }, duration);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize auth state listener
supabase.auth.onAuthStateChange((event, session) => {
    if (session) {
        currentUser = {
            email: session.user.email,
            uid: session.user.id,
            name: session.user.email.split('@')[0]
        };
        
        elements.userRole.textContent = `Operatör: ${currentUser.name}`;
        elements.loginScreen.style.display = "none";
        elements.appContainer.style.display = "flex";
        
        initApp();
    } else {
        elements.loginScreen.style.display = "flex";
        elements.appContainer.style.display = "none";
    }
});

// Initialize application when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    elements.loginScreen.style.display = 'flex';
    elements.appContainer.style.display = 'none';
});
</script>
</body>
</html>
